<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
    <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256</link>
    <description>[moved post to correct sequence]</description>
    <language>en</language>
    <lastBuildDate>Tue, 22 May 2018 19:02:23 +0000</lastBuildDate>
    <category>Development</category>
    <atom:link href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="http://forums.whonix.org/u/patrick">@Patrick</a> I will follow up with debian/apt (re: bug vs expected). There is nothing to do for Whonix / Qubes. (Haven’t tested yet, but if TemplateBasedVMs are using uwt, I don’t anticipate any issues - haven’t had any to date in W13).</p>
<p>Actually… this is a non-issue for Qubes 4 but it still affects Qubes 3.2 &amp; non-Qubes-Whonix(?). (Only <em>noticeable</em> for users with WORKSTATION_TRANSPARENT_DNS=0.)</p>
<p>Will update after hearing from upstream.</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/9</link>
        <pubDate>Tue, 22 May 2018 19:02:23 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-9</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p>[moved post to correct sequence]</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/1</link>
        <pubDate>Tue, 22 May 2018 17:59:46 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-1</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>entr0py:</p>
<blockquote>
<aside class="quote" data-post="11" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I am failing to understand this still but this may be important.</p>
</blockquote>
</aside>
<p>rewrite:</p>
<aside class="quote" data-post="9" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>apt-get performs DNS lookup [using system resolver] for every repository entry (including http, onion, and even numeric IPs) [regardless of whether or not a proxy is configured for that particular host using apt.conf].</p>
</blockquote>
</aside>
</blockquote>
<p>I see.</p>
<blockquote>
<aside class="quote" data-post="11" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Do you mean there is a non-Whonix / non-Qubes specific apt-get bug that it ignores proxy settings and makes system default DNS (“clearnet”) requests?</p>
</blockquote>
</aside>
<p>This. apt-get leaks and whonix cleans up the mess as expected.</p>
</blockquote>
<p>Phew. At least no Whonix leak bug found.</p>
<blockquote>
<p>Still trying to decide whether it’s a bug or expected behavior in apt-get. We would prefer this logic:</p>
<ol>
<li>check if proxy is configured for host</li>
<li>use proxy to resolve dns</li>
</ol>
<p>apt-get:</p>
<ol>
<li>resolve dns first</li>
<li>check if proxy is configured</li>
</ol>
</blockquote>
<p>Very much agreed!</p>
<blockquote>
<p>apt-get’s implementation may be correct since dns resolution may be required to check blocked hosts, configured proxies, etc.</p>
</blockquote>
<p>I guess that would be a big surprise, violating principle of least<br>
surprise. Should at very least be clearly documented. I guess if so,<br>
would be considered an apt-get bug.</p>
<blockquote>
<aside class="quote" data-post="11" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>There is no DNS connectivity in Qubes-Whonix templates by default.</p>
</blockquote>
</aside>
<p>So that solves the issue for templates. Running apt-get in appVMs will leak DNS queries through WORKSTATION_TRANSPARENT_DNS.</p>
</blockquote>
<p>Shouldn’t. [*] Does it?</p>
<ul>
<li>
<p>In Whonix TemplateBasedVMs, uwt is being used.</p>
</li>
<li>
<p>Only Whonix TemplateVMs use proxy settings (so Qubes UpdatesProxy<br>
mechanism gets used), but also in Whonix TemplateVMs NetVM is set to<br>
<code>none</code> by default.</p>
</li>
</ul>
<blockquote>
<p>Not ideal but not a big issue.</p>
</blockquote>
<p>If so: Really wouldn’t be ideal.</p>
<blockquote>
<p>Reinforces what we’ve known all along: Never trust application proxy settings!</p>
</blockquote>
<p>Agreed.</p>
<blockquote>
<p>I’ve been testing vscode with stream isolation using its command line proxy settings.</p>
</blockquote>
<p>Nice!</p>
<blockquote>
<p>Every program should use uwt.</p>
</blockquote>
<p>[*] Since uwt is based on torsocks, it’s not bulletproof either. Not<br>
even close.</p>
<aside class="quote" data-post="1" data-topic="4840">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar">
    <a href="https://forums.whonix.org/t/managing-programs-without-tor-dns-support/4840/13">Managing programs without Tor DNS Support</a> <a class="badge-wrapper  bullet" href="http://forums.whonix.org/c/development"><span class="badge-category-bg" style="background-color: #25AAE2;"></span><span style="" data-drop-close="true" class="badge-category clear-badge" title="Hacking on the Whonix software and code. (devs) (list of unmaintained components)">Development</span></a>
  </div>
  <blockquote>
    Summary way forward: 
As uwt/torsocks replacement… 
Run application either 
a) under its own linux user name (problematic linux access rights) OR 
b) under its own linux network namespace (strongly preferred) 
then redirect to pre-configured Tor TransPorts or DnsPorts. 
(Similar to how we currently pre-configure multiple Tor SocksPorts currently.)
  </blockquote>
</aside>

          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/8</link>
        <pubDate>Tue, 22 May 2018 02:11:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-8</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="11" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I am failing to understand this still but this may be important.</p>
</blockquote>
</aside>
<p>rewrite:</p>
<aside class="quote" data-post="9" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>apt-get performs DNS lookup [using system resolver] for every repository entry (including http, onion, and even numeric IPs) [regardless of whether or not a proxy is configured for that particular host using apt.conf].</p>
</blockquote>
</aside>
<aside class="quote" data-post="11" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Do you mean there is a non-Whonix / non-Qubes specific apt-get bug that it ignores proxy settings and makes system default DNS (“clearnet”) requests?</p>
</blockquote>
</aside>
<p>This. apt-get leaks and whonix cleans up the mess as expected. Still trying to decide whether it’s a bug or expected behavior in apt-get. We would prefer this logic:</p>
<ol>
<li>check if proxy is configured for host</li>
<li>use proxy to resolve dns</li>
</ol>
<p>apt-get:</p>
<ol>
<li>resolve dns first</li>
<li>check if proxy is configured</li>
</ol>
<p>apt-get’s implementation may be correct since dns resolution may be required to check blocked hosts, configured proxies, etc.</p>
<aside class="quote" data-post="11" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>There is no DNS connectivity in Qubes-Whonix templates by default.</p>
</blockquote>
</aside>
<p>So that solves the issue for templates. Running apt-get in appVMs will leak DNS queries through WORKSTATION_TRANSPARENT_DNS. Not ideal but not a big issue.</p>
<p>Reinforces what we’ve known all along: Never trust application proxy settings! I’ve been testing vscode with stream isolation using its command line proxy settings. Has behaved well for a long time. Fetches extensions through the proxy but then, when extension needs downloads - it ignores proxy settings. Every program should use uwt.</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/7</link>
        <pubDate>Mon, 21 May 2018 18:48:51 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-7</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>I am failing to understand this still but this may be important.</p>
<p>entr0py:</p>
<blockquote>
<aside class="quote" data-post="7" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Do you have the dom0 settings?</p>
</blockquote>
</aside>
<p>I suspect this is not a Qubes or Whonix issue. It appears to be an apt-get DNS leak (by design?).</p>
<p>apt-get performs DNS lookup for every repository entry (including http, onion, and even numeric IPs).</p>
</blockquote>
<p>Of course apt-get performs DNS lookup. apt-get knows nothing about Tor,<br>
Whonix, etc. We just need to make sure the DNS lookup is done by<br>
Whonix-Gateway through Tor. apt-get does DNS lookup like any application.</p>
<blockquote>
<p>This may be expected behavior because Acquire::http::Proxy can be configured per host. Also, http may be proxied while other apt-transports are not. In these cases, it would be desirable to have local DNS resolution.</p>
</blockquote>
<blockquote>
<p>It seems the only way to block DNS requests for our use case would be to establish complex rules.</p>
</blockquote>
<p>There is no DNS connectivity in Qubes-Whonix templates by default. So<br>
all DNS requests are filtered anyhow. More so in Qubes R4 since<br>
Qubes-Whonix TemplateVM’s NetVM is set to <code>none</code>.</p>
<p>Do you mean there is a non-Whonix / non-Qubes specific apt-get bug that<br>
it ignores proxy settings and makes system default DNS (“clearnet”)<br>
requests?</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/6</link>
        <pubDate>Mon, 21 May 2018 17:11:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-6</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p><code>tinyproxy</code> recently (Feb 2018) added SOCKS support (<a href="https://github.com/tinyproxy/tinyproxy/pull/64">https://github.com/tinyproxy/tinyproxy/pull/64</a>). Wonder if it’s possible to keep apt-get’s old uwt wrapper and just direct it to qubes-update-proxy?</p>
<p>(github question: how can I tell which version of tinyproxy contains that merge? it went into master but I don’t see any associated label, tag, release.) edit: nvm, there hasn’t been a release since Jan 2016.</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/5</link>
        <pubDate>Mon, 21 May 2018 01:30:01 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-5</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="7" data-topic="5236">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Do you have the dom0 settings?</p>
</blockquote>
</aside>
<p>I suspect this is not a Qubes or Whonix issue. It appears to be an apt-get DNS leak (by design?).</p>
<p>apt-get performs DNS lookup [using system resolver] for every repository entry (including http, onion, and even numeric IPs) [regardless of whether or not a proxy is configured for that particular host].</p>
<p>This may be expected behavior because Acquire::http::Proxy can be configured per host. Also, http may be proxied while other apt-transports are not. In these cases, it would be desirable to have local DNS resolution. It seems the only way to block DNS requests for our use case would be to establish complex rules.</p>
<p>This was not an issue in the past because uwt tunneled all apt-get traffic over SocksPort. Even now, users with Transparent DNS enabled will not notice - but seems rather sloppy behavior for core Whonix components to be polluting Transparent Ports.</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/4</link>
        <pubDate>Sun, 20 May 2018 19:43:26 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-4</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Btw mixing 13 and 14 will be unsupported.</p>
<p>entr0py:&gt; Finally getting back to testing here. I plan on reading<br>
through the <a href="https://forums.whonix.org/t/qubes-whonix-14-0-0-6-9-templatevms-for-r3-2-and-r4-testers-wanted/4988">Qubes-Whonix testing<br>
thread</a><br>
tomorrow, so my comment may have been addressed already.&gt;</p>
<blockquote>
<ol>
<li>Downloaded and cloned lastest whonix-gw-14 template manually on Qubes 3.2.</li>
<li>Attached template to existing sys-whonix-13 proxyVM.</li>
<li>Ran apt-get update.</li>
</ol>
<ul>
<li>Initial traffic is DROPPED by sys-whonix-13. LOG reveals destination IP: sys-whonix-13 &amp; port: 53</li>
<li>Eventually times out. apt-get then sends traffic to tinyproxy on 10.*.255.254:8082 and completes successfully</li>
</ul>
<p>Not sure why apt-get is requesting a standard DNS lookup when apt.conf.d/01qubes-proxy is configured to use tinyproxy.</p>
</blockquote>
<p>Do you have the dom0 settings?</p>
<ul>
<li><a href="https://www.whonix.org/wiki/Dev/Qubes#Qubes_R4">https://www.whonix.org/wiki/Dev/Qubes#Qubes_R4</a></li>
<li><a href="https://www.whonix.org/wiki/Dev/Qubes#anon-vm_tag">https://www.whonix.org/wiki/Dev/Qubes#anon-vm_tag</a></li>
</ul>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/3</link>
        <pubDate>Sat, 19 May 2018 07:15:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-3</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
      <item>
        <title>apt-get DNS Bypasses apt.conf Proxy Settings</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p>Finally getting back to testing here. I plan on reading through the <a href="https://forums.whonix.org/t/qubes-whonix-14-0-0-6-9-templatevms-for-r3-2-and-r4-testers-wanted/4988">Qubes-Whonix testing thread</a> tomorrow, so my comment may have been addressed already.</p>
<ol>
<li>Downloaded and cloned lastest whonix-gw-14 template manually on Qubes 3.2.</li>
<li>Attached template to existing sys-whonix-13 proxyVM.</li>
<li>Ran apt-get update.</li>
</ol>
<ul>
<li>Initial traffic is DROPPED by sys-whonix-13. LOG reveals destination IP: sys-whonix-13 &amp; port: 53</li>
<li>Eventually times out. apt-get then sends traffic to tinyproxy on 10.*.255.254:8082 and completes successfully</li>
</ul>
<p>Not sure why apt-get is requesting a standard DNS lookup when apt.conf.d/01qubes-proxy is configured to use tinyproxy.</p>
<p>(same is true for apt, per OP, as well as apt-get)</p>
<p>Forgot to mention: Port 53 dropped because Workstation Transparent DNS disabled on my Gateway. Do you have that set also <a class="mention" href="http://forums.whonix.org/u/kuruu">@kuruu</a>?</p>
          <p><a href="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256/2</link>
        <pubDate>Sat, 19 May 2018 03:52:33 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5256-2</guid>
        <source url="http://forums.whonix.org/t/apt-get-dns-bypasses-apt-conf-proxy-settings/5256.rss">apt-get DNS Bypasses apt.conf Proxy Settings</source>
      </item>
  </channel>
</rss>
