<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
    <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829</link>
    <description>On the topic of hardening your (host) and the danger of time leaks Whonix advises to disable TCP timestamps via kernel sysctl. I just did, my question is if this is useful and/or effective?

1) https://security.stackexchange.com/questions/111794/ros-and-cons-of-disabling-tcp-timestamps

Under the original question Aiuti Marble makes the following comment:

&gt; In modern Linux (i.e. Ubuntu 16, 18) changing the value of `net.ipv4.tcp_timestamps` has no effect. The documentation at kernel org doc Documentation networking [ip-sysctl.txt](https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt) is incorrect for modern kernels. 

Ajuti does not substantiate his claim by pointing to relevant sources, but ... is he right?

2) As I work with Ubuntu 18.04 as host, I found this in the [Ubuntu manual on sysctl(d)](https://manpages.ubuntu.com/manpages/xenial/man5/sysctl.d.5.html)
 
&gt; Many sysctl parameters only become available when certain kernel modules are loaded. Modules are usually loaded on demand, e.g. when certain hardware is plugged in or network brought up. This means that systemd-sysctl.service(8) which runs during early boot will not configure such parameters if they become available after it has run. To set such parameters, it is recommended to add an udev(7) rule to set those parameters when they become available. Alternatively, a slightly simpler and less efficient option is to add the module to modules-load.d(5), causing it to be loaded statically before sysctl settings are applied (see example below).

So we set the sysctl `net.ipv4.tcp_timestamps` parameter, but is it applied?? Maybe Whonix knows for sure this is the case, otherwise this feature should be tested by looking at TCP packets going out.</description>
    <language>en</language>
    <lastBuildDate>Mon, 19 Oct 2020 16:54:55 +0000</lastBuildDate>
    <category>Development</category>
    <atom:link href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Tails will re-enable TCP timestamps.</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://gitlab.tails.boum.org/uploads/-/system/appearance/favicon/1/gitlab.png" class="site-icon" width="16" height="16">
      <a href="https://gitlab.tails.boum.org/tails/tails/-/issues/17491#note_158371" target="_blank">GitLab</a>
  </header>
  <article class="onebox-body">
    <img src="https://gitlab.tails.boum.org/assets/gitlab_logo-7ae504fe4f68fdebb3c2034e36621930cd36ea87924c11ff65dbcb8ed50dca58.png" class="thumbnail onebox-avatar" width="128" height="128">

<h3><a href="https://gitlab.tails.boum.org/tails/tails/-/issues/17491#note_158371" target="_blank">Re-enable TCP timestamps (#17491) · Issues · tails / tails</a></h3>

<p>_Originally created by @cypherpunks on [#17491 (Redmine)](https://public-redmine-archive.tails.boum.org/code/issues/17491)_ TCP timestamps were initially disabled in Tails because they leaked the system time. Modern kernels now randomize the TCP...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/11">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/11</link>
        <pubDate>Mon, 19 Oct 2020 16:54:55 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-11</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[anontor]]></dc:creator>
        <description><![CDATA[
            <p>Regarding the sysctl -p; there were a couple things going on at the time with the system, as far as I was doing several things at once, so it is very possible that I simply forgot something or got distracted. In all other instances, as we know, a sysctl -p run as root/sudo privs will apply the settings right away.<br>
That snippet you posted is exactly what I was referring to! That page and ones linked from it have been very helpful in my study of networking.<br>
I have not tested the timestamp setting  in Whonix, mainly because you already did it and shared your results and also wireshark pulls in a ton of dependencies. It’s interesting that the setting does not seem to affect anything. So it seems that in Whonix, tcp timestamps are disabled by default. Perhaps it’s due to another setting somewhere in “security-misc” or somewhere else.<br>
Another good practice might be to disable timestamps on the host. I can speak for Virtualbox’s networking and say that everything that the virtual machine does is NAT’d to and processed by the host. I am not completely sure if disabling the setting on the host is necessary, but I do it anyway.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/10">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/10</link>
        <pubDate>Fri, 24 Jan 2020 16:29:30 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-10</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[rk1]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="http://forums.whonix.org/u/anontor">@anontor</a>:<br>
Your conclusions are not much different from mine, that is: you tested a non-Whonix system, setting and applying (via booting) the parameter net.ipv4.tcp_timestamps to 0 suppresses the timestamps, setting it to 1 inserts the timestamps in the TCP layer. That is what I found too (“Booted the host after setting the TCP timestamp parameter to 0. I only saw TCP traffic without these timestamps.”). But whereas you say that running the command ‘sysctl -p’ does not apply the setting, I saw that ‘sysctl -p’ did work.<br>
For the Whonix system (the guest OS run in KVM) I observed that setting and applying the parameter did not seem to matter, as either way (0 or 1) TCP traffic did not include the TCP timestamps.<br>
What you say in your last comment about inspecting the individual packets: that is how I did my testing.<br>
And just for info, this is how the timestamps look like (RFC 7323):<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/4/4f83ca47c36fbd48cd96ecf572e9b1d3452d5c5b.png" data-download-href="//forums.whonix.org/uploads/default/4f83ca47c36fbd48cd96ecf572e9b1d3452d5c5b" title="Selection_015.png"><img src="//forums.whonix.org/uploads/default/original/2X/4/4f83ca47c36fbd48cd96ecf572e9b1d3452d5c5b.png" alt="Selection_015" data-base62-sha1="blq4UJCZSUEP66HIEJigs7YdGC7" width="583" height="500" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/4/4f83ca47c36fbd48cd96ecf572e9b1d3452d5c5b_2_10x10.png"></a></div><p></p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/9</link>
        <pubDate>Fri, 24 Jan 2020 08:54:36 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-9</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[anontor]]></dc:creator>
        <description><![CDATA[
            <p>rk1, that’s interesting; since you already tried this on Whonix, here is what happened with non-Whonix (Debian 10, full updated etc, but completely vanilla–no security mods or anything. Just how it would be if you installed a fresh system. I did this in a virtual machine using the latest Debian iso from their site. Then I tested on an Ubuntu 18.04 host with the same results. The Ubuntu is heavily modified, security hardened etc)<br>
Here are my observations:<br>
Okay, this is my accepted conclusion. Originally, I had forgotten to reboot the system and the sysctl setting net.ipv4.tcp_timestamps= did not apply. Interesting that sudo sysctl -p did not apply it. Maybe I could have restarted networking service also? Anyway, here is how I proceed:<br>
Wireshark has a setting filter: tcp.options.timestamp.tsval which will show the timestamp values for the packets in the capture. With the live capture running and the sysctl setting for net.ipv4.tcp_timestamps= set to ‘0’ there was nothing to see, totally blank after the filter was applied. Then setting the sysctl value to ‘1’ and reboot and re-test of the filter value showed a full list of timestamps for the tcp packets. (Wireshark has a couple different ways to view time-related data. Go to View and then Time Display Format to toggle the different values.) So it appears that in Debian 10 and Ubuntu 18.04, the sysctl tcp timestamp setting is fully functional.<br>
Normally, AFAIK, the tcp-timestamp is a total of 10 bytes. 4 bytes sent, 4 bytes ACK’d and then 2 bytes I do not know what they are for. One could analyze the individual packets to see if this 10 bytes was included in the payload header. I have not done this, but it probably would not be too hard to do. The presence of this 4byte + 4byte + 1byte +1byte would indicate tcp timestamp. The absence would indicate no timestamp. This could be another way to test.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/8</link>
        <pubDate>Thu, 23 Jan 2020 17:52:47 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-8</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[rk1]]></dc:creator>
        <description><![CDATA[
            <p>Booted the host after setting the TCP timestamp parameter to 0. I only saw TCP traffic without these timestamps. For Whonix traffic the setting does not matter it seems. Even when the timestamp parameter is set to 1, I did not see the timestamps.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/7</link>
        <pubDate>Thu, 23 Jan 2020 15:11:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-7</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[anontor]]></dc:creator>
        <description><![CDATA[
            <p>I am a little late to the conversation, but I can verify what has been said here.<br>
Ubuntu 18.04 with various kernels from 4.15 to 5.3 are used daily. This sysctl parameter I have had implemented for a long time (at least as long as it became  relevant in Whonix with security-misc). Systemd-sysctl is a service that runs at boot and is active before sysinit.target. Right after systemd-modules load finishes, systemd-sysctl runs and applies everything in sysctl.conf according to the service file (and verified from a syslog search).<br>
Also, as mentioned, Wireshark can show you this information in real time capture, or as a pcap that you can view later. Conclusion is that the parameter is applied.<br>
For the setting to be effective, remember to disable systemd-timesyncd, and also ntp if you use that. Or use sdwdate on a torified system. Ideally set machine time to UTC as well.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/6</link>
        <pubDate>Thu, 23 Jan 2020 02:06:39 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-6</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[rk1]]></dc:creator>
        <description><![CDATA[
            <p>True. I can see (in Wireshark) that manually setting and applying the parameter (i.e. setting it to 0) does have the effect of suppressing TCP timestamps. Tomorrow I will see if the setting does get applied automatically when booting the system.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/5</link>
        <pubDate>Wed, 22 Jan 2020 21:34:02 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-5</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="1" data-topic="8829">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/r/9f8e36/40.png" class="avatar"> rk1:</div>
<blockquote>
<p>So we set the sysctl <code>net.ipv4.tcp_timestamps</code> parameter, but is it applied??</p>
</blockquote>
</aside>
<p>Wireshark logs should answer the question.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/4</link>
        <pubDate>Wed, 22 Jan 2020 19:40:49 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-4</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[madaidan]]></dc:creator>
        <description><![CDATA[
            <p>TCP timestamps are not part of a kernel module. Neither are any of the other sysctl settings we change.</p>
<p>Changing <code>net.ipv4.tcp_timestamps</code> does have effect. This is easily verified with something like nmap.</p>
<p>You can also verify the sysctl settings are correctly applied by running e.g. <code>sysctl net.ipv4.tcp_timestamps</code> and look for the correct value which in this case is <code>0</code>.</p>
<p>I still am skeptical of the claim that disabling TCP timestamps improves anonymity though as newer kernel versions randomize the offset for each connection, making time attacks impossible unless something messes up in the randomization <a href="https://github.com/torvalds/linux/commit/95a22caee396cef0bb2ca8fafdd82966a49367bb">https://github.com/torvalds/linux/commit/95a22caee396cef0bb2ca8fafdd82966a49367bb</a></p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/3</link>
        <pubDate>Wed, 22 Jan 2020 17:09:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-3</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Interesting line of thought. Thanks for bringing that up!</p>
<p>Applying sysctl setting already from inside initramfs was recently implemented.</p>
<ul>
<li><a href="https://github.com/Whonix/security-misc/pull/53">https://github.com/Whonix/security-misc/pull/53</a></li>
<li><a href="https://github.com/Whonix/security-misc/pull/55">https://github.com/Whonix/security-misc/pull/55</a></li>
</ul>
<p>But this might not help against what you are raising.</p>
<p>I don’t think we will be able to investigate this soon.  “Fortunately”, this is a general security question as also your link to <a href="https://security.stackexchange.com/questions/111794/pros-and-cons-of-disabling-tcp-timestamps">https://security.stackexchange.com/questions/111794/pros-and-cons-of-disabling-tcp-timestamps</a> indicates. The scope of this issue by far transcends Whonix. Meaning, it doesn’t need to necessarily wait until anyone from the small resourceful Whonix team can investigate this.</p>
<p>Could you please try to resolve this as per <a href="https://www.whonix.org/wiki/Free_Support_Principle">free support principle</a>.</p>
<p>Potential recipients:</p>
<ul>
<li><a href="https://security.stackexchange.com">https://security.stackexchange.com</a></li>
<li>other security related discussion places</li>
<li>
<a href="https://lists.freedesktop.org/mailman/listinfo/systemd-devel">systemd-devel mailing list</a> or <a href="https://github.com/systemd/systemd/issues">systemd issues</a> - “Dynamic module load can result in sysctl settings not being applied?”</li>
<li>
<a href="https://bugzilla.kernel.org/">kernel bug report</a> / kernel mailing list</li>
</ul>
<p>Please post any references here.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/2</link>
        <pubDate>Wed, 22 Jan 2020 12:06:26 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-2</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
      <item>
        <title>System hardening &amp; Time attacks &amp; TCP timestamps=0</title>
        <dc:creator><![CDATA[rk1]]></dc:creator>
        <description><![CDATA[
            <p>On the topic of hardening your (host) and the danger of time leaks Whonix advises to disable TCP timestamps via kernel sysctl. I just did, my question is if this is useful and/or effective?</p>
<ol>
<li><a href="https://security.stackexchange.com/questions/111794/ros-and-cons-of-disabling-tcp-timestamps" rel="nofollow noopener">https://security.stackexchange.com/questions/111794/ros-and-cons-of-disabling-tcp-timestamps</a></li>
</ol>
<p>Under the original question Aiuti Marble makes the following comment:</p>
<blockquote>
<p>In modern Linux (i.e. Ubuntu 16, 18) changing the value of <code>net.ipv4.tcp_timestamps</code> has no effect. The documentation at kernel org doc Documentation networking <a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" rel="nofollow noopener">ip-sysctl.txt</a> is incorrect for modern kernels.</p>
</blockquote>
<p>Ajuti does not substantiate his claim by pointing to relevant sources, but … is he right?</p>
<ol start="2">
<li>As I work with Ubuntu 18.04 as host, I found this in the <a href="https://manpages.ubuntu.com/manpages/xenial/man5/sysctl.d.5.html" rel="nofollow noopener">Ubuntu manual on sysctl(d)</a>
</li>
</ol>
<blockquote>
<p>Many sysctl parameters only become available when certain kernel modules are loaded. Modules are usually loaded on demand, e.g. when certain hardware is plugged in or network brought up. This means that systemd-sysctl.service(8) which runs during early boot will not configure such parameters if they become available after it has run. To set such parameters, it is recommended to add an udev(7) rule to set those parameters when they become available. Alternatively, a slightly simpler and less efficient option is to add the module to modules-load.d(5), causing it to be loaded statically before sysctl settings are applied (see example below).</p>
</blockquote>
<p>So we set the sysctl <code>net.ipv4.tcp_timestamps</code> parameter, but is it applied?? Maybe Whonix knows for sure this is the case, otherwise this feature should be tested by looking at TCP packets going out.</p>
          <p><a href="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829/1</link>
        <pubDate>Wed, 22 Jan 2020 11:35:36 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8829-1</guid>
        <source url="http://forums.whonix.org/t/system-hardening-time-attacks-tcp-timestamps-0/8829.rss">System hardening &amp; Time attacks &amp; TCP timestamps=0</source>
      </item>
  </channel>
</rss>
