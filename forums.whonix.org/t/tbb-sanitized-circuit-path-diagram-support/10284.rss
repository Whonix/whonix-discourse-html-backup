<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>TBB Sanitized Circuit Path Diagram Support</title>
    <link>http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284</link>
    <description>This is now done. I&#39;ve tested it and it works for clearnet and onion service sites, the circuit path  diagram shows without any sensitive info. TBB&#39;s Authenticated Service login prompt now shows. A quick look at the onion-grater debug logs doesn&#39;t show anything dangerous slipping thru, but I will need you to also double check this is the case.

Let me know if you want this committed as a separate profile or merged into the default one.

I noticed:
* The TBB environment variable that disables the circuit path thingie doesn&#39;t work in practice - it will show when the controlport communicates the needed commands in all cases.

*  The `confs` `bridge` command is needed for this to work, but I don&#39;t know exactly what it can allow.</description>
    <language>en</language>
    <lastBuildDate>Fri, 18 Sep 2020 10:05:07 +0000</lastBuildDate>
    <category>Development</category>
    <atom:link href="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>TBB Sanitized Circuit Path Diagram Support</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-username="HulaHoop" data-post="4" data-topic="10284">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p><code>        - replacement: '250+circuit-status='</code></p>
</blockquote>
</aside>
<p>Maybe the <code>+</code> is considered a special character and should be escaped as <code>\+</code>?</p>
<aside class="quote no-group" data-username="HulaHoop" data-post="4" data-topic="10284">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>My guess is it doesn’t like the relay names because the “$”’ part is breaking it somehow.</p>
</blockquote>
</aside>
<p>That is hopefully only considered text and not processed as pattern by onion-grater.</p>
          <p><a href="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/5</link>
        <pubDate>Fri, 18 Sep 2020 10:05:07 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10284-5</guid>
        <source url="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284.rss">TBB Sanitized Circuit Path Diagram Support</source>
      </item>
      <item>
        <title>TBB Sanitized Circuit Path Diagram Support</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>Latest working version of the 40_ tor-browser.yml I am using. It takes effect after running <code>sudo ln -s /usr/share/doc/onion-grater-merger/examples/40_tor-browser.yml /usr/local/etc/onion-grater-merger.d/</code><br>
The WIP section for <code>circuit-status</code> and related onion-grater debug output is posted below it.</p>
<pre><code>---
- exe-paths:
    - '*'
  users:
    - '*'
  hosts:
    - '*'
  commands:
    SIGNAL:
      - 'NEWNYM'
    GETINFO:
      - 'circuit-status'
    GETCONF:
      - pattern: 'bridge'
        response:
        - pattern:     '250-Bridge=(.+) (\S+) (\S+) (\S+) (\S+)'
          replacement: '250-Bridge='
        - pattern:     '250 Bridge=(.+) (\S+) (\S+) (\S+) (\S+)'
          replacement: '250 Bridge='
  events:
    STREAM:
  restrict-stream-events: true
</code></pre>
<hr>
<pre><code>   GETINFO:
      - pattern: 'circuit-status'
        response:
        - pattern: '250(.+)circuit-status=(\S+) (\S+) (.+) (\S+) (\S+)'
        - replacement: '250+circuit-status='
</code></pre>
<p>The onion-grater debug mode:</p>
<pre><code> host onion-grater[8471]:   - pattern: circuit-status
 host onion-grater[8471]:     response:
 host onion-grater[8471]:     - {pattern: 250(.+)circuit-status=(\S+) (\S+) (.+) (\S+) (\S+)}
 host onion-grater[8471]:     - {replacement: 250+circuit-status=}
 host onion-grater[8471]:   SIGNAL:
 host onion-grater[8471]:   - {pattern: NEWNYM}
 host onion-grater[8471]: events:
 host onion-grater[8471]:   CONF_CHANGED: {suppress: true}
 host onion-grater[8471]:   SIGNAL: {suppress: true}
 host onion-grater[8471]:   STATUS_SERVER: {suppress: true}
 host onion-grater[8471]:   STREAM: {}
 host onion-grater[8471]: restrict-stream-events: false
 host onion-grater[8471]: 10.152.152.11:56158 (filter: 30_autogenerated): -&gt; getinfo circuit-status
 host onion-grater[8471]: 10.152.152.11:56158 (filter: 30_autogenerated) disconnected: client quit
 host onion-grater[8471]: ----------------------------------------
 host onion-grater[8471]: Exception happened during processing of request from ('10.152.152.11', 56158)
 host onion-grater[8471]: Traceback (most recent call last):
 host onion-grater[8471]:   File "/usr/lib/python3.7/socketserver.py", line 650, in process_request_thread
 host onion-grater[8471]:     self.finish_request(request, client_address)
 host onion-grater[8471]:   File "/usr/lib/python3.7/socketserver.py", line 360, in finish_request
 host onion-grater[8471]:     self.RequestHandlerClass(request, client_address, self)
 host onion-grater[8471]:   File "/usr/lib/python3.7/socketserver.py", line 720, in __init__
 host onion-grater[8471]:     self.handle()
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 661, in handle
 host onion-grater[8471]:     session.handle()
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 481, in handle
 host onion-grater[8471]:     response_rewriter=response_rewriter)
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 277, in proxy_line
 host onion-grater[8471]:     new_response = response_rewriter(response)
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 462, in _response_rewriter
 host onion-grater[8471]:     lines)
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 314, in rewrite_matched_lines
 host onion-grater[8471]:     for line in split_lines]) + "\r\n"
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 314, in &lt;listcomp&gt;
 host onion-grater[8471]:     for line in split_lines]) + "\r\n"
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 307, in rewrite_matched_line
 host onion-grater[8471]:     return self.rewrite_line(replacers, line)
 host onion-grater[8471]:   File "/usr/lib/onion-grater", line 298, in rewrite_line
 host onion-grater[8471]:     match = re.match(r['pattern'] + "$", line)
 host onion-grater[8471]: KeyError: 'pattern'
 host onion-grater[8471]: ----------------------------------------
</code></pre>
<p>i want to know what the error means so I can work around it.<br>
My guess is it doesn’t like the relay names because the “$”’ part is breaking it somehow. Or maybe something to do with newlines?</p>
          <p><a href="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/4</link>
        <pubDate>Thu, 17 Sep 2020 20:48:23 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10284-4</guid>
        <source url="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284.rss">TBB Sanitized Circuit Path Diagram Support</source>
      </item>
      <item>
        <title>TBB Sanitized Circuit Path Diagram Support</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>Took some effort but got <code>getconf bridge</code> working. Replying just <code>250 Bridge</code> doesn’t cut it. I had to feed it a redacted reply.</p>
<p>The remaining  command I have to clean up to make safe is <code>getinfo circuit-status</code>. It is required so we can’t block it, however it passes all the info about a circuit path fully. The replies have varying lengths and so require a bunch of rules with varying capture group numbers to account for all possible patterns.</p>
<p>There are two problems with the whitelist rule I have right now:</p>
<p>Doing a regex on<br>
250+circuit-status is problematic because + is also interpreted as a special character if not escaped. I tried escaping pattern and reply as well as just the normal pattern, but that doesn’t work. There could also be problems with white-spaces.</p>
<p>Example raw output:</p>
<pre><code>250+circuit-status=00 BUILT Z~Z,Z~Z,Z~Z BUILD_FLAGS=NEED_CAPACITY PURPOSE=GENERAL TIME_CREATED=2020-09-16T00:00:00.000000
</code></pre>
<p>Example pattern rule checked on <a href="http://pythex.org">pythex.org</a>:</p>
<p><code>250\+circuit-status=(\S+) BUILT (\S+) (\S+) (\S+) (\S+)</code></p>
<p>What I am using as a replacement:</p>
<p><code>250+circuit-status=redacted</code></p>
<hr>
<p>The <code>650 STREAM</code> events seem to be about the destination IP only and don’t reveal anything about circuits.</p>
          <p><a href="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/3</link>
        <pubDate>Wed, 16 Sep 2020 22:40:19 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10284-3</guid>
        <source url="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284.rss">TBB Sanitized Circuit Path Diagram Support</source>
      </item>
      <item>
        <title>TBB Sanitized Circuit Path Diagram Support</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Awesome!</p>
<aside class="quote no-group" data-username="HulaHoop" data-post="1" data-topic="10284">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>The <code>confs</code> <code>bridge</code> command is needed for this to work, but I don’t know exactly what it can allow.</p>
</blockquote>
</aside>
<p>Redacted example if using bridges.</p>
<pre><code>GETCONF bridge
</code></pre>
<blockquote>
<p>250-Bridge=obfs4 xxx.xxx.xxx.xxx:xxx yyy cert=xxx iat-mode=1</p>
</blockquote>
<p>Multiple lines. One line for each bridge. That surely should be redacted.</p>
<p>Non-redacted example when not using bridges.</p>
<pre><code>GETCONF bridge
</code></pre>
<blockquote>
<p>250 Bridge</p>
</blockquote>
<p>Therefore when Tor Browser asks <code>GETCONF bridge</code> it would be best to make onion-grater reply <code>250 Bridge</code> whether using bridges or not?</p>
<p>Btw not in this case but generally often <a href="https://gitweb.torproject.org/torspec.git/tree/control-spec.txt">https://gitweb.torproject.org/torspec.git/tree/control-spec.txt</a> helps.</p>
<aside class="quote no-group" data-username="HulaHoop" data-post="1" data-topic="10284">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>Let me know if you want this committed as a separate profile or merged into the default one.</p>
</blockquote>
</aside>
<p>Default one as we don’t want to confuse Tor Browser. By using this widely, we’ll be ready for for any upcoming Tor Browser control protocol demands.</p>
          <p><a href="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/2</link>
        <pubDate>Wed, 16 Sep 2020 08:39:44 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10284-2</guid>
        <source url="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284.rss">TBB Sanitized Circuit Path Diagram Support</source>
      </item>
      <item>
        <title>TBB Sanitized Circuit Path Diagram Support</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>This is now done. I’ve tested it and it works for clearnet and onion service sites, the circuit path  diagram shows without any sensitive info. TBB’s Authenticated Service login prompt now shows. A quick look at the onion-grater debug logs doesn’t show anything dangerous slipping thru, but I will need you to also double check this is the case.</p>
<p>Let me know if you want this committed as a separate profile or merged into the default one.</p>
<p>I noticed:</p>
<ul>
<li>
<p>The TBB environment variable that disables the circuit path thingie doesn’t work in practice - it will show when the controlport communicates the needed commands in all cases.</p>
</li>
<li>
<p>The <code>confs</code> <code>bridge</code> command is needed for this to work, but I don’t know exactly what it can allow.</p>
</li>
</ul>
          <p><a href="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284/1</link>
        <pubDate>Tue, 15 Sep 2020 21:58:52 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10284-1</guid>
        <source url="http://forums.whonix.org/t/tbb-sanitized-circuit-path-diagram-support/10284.rss">TBB Sanitized Circuit Path Diagram Support</source>
      </item>
  </channel>
</rss>
