<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>kernel recompilation for better hardening - #292 by Patrick - Development - Whonix Forum</title>
    <meta name="description" content="https://docs.clip-os.org/clipos/kernel.html 


These both look interesting. They’re mainly for kernel compile options though. 
Is there any way to build Whonix with custom kernel configurations? Or will kernels have to b&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../75985760.html?page=15" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../../c/news/21.html">NEWS</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;kernel recompilation for better hardening&#39;" href="../7598.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/292" />
<meta name="twitter:url" content="https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/292" />
<meta property="og:title" content="kernel recompilation for better hardening" />
<meta name="twitter:title" content="kernel recompilation for better hardening" />
<meta property="og:description" content="I have a vision now how to implement this.  Installation through dpkg isn’t great anyhow? That doesn’t handle version upgrades. For example if someone installed a 5.x kernel from backports, this package would still force dpkg install a hardened 4.x kernel for no reason. By using APT, we’d never attempt a downgrade / install a lower versioned kernel.  dpkg also doesn’t well handle dependencies. If there ever was a conflicting dependency, dpkg would wreck APT (broken dependencies) which then requi..." />
<meta name="twitter:description" content="I have a vision now how to implement this.  Installation through dpkg isn’t great anyhow? That doesn’t handle version upgrades. For example if someone installed a 5.x kernel from backports, this package would still force dpkg install a hardened 4.x kernel for no reason. By using APT, we’d never attempt a downgrade / install a lower versioned kernel.  dpkg also doesn’t well handle dependencies. If there ever was a conflicting dependency, dpkg would wreck APT (broken dependencies) which then requi..." />
<meta property="article:published_time" content="2020-01-18T19:36:38+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="prev" href="../7598a7f1.html?page=14">
        <link rel="next" href="../759842a7.html?page=16">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../../index.html">
          <img src="../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="../7598.html">kernel recompilation for better hardening</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../../external.html?link=http://schema.org/ListItem">
            <a href="../../../c/development/8.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../../tag/component_security.html' class='discourse-tag' rel="tag">component_security</a>, 
            <a href='../../../tag/status_open_issue_todo.html' class='discourse-tag' rel="tag">status_open_issue_todo</a>
        </div>
      </div>
  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T11:05:44Z' class='post-time'>
                January 18, 2020, 11:05am
              </time>
              <meta itemprop='dateModified' content='2020-01-18T11:05:44Z'>
          <span itemprop='position'>#287</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>madaidan via Whonix Forum:</p>
<blockquote>
<p><a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/31">https://github.com/Whonix/hardened-kernel/pull/31</a></p>
</blockquote>
<p>Merged.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>
          <meta itemprop='keywords' content='component_security, status_open_issue_todo'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T18:25:19Z' class='post-time'>
                January 18, 2020,  6:25pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T18:25:19Z'>
          <span itemprop='position'>#288</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/32" target="_blank">github.com/Whonix/hardened-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/32" target="_blank">Disable notifier error injection</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:error_injection</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2020-01-18" data-time="18:25:04" data-timezone="UTC">06:25PM - 18 Jan 20 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="3 commits changed 3 files with 8 additions and 9 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/32/files" target="_blank">
          <span class="added">+8</span>
          <span class="removed">-9</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T18:31:46Z' class='post-time'>
                January 18, 2020,  6:31pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T18:31:46Z'>
          <span itemprop='position'>#289</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="158" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>That is about <code>/sys/kernel/debug</code> folder? Perhaps better to restrict that through security-misc (permission hardening) and/or apparmor-profile-everything? Why? Maybe same as this very post: <a href="139.html">kernel recompilation for better hardening</a></p>
</blockquote>
</aside>
<p>What if we disable debugfs in the kernel but enable it in our new debugging kernel config?</p>
<p>Not every user of this config will be using apparmor-profile-everything so I think we should do as much reasonable kernel hardening as possible regardless of apparmor. Any lost debugging functionality can easily be re-enabled with the <code>--debug</code> flag if the user needs it.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T18:41:40Z' class='post-time'>
                January 18, 2020,  6:41pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T18:41:40Z'>
          <span itemprop='position'>#290</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/33" target="_blank">github.com/Whonix/hardened-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/33" target="_blank">Enable sanity checks in virtual to page code</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:debug_virtual</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2020-01-18" data-time="18:41:17" data-timezone="UTC">06:41PM - 18 Jan 20 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="2 commits changed 2 files with 4 additions and 2 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/33/files" target="_blank">
          <span class="added">+4</span>
          <span class="removed">-2</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T19:07:16Z' class='post-time'>
                January 18, 2020,  7:07pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T19:07:16Z'>
          <span itemprop='position'>#291</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p><a class="mention" href="../../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a> Would it be possible to make the CI actually test booting the kernel via e.g. kexec?</p>
<pre><code>kexec -l "/boot/vmlinuz-${version}" --append="root=$(grep -w '/' /proc/mounts | awk '{print $1}')" --initrd="/boot/initrd.img-${version}"
kexec -e
</code></pre>
<p>We can also test our custom boot parameters via the <code>--append</code> flag.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T19:36:38Z' class='post-time'>
                January 18, 2020,  7:36pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T19:36:38Z'>
          <span itemprop='position'>#292</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I have a vision now how to implement this.</p>
<p>Installation through dpkg isn’t great anyhow? That doesn’t handle version upgrades. For example if someone installed a 5.x kernel from backports, this package would still force dpkg install a hardened 4.x kernel for no reason. By using APT, we’d never attempt a downgrade / install a lower versioned kernel.</p>
<p>dpkg also doesn’t well handle dependencies. If there ever was a conflicting dependency, dpkg would wreck APT (broken dependencies) which then requires manual commands to resolve. APT often warns against such situations, with the option to abort etc. Also dpkg does not properly call triggers such as DKMS?</p>
<p>How this could be implemented…</p>
<p>Terminology:</p>
<ul>
<li>real APT: (non-Whonix, non-Kicksecure, plain Debian APT. Just the normal APT that any Debian user is using.)</li>
<li>wrapped APT (wapt): a wrapper that stacks various plugins such as rapt or hdapt</li>
<li>restricted APT (rapt): as per apparmor-profile-everything</li>
<li>hdapt: runs usual real apt dist-upgarde, apt update, apt-dist upgrade again</li>
</ul>
<p>Most of these scripts can be implemented standalone without much thought about the other scripts.</p>
<p>When APT runs, some script could call the compilation script. And then create a local APT repository. That local APT repository would then be used with APT for proper processing of dependencies and triggers.</p>
<p><code>/etc/apt/sources.list.d/hardened-kernel-local.list</code>:</p>
<pre><code>deb [trusted=yes] file:/path/to/local/repository local main contrib non-free
</code></pre>
<p>similar to <a href="../../../../external.html?link=https://github.com/Whonix/Whonix/blob/master/help-steps/create-local-temp-apt-repo">https://github.com/Whonix/Whonix/blob/master/help-steps/create-local-temp-apt-repo</a></p>
<p>User runs apt (or apt-get). What actually happens (without need to tell the user) (fully auditable in source code or by reading the files on the disk), that rapt (restricted APT) is executed - only if that is installed. It then passes on to hdapt (hardened kernel APT). Doing a usual real apt dist-upgrade. hdapt would then run “apt update” again to load the local APT repository which contains the hardened kernel and run real apt dist-upgrade again.</p>
<p>with apparmor-profile-everything:</p>
<blockquote>
<p>wapt -&gt; rapt -&gt; hdapt -&gt; real apt update -&gt; real apt dist-upgrade -&gt; real apt update -&gt; real apt dist-upgrade</p>
</blockquote>
<p>without apparmor-profile-everything:</p>
<blockquote>
<p>wapt -&gt; hdapt -&gt; real apt update -&gt; real apt dist-upgrade -&gt; real apt update -&gt; real apt dist-upgrade</p>
</blockquote>
<hr>
<p>From user perspective:</p>
<ul>
<li>user runs <code>sudo apt update</code>: just only that happens as per usual</li>
<li>user runs <code>sudo apt dist-upgrade</code>: usual <code>sudo apt dist-upgrade</code> happens + <code>sudo apt update</code> (fetching local APT repository with hardened kernel only) -&gt; another <code>sudo apt --yes dist-upgrade</code> is performed</li>
</ul>
<p>(Fetching local (from hard drive) APT repository will take just 1 second or so.)</p>
<p>Same in other words:</p>
<ul>
<li>user runs <code>sudo apt update</code>: just only that happens as per usual</li>
<li>user runs <code>sudo apt dist-upgrade</code>: usual <code>sudo apt dist-upgrade</code> happens -&gt; maybe hardened-kernel package is upgraded, compiles a new kernel, updates the local APT repository -&gt; + maybe <code>sudo apt update</code> (fetching local APT repository with hardened kernel only) -&gt; maybe another <code>sudo apt --yes dist-upgrade</code> is performed</li>
</ul>
<p>maybe meaning: only if necessary (hardened-kernel package was upgraded).</p>
<hr>
<p>Another layer of complexity that I haven’t mentioned yet: uwt stream isolation wrapper. Also something wrapped apt has to handle.</p>
<hr>
<p>Just an idea yet. Dunno how it will look when implemented. Seems kinda complex. And messing that up would break APT. Users could still always run <code>apt-get.anondist-orig</code> (real apt).</p>
<p>And all this trouble for what? So users can keep typing what they’re accustomed to: apt or apt-get</p>
<p>Maybe rather than taking on that complexity with wrapped apt, we should rather have a <a href="../../do-not-show-this-message-again-generic-one-time-popup/8066.html">one time popup</a> teaching users to use hdapt from now?</p>
<p><code>hdapt</code> and <code>hdapt-get</code>? Or only 1? I guess not much of extra work for both.</p>
<hr>
<p>Maybe better to finish developing the concept of stackable wrappers first before implementing this?</p>
<ul>
<li><a href="../../../../external.html?link=https://github.com/Whonix/proposals/blob/master/634-stackable-wrappers.txt">https://github.com/Whonix/proposals/blob/master/634-stackable-wrappers.txt</a></li>
<li><a href="../../../../external.html?link=https://phabricator.whonix.org/T634">https://phabricator.whonix.org/T634</a></li>
</ul>
<hr>
<p>What do we do with Whonix default redistributed (downloadable) builds in future? Pre-compile a hardened kernel and then re-compile it at first boot? Or just install Debian default kernel and compile a hardened kernel at first boot before going online for the first time?</p>
<p>An interesting option would also be to compile both, a non-debug and a debug kernel during the build process. Install both. Boot non-debug kernel by default. Debug kernel could be booted by choosing it in grub boot menu. Would waste some disk space and increase VM image size though.</p>
<p>madaidan via Whonix Forum:</p>
<blockquote>
<aside class="quote no-group" data-post="158" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>That is about <code>/sys/kernel/debug</code> folder? Perhaps better to restrict that through security-misc (permission hardening) and/or apparmor-profile-everything? Why? Maybe same as this very post: <a href="139.html">kernel recompilation for better hardening</a></p>
</blockquote>
</aside>
<p>What if we disable debugfs in the kernel but enable it in our new debugging kernel config?</p>
<p>Not every user of this config will be using apparmor-profile-everything so I think we should do as much reasonable kernel hardening as possible regardless of apparmor. Any lost debugging functionality can easily be re-enabled with the <code>--debug</code> flag if the user needs it.</p>
</blockquote>
<p>Agreed. Debug kernel is required anyhow. And hardened-kernel might be sooner to go through completion, calling for testers, installed by default. Also more likely to be used by others than apparmor-profile-everything.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="5" />
          </div>

            <div class='crawler-linkback-list' itemscope itemtype='../../../../external.html?link=http://schema.org/ItemList'>
                  <div itemprop='itemListElement' itemscope itemtype='../../../../external.html?link=http://schema.org/ListItem'>
                    <a href="../../whonix-kvm-kicksecure-15-0-0-8-7-released-a-qunatum-leap-forward/8921.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='../../whonix-kvm-kicksecure-15-0-0-8-7-released-a-qunatum-leap-forward/8921.html'>
                      <span itemprop='name'>Whonix KVM / Kicksecure 15.0.0.8.7 Released! - A Qunatum Leap Forward</span>
                    </a>
                    <meta itemprop='position' content='5'>
                  </div>
                  <div itemprop='itemListElement' itemscope itemtype='../../../../external.html?link=http://schema.org/ListItem'>
                    <a href="../../whonix-virtualbox-15-0-0-8-7-testers-wanted-vanguards-tcp-isn-leak-protection-extensive-hardening/8914.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='../../whonix-virtualbox-15-0-0-8-7-testers-wanted-vanguards-tcp-isn-leak-protection-extensive-hardening/8914.html'>
                      <span itemprop='name'>Whonix VirtualBox 15.0.0.8.7 - Testers Wanted! - vanguards; TCP ISN Leak Protection; Extensive Hardening! 🔥</span>
                    </a>
                    <meta itemprop='position' content='6'>
                  </div>
                  <div itemprop='itemListElement' itemscope itemtype='../../../../external.html?link=http://schema.org/ListItem'>
                    <a href="../../whonix-virtualbox-15-0-0-8-9-point-release-vanguards-tcp-isn-leak-protection-extensive-hardening/8994.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='../../whonix-virtualbox-15-0-0-8-9-point-release-vanguards-tcp-isn-leak-protection-extensive-hardening/8994.html'>
                      <span itemprop='name'>Whonix VirtualBox 15.0.0.8.9 - Point Release! - vanguards; TCP ISN Leak Protection; Extensive Hardening! 🔥</span>
                    </a>
                    <meta itemprop='position' content='7'>
                  </div>
            </div>
      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T20:01:39Z' class='post-time'>
                January 18, 2020,  8:01pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T20:01:39Z'>
          <span itemprop='position'>#293</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Instead of the complexity of all those wrappers, maybe we could just use a bash alias?</p>
<pre><code>alias apt="hdapt"
alias apt-get="hdapt"
</code></pre>
<p>rapt runs <code>apt</code> which if hardened-kernel is being used would be an alias of <code>hdapt</code>. If not using hardened-kernel, it would be real <code>apt</code>.</p>
<p>We instruct users to use <code>rapt</code> when using apparmor-profile-everything and just <code>apt</code> when not.</p>
<p>Using ordinary apt can be done by running <code>/usr/bin/apt</code>.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-18T23:00:24Z' class='post-time'>
                January 18, 2020, 11:00pm
              </time>
              <meta itemprop='dateModified' content='2020-01-18T23:00:24Z'>
          <span itemprop='position'>#294</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Since lockdown is not in our kernel version, I can create a patchset to implement some of its features in our kernel if you want.</p>
<p>I won’t implement the ones we’ve already mitigated with our config though as that’d be pointless so there won’t be too many changes.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T00:52:36Z' class='post-time'>
                January 19, 2020, 12:52am
              </time>
              <meta itemprop='dateModified' content='2020-01-19T00:52:36Z'>
          <span itemprop='position'>#295</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Did that.</p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/tree/lockdown/usr/share/hardened-kernel/patches/lockdown">https://github.com/madaidan/hardened-kernel/tree/lockdown/usr/share/hardened-kernel/patches/lockdown</a></p>
<p>The only one missing is the acpi_rsdp patch as that one is more complicated (it requires some reworking of the early boot code).</p>
<p>This isn’t for inclusion in linux-hardened as they’ll prefer the official lockdown LSM and these patches only complement our config (things such as <code>LOCKDOWN_KPROBES</code> would be needed for linux-hardened but not us).</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T09:52:40Z' class='post-time'>
                January 19, 2020,  9:52am
              </time>
              <meta itemprop='dateModified' content='2020-01-19T09:52:40Z'>
          <span itemprop='position'>#296</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>madaidan via Whonix Forum:</p>
<blockquote>
<p><a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/32">https://github.com/Whonix/hardened-kernel/pull/32</a></p>
</blockquote>
<blockquote>
<p><a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/33">https://github.com/Whonix/hardened-kernel/pull/33</a></p>
</blockquote>
<p>Merged.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T13:52:41Z' class='post-time'>
                January 19, 2020,  1:52pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T13:52:41Z'>
          <span itemprop='position'>#297</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>madaidan via Whonix Forum:</p>
<blockquote>
<p><a class="mention" href="../../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a> Would it be possible to make the CI actually test booting the kernel via e.g. kexec?</p>
</blockquote>
<p>I would love to have this.</p>
<aside class="quote no-group" data-post="219" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Ideally we would could also automate on the CI booting the kernel in<br>
VirtualBox, KVM, Qubes and see where it is functional and where it is<br>
broken but that might be a pipe dream. Although<br>
<a href="../../../../external.html?link=https://criu.org/Continuous_integration#Kernel_testing">https://criu.org/Continuous_integration#Kernel_testing</a> is using kexec<br>
but that seems hard to re-use and that would reboot test only KVM (which<br>
would still be awesome for start) (because Travis CI is based on KVM as<br>
<code>virt-what</code> says). Travis CI also supports artifacts (and any<br>
scripting). Build results could be send elsewhere (another cloud<br>
service) for further automated testing, i.e. (kexec) kernel boot.</p>
</blockquote>
</aside>
<p>Not only I would love to kexec boot the kernel but also run an <a href="../../automated-test-suite/5942.html">automated test suite</a>.</p>
<p>I don’t know if it is possible on travis CI. The current CI is rather<br>
complex, hacky. Travis CI is based on Ubuntu. VM based. Dunno if kexec<br>
would be supported there. The actual kernel build happens inside a<br>
docker ( <a href="../../../../external.html?link=http://travis.debian.net/">http://travis.debian.net/</a> ). Dunno if that docker could be<br>
restarted with the newly built kernel either.</p>
<p>Also do we really have to invent this? Doesn’t <a href="../../../../external.html?link=http://kernel.org/">kernel.org</a> already have<br>
automated testing / fuzzing on CI servers somewhere that we can re-use?</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/HulaHoop'><span itemprop='name'>HulaHoop</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T15:19:32Z' class='post-time'>
                January 19, 2020,  3:19pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T15:19:32Z'>
          <span itemprop='position'>#298</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Maybe rather than taking on that complexity with wrapped apt, we should rather have a <a href="../../do-not-show-this-message-again-generic-one-time-popup/8066.html">one time popup</a> teaching users to use hdapt from now?</p>
</blockquote>
</aside>
<p>Absolutely.</p>
<p>Also I think this would make things easier to manage in case a user installs a regular unsecure kernel for hardware compatibility reasons?</p>
<aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p><code>hdapt</code> and <code>hdapt-get</code> ? Or only 1? I guess not much of extra work for both.</p>
</blockquote>
</aside>
<p>Both to keep it in-line with user expectation and future extensibility. Think hapt-get  purge. apt invokes a general man page, apt-get is one specific function of many.</p>
<aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Maybe better to finish developing the concept of stackable wrappers first before implementing this?</p>
</blockquote>
</aside>
<p>Unnecessary. I’d consider it a working design document that describes what scope you implemented as you go along.</p>
<aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>What do we do with Whonix default redistributed (downloadable) builds in future? Pre-compile a hardened kernel and then re-compile it at first boot? Or just install Debian default kernel and compile a hardened kernel at first boot before going online for the first time?</p>
</blockquote>
</aside>
<p>On my end I’m prepared to precompile binaries for distribution from our repos. I don’t know the feasibility of harnessing the reproducible build structure currently, but it should be a priority  for user safety.</p>
<aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>An interesting option would also be to compile both, a non-debug and a debug kernel during the build process. Install both. Boot non-debug kernel by default. Debug kernel could be booted by choosing it in grub boot menu. Would waste some disk space and increase VM image size though.</p>
</blockquote>
</aside>
<p>Debian has a dedicated debug kernel version so I think that’s the way to instead of either compromising th production version or making it undebuggable at all because of hardening.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T15:41:05Z' class='post-time'>
                January 19, 2020,  3:41pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T15:41:05Z'>
          <span itemprop='position'>#299</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="298" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>Debian has a dedicated debug kernel version so I think that’s the way to instead of either compromising th production version or making it undebuggable at all because of hardening.</p>
</blockquote>
</aside>
<p>We already have a separate kernel config for debugging.</p>
<p><a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/blob/master/usr/share/hardened-kernel/debugging-config">https://github.com/Whonix/hardened-kernel/blob/master/usr/share/hardened-kernel/debugging-config</a></p>
<p>This is added onto the hardened config if the <code>--debug</code> flag is used during build.</p>
<p>Installing both by default would just be a usability feature.</p>
<p>Unrelated:</p>
<aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/34" target="_blank">github.com/Whonix/hardened-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/34" target="_blank">Disable debugfs</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:disable_debugfs</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2020-01-19" data-time="15:32:45" data-timezone="UTC">03:32PM - 19 Jan 20 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="5 commits changed 5 files with 40 additions and 53 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/34/files" target="_blank">
          <span class="added">+40</span>
          <span class="removed">-53</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T19:18:50Z' class='post-time'>
                January 19, 2020,  7:18pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T19:18:50Z'>
          <span itemprop='position'>#300</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I finished my lockdown patches.</p>
<aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/35" target="_blank">github.com/Whonix/hardened-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/35" target="_blank">Implement lockdown patches</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:lockdown</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2020-01-19" data-time="19:02:05" data-timezone="UTC">07:02PM - 19 Jan 20 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="10 commits changed 12 files with 407 additions and 0 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-kernel/pull/35/files" target="_blank">
          <span class="added">+407</span>
          <span class="removed">-0</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>The acpi_rdsp patch was actually not needed since it’s only an issue with CONFIG_KEXEC enabled which we disable.</p>
<p>It creates a  CONFIG_SECURITY_LOCKDOWN option which when enabled locks down various ways userspace can escalate to kernel mode.</p>
<p>It cannot be disabled at runtime and the kernel_lockdown variable is marked read-only.</p>
<p>I’ve tested this and it works.</p>
<p>You can test that certain features are locked down. For example, you can use this to test if iopl() is locked down <a href="../../../../external.html?link=https://paste.debian.net/hidden/2dc2044f/">https://paste.debian.net/hidden/2dc2044f/</a></p>
<pre><code class="lang-auto">user@host:~$ sudo ./iopl 
iopl: Operation not permitted
user@host:~$
</code></pre>
<p>We should now have prevented every way userspace can escalate to kernel mode, excluding vulnerabilities and modules (which we’ll eventually solve).</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T20:02:21Z' class='post-time'>
                January 19, 2020,  8:02pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T20:02:21Z'>
          <span itemprop='position'>#301</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>madaidan via Whonix Forum:</p>
<blockquote>
<p>Since lockdown is not in our kernel version, I can create a patchset to implement some of its features in our kernel if you want.</p>
</blockquote>
<p>For quality control reasons and due to my very limited C programming<br>
language skills (let alone kernel development) I need an independent<br>
review of these patches. One option would be to get them merged in<br>
another project with that capacity first for them to sign-off on so we<br>
can go forward on this. Not sure if any is suited such as ClipOS or similar.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T20:53:31Z' class='post-time'>
                January 19, 2020,  8:53pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T20:53:31Z'>
          <span itemprop='position'>#302</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="301" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>For quality control reasons and due to my very limited C programming language skills (let alone kernel development) I need an independent review of these patches.</p>
</blockquote>
</aside>
<p>Compare them to the upstream code.</p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0002-lockdown-efivar_ssdt_load.patch">0002-lockdown-efivar_ssdt_load.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1201">https://lkml.org/lkml/2019/8/19/1201</a></p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0003-lockdown-pci-bar-access.patch">0003-lockdown-pci-bar-access.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1207">https://lkml.org/lkml/2019/8/19/1207</a></p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0004-lockdown-perf.patch">0004-lockdown-perf.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1208">https://lkml.org/lkml/2019/8/19/1208</a></p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0005-lockdown-tiocsserial.patch">0005-lockdown-tiocsserial.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1209">https://lkml.org/lkml/2019/8/19/1209</a></p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0006-lockdown-ioport.patch">0006-lockdown-ioport.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1211">https://lkml.org/lkml/2019/8/19/1211</a></p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0007-lockdown-pcmcia.patch">0007-lockdown-pcmcia.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1215">https://lkml.org/lkml/2019/8/19/1215</a></p>
<p><a href="../../../../external.html?link=https://github.com/madaidan/hardened-kernel/blob/lockdown/usr/share/hardened-kernel/patches/lockdown/0008-lockdown-module-params.patch">0008-lockdown-module-params.patch</a> -&gt; <a href="../../../../external.html?link=https://lkml.org/lkml/2019/8/19/1222">https://lkml.org/lkml/2019/8/19/1222</a></p>
<p>They’re all very similar. They’re mostly just simple if statements and exits. You can see they do the same even with limited C skills.</p>
<p>The perf lockdown patch is slightly different as my patch locks down perf entirely instead of just <code>PERF_SAMPLE_REGS_INTR</code> as more bad things can be done with perf such as kernel address leaking with <code>PERF_SAMPLE_IP</code> <a href="../../../../external.html?link=https://blog.lizzie.io/kaslr-and-perf.html">https://blog.lizzie.io/kaslr-and-perf.html</a></p>
<aside class="quote no-group" data-post="301" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>One option would be to get them merged in another project with that capacity first for them to sign-off on so we can go forward on this. Not sure if any is suited such as ClipOS or similar.</p>
</blockquote>
</aside>
<p>I’m not aware of any other project these patches would make sense in due to the reasons above.</p>
<blockquote>
<p>This isn’t for inclusion in linux-hardened as they’ll prefer the official lockdown LSM and these patches only complement our config (things such as <code>LOCKDOWN_KPROBES</code> would be needed for linux-hardened but not us).</p>
</blockquote>
<p>ClipOS uses the official lockdown LSM so these patches don’t make sense for them.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-19T22:32:03Z' class='post-time'>
                January 19, 2020, 10:32pm
              </time>
              <meta itemprop='dateModified' content='2020-01-19T22:32:03Z'>
          <span itemprop='position'>#303</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Agreed. Debug kernel is required anyhow. And hardened-kernel might be sooner to go through completion, calling for testers, installed by default. Also more likely to be used by others than apparmor-profile-everything.</p>
</blockquote>
</aside>
<p>Should we also disable coredumps and enable them in the debug kernel?</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-20T08:23:44Z' class='post-time'>
                January 20, 2020,  8:23am
              </time>
              <meta itemprop='dateModified' content='2020-01-20T08:23:44Z'>
          <span itemprop='position'>#304</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>madaidan via Whonix Forum:</p>
<blockquote>
<aside class="quote no-group" data-post="301" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>For quality control reasons and due to my very limited C programming language skills (let alone kernel development) I need an independent review of these patches.</p>
</blockquote>
</aside>
<p>Compare them to the upstream code.</p>
</blockquote>
<p>I can’t even do that. For all of Whonix’s source code, for any reviewers<br>
reporting any security issues or asking any reasonable questions, I can<br>
can handle that. For kernel code, I could not even fix minor things.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-20T08:42:28Z' class='post-time'>
                January 20, 2020,  8:42am
              </time>
              <meta itemprop='dateModified' content='2020-01-20T08:42:28Z'>
          <span itemprop='position'>#305</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>For simplicity, I think Whonix redistributed (downloadable) versions<br>
could come with Debian standard stable kernel by default. This would<br>
also serve as “debug” kernel. I.e. those VMs that can’t boot with the<br>
hardened kernel can at least boot with the Debian kernel. During the<br>
first boot, the hardened kernel could be compiled and installed<br>
automatically before any networking goes up and before the user can do<br>
anything except cancel compilation of the kernel.</p>
<p>Not much of an enhancement to do same as above but ship with a hardened<br>
kernel which layout is public knowledge (redistributed, downloadable,<br>
public build) anyhow. Related to<br>
<aside class="quote quote-modified" data-post="1" data-topic="8599">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar">
    <a href="../../hide-kernel-symbols-for-better-security-vs-reproducible-builds/8599.html">Hide Kernel Symbols for Better Security vs Reproducible Builds</a> <a class="badge-wrapper  bullet" href="../../../c/development/8.html"><span class="badge-category-bg" style="background-color: #25AAE2;"></span><span style="" data-drop-close="true" class="badge-category clear-badge" title="Hacking on the Whonix software and code. (devs) (list of unmaintained components)">Development</span></a>
  </div>
  <blockquote>
    Quote: 



If you say Y here, getting information on loaded modules, and 
displaying all kernel symbols through a syscall will be restricted 
to users with CAP_SYS_MODULE.  For software compatibility reasons, 
/proc/kallsyms will be restricted to the root user.  The RBAC 
system can hide that entry even from root. 
This option also prevents leaking of kernel addresses through 
several /proc entries. 
Note that this option is only effective provided the following 
conditions are met: 

The kernel…
  </blockquote>
</aside>
</p>
<p>madaidan via Whonix Forum:</p>
<blockquote>
<aside class="quote no-group" data-post="292" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Agreed. Debug kernel is required anyhow. And hardened-kernel might be sooner to go through completion, calling for testers, installed by default. Also more likely to be used by others than apparmor-profile-everything.</p>
</blockquote>
</aside>
<p>Should we also disable coredumps and enable them in the debug kernel?</p>
</blockquote>
<p>I guess yes. Debugging in hardened-kernel (non-debug) isn’t possible now<br>
anymore?</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2020-01-20T09:34:31Z' class='post-time'>
                January 20, 2020,  9:34am
              </time>
              <meta itemprop='dateModified' content='2020-01-20T09:34:31Z'>
          <span itemprop='position'>#306</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Patrick via Whonix Forum:</p>
<blockquote>
<p>[1] For simplicity, I think Whonix redistributed (downloadable) versions<br>
could come with Debian standard stable kernel by default. This would<br>
also serve as “debug” kernel. I.e. those VMs that can’t boot with the<br>
hardened kernel can at least boot with the Debian kernel. During the<br>
first boot, the hardened kernel could be compiled and installed<br>
automatically before any networking goes up and before the user can do<br>
anything except cancel compilation of the kernel.</p>
<p>[2] Not much of an enhancement to do same as above but ship with a hardened<br>
kernel which layout is public knowledge (redistributed, downloadable,<br>
public build) anyhow. Related to<br>
<a href="../../hide-kernel-symbols-for-better-security-vs-reproducible-builds/8599.html" class="inline-onebox">Hide Kernel Symbols for Better Security vs Reproducible Builds</a></p>
</blockquote>
<p>This also simplifies reproducible builds since it doesn’t introduce new<br>
non-determinism. Our hardened kernel uses all available randomization<br>
security options. Disabling these for redistributed (downloadable)<br>
versions would add even more complexity. [1] is enough.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><a rel="prev" itemprop="url" href="../7598a7f1.html?page=14">← previous page</a></span>
        <span itemprop='name'><b><a rel="next" itemprop="url" href="../759842a7.html?page=16">next page →</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
