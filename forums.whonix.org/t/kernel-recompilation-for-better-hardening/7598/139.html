<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>kernel recompilation for better hardening - #139 by Patrick - Development - Whonix Forum</title>
    <meta name="description" content="https://docs.clip-os.org/clipos/kernel.html 


These both look interesting. They’re mainly for kernel compile options though. 
Is there any way to build Whonix with custom kernel configurations? Or will kernels have to b&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../7598235c.html?page=7" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../../c/news/21.html">NEWS</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;kernel recompilation for better hardening&#39;" href="../7598.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/139" />
<meta name="twitter:url" content="https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/139" />
<meta property="og:title" content="kernel recompilation for better hardening" />
<meta name="twitter:title" content="kernel recompilation for better hardening" />
<meta property="og:description" content="Things are difficult already. Very difficult.  I know people with university degrees, and engineering working in technology but not information technology. These are as much as that’s possible, “certified intelligent”. Yet, these are incapable to use any Linux desktop distribution. Let alone Whonix. Whonix is operating in a geek sphere. Yet, I don’t want to make it too difficult to make even more geeks give up.  It is my goal to follow the principle of least astonishment.  Disabling debugging ca..." />
<meta name="twitter:description" content="Things are difficult already. Very difficult.  I know people with university degrees, and engineering working in technology but not information technology. These are as much as that’s possible, “certified intelligent”. Yet, these are incapable to use any Linux desktop distribution. Let alone Whonix. Whonix is operating in a geek sphere. Yet, I don’t want to make it too difficult to make even more geeks give up.  It is my goal to follow the principle of least astonishment.  Disabling debugging ca..." />
<meta property="article:published_time" content="2019-12-12T19:44:25+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="prev" href="../7598c575.html?page=6">
        <link rel="next" href="../7598fdfa.html?page=8">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../../index.html">
          <img src="../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="../7598.html">kernel recompilation for better hardening</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../../external.html?link=http://schema.org/ListItem">
            <a href="../../../c/development/8.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../../tag/component_security.html' class='discourse-tag' rel="tag">component_security</a>, 
            <a href='../../../tag/status_open_issue_todo.html' class='discourse-tag' rel="tag">status_open_issue_todo</a>
        </div>
      </div>
  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T17:15:21Z' class='post-time'>
                December 12, 2019,  5:15pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T17:15:21Z'>
          <span itemprop='position'>#134</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="133" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>It also disables CONFIG_PREEMPT. What’s the rationale of that?</p>
</blockquote>
</aside>
<p>It was disabled with <code>make</code> so it probably depended on something that was disabled.</p>
<aside class="quote no-group" data-post="133" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>But why is it useful to disable it in the kernel?</p>
</blockquote>
</aside>
<p>A core dump can contain a copy of everything in kernel memory. That will contain tons of sensitive information.</p>
<aside class="quote no-group" data-post="133" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Doesn’t security-misc already turn off all sorts of core dumps?</p>
</blockquote>
</aside>
<p>An attacker with root can enable them again to get kernel secrets.</p>
<aside class="quote no-group" data-post="133" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Why force the default?</p>
</blockquote>
</aside>
<p>There’s not really any harm in enabling it by default.</p>
<aside class="quote no-group" data-post="133" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Reason: could make debugging harder.</p>
</blockquote>
</aside>
<p>How?</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>
          <meta itemprop='keywords' content='component_security, status_open_issue_todo'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T17:30:32Z' class='post-time'>
                December 12, 2019,  5:30pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T17:30:32Z'>
          <span itemprop='position'>#135</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Should <code>CONFIG_PROC_PAGE_MONITOR</code> be disabled?</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/torvalds/linux/blob/master/fs/proc/Kconfig#L83" target="_blank">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="../../../../external.html?link=https://github.com/torvalds/linux/blob/master/fs/proc/Kconfig#L83" target="_blank">torvalds/linux/blob/master/fs/proc/Kconfig#L83</a></h4>
<pre class="onebox"><code class="lang-"><ol class="start lines" start="73" style="counter-reset: li-counter 72 ;">
<li>	  interface is through /proc/sys.  If you say Y here a tree of</li>
<li>	  modifiable sysctl entries will be generated beneath the</li>
<li>	  /proc/sys directory. They are explained in the files</li>
<li>	  in &lt;file:Documentation/admin-guide/sysctl/&gt;.  Note that enabling this</li>
<li>	  option will enlarge the kernel by at least 8 KB.</li>
<li>
</li>
<li>	  As it is generally a good thing, you should say Y here unless</li>
<li>	  building a kernel for install/rescue disks or your system is very</li>
<li>	  limited in memory.</li>
<li>
</li>
<li class="selected">config PROC_PAGE_MONITOR</li>
<li> 	default y</li>
<li>	depends on PROC_FS &amp;&amp; MMU</li>
<li>	bool "Enable /proc page monitoring" if EXPERT</li>
<li> 	help</li>
<li>	  Various /proc files exist to monitor process memory utilization:</li>
<li>	  /proc/pid/smaps, /proc/pid/clear_refs, /proc/pid/pagemap,</li>
<li>	  /proc/kpagecount, and /proc/kpageflags. Disabling these</li>
<li>	  interfaces will reduce the size of the kernel by approximately 4kb.</li>
<li>
</li>
<li>config PROC_CHILDREN</li>
</ol></code></pre>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<blockquote>
<p>Various /proc files exist to monitor process memory utilization:<br>
/proc/pid/smaps, /proc/pid/clear_refs, /proc/pid/pagemap,<br>
/proc/kpagecount, and /proc/kpageflags. Disabling these<br>
interfaces will reduce the size of the kernel by approximately 4kb.</p>
</blockquote>
<p>It was called “brain-dead” and a security risk by grsecurty.</p>
<p>It was also used in exploiting rowhammer to gain kernel privileges.</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../../external.html?link=https://googleprojectzero.blogspot.com/favicon.ico" class="site-icon" width="16" height="16">
      <a href="../../../../external.html?link=https://googleprojectzero.blogspot.com/2015/03/exploiting-dram-rowhammer-bug-to-gain.html" target="_blank">googleprojectzero.blogspot.com</a>
  </header>
  <article class="onebox-body">
    <img src="#" class="thumbnail">

<h3><a href="../../../../external.html?link=https://googleprojectzero.blogspot.com/2015/03/exploiting-dram-rowhammer-bug-to-gain.html" target="_blank">Exploiting the DRAM rowhammer bug to gain kernel privileges</a></h3>

<p>Rowhammer blog post (draft)         Posted by Mark Seaborn, sandbox builder and breaker, with contributions by Thomas Dullien, reverse en...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/HulaHoop'><span itemprop='name'>HulaHoop</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T18:33:02Z' class='post-time'>
                December 12, 2019,  6:33pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T18:33:02Z'>
          <span itemprop='position'>#136</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="133" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>CONFIG_PREEMPT</p>
</blockquote>
</aside>
<p>This is necessary for realtime kernel patches to work</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T18:43:39Z' class='post-time'>
                December 12, 2019,  6:43pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T18:43:39Z'>
          <span itemprop='position'>#137</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="134" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>An attacker with root can enable them again to get kernel secrets.</p>
</blockquote>
</aside>
<p>Then let’s use apparmor-profile-everything to block write access to these (<code>/etc/sysctl.d</code> and <code>sysctl</code> and whatnot) to prevent root from enabling core dumps. That reaches the same goal but doesn’t worsen debugging.</p>
<aside class="quote no-group quote-modified" data-post="134" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<blockquote>
<p>Reason: could make debugging harder.</p>
</blockquote>
<p>How?</p>
</blockquote>
</aside>
<p>If there’s an issue now, and someone wants to debug it, we can say “use root, re-enable core dumps”, done.</p>
<p>If there’s an issue when apparmor-profile-everything is default, and someone wants to debug it, we can say “use superroot, re-enable core dumps”, done.</p>
<p>But if core dumps are disabled in kernel and once apparmor-profile-everything is default and someone wants to debug it, we don’t have a good answer. “Need superroot. And need to re-compile your kernel.” We’d need a debug kernel and a regular kernel. But issues producible with the regular kernel may not happen with the debug kernel. So if not needed, let’s not destroy debugging.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T18:51:24Z' class='post-time'>
                December 12, 2019,  6:51pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T18:51:24Z'>
          <span itemprop='position'>#138</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="136" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>This is necessary for realtime kernel patches to work</p>
</blockquote>
</aside>
<p>Those are disabled anyway.</p>
<aside class="quote no-group" data-post="137" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>But if core dumps are disabled in kernel and once apparmor-profile-everything is default and someone wants to debug it, we don’t have a good answer. “Need superroot. And need to re-compile your kernel.” We’d need a debug kernel and a regular kernel. But issues producible with the regular kernel may not happen with the debug kernel. So if not needed, let’s not destroy debugging.</p>
</blockquote>
</aside>
<p>The same could be said for nearly every other security feature.</p>
<p>Why enable kptr_restrict or dmesg_restrict since they interfere with debugging?</p>
<p>Why remove System.map?</p>
<p>Why not give total, unrestricted access to /proc and /sys?</p>
<p>So many debugging features open up security holes. Some need to be sacrificed.</p>
<p>Besides, the chances an end user is going to need to look at core dumps on a stable kernel is very unlikely. Those are only really needed for developers testing stuff.</p>
<p>Recompiling the kernel isn’t that big of a deal due to hardened-vm-kernel (once it’s finished). We could even have a second package that allows users to add their own custom configurations and still being easy to use.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T19:44:25Z' class='post-time'>
                December 12, 2019,  7:44pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T19:44:25Z'>
          <span itemprop='position'>#139</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Things are difficult already. Very difficult.<br>
I know people with university degrees, and engineering working in technology but not information technology. These are as much as that’s possible, “certified intelligent”. Yet, these are incapable to use any Linux desktop distribution. Let alone Whonix. Whonix is operating in a geek sphere. Yet, I don’t want to make it too difficult to make even more geeks give up.</p>
<p>It is my goal to follow the <a href="../../../../external.html?link=https://en.wikipedia.org/wiki/Principle_of_least_astonishment">principle of least astonishment</a>.</p>
<p>Disabling debugging can be a bad surprise already. But it’s justified for a security focused distribution. And it can be undo in one step by using root. And in future, it can be undone by using superroot. But disabling these settings and then also removing it from the kernel… That’s two times for the same thing. Even someone who managed to re-enable the debugging sysctl settings (using superroot) could still not debug.</p>
<p>It is also my goal to stay reasonable. I am expecting upcoming discussions. Using reasonable time effort to answer reasonable questions.</p>
<blockquote>
<p>Why did you disable core dumps in sysctl settings?</p>
</blockquote>
<blockquote>
<blockquote>
<p>Because, see <a href="../../../../external.html?link=https://www.whonix.org/wiki/Core_Dumps">https://www.whonix.org/wiki/Core_Dumps</a></p>
</blockquote>
</blockquote>
<blockquote>
<p>Alright, but why don’t you let even root change these settings, it’s blocked by apparmor-profile-everything?</p>
</blockquote>
<blockquote>
<blockquote>
<p>Because we’re implementing <a href="../../untrusted-root-improve-security-by-restricting-root/7998.html" class="inline-onebox">Untrusted Root - improve Security by Restricting Root</a> too.</p>
</blockquote>
</blockquote>
<blockquote>
<p>Alright, I see why core dumps are disabled by default and re-enabling requires superroot. I used superroot to enable core dumps. Why I still can’t get coredumps?</p>
</blockquote>
<blockquote>
<blockquote>
<p>We disabled core dumps in kernel too. You need to recompile your kernel.</p>
</blockquote>
</blockquote>
<blockquote>
<p>Kernel recompilation is pushing it. <img src="../../../images/emoji/twitter/confusedc164.png?v=9" title=":confused:" class="emoji" alt=":confused:"> Why did you disable coredumps in kernel too if you already disabled the sysctl and blocked root from re-enalbing it using apparmor-profile-everything?</p>
</blockquote>
<blockquote>
<blockquote>
<p><img src="../../../images/emoji/twitter/thinkingc164.png?v=9" title=":thinking:" class="emoji" alt=":thinking:"> That one I don’t know. <img src="../../../images/emoji/twitter/thinkingc164.png?v=9" title=":thinking:" class="emoji" alt=":thinking:"></p>
</blockquote>
</blockquote>
<p>The last answer isn’t reasonable. There needs to be a good answer for that.</p>
<p>Quite a lengthy potentially upcoming discussion. (Can often be shortened by writing documentation.) But super lengthy and complex already. I’d like to avoid layers of complexity if avoidable.</p>
<aside class="quote no-group" data-post="138" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Why enable kptr_restrict or dmesg_restrict since they interfere with debugging?</p>
<p>Why remove System.map?</p>
<p>Why not give total, unrestricted access to /proc and /sys?</p>
<p>So many debugging features open up security holes. Some need to be sacrificed.</p>
</blockquote>
</aside>
<p>Yes but these are all easily undone in 1 step. Either with root or superoot. Disabling them has a reasonable justification and the process of re-enabling is reasonable too. Kernel recompilation is an extra step on top which isn’t well justified yet. Piling up unjustified things makes the project harder to maintain. Also I don’t want to push the level of complexity to a stage where I myself start to forget things and not see through anymore.</p>
<aside class="quote no-group" data-post="138" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Besides, the chances an end user is going to need to look at core dumps on a stable kernel is very unlikely. Those are only really needed for developers testing stuff.</p>
</blockquote>
</aside>
<p>Slim, few people, but these can be very important people. I specifically don’t want to needlessly annoy super geeks too much. If there’s a great rationale for requiring a rain dance they might forgive, but I don’t want to be unreasonable.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-12T20:03:32Z' class='post-time'>
                December 12, 2019,  8:03pm
              </time>
              <meta itemprop='dateModified' content='2019-12-12T20:03:32Z'>
          <span itemprop='position'>#140</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Alright. Good point. I’ve now re-enabled coredumps <a href="../../../../external.html?link=https://github.com/madaidan/hardened-vm-kernel/commit/e6b8c4b4049fe2d98aba8f4de866718106f68a79">https://github.com/madaidan/hardened-vm-kernel/commit/e6b8c4b4049fe2d98aba8f4de866718106f68a79</a></p>
<p>I still don’t think coredumps will ever be needed for the average user and “super geeks” would probably be able to re-compile the kernel.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-16T20:02:15Z' class='post-time'>
                December 16, 2019,  8:02pm
              </time>
              <meta itemprop='dateModified' content='2019-12-16T20:02:15Z'>
          <span itemprop='position'>#141</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/10" target="_blank">github.com/Whonix/hardened-vm-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/10" target="_blank">More hardening</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:hardening</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2019-12-16" data-time="19:59:55" data-timezone="UTC">07:59PM - 16 Dec 19 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="1 commits changed 1 files with 6 additions and 10 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/10/files" target="_blank">
          <span class="added">+6</span>
          <span class="removed">-10</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>I don’t know why <code>make</code> keeps shifting around preempt stuff. Probably just dependency weirdness.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-17T17:06:46Z' class='post-time'>
                December 17, 2019,  5:06pm
              </time>
              <meta itemprop='dateModified' content='2019-12-17T17:06:46Z'>
          <span itemprop='position'>#142</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Could you enable <code>GCC_PLUGIN_RANDSTRUCT</code> please?</p>
<p>(related: <a href="../../hide-kernel-symbols-for-better-security-vs-reproducible-builds/8599/9.html" class="inline-onebox">Hide Kernel Symbols for Better Security vs Reproducible Builds</a>)</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

            <div class='crawler-linkback-list' itemscope itemtype='../../../../external.html?link=http://schema.org/ItemList'>
                  <div itemprop='itemListElement' itemscope itemtype='../../../../external.html?link=http://schema.org/ListItem'>
                    <a href="../../hide-kernel-symbols-for-better-security-vs-reproducible-builds/8599/10.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='../../hide-kernel-symbols-for-better-security-vs-reproducible-builds/8599/10.html'>
                      <span itemprop='name'>Hide Kernel Symbols for Better Security vs Reproducible Builds</span>
                    </a>
                    <meta itemprop='position' content='2'>
                  </div>
            </div>
      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-17T17:13:26Z' class='post-time'>
                December 17, 2019,  5:13pm
              </time>
              <meta itemprop='dateModified' content='2019-12-17T17:13:26Z'>
          <span itemprop='position'>#143</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Randstruct isn’t supported by Debian yet unless we use backports.</p>
<p>It also comes with a large performance drop but there is a <code>RANDSTRUCT_PERFORMANCE</code> option which has worse security but better performance.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T13:52:04Z' class='post-time'>
                December 18, 2019,  1:52pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T13:52:04Z'>
          <span itemprop='position'>#144</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Ignoring the apt during apt issue [1], I would like to make progress making this accessible to users. Currently we have no script / automation / documentation / awareness.</p>
<p>How to solve the following…?</p>
<pre><code>~/kernel/linux-source-4.19 $ make deb-pkg
  LEX     scripts/kconfig/zconf.lex.c
  HOSTCC  scripts/kconfig/zconf.tab.o
  HOSTLD  scripts/kconfig/conf
scripts/kconfig/conf  --syncconfig Kconfig
***
*** Configuration file ".config" not found!
***
*** Please run some configurator (e.g. "make oldconfig" or
*** "make menuconfig" or "make xconfig").
***
make[2]: *** [scripts/kconfig/Makefile:69: syncconfig] Error 1
make[1]: *** [Makefile:533: syncconfig] Error 2
Makefile:620: include/config/auto.conf.cmd: No such file or directory
make: *** [Makefile:632: include/config/auto.conf.cmd] Error 2
</code></pre>
<p>What’s the solution to make this non-interactive (no user terminal input required)?</p>
<p><code>make defconfig</code>?</p>
<aside class="quote no-group" data-post="143" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Randstruct isn’t supported by Debian yet unless we use backports.</p>
</blockquote>
</aside>
<p>Needs kernel source or gcc from backports? kernel source might be quite doable. I don’t think that would cause any conflicts. Otherwise mixing with backports could lead to issues. Not a great default choice for a distribution default.</p>
<p>But even gcc from backports would not be a blocker. I could script the following:<br>
set up a chroot (based on buster, buster-backports, or whatever) and build the kernel inside the chroot. Perhaps even using <code>cowbuilder</code>.</p>
<p>If we want to create something amazing here, we might have to bite the bullet using backports, chroot, whatnot. Needless to say, ideally we could use linux-hardened.</p>
<p>To solve [1] (apt during apt) we might introduce a wrapper or teach users to use a tool other than apt if they want a hardened kernel. (More and more wrappers. Stream isolation (uwt), rapt (restricted APT) and now kernel upgrade.)</p>
<p>To make some progress I’ve added the build script.</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/blob/master/build" target="_blank">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/blob/master/build" target="_blank">Whonix/hardened-vm-kernel/blob/master/build</a></h4>
<pre><code class="lang-">#!/bin/bash

## Copyright (C) 2019 - 2019 ENCRYPTED SUPPORT LP &lt;adrelanos@riseup.net&gt;
## See the file COPYING for copying conditions.

set -x

set -e

## TODO: This probably has to be converted to debian/control 'Depends:'.
sudo apt-get --no-install-recommends --yes install linux-source build-essential libssl-dev libncurses-dev fakeroot libelf-dev bison flex

## TODO: Probably better using mktemp?
working_folder=~/kernel

source_folder="${working_folder}/linux-source-${version}/"

## TODO: Wipe existing working_folder?

## TODO: working_folder permissions
</code></pre>

  This file has been truncated. <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/blob/master/build" target="_blank">show original</a>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Could you try it please? It is still primitive. But it can be improved over time. Soon I can do the proper packaging. Install <code>build</code> to <code>/usr/bin/hardened-kernel-build</code>? Then this pacakge could be added to repository and users could manually run <code>/usr/bin/hardened-kernel-build</code>. Next step would be <code>/usr/bin/hardened-kernel-install-and-build</code>? Not a good name. And after this got more usable, the last step would be sorting out [1].</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="3" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T15:41:29Z' class='post-time'>
                December 18, 2019,  3:41pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T15:41:29Z'>
          <span itemprop='position'>#145</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="144" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>How to solve the following…?</p>
</blockquote>
</aside>
<p>Save <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/blob/master/usr/share/hardened-vm-kernel/kernel-config">https://github.com/Whonix/hardened-vm-kernel/blob/master/usr/share/hardened-vm-kernel/kernel-config</a> as file <code>.config</code> in the directory containing the kernel source.</p>
<aside class="quote no-group" data-post="144" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Needs kernel source or gcc from backports?</p>
</blockquote>
</aside>
<p>Probably both. Need to test.</p>
<aside class="quote no-group" data-post="144" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I could script the following:<br>
set up a chroot (based on buster, buster-backports, or whatever) and build the kernel inside the chroot. Perhaps even using <code>cowbuilder</code> .</p>
</blockquote>
</aside>
<p>Sounds like a good idea.</p>
<aside class="quote no-group" data-post="144" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>To make some progress I’ve added the build script.</p>
</blockquote>
</aside>
<p>You should change</p>
<pre><code>cp usr/share/hardened-vm-kernel/kernel-config "$source_folder"
</code></pre>
<p>to</p>
<pre><code>cp usr/share/hardened-vm-kernel/kernel-config "$source_folder/.config"
</code></pre>
<p>Instead of using pushd and popd, you can use tar’s <code>-C</code> option, patch’s <code>-d</code> option and make’s <code>-C</code> option.</p>
<p>e.g.</p>
<pre><code>tar -xaf "/usr/src/linux-source-${version}.tar.xz" -C "$working_folder"

xzcat "/usr/src/linux-patch-${version}-rt.patch.xz" | patch -p1 -d "$source_folder"

make deb-pkg -C "$source_folder"
</code></pre>
<p><code>make defconfig</code> isn’t needed if the full config is already at <code>.config</code>.</p>
<p>You should use <code>make deb-pkg -j $(nproc)</code> so the compilation uses all available cores to speed up.</p>
<p>We might also want to use patch’s <code>-s</code> option to hide output unless it’s an error.</p>
<aside class="quote no-group" data-post="144" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Then this pacakge could be added to repository and users could manually run <code>/usr/bin/hardened-kernel-build</code> .</p>
</blockquote>
</aside>
<p>Users don’t need to manually run that. That can be done during package installation. Actually installing the kernel is the only problem.</p>
<p>To get rid of this problem entirely, we can replace <code>make deb-pkg</code> with just <code>make</code> and sort out the kernel images and bootloader configuration ourselves without needing to use the .debs.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T17:12:32Z' class='post-time'>
                December 18, 2019,  5:12pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T17:12:32Z'>
          <span itemprop='position'>#146</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/11" target="_blank">github.com/Whonix/hardened-vm-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/11" target="_blank">Disable debugfs</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:debugfs</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2019-12-18" data-time="17:08:53" data-timezone="UTC">05:08PM - 18 Dec 19 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="1 commits changed 1 files with 2 additions and 23 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/11/files" target="_blank">
          <span class="added">+2</span>
          <span class="removed">-23</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T19:45:26Z' class='post-time'>
                December 18, 2019,  7:45pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T19:45:26Z'>
          <span itemprop='position'>#147</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="144" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Needs kernel source or gcc from backports?</p>
</blockquote>
</aside>
<p>We don’t need the kernel source from backports. <code>scripts/gcc-plugins/randomize_layout_plugin.c</code> exists in the stable debian kernel sources.</p>
<p>Looking at the commit, the minimum gcc version is supposed to be 4.7 and debian’s is 8.3 so we should be able to use randstruct.</p>
<p>Searching <code>make menuconfig</code>, the randstruct option does exist but for some reason, it isn’t showing up in the menu or when grepping the config file.</p>
<p>These plugins might be hidden behind another config option we have to enable first.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T19:54:18Z' class='post-time'>
                December 18, 2019,  7:54pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T19:54:18Z'>
          <span itemprop='position'>#148</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Found the problem. We need to install gcc-8-plugin-dev first.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T20:00:30Z' class='post-time'>
                December 18, 2019,  8:00pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T20:00:30Z'>
          <span itemprop='position'>#149</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="onebox githubpullrequest">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/12" target="_blank">github.com/Whonix/hardened-vm-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/12" target="_blank">Enable GCC plugins</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>madaidan:gcc-plugins</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2019-12-18" data-time="20:00:20" data-timezone="UTC">08:00PM - 18 Dec 19 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/madaidan" target="_blank">
          <img alt="madaidan" src="../../../../external.html?link=https://avatars0.githubusercontent.com/u/50278627?v=4" class="onebox-avatar-inline" width="20" height="20">
          madaidan
        </a>
      </div>

      <div class="lines" title="1 commits changed 1 files with 9 additions and 1 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/pull/12/files" target="_blank">
          <span class="added">+9</span>
          <span class="removed">-1</span>
        </a>
      </div>
    </div>

  </div>
</div>
  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T20:08:30Z' class='post-time'>
                December 18, 2019,  8:08pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T20:08:30Z'>
          <span itemprop='position'>#150</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Added all your suggestions.</p>
<aside class="onebox githubcommit">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/commit/0a29b7d09dd31952766d61b3bb3991f945725954" target="_blank">github.com/Whonix/hardened-vm-kernel</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Commit">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 14 16" aria-hidden="true"><path d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/commit/0a29b7d09dd31952766d61b3bb3991f945725954" target="_blank">add suggestions by @madaidan</a>
    </h4>

    <div class="github-info">
      <div class="date">
        committed <span class="discourse-local-date" data-format="ll" data-date="2019-12-18" data-time="19:57:46" data-timezone="UTC">07:57PM - 18 Dec 19 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/adrelanos" target="_blank">
          <img alt="adrelanos" src="../../../../external.html?link=https://avatars3.githubusercontent.com/u/1985040?v=4" class="onebox-avatar-inline" width="20" height="20">
          adrelanos
        </a>
        
      </div>

      <div class="lines" title="changed 1 files with 4 additions and 16 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/hardened-vm-kernel/commit/0a29b7d09dd31952766d61b3bb3991f945725954" target="_blank">
          <span class="added">+4</span>
          <span class="removed">-16</span>
        </a>
      </div>
    </div>

  </div>
</div>


  <div class="github-row">
    <pre class="github-content" style="white-space: normal;">https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/145</pre>
  </div>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>(Not done: chroot / cowbuilder.)</p>
<p>There is one prompt which requires interactive entry.</p>
<pre><code>+ make deb-pkg -j 8 -C /home/user/kernel/linux-source-4.19/
make: Entering directory '/home/user/kernel/linux-source-4.19'
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  YACC    scripts/kconfig/zconf.tab.c
  LEX     scripts/kconfig/zconf.lex.c
  HOSTCC  scripts/kconfig/zconf.tab.o
  HOSTLD  scripts/kconfig/conf
scripts/kconfig/conf  --syncconfig Kconfig
*
* Restart config...
*
*
* General setup
*
Compile also drivers which will not load (COMPILE_TEST) [N/y/?] n
Local version - append to kernel release (LOCALVERSION) [] 
Automatically append version information to the version string (LOCALVERSION_AUTO) [N/y/?] n
Build ID Salt (BUILD_SALT) [4.19.0-67-amd64] 4.19.0-67-amd64
Kernel compression mode
  1. Gzip (KERNEL_GZIP)
  2. Bzip2 (KERNEL_BZIP2)
  3. LZMA (KERNEL_LZMA)
&gt; 4. XZ (KERNEL_XZ)
  5. LZO (KERNEL_LZO)
  6. LZ4 (KERNEL_LZ4)
choice[1-6?]: 4
Default hostname (DEFAULT_HOSTNAME) [(none)] (none)
Support for paging of anonymous memory (swap) (SWAP) [Y/n/?] y
System V IPC (SYSVIPC) [Y/n/?] y
POSIX Message Queues (POSIX_MQUEUE) [Y/n/?] y
Enable process_vm_readv/writev syscalls (CROSS_MEMORY_ATTACH) [Y/n/?] y
uselib syscall (USELIB) [N/y/?] n
Auditing support (AUDIT) [Y/?] y
Preemption Model
  1. No Forced Preemption (Server) (PREEMPT_NONE)
&gt; 2. Voluntary Kernel Preemption (Desktop) (PREEMPT_VOLUNTARY)
  3. Preemptible Kernel (Low-Latency Desktop) (PREEMPT__LL) (NEW)
  4. Preemptible Kernel (Basic RT) (PREEMPT_RTB) (NEW)
  5. Fully Preemptible Kernel (RT) (PREEMPT_RT_FULL) (NEW)
choice[1-5?]: 
</code></pre>
<aside class="quote no-group" data-post="145" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Users don’t need to manually run that. That can be done during package installation.</p>
</blockquote>
</aside>
<p>Indeed.</p>
<p>And we need to use some trigger too. If he kernel source file is upgraded (security update by Debian), the kernel (and all modules) need to be rebuild too.</p>
<p>(<a href="../../../../external.html?link=https://wiki.debian.org/DpkgTriggers">https://wiki.debian.org/DpkgTriggers</a>)</p>
<aside class="quote no-group" data-post="145" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Actually installing the kernel is the only problem.</p>
</blockquote>
</aside>
<p>Maybe <code>dpkg --force-all</code> (or some more limited <code>--force-something</code>) parameter could do. Will try. Will also ask Debian mentors.</p>
<aside class="quote no-group" data-post="145" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>To get rid of this problem entirely, we can replace <code>make deb-pkg</code> with just <code>make</code> and sort out the kernel images and bootloader configuration ourselves without needing to use the .debs.</p>
</blockquote>
</aside>
<p>I hope not. A package is a good vehicle to get all the files in the right place and to cleanly remove these later on. It also integrates all with <code>/etc/kernel/</code>, dkms, initramfs, dracut, grub, dpkg triggers, what I am not even aware of and future changes.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T20:12:27Z' class='post-time'>
                December 18, 2019,  8:12pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T20:12:27Z'>
          <span itemprop='position'>#151</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="150" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>There is one prompt which requires interactive entry.</p>
</blockquote>
</aside>
<p>I don’t get any prompts. Are you sure the config is at <code>.config</code> in the kernel source directory?</p>
<aside class="quote no-group" data-post="150" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I hope not. A package is a good vehicle to get all the files in the right place and to cleanly remove these later on. It also integrates all with <code>/etc/kernel/</code> , dkms, initramfs, dracut, grub, dpkg triggers, what I am not even aware of and future changes.</p>
</blockquote>
</aside>
<p>We can just copy/paste all that into our package. So users will just need to install hardened-vm-kernel and it will handle everything rather than needing to use wrappers or other things.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T20:19:18Z' class='post-time'>
                December 18, 2019,  8:19pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T20:19:18Z'>
          <span itemprop='position'>#152</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="151" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>I don’t get any prompts. Are you sure the config is at <code>.config</code> in the kernel source directory?</p>
</blockquote>
</aside>
<p>Yes, I am sure.</p>
<pre><code>diff usr/share/hardened-vm-kernel/kernel-config ~/kernel/linux-source-4.19/.config ; echo $?
</code></pre>
<blockquote>
<p>0</p>
</blockquote>
<aside class="quote no-group" data-post="151" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>We can just copy/paste all that into our package. So users will just need to install hardened-vm-kernel and it will handle everything rather than needing to use wrappers or other things.</p>
</blockquote>
</aside>
<p>I don’t know if that is possible without using a package. For example to trigger DKMS, a new kernel package needs to be installed. It may be possible to reinvent all of this (call DKMS ourselfes) but the bigger the hack, the more likely it will have bugs.</p>
<p>question | with a package | without a package<br>
What kernel version is installed? | Check kernel package version. | ?<br>
How to remove that kernel? | apt purge… | ?</p>
<p>By not using a package many things get messy / lots of code duplication / bugs.</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../7598.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-12-18T21:00:43Z' class='post-time'>
                December 18, 2019,  9:00pm
              </time>
              <meta itemprop='dateModified' content='2019-12-18T21:00:43Z'>
          <span itemprop='position'>#153</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="152" data-topic="7598">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Yes, I am sure.</p>
</blockquote>
</aside>
<p>I can’t reproduce this. Exactly which of the config options does it prompt you about? Is it all of the ones you said or where some automatically selected?</p>
        </div>

        <meta itemprop='headline' content='kernel recompilation for better hardening'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><a rel="prev" itemprop="url" href="../7598c575.html?page=6">← previous page</a></span>
        <span itemprop='name'><b><a rel="next" itemprop="url" href="../7598fdfa.html?page=8">next page →</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
