<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Forwarding a port on public interface into tor - Support - Whonix Forum</title>
    <meta name="description" content="Hello! I need co accomplish a specific task - to forward a single port from public interface to a tor hidden service. The whonix box should act as a fake server. Any incoming requests to this port should be forwarded to &amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="2897.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../c/news/21.html">NEWS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Forwarding a port on public interface into tor&#39;" href="2897.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/forwarding-a-port-on-public-interface-into-tor/2897" />
<meta name="twitter:url" content="https://forums.whonix.org/t/forwarding-a-port-on-public-interface-into-tor/2897" />
<meta property="og:title" content="Forwarding a port on public interface into tor" />
<meta name="twitter:title" content="Forwarding a port on public interface into tor" />
<meta property="og:description" content="Hello!  I need co accomplish a specific task - to forward a single port from public interface to a tor hidden service.  The whonix box should act as a fake server. Any incoming requests to this port should be forwarded to tor hidden service, and the responses should be forwarded back to client. Without tor involved this would be a simple NAT relation, I think  What I have now:  Whonix Gateway (WG) with private (eth1) interface 10.152.152.10 and public (eth0) interface say 100.100.100.100  I don’..." />
<meta name="twitter:description" content="Hello!  I need co accomplish a specific task - to forward a single port from public interface to a tor hidden service.  The whonix box should act as a fake server. Any incoming requests to this port should be forwarded to tor hidden service, and the responses should be forwarded back to client. Without tor involved this would be a simple NAT relation, I think  What I have now:  Whonix Gateway (WG) with private (eth1) interface 10.152.152.10 and public (eth0) interface say 100.100.100.100  I don’..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="12 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="4 ❤" />
<meta property="article:published_time" content="2016-08-26T17:21:08+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="2897.html">Forwarding a port on public interface into tor</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/support/5.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #8C6238'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Support</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-26T17:21:08Z' class='post-time'>
                August 26, 2016,  5:21pm
              </time>
              <meta itemprop='dateModified' content='2016-08-26T17:21:08Z'>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Hello!<br>
I need co accomplish a specific task - to forward a single port from public interface to a tor hidden service.<br>
The whonix box should act as a fake server. Any incoming requests to this port should be forwarded to tor hidden service, and the responses should be forwarded back to client. Without tor involved this would be a simple NAT relation, I think<br>
What I have now:<br>
Whonix Gateway (WG) with private (eth1) interface 10.152.152.10 and public (eth0) interface say 100.100.100.100<br>
I don’t actually need the eth1 for my task, but left it by now to play around.<br>
The hidden service is up and running on separate host. On WG it is statically mapped as 1.1.1.1<br>
I can successfully connect to the service by IP 1.1.1.1 from WG, WW and any workstation on 10.152.152.10 subnet (WG acts as gateway).<br>
If 1.1.1.1 was real public address with no Tor involved I suppose following would work:<br>
iptables -t nat -I PREROUTING 1 -p tcp --dport 80 -j DNAT --to-destination 1.1.1.1<br>
iptables -t nat -I POSTROUTING 1 -j MASQUERADE<br>
But it doesn’t. I’m unable to connect to 100.100.100.100 from any interface or locally at WG.<br>
I tried lots of combinations, added more INPUT and OUTPUT rules etc., nothing helps. I think I lack some fundamental knowledge to understand what’s wrong.<br>
I’d appreciate any help. Thanks.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-26T17:39:06Z' class='post-time'>
                August 26, 2016,  5:39pm
              </time>
              <meta itemprop='dateModified' content='2016-08-26T17:39:06Z'>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>You do realize that this would not be anonymous?</p>
<p>Are you sure the standard guide on how to set up Tor hidden services would not suffice?</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../external.html?link=https://www.whonix.org/favicon.ico" class="site-icon" width="16" height="16">
      <a href="../../../external.html?link=https://www.whonix.org/wiki/Hidden_Services" target="_blank" rel="nofollow noopener">Whonix</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:640/480;"><img src="../../../external.html?link=https://www.whonix.org/w/images/1/12/Fly-agaric808110640.jpg" class="thumbnail"></div>

<h3><a href="../../../external.html?link=https://www.whonix.org/wiki/Hidden_Services" target="_blank" rel="nofollow noopener">Onion Services</a></h3>

<p>Anonymously host any server with Whonix and Tor onion services</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<hr>
<p>What do you mean by fake server?</p>
<p>What should this be useful for?</p>
<p>Since this sounds rather difficult… Did you figure out how to set this up without Whonix being involved first? I highly recommend a case study if this is doable at all until you try to modify Whonix to make that work also.</p>
<hr>
<p>The Whonix specific stuff… Basically:</p>
<ol>
<li>add extra rule to Whonix firewall (since we have no config option to open arbitrary incoming ports) (You can add it similar to the above, but outside (!) the <code>if</code>.</li>
</ol>
<p>For example in <code>/usr/bin/whonix_firewall</code>… Below this line (but outside the <code>if</code>):</p>
<pre><code>$iptables_cmd -A INPUT -i "$ext_if_item" -p tcp --dport 22 -j ACCEPT
</code></pre>
<ol start="2">
<li>You also need a - virtualizer specific [Which virtualizer?] - way to open that port in the virtualizer.</li>
</ol>
<p>similar to:<br>
<a href="../../../external.html?link=https://www.whonix.org/wiki/File_Transfer#SSH_into_Whonix-Gateway">https://www.whonix.org/wiki/File_Transfer#SSH_into_Whonix-Gateway</a></p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-26T18:18:42Z' class='post-time'>
                August 26, 2016,  6:18pm
              </time>
              <meta itemprop='dateModified' content='2016-08-26T18:18:42Z'>
          <span itemprop='position'>#3</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="2" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>You do realize that this would not be anonymous?</p>
</blockquote>
</aside>
<p>I think yes. My goal is to hide actual hidden service location only, I’m not going to hide tha fact of using WG. The hidden service is actually a VPN server (my own). By this setup I hope to acive</p>
<ul>
<li>easy client setup - a simple vpn client only</li>
<li>protection against mitm on tor exit node</li>
<li>no revealing of hidden service location</li>
</ul>
<aside class="quote" data-post="2" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Are you sure the standard guide on how to set up Tor hidden services would not suffice?</p>
</blockquote>
</aside>
<p>Yes. I actually have the hidden serevice running already. Everything works from the private subnet Written above). The problem is - I’ll have no private subnet in “production” environment</p>
<aside class="quote" data-post="2" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>What do you mean by fake server?</p>
</blockquote>
</aside>
<p>The WG box should behave as a VPN server. In fact it’ll be not a server, but establish a secure channel to actual server, hidden within tor.</p>
<aside class="quote" data-post="2" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Did you figure out how to set this up without Whonix being involved first?</p>
</blockquote>
</aside>
<p>Actually not. I ony studied the Internet and it seems a kind of standart task, not too difficult. You’re right, I need to tast that setup without tor</p>
<aside class="quote" data-post="2" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>The Whonix specific stuff… Basically:</p>
</blockquote>
</aside>
<p>This is about allowing incoming ssh. I already did it (by enabling the corresponding option in firewall setup). How could it relate to my problem? I you mean opening MY needed port in the same way - I also tried a similar INPUT rule, it didn’t help.<br>
My setup (4 hosts: 2 in private and 2 in public subnet) runns in virtual lab by now, I uctually didn’t open anything on the hypervisor host.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-26T19:32:31Z' class='post-time'>
                August 26, 2016,  7:32pm
              </time>
              <meta itemprop='dateModified' content='2016-08-26T19:32:31Z'>
          <span itemprop='position'>#4</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="3" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>You’re right, I need to tast that setup without tor</p>
</blockquote>
</aside>
<p>Oops. I meant to imply “without Whonix but with Tor”. However, starting even simpler without involving Tor is even better. This seems a good way to experiment this step by step:</p>
<ol>
<li>no Tor</li>
<li>Tor</li>
<li>Whonix with Tor</li>
</ol>
<aside class="quote" data-post="3" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>This is about allowing incoming ssh.</p>
</blockquote>
</aside>
<p>It’s just an example how to open an external port in Whonix-Gateway. With minor tweaks you can turn this from “open ssh port” to “open an arbitrary port”.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-26T19:47:33Z' class='post-time'>
                August 26, 2016,  7:47pm
              </time>
              <meta itemprop='dateModified' content='2016-08-26T19:47:33Z'>
          <span itemprop='position'>#5</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="4" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>you can turn this from “open ssh port” to “open an arbitrary port”.</p>
</blockquote>
</aside>
<p>Yes, I already got what you mean. I tried this with my port, but it didn’t help. The problem lays somewhere else I guess…</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-30T15:06:25Z' class='post-time'>
                August 30, 2016,  3:06pm
              </time>
              <meta itemprop='dateModified' content='2016-08-30T15:30:37Z'>
          <span itemprop='position'>#6</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Ok, I spent several days studying debian and iptables (i’m actually a guy from M$ world, half of this time has been wasted to solve simple things like making ssh and sudo/kde work, getting used to nano etc.)<br>
I finally found a solution (below), still not tested on whonix, but worth reporting.</p>
<p>Stage 1.<br>
For middlebox  I deployed a clean Debian Jessie with single network interface eth0 100.100.100.100 (for this example).<br>
The destination web server  is 200.200.200.200 with Apache responding on port 80. The default web page displays the client IP.<br>
Client machine - regular Win workstation somewhere on external network.<br>
Goal: request the web page from middlebox and get proper answer served by webserver.<br>
Following script made this possible:</p>
<details>
<summary>
Config 1: No Whonix, No Tor, No hidden service</summary>
<pre><code>#!/bin/bash
localPort=80
destPort=80
destAddr=200.200.200.200
sysctl -w net.ipv4.ip_forward=1
iptables -F
iptables -F -t nat
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
iptables -A PREROUTING -t nat -p tcp --dport $localPort -j DNAT --to-destination $destAddr:$destPort
iptables -A FORWARD -p tcp --dport $destPort -d $destAddr -j ACCEPT
iptables -A POSTROUTING -t nat -j MASQUERADE
iptables -A FORWARD -p tcp --sport $destPort -s $destAddr -j ACCEPT

#the lines below just to let system work with tight default policy
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -m multiport --dports 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp -m multiport --sports 80,443 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p udp --dport 53 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --sport 53 -j ACCEPT
</code></pre>
</details>
<p>When requesting URL http:// 200.200.200.200 from webserver by client machine (regular CHROME browser), the page is returned displaying client address equal to client mchine IP. When requesting middlebox URL http:// 100.100.100.100 , the page also loads ok, but displays client IP 100.100.100.100, that means that middlebox successfully redirected my request to webserver and forwarded the response back to client machine. Goal reached.</p>
<p>Stage 2:<br>
Intalled Tor on both middlebox and webserver .<br>
On webserver set up a hidden web service with name abcdef.onion , checked proper operation via client machine Tor Browser. The page displays client IP 127.0.0.1 (the decrypted request appears to originate from webserver’s local tor router)<br>
On middlebox added following to /etc/tor/torrc:<br>
TransPort 9040<br>
DNSPort 53<br>
MapAddress 1.1.1.1 abcdef.onion<br>
Then rewrote iptables script using this <a href="../../../external.html?link=https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy" rel="nofollow noopener">Tutorial</a><br>
Changed default policies to ACCEPT and ended up with following script:</p>
<details>
<summary>
Config 2: No Whonix, No hidden service, trying to torify all traffic</summary>
<pre><code>#!/bin/bash
localPort=80
destPort=80
destAddr=200.200.200.200
sysctl -w net.ipv4.ip_forward=1
iptables -F
iptables -F -t nat
iptables -F -t raw
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

#the UID that Tor runs as (varies from system to system)
_tor_uid="109"
#Tor's TransPort
_trans_port="9040"

### for debugging only
iptables -t raw -A PREROUTING -p tcp -m multiport --dports 80,8888,9040 -j TRACE
iptables -t raw -A PREROUTING -p tcp -m multiport --sports 80,8888,9040 -j TRACE
iptables -t raw -A OUTPUT -p tcp -m multiport --sports 80,8888,9040 -j TRACE
iptables -t raw -A OUTPUT -p tcp -m multiport --dports 80,8888,9040 -j TRACE

### torify requests from local system
iptables -t nat -A OUTPUT -o lo -j RETURN
iptables -t nat -A OUTPUT -m owner --uid-owner $_tor_uid -j RETURN
iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 53
iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports $_trans_port

### torify routed requests
iptables -t nat -A PREROUTING -p tcp --dport $localPort -j DNAT --to-destination $destAddr:$destPort
iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53
iptables -t nat -A PREROUTING -p tcp --syn -j REDIRECT --to-ports $_trans_port

iptables -A POSTROUTING -t nat -j MASQUERADE
</code></pre>
</details>
<p>With this script I got strange results.<br>
When making http request from inside middlebox (“curl 200.200.200.200”) the page returns successfully displaying client IP from Tor network. That means that locally-originated requests are torified correctly.<br>
But when making request http:// 200.200.200.200 from client machine, the page returns client IP 100.100.100.100 , the forwarding works ok as in stage 1, but not torified.<br>
Obviously , the rule<br>
<code>iptables -t nat -A PREROUTING -p tcp --dport $localPort -j DNAT --to-destination $destAddr:$destPort</code><br>
works in this case, but<br>
<code>iptables -t nat -A PREROUTING -p tcp --syn -j REDIRECT --to-ports $_trans_port</code><br>
does not.<br>
On various iptables manuals over Inet I never saw that DNAT or REDIRECT actions stop chain traversal.<br>
The situation above (as long as examining the TRACE output) shows, that after the first rule is matched in the  PREROUTING chain, the processing of other rules in this chain stops, and never reaches the third REDIRECT . Since the destination address is DNATed to external webserver IP, a “routing decision” is made and the packet goes through FORWARD chains and is fired outside. No chance to get torified.<br>
By now I have no idea how to make the packet to be processed by both rules (DNAT and REDIRECT). And no other table or chain allows DNAT or REDIRECT for incoming packets.</p>
<p>Nevertheless, the solution was found, not completely the iptables-way<br>
Stage 3:<br>
Luckily I stumbled across  <a href="../../../external.html?link=http://linux.die.net/man/1/redir" rel="nofollow noopener">redir</a><br>
This is a software port forwarder. It can be used instead of kernel/netfilter NAT facility.<br>
The main difference is that the forwarded packets generated by it are treated by local system as locally-originated, thus these packets are processed by OUTPUT chain instead of FORWARD. And output chain allows us to make REDIRECT to Tor TransPort (see above rules).<br>
Since we don’t need kernel packet forwarding anymore, we can disable it.<br>
Final rewritten script looks like following:</p>
<details>
<summary>
Config 3: No Whonix, trying to torify all traffic, trying hidden service</summary>
<pre><code>#!/bin/bash
sysctl -w net.ipv4.ip_forward=0
iptables -F
iptables -F -t nat
iptables -F -t raw
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

#the UID that Tor runs as (varies from system to system)
_tor_uid="109"
#Tor's TransPort
_trans_port="9040"

### torify requests from local system
iptables -t nat -A OUTPUT -o lo -j RETURN
iptables -t nat -A OUTPUT -m owner --uid-owner $_tor_uid -j RETURN
iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 53
iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports $_trans_port
</code></pre>
</details>
<p>Then I launched<br>
<code>redir --lport=80 --dport=80 --caddr=1.1.1.1</code><br>
to forward all incoming requests on port 80 to the hidden service mapped IP. The rest does tor.<br>
After all I’m able to request http:// 100.100.100.100 by client machine, and get result wpage displaying client IP 127.0.0.1 . The goal is reached, My request to middlebox gets into tor network, reaches hidden service and the response finds it’s way back.<br>
If it was VPN server instead of Apache, I’d get a transparent secure channel from client machine to remote VPN server, immune to MITM, and not even knowing VPN server location. The server would also not know my address (not critical).<br>
Now I’ll try to apply everything above to Whonix.<br>
.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/entr0py'><span itemprop='name'>entr0py</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-30T17:06:59Z' class='post-time'>
                August 30, 2016,  5:06pm
              </time>
              <meta itemprop='dateModified' content='2016-08-30T17:06:59Z'>
          <span itemprop='position'>#7</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Thanks for clear, detailed write-up. Hoping to learn from your progress.</p>
<hr>
<aside class="quote" data-post="6" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>On various iptables manuals over Inet I never saw that DNAT or REDIRECT actions stop chain traversal.</p>
</blockquote>
</aside>
<p>From <code>man iptables-extensions</code>:</p>
<blockquote>
<p>DNAT: This  target is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only  called  from  those chains.  It specifies that the destination address of the packet should be modified (and all future packets in this  connection  will  also  be mangled),  and <strong>rules should cease being examined.</strong></p>
</blockquote>
<hr>
<p>I can understand the motivation for wanting to isolate a webserver from the Tor Gateway. Are you also uncomfortable with having a hidden server on the openvpn server itself? Or is there another reason that a separate gateway is needed to serve the openvpn server?</p>
<hr>
<p>Did you see this already? <a href="../../../external.html?link=https://www.whonix.org/wiki/OnionCat">https://www.whonix.org/wiki/OnionCat</a></p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-30T21:45:11Z' class='post-time'>
                August 30, 2016,  9:45pm
              </time>
              <meta itemprop='dateModified' content='2016-08-30T21:52:14Z'>
          <span itemprop='position'>#8</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="7" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Are you also uncomfortable with having a hidden server on the openvpn server itself? Or is there another reason that a separate gateway is needed to serve the openvpn server?</p>
</blockquote>
</aside>
<p>The openvpn server WILL BE the hidden service. The experiments above used web server instead of vpn server because web server is easier to setup and query (and helps quickly determine client ip). In “production” I’ll have openvpn server published as hidden service, other user demanded services (maybe web mail or file sharing or remote desktop) will be available through vpn tunnel’s virtual subnet (default subnet is 10.8.<em>.</em>).<br>
But vpn client can’t connect to vpn server by .onion name, that’s the main motivation for setting up a common middlebox. Otherwise I should provide separate whonix infrastructure for each client.<br>
When my setup is finished, I’ll get clear benefits:</p>
<ol>
<li>First of all, the destination server’s location remains hidden, even in case the middlebox or a client is compromised. (The server will reside behind a strict firewall and have no access to Internet besides openvpn tunnel)</li>
<li>Second, the client setup get very easy - only a simple openvpn installation, all clients connect to the same middlebox by single public IP.</li>
<li>Clients or any observer on clients side don’t know anything about tor involved, that’s far less suspicious than using tor</li>
<li>The tunnel is encrypted end-to-end, there is no unencrypted segment (comparing to other tor/vpn scenarios), eavesdropping is impossible even by malcious tor nodes or compromised middlebox (I guess).</li>
<li>Multiple middleboxes can be used for different client groups, each group works with it’s own middlebox revealing no correlation with other groups.</li>
<li>In case of emergency the middlebox can be shutdown or even wiped out remotely, “burning the bridge” to hidden server. Also the redirection can be switched to a decoy server.</li>
<li>Since clients, middlebox and hidden server are supposed to be physically located in different countries, timing attacks seem to be impossible.<br>
The main problem personally for me remains deploying Whonix middlebox somewhere on VPS. The docs say it’s neither easy nor recommended. Instead I could setup a clean Debian installation from scratch as I did above, but I find Whonix to be far more secure and admin-friendly and highly appreciate creator’s efforts.<br>
Add.: Another problem is possible low througput or high latency. Need to test it when final setup is complete.</li>
</ol>
<aside class="quote" data-post="7" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Did you see this already? <a href="../../../external.html?link=https://www.whonix.org/wiki/OnionCat" rel="nofollow noopener">https://www.whonix.org/wiki/OnionCat</a></p>
</blockquote>
</aside>
<p>No. I’m not sure If it can help me, but I definitely will check this out. I really hope not to have wasted several days inventing the wheel <img src="../../images/emoji/twitter/winkae52.png?v=5" title=":wink:" class="emoji" alt=":wink:"></p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-31T09:46:54Z' class='post-time'>
                August 31, 2016,  9:46am
              </time>
              <meta itemprop='dateModified' content='2016-08-31T09:46:54Z'>
          <span itemprop='position'>#9</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Examined OnionCat docs (didn;t try to install).<br>
Yes it’s very close to what I wanted to achive. The drawback comparing to my scheme is more complicated client setup, including tor router running on client. Advantages are also there: anonymity of all parties, no need for middlebox.<br>
I’ll go on finalizing my setup, It suits my needs better. I’ll also try OnionCat for different tasks, maybe for administration.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/entr0py'><span itemprop='name'>entr0py</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-31T18:09:49Z' class='post-time'>
                August 31, 2016,  6:09pm
              </time>
              <meta itemprop='dateModified' content='2016-08-31T18:09:49Z'>
          <span itemprop='position'>#10</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>But vpn client can’t connect to vpn server by .onion name, that’s the main motivation for setting up a common middlebox. Otherwise I should provide separate whonix infrastructure for each client.</p>
</blockquote>
</aside>
<p>I understand now. The primary motivation of this project is to protect the destination server. Client anonymity is up to each client to implement.</p>
<ol>
<li>clients only know the public IP of the middlebox and so must use clearnet for outgoing traffic. clients are not allowed to know the server’s .onion address.</li>
<li>client traffic is tunneled using a vpn protocol to a middlebox</li>
<li>middlebox routes vpn traffic to vpn server over tor</li>
</ol>
<p>In essence, what you are doing is putting a <strong>shared</strong>, <strong>remote</strong> Tor Gateway on a VPS router.</p>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>When my setup is finished, <strong>I’ll get clear benefits</strong>:</p>
<ol>
<li>First of all, the destination server’s location remains hidden, even in case the middlebox or a client is compromised. (The server will reside behind a strict firewall and have no access to Internet besides openvpn tunnel)</li>
</ol>
</blockquote>
</aside>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>6 In case of [<strong>my</strong>] emergency the middlebox can be shutdown or even wiped out remotely, “burning the bridge” to hidden server. Also the redirection can be switched to a decoy server.</p>
</blockquote>
</aside>
<p>Yes, <strong>you</strong> will get clear benefits. Your clients on the other hand… Let’s hope they use Whonix to connect to the middlebox.</p>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>2 Second, the client setup get very easy - only a simple openvpn installation, all clients connect to the same middlebox by single public IP.</p>
</blockquote>
</aside>
<p>It’s easy and the protection is proportionate. This is borderline reckless unless you couldn’t care less about the clients. If one client is compromised, it’s safe to assume that the identities of all of the other clients using the middlebox will be compromised as well. The only way to avoid that is to have one middlebox per client.</p>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>3 Clients or any observer on clients side don’t know anything about tor involved, that’s far less suspicious than using tor</p>
</blockquote>
</aside>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>4 The tunnel is encrypted end-to-end, there is no unencrypted segment (comparing to other tor/vpn scenarios), eavesdropping is impossible even by malcious tor nodes or compromised middlebox (I guess).</p>
</blockquote>
</aside>
<p>Having clients use Whonix-Gateway in combination with a VPN achieves the same results plus provides real anonymity to your clients. You can still protect yourself by publishing your .onion in <a href="../../../external.html?link=https://www.whonix.org/wiki/Hidden_Services#Hidden_Service_Authentication">authenticated mode</a>.</p>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>7 Since clients, middlebox and hidden server are supposed to be physically located in different countries, timing attacks seem to be impossible.</p>
</blockquote>
</aside>
<p>It’s only impossible if the distance between countries changes randomly.</p>
<aside class="quote" data-post="8" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>The docs say it’s neither easy nor recommended.</p>
</blockquote>
</aside>
<p>Don’t know about difficulty but it’s safe to say that no one around here will recommend throwing clients under the bus. If Whonix is too difficult for your clients, have them use Tails / TBB.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-08-31T22:15:56Z' class='post-time'>
                August 31, 2016, 10:15pm
              </time>
              <meta itemprop='dateModified' content='2016-08-31T22:15:56Z'>
          <span itemprop='position'>#11</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>what you are doing is putting a shared, remote Tor Gateway on a VPS router.</p>
</blockquote>
</aside>
<p>Mmmm. Not sure I understood you right. I would better say “building private VPN tunnel through shared remote tor tunnel”</p>
<aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Yes, you will get clear benefits. Your clients on the other hand… Let’s hope they use Whonix to connect to the middlebox.</p>
</blockquote>
</aside>
<aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>it’s safe to say that no one around here will recommend throwing clients under the bus.</p>
</blockquote>
</aside>
<p>Hey, I doubt there is place for offense here.<br>
You misunderstood the client part. “clients” are meant friendly workstations, some of them under my own control. I AM the clients and the server.  Also “clients” doesn’t mean commercial stuff, they’re just “client side” in the “client-server” paradigm.<br>
I don’t care about client anonymity the way it’s meant by the tor concept. Client anonymity from tor point of view is that:</p>
<ol>
<li>client connects to any potentially hostile server and the server shouldn’t be able to get enough info to associate the client to real person/host (geting the client IP is the easiest way to build such association, that;s why tor is mainly about hiding the source IP)</li>
<li>client wants to use public network but prevent any third party to get info about the client or eavesdrop on transmitted data.<br>
My setup completely fulfills condition 1 and partially fulfills 2. It protects client data end-to-end, but doesn’t hide client’s IP. FROM WHOM? Both middlebox and server are trusted by concept, there is no problem if any observer sees a vpn tunne fro a client to middlebox without chance of eavesdropping. The only risk for the client is actually some brutal person getting physical access to client’s workstation.<br>
On the contrary, installing only tor on client doesn’t increase anonymity much if the client doesn’t follow anonymity rules. You certainly should know, that many people install tor thinking it to be ultimate protection and immediately reveal tons of passwords through malcious exit nodes just by not using https in login forms…<br>
I’m part of a team that needs a secure place for collaboration (that hidden server). Most of team members have no idea about anonymity, about routing, running virtual machines etc., they’re unable to setup anything complicated on their PC’s. Trying to deploy whonix infrastructure to each of them would be a failure. That’s why I try to go the way with common middlebox.</li>
</ol>
<aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>In case of [my] emergency</p>
</blockquote>
</aside>
<p>You better should insert [our] in this case. As I said, I’m part of a team and my goal to provide equal security to all teammates. Burning the bridge actually protects the whole team, because vital server data remains undisclosed.</p>
<aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>it’s safe to assume that the identities of all of the other clients using the middlebox will be compromised as well.</p>
</blockquote>
</aside>
<p>I thnk you’re only partially right. Even if one client gets compromised he only gets access to server, not to other clients. Since connections to server go from tor network (127.0.0.1), the only info an attacker could get (maybe) is the other client’s IP in the virtual subnet.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/entr0py'><span itemprop='name'>entr0py</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-01T05:22:25Z' class='post-time'>
                September 1, 2016,  5:22am
              </time>
              <meta itemprop='dateModified' content='2016-09-01T05:22:25Z'>
          <span itemprop='position'>#12</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="11" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>what you are doing is putting a shared, remote Tor Gateway on a VPS router.</p>
</blockquote>
</aside>
<p>Mmmm. Not sure I understood you right. I would better say “building private VPN tunnel through shared remote tor tunnel”</p>
</blockquote>
</aside>
<p>Yes, your description sounds more accurate.</p>
<aside class="quote" data-post="11" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>Hey, I doubt there is place for offense here.<br>
You misunderstood the client part. “clients” are meant friendly workstations, some of them under my own control. I AM the clients and the server.  Also “clients” doesn’t mean commercial stuff, they’re just “client side” in the “client-server” paradigm.</p>
</blockquote>
</aside>
<p>My intention wasn’t to either offend or not offend. The point was to emphasize that your clients - whether they’re devices, people, customers, or you - are not receiving nearly the same level of protection as the server.</p>
<aside class="quote" data-post="11" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>I’m part of a team that needs a secure place for collaboration (that hidden server). Most of team members have no idea about anonymity, about routing, running virtual machines etc., they’re unable to setup anything complicated on their PC’s. Trying to deploy whonix infrastructure to each of them would be a failure. That’s why I try to go the way with common middlebox.</p>
</blockquote>
</aside>
<p>If the clients are under your control, you very clearly have the better option of using Whonix with all of your clients and connecting directly to the hidden server. Even for novice users, TBB/Tails would be far more preferable than this more complicated, less secure setup. Especially when you consider that TBB/Tails could be shipped in a hardened configuration dedicated to this sole use case.</p>
<aside class="quote" data-post="11" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<aside class="quote" data-post="10" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>it’s safe to assume that the identities of all of the other clients using the middlebox will be compromised as well.</p>
</blockquote>
</aside>
<p>I thnk you’re only partially right. Even if one client gets compromised he only gets access to server, not to other clients. Since connections to server go from tor network (127.0.0.1), the only info an attacker could get (maybe) is the other client’s IP in the virtual subnet.</p>
</blockquote>
</aside>
<p>Ahh, but you’re assuming that the only mistakes people make are InfoSec mistakes and that the only compromises people face are remotely-exploited InfoSec compromises. In reality, there are very few real-world cases of failures in InfoSec (ie cryptography, Tor protocol, etc) and every indication is that people are far more prone to be compromised by bad OpSec. Thus a good InfoSec strategy anticipates failures in OpSec and mitigates the damage that results. Consider this scenario…</p>
<p>You run a whistleblower website on your hidden server and a group of whistleblowers (unrelated to each other, so more anonymous than your team) wish to submit leaks by connecting to your middlebox. One of them leaves a document on the passenger seat of her car and falls under suspicion by the adversaries. This person is raided and computers are seized. The adversaries find out by examining computer that this person has been connecting to your middlebox. Obviously, it’s trivial to locate the middlebox. They  seize the middlebox and grab every incoming IP address. Result: Everyone that touched the middlebox is now de-anonymized and teammates=very angry. But the server should be safe…</p>
<p>It’s actually worse. Unlike a public VPN used to route to Tor, your middlebox serves only one purpose and is accessed by only your client group. There is no plausible deniability - everyone is guilty by association. Adversaries don’t even need to physically access either the compromised client device or the middlebox. All they need to do are view the logs of the client &amp; middlebox ISP’s. You would never know there was a compromise until the entire group is rounded up.</p>
<aside class="quote" data-post="11" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>My setup … protects client data end-to-end, but doesn’t hide client’s IP. FROM WHOM? <strong>Both middlebox and server are trusted by concept</strong>, there is no problem if any observer sees a vpn tunne fro a client to middlebox without chance of eavesdropping.</p>
</blockquote>
</aside>
<p>As in prior example, the middlebox can <strong>not</strong> be trusted since it is out of your physical control and easily located / compromised.</p>
<aside class="quote" data-post="11" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>On the contrary, installing only tor on client doesn’t increase anonymity much if the client doesn’t follow anonymity rules.</p>
</blockquote>
</aside>
<p>True, it doesn’t do much for the compromised client - but it means everything to the security of the middlebox and using Tor keeps the other non-compromised clients safe.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-01T09:39:19Z' class='post-time'>
                September 1, 2016,  9:39am
              </time>
              <meta itemprop='dateModified' content='2016-09-01T09:39:19Z'>
          <span itemprop='position'>#13</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Ok, I understand your point of view now. I can agree with all you wrote above. 100%. The kind of activities you described, the risks level and (I guess) the adversary resources certainly demand anonymity level you talk about.<br>
My situation is much simplier. There is nothing in our activities that could attract such a skilful and powerful adversary like a government agency or a criminal group or similar… That’s why I can’t even imagine IN MY CASE that somebody would bother compromising the middlebox or do complicated attacks or seize workstations etc. My teammates are no secret, we don’t hide the fact that we cooperate. If anybody would need to get list of team members, he could just observe our regular email correspondence or check smartphone address book. There is only a small part of our activities that needs to be hidden. That’s why even my setup as actually an overkill, not to speak about your described above.<br>
Again, I completely agree with you in situation you described above, I’m completely aware of such risks. My situation is simply different.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/entr0py'><span itemprop='name'>entr0py</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-01T15:45:41Z' class='post-time'>
                September 1, 2016,  3:45pm
              </time>
              <meta itemprop='dateModified' content='2016-09-01T15:45:41Z'>
          <span itemprop='position'>#14</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Obviously, you know your situation best. Just making sure you know the risks. Good luck.</p>
<p>[Also, the example I wrote is not so far-fetched and doesn’t require much skill from the adversary. Not that hard for even local law enforcement to obtain subpoenas in the US. And in some countries, a bottle of liquor might be all it takes…]</p>
<p>[Would still be interested in seeing how you manage this. Please keep this updated. Thanks!]</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-13T10:18:11Z' class='post-time'>
                September 13, 2016, 10:18am
              </time>
              <meta itemprop='dateModified' content='2016-09-13T10:18:11Z'>
          <span itemprop='position'>#15</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Hi!<br>
I’m finally done with my setup. This is the final followup</p>
<p><em>I think here should be a disclaimer: What I’ve done is not the way whonix is meant to work and not the purpose whonix was created for. This setup violates many recommendations and brings clear anonymity risks. I doubt anybode should ever repeat this.</em></p>
<p>So, the last step was setting up the middlebox somwhere on the Net. I chose Linode KVM VPS. Mainly because they offer ability to launch a live ISO and use it to clone storage from my local VM. Unfortunately I had no success with this (the sustem didn’t boot, maybe because I did something wrong), but the VPS was already up and paid so I continued with it. So I had to install clean Debian and build Whonix from source.</p>
<p>I used this manual <a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Build_Documentation/Physical_Isolation#How_To_Install_Whonix-Gateway_on_Hardware_.28RECOMMENDED.29" rel="nofollow noopener">https://www.whonix.org/wiki/Dev/Build_Documentation/Physical_Isolation#How_To_Install_Whonix-Gateway_on_Hardware_.28RECOMMENDED.29</a></p>
<p>Building was successful, without a single glitch. After reboot I got a clean Whonix-Gateway, identical (I hope) to VM destribution. Then I made additional tuning to make it work as I need:</p>
<p>I. Because of absent eth1 Tor service failed to launch, and the control port filter failed also.<br>
I edited etc/tor/torrc file to disable any SocksPorts bound to 10.152.152.10 address. Any instruction in torrc file overrides ALL similar instructions in default config. So I added only SocksPorts and TransPort which bind to 127.0.0.1, this effectively disabled other SocksPorts.</p>
<pre><code>MapAddress 1.1.1.1 abcdef.onion
TransPort 127.0.0.1:9041 IsolateDestAddr IsolateDestPort
SocksPort 127.0.0.1:9050
SocksPort 127.0.0.1:9100
SocksPort 127.0.0.1:9101 IsolateDestAddr IsolateDestPort
# etc... from default file 
</code></pre>
<p>After these modifications tor service started successfully</p>
<p>II. To disable eth1 presence check by WhonixCheck a file should be created<br>
<code>/etc/whonix.d/50_whonixcheck_user.conf</code><br>
with following line in it<br>
<code>whonixcheck_skip_functions+=" check_network_interfaces "</code></p>
<p>III. I disabled control port filter. Actually, there was no need to, because it failed anyway, I just didn’t want to observe the red “FAILED” event in system log. The instructions for disabling it are pretty clear, I had no problem with them.  <a href="../../../external.html?link=https://www.whonix.org/wiki/Advanced_Security_Guide#Disable_Control_Port_Filter_Proxy" rel="nofollow noopener">https://www.whonix.org/wiki/Advanced_Security_Guide#Disable_Control_Port_Filter_Proxy</a><br>
a) Add line<br>
<code>CONTROL_PORT_FILTER_PROXY_ENABLE=0</code><br>
to custom firewall config file<br>
<code>/etc/whonix_firewall.d/50_user.conf</code><br>
b) disable service by typing<br>
<code>sudo systemctl mask control-port-filter-proxy-python</code><br>
c) disable service checking by WhonixCheck adding<br>
<code>whonixcheck_skip_functions+=" check_control_port_filter_running "</code><br>
to<br>
<code>/etc/whonix.d/50_whonixcheck_user.conf</code></p>
<p>IV. For testing purposes I enabled SSH (mainly for SFTP access) by adding<br>
<code>GATEWAY_ALLOW_INCOMING_SSH=1</code><br>
to custom firewall config file<br>
<code>/etc/whonix_firewall.d/50_user.conf</code></p>
<p>V. Installed redir. The problem was redir doesn’t come with a service, and is even unable to demonize itself. So I spent pretty much time to figure out how to write a service script for it.<br>
a) apt-get install redir<br>
b) placed a service script /etc/init.d/redir-d with following contents</p>
<pre><code>#!/bin/sh
### BEGIN INIT INFO
# Provides:          redir-d
# Required-Start:    $local_fs $network $named $time $syslog
# Required-Stop:     $local_fs $network $named $time $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       redir daemon
### END INIT INFO
_EXECUTABLE="/usr/bin/redir"
_OPTIONS="--cport=12345 --lport=12345 --caddr=1.1.1.1"

start() {
  start-stop-daemon --start --background --exec $_EXECUTABLE -- $_OPTIONS
  exit 0
}
stop() {
  start-stop-daemon --stop --exec $_EXECUTABLE --retry 5
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
esac
</code></pre>
<p>I realize this is definitely not the best or cleanest script ever written (error handling is completely absent)  but it works for me.<br>
c) install service by typing<br>
<code>update-rc.d redir-d defaults</code></p>
<p>VI. Then I had to modify firewall rules for redirection to work. I found no way to run a custom script when firewall is loaded. The main firewall script is /usr/bin/whonix_firewall . I decided not to hardcode iptables rules into it (because they could be overwritten on update), but add an ability to launch custom script.<br>
a) added some lines near bottom of /usr/bin/whonix_firewall</p>
<pre><code>###########################
## Invoke Custom Firewall Script
###########################
if [ -f "$CUSTOM_SCRIPT" ]
then
    source $CUSTOM_SCRIPT
fi
###########################
## End
###########################
</code></pre>
<p>b) the option variables are read from /etc/whonix_firewall.d/50_user.conf, so I added my variable to it<br>
<code>CUSTOM_SCRIPT=/home/user/whonix_firewall_custom</code><br>
I don’t know what is the best practice to place such scripts, maybe /home/user/ is not the best place…<br>
The /home/user/whonix_firewall_custom script contains actual iptables rules</p>
<pre><code>#!/bin/bash
localPort=12345
destPort=12345
destAddr=1.1.1.1
transPort=9041
iptables -I INPUT 15 -p tcp --dport $localPort --syn -j ACCEPT
iptables -I OUTPUT 1 -t nat -d $destAddr -p tcp --dport $destPort --syn -j REDIRECT --to-ports $transPort
</code></pre>
<p>Finally I’m able to establish OpenVPN connection with this middlebox on port 12345 and land inside my hidden server. Profit.</p>
<p>Next I plan to drill deeper into stream isolation, because I’m not sure if each client uses the same circuit or not. I think the circuits should be separate bacause of hidden service protocol (as I understood it), but didn’t find any evidence for this yet.</p>
<p>And Patrick, sorry for downgrading your masterpiece. Anyway, this was a great educational possibility and big fun for me. I was a complete newbie in Linux some weeks ago, now I’m … still a complete newbie <img src="../../images/emoji/twitter/slight_smileae52.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-13T10:43:38Z' class='post-time'>
                September 13, 2016, 10:43am
              </time>
              <meta itemprop='dateModified' content='2016-09-13T10:43:38Z'>
          <span itemprop='position'>#16</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="15" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>I found no way to run a custom script when firewall is loaded.</p>
</blockquote>
</aside>
<p>This will improve with Whonix 14 btw, because then Whonix firewall is load through a systemd unit file so you could use an <code>ExecStartPre</code> / <code>ExecStartPost</code> systemd drop-in snippet and thereby have a post hook that will not be lost after upgrades.</p>
<p>(That would be doable today also by using <code>/etc/network/pre-up.d</code>.)</p>
<aside class="quote" data-post="15" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/k/a88e4f/40.png" class="avatar"> Kamaz:</div>
<blockquote>
<p>And Patrick, sorry for downgrading your masterpiece.</p>
</blockquote>
</aside>
<p>Don’t mind. <img src="../../images/emoji/twitter/slight_smileae52.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> I am glad Whonix is useful to use. One reason it is Libre Software / Open Source is so people can hack it for their purposes.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-13T11:38:30Z' class='post-time'>
                September 13, 2016, 11:38am
              </time>
              <meta itemprop='dateModified' content='2016-09-13T11:38:30Z'>
          <span itemprop='position'>#17</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="16" data-topic="2897">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>is load through a systemd unit file so you could use an ExecStartPre / ExecStartPost systemd drop-in snippet and thereby have a post hook</p>
</blockquote>
</aside>
<p>Rocket science…</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-13T19:08:11Z' class='post-time'>
                September 13, 2016,  7:08pm
              </time>
              <meta itemprop='dateModified' content='2016-09-13T19:08:11Z'>
          <span itemprop='position'>#18</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Not really.</p>
<p><code>/lib/systemd/system/whonix-firewall.service.d/50_user.conf</code></p>
<pre><code class="lang-auto">[Service]
ExecStartPre=/path/to/script
</code></pre>
<hr>
<p>Another hack that should already work for pre run code would be adding the commands to <code>/etc/whonix_firewall.d/50_user.conf</code>.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Kamaz'><span itemprop='name'>Kamaz</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="2897.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-09-13T20:18:08Z' class='post-time'>
                September 13, 2016,  8:18pm
              </time>
              <meta itemprop='dateModified' content='2016-09-13T20:18:08Z'>
          <span itemprop='position'>#19</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>oh, thanks, I’ll try this out.</p>
        </div>

        <meta itemprop='headline' content='Forwarding a port on public interface into tor'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
