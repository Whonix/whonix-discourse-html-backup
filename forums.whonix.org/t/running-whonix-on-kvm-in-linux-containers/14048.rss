<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Running Whonix on KVM in Linux containers</title>
    <link>http://forums.whonix.org/t/running-whonix-on-kvm-in-linux-containers/14048</link>
    <description>I got Whonix running on KVM via libvirt&#39;s `qemu:///session` inside of a Docker container. I&#39;m sharing here as this may be of interest to the forum, or at least of use to anyone attempting anything similar in the future.

https://github.com/nspin/whonix-now

### Motivation

Docker serves to simplify the configuration and management of the network and filesystem resources associated with Whonix virtual machines. This approach enables reproducibility and ease of management for custom configurations of Whonix-based environments. On the other side of the spectrum, this approach also enables contained, side effect-free, single-command setup and teardown of pre-baked Whonix environments for new users.

### Implementation notes

libvirt runs inside of a Docker container which runs with `--device /dev/kvm`. virt-manager and virtual machine GUIs are forwarded to the host&#39;s X11 session.

libvirt&#39;s `qemu:///session` doesn&#39;t have the privilege to manage virtual networking resources, so the container must set up the virtual networks on behalf of libvirt and then define them using `&lt;forward mode=&#39;bridge&#39;/&gt;`.

To work around a libvirt-related networking issue which I have yet to diagnose, I had to include a patch for the Whonix-Gateway firewall [1][2]. This is a temporary hack which I will remove once I manage to find and resolve the underlying problem.

[1] https://github.com/nspin/whonix-now/blob/5b4937481465f60ce64f4beadf24386d48287b69/nix/whonix.nix#L80
[2] https://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/3?u=nspin</description>
    <language>en</language>
    <lastBuildDate>Mon, 27 Jun 2022 13:59:58 +0000</lastBuildDate>
    <category>KVM</category>
    <atom:link href="http://forums.whonix.org/t/running-whonix-on-kvm-in-linux-containers/14048.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Running Whonix on KVM in Linux containers</title>
        <dc:creator><![CDATA[nspin]]></dc:creator>
        <description><![CDATA[
            <p>I got Whonix running on KVM via libvirt’s <code>qemu:///session</code> inside of a Docker container. I’m sharing here as this may be of interest to the forum, or at least of use to anyone attempting anything similar in the future.</p>
<aside class="onebox allowlistedgeneric" data-onebox-src="https://github.com/nspin/whonix-now">
  <header class="source">
      <img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">

      <a href="https://github.com/nspin/whonix-now" target="_blank" rel="noopener nofollow ugc">GitHub</a>
  </header>

  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="https://opengraph.githubassets.com/0990dee5ce66655fc49ce70605ac4943cee033f0e16cf28254f825a75b64bfdd/nspin/whonix-now" class="thumbnail" width="690" height="362"></div>

<h3><a href="https://github.com/nspin/whonix-now" target="_blank" rel="noopener nofollow ugc">GitHub - nspin/whonix-now: Whonix on KVM in Linux containers</a></h3>

  <p>Whonix on KVM in Linux containers. Contribute to nspin/whonix-now development by creating an account on GitHub.</p>


  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<h3>
<a name="motivation-1" class="anchor" href="http://forums.whonix.org#motivation-1"></a>Motivation</h3>
<p>Docker serves to simplify the configuration and management of the network and filesystem resources associated with Whonix virtual machines. This approach enables reproducibility and ease of management for custom configurations of Whonix-based environments. On the other side of the spectrum, this approach also enables contained, side effect-free, single-command setup and teardown of pre-baked Whonix environments for new users.</p>
<h3>
<a name="implementation-notes-2" class="anchor" href="http://forums.whonix.org#implementation-notes-2"></a>Implementation notes</h3>
<p>libvirt runs inside of a Docker container which runs with <code>--device /dev/kvm</code>. virt-manager and virtual machine GUIs are forwarded to the host’s X11 session.</p>
<p>libvirt’s <code>qemu:///session</code> doesn’t have the privilege to manage virtual networking resources, so the container must set up the virtual networks on behalf of libvirt and then define them using <code>&lt;forward mode='bridge'/&gt;</code>.</p>
<p>To work around a libvirt-related networking issue which I have yet to diagnose, I had to include a patch for the Whonix-Gateway firewall [1][2]. This is a temporary hack which I will remove once I manage to find and resolve the underlying problem.</p>
<p>[1] <a href="https://github.com/nspin/whonix-now/blob/5b4937481465f60ce64f4beadf24386d48287b69/nix/whonix.nix#L80" class="inline-onebox" rel="noopener nofollow ugc">whonix-now/whonix.nix at 5b4937481465f60ce64f4beadf24386d48287b69 · nspin/whonix-now · GitHub</a><br>
[2] <a href="https://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/3" class="inline-onebox">Have firewall accept ICMP Fragmentation Needed - #3 by pege</a></p>
          <p><a href="http://forums.whonix.org/t/running-whonix-on-kvm-in-linux-containers/14048/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/running-whonix-on-kvm-in-linux-containers/14048/1</link>
        <pubDate>Mon, 27 Jun 2022 10:11:30 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-14048-1</guid>
        <source url="http://forums.whonix.org/t/running-whonix-on-kvm-in-linux-containers/14048.rss">Running Whonix on KVM in Linux containers</source>
      </item>
  </channel>
</rss>
