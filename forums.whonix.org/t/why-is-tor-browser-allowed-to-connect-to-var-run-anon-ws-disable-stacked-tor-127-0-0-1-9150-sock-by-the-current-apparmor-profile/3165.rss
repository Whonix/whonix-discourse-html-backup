<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
    <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165</link>
    <description>I wanted to update https://github.com/Whonix/apparmor-profile-torbrowser so it keeps working  since Tor Project changed TBB to SocksSocket. Strangely it is not required.

I wonder why Tor Browser is able to connect to these unix domain sockets as its not allowed by the profile.

* `/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock`
* `/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock`

`sudo aa-status` shows the Tor Browser AppArmor profile is loaded and enforced.

Related:

* https://phabricator.whonix.org/T192
* https://forums.whonix.org/t/tor-browser-6-5a4-connectivity-broken-blocked-by-apparmor-profile-since-tbb-changed-to-sockssocket</description>
    <language>en</language>
    <lastBuildDate>Sat, 26 Nov 2016 07:24:08 +0000</lastBuildDate>
    <category>AppArmor</category>
    <atom:link href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[torjunkie]]></dc:creator>
        <description><![CDATA[
            <p>No idea. Beyond my pay grade! <img src="//forums.whonix.org/images/emoji/twitter/wink.png?v=5" title=":wink:" class="emoji" alt=":wink:"></p>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/8</link>
        <pubDate>Sat, 26 Nov 2016 07:24:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-8</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>So this might be a bug in both Debian and Fedora kernels. The root cause may even be a missing patch in the mainline Linux kernel. Is there a Linux bug report yet?</p>
<p>Debian changelog for apparmor mentions UNIX domain sockets.</p>
<p><a href="http://metadata.ftp-master.debian.org/changelogs/main/a/apparmor/unstable_changelog" class="onebox" target="_blank">http://metadata.ftp-master.debian.org/changelogs/main/a/apparmor/unstable_changelog</a></p>
<p>Am I inflating this or doesn’t this bug totally render apparmor useless? Isn’t there some unix domain socket, once access can compromise the whole system?</p>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/7</link>
        <pubDate>Wed, 23 Nov 2016 16:43:21 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-7</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[torjunkie]]></dc:creator>
        <description><![CDATA[
            <p>FWIW</p>
<p>The apparmor profile also doesn’t block the connection to the Socks port when Qubes dom0 kernel is upgraded to the latest available from the unstable repo i.e. 4.8.9-12</p>
<p>Since that is only 4 days old, it looks like the problem is yet to be sorted.</p>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/6</link>
        <pubDate>Wed, 23 Nov 2016 15:57:34 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-6</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Thanks so much for taking this assignment! <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> I guess more than a justifiable amount of work has been spend to justify reporting a bug against Debain. Could you open a bug against Debian please?</p>
<aside class="quote" data-post="4" data-topic="3165">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Does the Linux kernel in Qubes-Whonix VMs matter at all since we are using Qubes PV kernels?</p>
</blockquote>
</aside>
<p>Exactly right, it does not matter since we are using dom0 kernel. Unless we are using pv grub:</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.qubes-os.org/attachment/icons/512x512/apps/qubes-logo-icon.png" class="site-icon" width="500" height="500">
      <a href="https://www.qubes-os.org/doc/managing-vm-kernel/#using-kernel-installed-in-the-vm" target="_blank" rel="nofollow noopener">Qubes OS</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="https://www.qubes-os.org/attachment/icons/qubes-logo-icon-name-slogan-fb.png" class="thumbnail"></div>

<h3><a href="https://www.qubes-os.org/doc/managing-vm-kernel/#using-kernel-installed-in-the-vm" target="_blank" rel="nofollow noopener">Managing VM kernel</a></h3>

<p>VM kernel managed by dom0  By default, VMs kernels are provided by dom0. This means that:     You can select the kernel version in VM settings;   You can modify kernel options in VM settings;   You...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="quote" data-post="4" data-topic="3165">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>So even if this gets fixed by 4.10, it might not matter for Qubes users because Qubes PV kernel might be older? Is that right?</p>
</blockquote>
</aside>
<p>Yes.</p>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/5</link>
        <pubDate>Tue, 22 Nov 2016 21:13:30 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-5</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="3" data-topic="3165">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Could you try upgrading your linux kernel and apparmor package to stretch please in a test VM?</p>
</blockquote>
</aside>
<p>Wow, what a miserable assignment (when you have no idea how to do this)…</p>
<p>The answer first:</p>
<p>As of Debian Linux kernel 4.8.5, apparmor still does <strong>not</strong> enforce read/write policies on domain sockets. Stretch is supposed to ship with 4.10 so there’s a chance that a fix may make it by then.</p>
<p>Now some questions:</p>
<ul>
<li>First I tried upgrading just the kernel in a Virtualbox Whonix-13 Workstation. Then I tried dist-upgrading the whole workstation to stretch. Neither method worked. Can’t remember exactly why but I think I couldn’t get X operational again. Mentioning this in case there’s some easy way to do this.</li>
<li>So I started with a fresh Debian stretch install. Installed TBB, apparmor profile, anon-ws-disable-stacked-tor (11/22 commit). Hacked around with anon-shared-helper-scripts until I got the correct GATEWAY_IP. Restarted service to get correct socat mappings. TBB was fully functional, including control port. Added deny rule to apparmor profile. Reloaded. No effect.</li>
<li>I did this in Virtualbox for the Whonix images and then moved back to Qubes with a Debian HVM. One thing I’d like to know is: Does the Linux kernel in Qubes-Whonix VMs matter at all since we are using Qubes PV kernels? So even if this gets fixed by 4.10, it might not matter for Qubes users because Qubes PV kernel might be older? Is that right?</li>
</ul>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/4</link>
        <pubDate>Tue, 22 Nov 2016 06:06:56 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-4</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p><a href="https://udd.debian.org/bugs.cgi?release=jessie&amp;merged=ign&amp;fnewerval=7&amp;flastmodval=7&amp;apparmor=1&amp;sortby=id&amp;sorto=asc#results" class="onebox" target="_blank">https://udd.debian.org/bugs.cgi?release=jessie&amp;merged=ign&amp;fnewerval=7&amp;flastmodval=7&amp;apparmor=1&amp;sortby=id&amp;sorto=asc#results</a></p>
<p>Maybe there is no Debian bug report.</p>
<p>Could you try upgrading your linux kernel and apparmor package to stretch please in a test VM? See if it is fixed there?</p>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/3</link>
        <pubDate>Sun, 20 Nov 2016 16:34:01 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-3</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <ul>
<li>Confirmed your conclusion that TBB 6.5a4-hardened works with new environment variables without changing apparmor.</li>
<li>Added explicit deny rules to apparmor profile.<br>
<code>deny /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock rw,</code><br>
<code>deny /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock rw,</code><br>
TBB continues to work without issue.</li>
</ul>
<p>Background info from: <a href="http://man7.org/linux/man-pages/man7/unix.7.html">http://man7.org/linux/man-pages/man7/unix.7.html</a></p>
<blockquote>
<p>On Linux, connecting to a stream socket object requires write<br>
permission on that socket; sending a datagram to a datagram socket<br>
likewise requires write permission on that socket.  POSIX does not<br>
make any statement about the effect of the permissions on a socket<br>
file, and on some systems (e.g., older BSDs), the socket permissions<br>
are ignored.  Portable programs should not rely on this feature for<br>
security.</p>
</blockquote>
<p>Relevant bug report? <a href="https://bugs.launchpad.net/apparmor/+bug/1208988">https://bugs.launchpad.net/apparmor/+bug/1208988</a></p>
<blockquote>
<ul>
<li>AppArmor removed unix domain socket mediation as part of the 2.4 (karmic) rewrite to the security_path hooks so that it could be upstreamed into the main kernel. The result being apparmor no longer mediates access to AF_UNIX socket files. Or more specifically it does not mediation connections between sockets, creation of a socket within the filesystem is mediated</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Confined applications can currently read from and write to any AF_UNIX<br>
socket files</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Existing AppArmor profiles that contain file rules granting write access to<br>
AF_UNIX socket files are effectively being ignored</li>
</ul>
</blockquote>
<p>So IIUC apparmor can control socket creation and destruction but not read/write to existing sockets. It says “Fix Released”. Is that to upstream AppArmor? Where is the corresponding Debian report?</p>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/2</link>
        <pubDate>Sun, 20 Nov 2016 05:48:35 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-2</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
      <item>
        <title>Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>I wanted to update <a href="https://github.com/Whonix/apparmor-profile-torbrowser">https://github.com/Whonix/apparmor-profile-torbrowser</a> so it keeps working  since Tor Project changed TBB to SocksSocket. Strangely it is not required.</p>
<p>I wonder why Tor Browser is able to connect to these unix domain sockets as its not allowed by the profile.</p>
<ul>
<li><code>/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock</code></li>
<li><code>/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock</code></li>
</ul>
<p><code>sudo aa-status</code> shows the Tor Browser AppArmor profile is loaded and enforced.</p>
<p>Related:</p>
<ul>
<li><a href="https://phabricator.whonix.org/T192">https://phabricator.whonix.org/T192</a></li>
<li><a href="https://forums.whonix.org/t/tor-browser-6-5a4-connectivity-broken-blocked-by-apparmor-profile-since-tbb-changed-to-sockssocket">https://forums.whonix.org/t/tor-browser-6-5a4-connectivity-broken-blocked-by-apparmor-profile-since-tbb-changed-to-sockssocket</a></li>
</ul>
          <p><a href="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165/1</link>
        <pubDate>Sun, 20 Nov 2016 00:47:14 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3165-1</guid>
        <source url="http://forums.whonix.org/t/why-is-tor-browser-allowed-to-connect-to-var-run-anon-ws-disable-stacked-tor-127-0-0-1-9150-sock-by-the-current-apparmor-profile/3165.rss">Why is Tor Browser allowed to connect to /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock by the current AppArmor profile?</source>
      </item>
  </channel>
</rss>
