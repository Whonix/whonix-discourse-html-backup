<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Qubes sudo / su / root Hardening - Development Discussion</title>
    <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561</link>
    <description>Too bad, that Qubes-Whonix users do not fully benefit much from the recent user/root/misc hardening by Whonix by default such as for example:

* https://forums.whonix.org/t/restrict-root-access/7658
* https://forums.whonix.org/t/protect-linux-user-accounts-against-brute-force-attacks/7698
* https://github.com/Whonix/security-misc
* https://forums.whonix.org/t/kernel-hardening/7296
* [Linux Kernel Runtime Guard (LKRG)](https://www.whonix.org/wiki/Linux_Kernel_Runtime_Guard_LKRG)
* https://www.whonix.org/wiki/Dev/Permissions
* And possibly also soon https://forums.whonix.org/t/untrusted-root-improve-security-by-restricting-root/7998.
* documented here:

https://www.whonix.org/wiki/Root

Preventing malware from gaining root is vital to prevent malware from breaking out of a VM, spreading to dom0 or other VMs. Many attacks aren&#39;t possible with root and/or kernel level compromise.
([More meaningful separation of root and kernel is being worked on](https://forums.whonix.org/t/untrusted-root-improve-security-by-restricting-root/7998).)

This is currently really bad in Qubes Debian templates. Any compromised user (not only user `user`) can use `su` without a password and gain root. ([bug reported here](https://github.com/QubesOS/qubes-issues/issues/1128#issuecomment-511185971))

Just learned that `qubes-template-debian-10-minimal` comes without passwordless root by default. This is documented here:
 https://www.qubes-os.org/doc/templates/minimal/#passwordless-root
Quote:

&gt; It is an intentional design choice for [Passwordless Root Access in VMs](https://www.qubes-os.org/doc/vm-sudo/) to be optional in Minimal TemplateVMs. Since the Minimal TemplateVMs are *minimal* , they are not configured for passwordless root by default. To update or install packages, execute the following command in dom0 (where `X` is your distro and version number):
&gt; 
&gt; ```
&gt; [user@dom0 ~]$ qvm-run -u root X-minimal xterm
&gt; ```
&gt; 
&gt; This opens a root terminal in the Minimal TemplateVM, from which you can use execute root commands without `sudo` . You will have to do this every time if you choose not to enable passwordless root.
&gt; 
&gt; If you want to be able to use `sudo` inside a Minimal TemplateVM (or TemplateBasedVMs based on a Minimal TemplateVM), open a root terminal as just instructed, then install the `qubes-core-agent-passwordless-root` package.
&gt; 
&gt; Optionally, verify that passwordless root now works by opening a normal (non-root) xterm window in the Minimal TemplateVM, then issue the command `sudo -l` . This should give you output that includes the `NOPASSWD` keyword.

In Qubes Debian minimal templates user `user` is also by default not a member of group `sudo`.

This is an excellent basis for Qubes-Whonix.
(Which is already based on Qubes Debian minimal templates.)

Qubes-Whonix package `qubes-whonix-shared-packages-recommended` currently `Depends:` on `qubes-core-agent-passwordless-root`. This dependency could be dropped.

The question is, how users could easily gain root then. In dom0 command line:

&gt; qvm-run -u root X-minimal xterm

Or 

&gt; qvm-run -u root X-minimal xfce4-terminal

Usability issue. Which may be fixable. More on that below.

Security issue? Better than the default we have now. However, I am not sure if that is non-ideal security wise. Running a GUI application as root? Maybe a better default would be if a user `admin` would be a member of group `sudo` by default? Then open a terminal as user `admin` and allow `admin` to use `sudo` without a password?

Usability. Somehow add a Qubes start menu entry. Not sure that is yet supported by Qubes to run something as a different user from Qubes start menu.

Example:

dom0

    cat .local/share/qubes-appmenus/debian-10/apps.templates/xfce4-terminal.desktop

&gt; [Desktop Entry]
&gt; ...
&gt; Exec=qvm-run -q -a --service -- %VMNAME% qubes.StartApp+xfce4-terminal

We&#39;d have to use `qvm-run -u admin`. That may require Qubes dom0 enhancements.

If these aren&#39;t coming / too late, maybe we could work around that limitation somehow. Perhaps an /etc/sudoers.d exception. Maybe a dom0 yes/no prompt using qrexec.</description>
    <language>en</language>
    <lastBuildDate>Sun, 01 Nov 2020 21:49:13 +0000</lastBuildDate>
    <category>Qubes-Whonix</category>
    <atom:link href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[ratpoison4]]></dc:creator>
        <description><![CDATA[
            <blockquote>
<p>you need to reverse the long time ago changes and just stick to the<br>
simple solution now provided by removing the passwordless package</p>
</blockquote>
<p>It worked. Thanks!</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/17">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/17</link>
        <pubDate>Sun, 01 Nov 2020 21:49:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-17</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.whonix.org/w/images/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://www.whonix.org/wiki/Factory_Reset" target="_blank" title="11:11PM - 09 October 2020">Whonix – 9 Oct 20</a>
  </header>
  <article class="onebox-body">
    <img src="https://www.whonix.org/w/images/c/c4/Factoryreset13124512.png" class="thumbnail onebox-avatar" width="500" height="500">

<h3><a href="https://www.whonix.org/wiki/Factory_Reset" target="_blank">Whonix ™ Factory Reset</a></h3>

<p>Resetting Whonix ™ to Vendor Defaults. Reset configuration files to defaults, re-install meta package, move the system closer to vendor defaults.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/16">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/16</link>
        <pubDate>Sun, 01 Nov 2020 12:43:57 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-16</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>you need to reverse the long time ago changes and just stick to the<br>
simple solution now provided by removing the passwordless package,<br>
otherwise im not sure anything would solve that except if you for e.g<br>
enable tester repository of whonix and try to update/upgrade and see if<br>
it solve anything or remove/reinstall whonix template and if that didnt<br>
work then backup and reinstall qubes again.</p>
<p>ratpoison4 via Whonix Forum:</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/15">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/15</link>
        <pubDate>Sat, 31 Oct 2020 21:14:29 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-15</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[ratpoison4]]></dc:creator>
        <description><![CDATA[
            <p>I added the following to /etc/sudoers.d/msgcollector in whonix-ws-15:</p>
<pre><code>%user ALL=NOPASSWD: /usr/lib/msgcollector/msgdispatcher_delete_wrapper
user ALL=NOPASSWD: /usr/lib/msgcollector/msgdispatcher_delete_wrapper
</code></pre>
<p>I update it regularly.</p>
<p>Before that (long time ago) I followed qubes-os org/doc/vm-sudo/<span class="hashtag">#replacing-passwordless-root-access-with-dom0-user-prompt</span> (replace space with “.”, section “Configuring Debian/Whonix TemplateVM to prompt Dom0 for any authorization request”) and started getting the error. I didn’t realize the error was caused by removing passwordless sudo until recently read what it says in the middle more carefully. Then found this thread.</p>
<p>Qubes version: 4.0 (updated regularly)<br>
Whonix version: 15 (updated regularly)</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/14">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/14</link>
        <pubDate>Sat, 31 Oct 2020 20:12:39 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-14</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>what you have done specifically?, Qubes version (do you upgrade it regularly?) , Whonix version (do you upgrade it regularly?)</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/13">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/13</link>
        <pubDate>Sat, 31 Oct 2020 19:59:03 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-13</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[ratpoison4]]></dc:creator>
        <description><![CDATA[
            <p>I tried this and it does not work for me. I am still getting the message.</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/12">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/12</link>
        <pubDate>Wed, 28 Oct 2020 20:00:37 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-12</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>great thanks alot, now working normally.</p>
<p>Patrick via Whonix Forum:</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/11">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/11</link>
        <pubDate>Tue, 29 Sep 2020 18:47:23 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-11</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>To emulate that change before it reaches package upgrades, I recommend running <code>visudo -f /etc/sudoers.d/msgcollector</code> as root to make the changes as invalid changes (syntax errors) in sudoers configuration files result in broken sudo.</p>
<pre><code>sudo visudo -f /etc/sudoers.d/msgcollector</code></pre>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/10">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/10</link>
        <pubDate>Tue, 29 Sep 2020 10:38:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-10</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://gitlab.com/assets/favicon-7901bd695fb93edb07975966062049829afb56cf11511236e61bcf425070e36e.png" class="site-icon" width="16" height="16">
      <a href="https://gitlab.com/whonix/msgcollector/-/commit/88977926d17298eaea08868cbbf1228bc0c0a5d9" target="_blank">GitLab</a>
  </header>
  <article class="onebox-body">
    <img src="https://assets.gitlab-static.net/assets/gitlab_logo-7ae504fe4f68fdebb3c2034e36621930cd36ea87924c11ff65dbcb8ed50dca58.png" class="thumbnail onebox-avatar" width="128" height="128">

<h3><a href="https://gitlab.com/whonix/msgcollector/-/commit/88977926d17298eaea08868cbbf1228bc0c0a5d9" target="_blank">fix msgcollector sudoers issue when qubes-core-agent-passwordless-root...</a></h3>

<p>Thanks to @TNT_BOOM_BOOM for the bug report! https://forums.whonix.org/t/hardening-qubes-vms-by-removing-passwordless-root-will-give-boot-error-message/10350</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/9</link>
        <pubDate>Tue, 29 Sep 2020 10:34:49 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-9</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>Qubes had pushed fixation to the package qubes-core-agent-passwordless-root that if user want to remove it he can be removed safely without any other packages. Doing this in whonix gonna give this error message on every boot:</p>
<pre><code>msgdispatcher script bug. 

No panic. Nothing is broken. Just some rare condition has been hit. 
Try again later. There is likely a solution for this problem. 
Please see Whonix News, Whonix Blog and Whonix User Help Forum. 
Please report this bug! 

who_ami: 'user' 
msgdisptacher_username: 'whonixcheck' 
msgdispatcher_identifier: 'whonixcheck' 
msgdispatcher_appendix: 'messagex_done' 
delete_wrapper: '/usr/lib/msgcollector/msgdispatcher_delete_wrapper' 
msgdispatcher_sudo_wrapper_command: 'sudo --non-interactive msgdisptacher_username=whonixcheck msgdispatcher_identifier=whonixcheck msgdispatcher_appendix=messagex_done /usr/lib/msgcollector/msgdispatcher_delete_wrapper' 
output_msgdispatcher_sudo_wrapper: 'sudo: a password is required' 

error_text: 'output_msgdispatcher_sudo_wrapper="$(sudo --non-interactive msgdisptacher_username="$msgdisptacher_username" msgdispatcher_identifier="$msgdispatcher_identifier" msgdispatcher_appendix="$msgdispatcher_appendix" "$delete_wrapper" 2&gt;&amp;1)"' 
last_exit_code: '1' 
</code></pre>
<p>I think the issue which need to be fixed with this line:</p>
<p><code>output_msgdispatcher_sudo_wrapper: 'sudo: a password is required'</code></p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/8</link>
        <pubDate>Mon, 28 Sep 2020 20:16:59 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-8</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Fost]]></dc:creator>
        <description><![CDATA[
            <p>Hate to chime in…</p>
<p>But I read the description in the link and it mentions to clone whonix ws or gw and to add some additional code to harden the root.</p>
<p>Would these suggestions prevent hardware leaks such as MAC address, Manufacturer, etc until kick secure covers those issues?</p>
<p>thanks,</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/7</link>
        <pubDate>Fri, 07 Aug 2020 11:24:24 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-7</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-username="do23bf7m" data-post="5" data-topic="8561">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/d/4491bb/40.png" class="avatar"> do23bf7m:</div>
<blockquote>
<p>To put it clearly: After using the dummy dependency fix Qubes-Whonix users benefit from all Whonix root hardening inside Whonix Workstation and Whonix Gateway?</p>
</blockquote>
</aside>
<p>No. It’s only 1 step. As said in above post:</p>
<aside class="quote no-group" data-username="Patrick" data-post="4" data-topic="8561">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>But I didn’t test any further than this.</p>
</blockquote>
</aside>
<aside class="quote no-group" data-username="do23bf7m" data-post="5" data-topic="8561">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/d/4491bb/40.png" class="avatar"> do23bf7m:</div>
<blockquote>
<p>What about hardware identifier hardening? =&gt; <a href="https://whonix.org/wiki/Whonix-Workstation_Security_Hardening#Restrict_Hardware_Information_to_Root">https://whonix.org/wiki/Whonix-Workstation_Security_Hardening#Restrict_Hardware_Information_to_Root</a></p>
</blockquote>
</aside>
<p>Unrelated.<br>
Just that it doesn’t help much when sudo is still available.</p>
<aside class="quote no-group" data-username="do23bf7m" data-post="5" data-topic="8561">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/d/4491bb/40.png" class="avatar"> do23bf7m:</div>
<blockquote>
<p>Will this benefit all Debian/Fedora templates in the future?</p>
</blockquote>
</aside>
<p>Restrict Hardware Information to Root? It doesn’t seem that way at the moment. Unless someone creates a Kicksecure template for Qubes.</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.whonix.org/w/images/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://www.whonix.org/wiki/Kicksecure" target="_blank" title="12:33PM - 12 July 2020">Whonix – 12 Jul 20</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:120/80;"><img src="https://www.whonix.org/w/images/5/52/Hardening-13423213.jpg" class="thumbnail" width="120" height="80"></div>

<h3><a href="https://www.whonix.org/wiki/Kicksecure" target="_blank">Kicksecure ™: A Security-hardened, Non-anonymous Linux Distribution</a></h3>

<p>Kicksecure ™ is a security-hardened Debian based Linux distribution that provides better protection from malware.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/6</link>
        <pubDate>Fri, 07 Aug 2020 08:14:22 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-6</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[do23bf7m]]></dc:creator>
        <description><![CDATA[
            <p>Sounds good. To put it clearly: After using the dummy dependency fix Qubes-Whonix users benefit from all Whonix root hardening inside Whonix Workstation and Whonix Gateway?<br>
What about hardware identifier hardening? =&gt; <a href="https://whonix.org/wiki/Whonix-Workstation_Security_Hardening#Restrict_Hardware_Information_to_Root" rel="nofollow noopener">https://whonix.org/wiki/Whonix-Workstation_Security_Hardening#Restrict_Hardware_Information_to_Root</a><br>
Is it also root depended and will it benefit?<br>
Will this benefit all Debian/Fedora templates in the future?<br>
The minimal template fix is also working well to restrict root access (despite usability)?</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/5</link>
        <pubDate>Fri, 07 Aug 2020 02:13:45 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-5</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>It is now possible to remove package <code>qubes-core-agent-passwordless-root</code> in Qubes-Whonix by first installing package <code>dummy-dependency</code>.</p>
<pre><code>sudo apt update
sudo apt install dummy-dependency
sudo apt purge qubes-core-agent-passwordless-root
</code></pre>
<p>In testers repository. Will flow into other repositories as per usual.</p>
<p>But I didn’t test any further than this.</p>
<ul>
<li><a href="https://gitlab.com/whonix/qubes-whonix/-/commit/fd8bc8213ef6a4bf1ce5b03a13d5f30afc80175c">https://gitlab.com/whonix/qubes-whonix/-/commit/fd8bc8213ef6a4bf1ce5b03a13d5f30afc80175c</a></li>
<li><a href="https://gitlab.com/whonix/anon-meta-packages/-/commit/57072ac0b9f973ccf4ec2e5827ce2037819832c1">https://gitlab.com/whonix/anon-meta-packages/-/commit/57072ac0b9f973ccf4ec2e5827ce2037819832c1</a></li>
</ul>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/4</link>
        <pubDate>Tue, 21 Jul 2020 17:37:40 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-4</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>That might work.</p>
<p>But maybe in Qubes we can do better than that. Thanks to dom0 / qrexec we could have a safer implementation.</p>
<p>This is related to the ideas of a safer implementation in Non-Qubes-Whonix, possible using multiple boot modes in grub boot menu:</p>
<aside class="quote quote-modified" data-post="1" data-topic="7708">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar">
    <a href="https://forums.whonix.org/t/multiple-boot-modes-for-better-security-persistent-root-persistent-noroot-live-root-live-noroot/7708">multiple boot modes for better security: persistent + root | persistent + noroot | live + root | live + noroot</a> <a class="badge-wrapper  bullet" href="http://forums.whonix.org/c/development"><span class="badge-category-bg" style="background-color: #25AAE2;"></span><span style="" data-drop-close="true" class="badge-category clear-badge" title="Hacking on the Whonix software and code. (devs) (list of unmaintained components)">Development</span></a>
  </div>
  <blockquote>
    Related: 

<a href="https://forums.whonix.org/t/restrict-root-access/7658/15" class="inline-onebox">Restrict root access</a>
<a href="https://forums.whonix.org/t/disable-suid-binaries/7706/5" class="inline-onebox">Disable SUID Binaries</a>
<a href="https://forums.whonix.org/t/re-mount-home-and-other-with-noexec-and-nosuid-among-other-useful-mount-options-for-better-security/7707" class="inline-onebox">(re-)mount home [and other?] with noexec (and nosuid [among other useful mount options]) for better security?</a>
<a href="https://forums.whonix.org/t/walled-garden-firewall-whitelisting-application-whitelisting-sudo-lockdown-superuser-mode-protected-mode/5725" class="inline-onebox">walled garden, firewall whitelisting, application whitelisting, sudo lockdown, superuser mode, protected mode</a>


What about more boot modes: 

persistent + root
persistent + noroot
live + root
live + noroot

Not all might make sense. 
Think of noroot has “hardening” where we can do stuff like noexec, nosuid, no root/sudo possible at al…
  </blockquote>
</aside>

<p>In Qubes we may or may not have access to different boot modes using Qubes start menu.</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/3</link>
        <pubDate>Wed, 27 Nov 2019 15:11:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-3</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[madaidan]]></dc:creator>
        <description><![CDATA[
            <p>Why not make sudo require a password and allow it to be used in VMs just like in non-Qubes-Whonix?</p>
<p>Then a user can do</p>
<pre><code>qvm-run X-minimal xfce4-terminal
sudo command</code></pre>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/2</link>
        <pubDate>Wed, 27 Nov 2019 14:54:34 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-2</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
      <item>
        <title>Qubes sudo / su / root Hardening - Development Discussion</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Too bad, that Qubes-Whonix users do not fully benefit much from the recent user/root/misc hardening by Whonix by default such as for example:</p>
<ul>
<li><a href="https://forums.whonix.org/t/restrict-root-access/7658" class="inline-onebox">Restrict root access</a></li>
<li><a href="https://forums.whonix.org/t/protect-linux-user-accounts-against-brute-force-attacks/7698" class="inline-onebox">protect Linux user accounts against brute force attacks</a></li>
<li><a href="https://github.com/Whonix/security-misc">https://github.com/Whonix/security-misc</a></li>
<li><a href="https://forums.whonix.org/t/kernel-hardening/7296" class="inline-onebox">Kernel Hardening</a></li>
<li><a href="https://www.whonix.org/wiki/Linux_Kernel_Runtime_Guard_LKRG">Linux Kernel Runtime Guard (LKRG)</a></li>
<li><a href="https://www.whonix.org/wiki/Dev/Permissions">https://www.whonix.org/wiki/Dev/Permissions</a></li>
<li>And possibly also soon <a href="https://forums.whonix.org/t/untrusted-root-improve-security-by-restricting-root/7998" class="inline-onebox">Untrusted Root - improve Security by Restricting Root</a>.</li>
<li>documented here:</li>
</ul>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.whonix.org/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://www.whonix.org/wiki/Root" target="_blank" title="05:01PM - 10 September 2019">Whonix – 10 Sep 19</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:332/500;"><img src="https://www.whonix.org/w/images/e/e2/Root123123.jpg" class="thumbnail"></div>

<h3><a href="https://www.whonix.org/wiki/Root" target="_blank">Root</a></h3>

<p>Tips on using sudo / root (privileged) commands safely</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Preventing malware from gaining root is vital to prevent malware from breaking out of a VM, spreading to dom0 or other VMs. Many attacks aren’t possible with root and/or kernel level compromise.<br>
(<a href="https://forums.whonix.org/t/untrusted-root-improve-security-by-restricting-root/7998">More meaningful separation of root and kernel is being worked on</a>.)</p>
<p>This is currently really bad in Qubes Debian templates. Any compromised user (not only user <code>user</code>) can use <code>su</code> without a password and gain root. (<a href="https://github.com/QubesOS/qubes-issues/issues/1128#issuecomment-511185971">bug reported here</a>)</p>
<p>Just learned that <code>qubes-template-debian-10-minimal</code> comes without passwordless root by default. This is documented here:<br>
<a href="https://www.qubes-os.org/doc/templates/minimal/#passwordless-root">https://www.qubes-os.org/doc/templates/minimal/#passwordless-root</a><br>
Quote:</p>
<blockquote>
<p>It is an intentional design choice for <a href="https://www.qubes-os.org/doc/vm-sudo/">Passwordless Root Access in VMs</a> to be optional in Minimal TemplateVMs. Since the Minimal TemplateVMs are <em>minimal</em> , they are not configured for passwordless root by default. To update or install packages, execute the following command in dom0 (where <code>X</code> is your distro and version number):</p>
<pre><code class="lang-auto">[user@dom0 ~]$ qvm-run -u root X-minimal xterm
</code></pre>
<p>This opens a root terminal in the Minimal TemplateVM, from which you can use execute root commands without <code>sudo</code> . You will have to do this every time if you choose not to enable passwordless root.</p>
<p>If you want to be able to use <code>sudo</code> inside a Minimal TemplateVM (or TemplateBasedVMs based on a Minimal TemplateVM), open a root terminal as just instructed, then install the <code>qubes-core-agent-passwordless-root</code> package.</p>
<p>Optionally, verify that passwordless root now works by opening a normal (non-root) xterm window in the Minimal TemplateVM, then issue the command <code>sudo -l</code> . This should give you output that includes the <code>NOPASSWD</code> keyword.</p>
</blockquote>
<p>In Qubes Debian minimal templates user <code>user</code> is also by default not a member of group <code>sudo</code>.</p>
<p>This is an excellent basis for Qubes-Whonix.<br>
(Which is already based on Qubes Debian minimal templates.)</p>
<p>Qubes-Whonix package <code>qubes-whonix-shared-packages-recommended</code> currently <code>Depends:</code> on <code>qubes-core-agent-passwordless-root</code>. This dependency could be dropped.</p>
<p>The question is, how users could easily gain root then. In dom0 command line:</p>
<blockquote>
<p>qvm-run -u root X-minimal xterm</p>
</blockquote>
<p>Or</p>
<blockquote>
<p>qvm-run -u root X-minimal xfce4-terminal</p>
</blockquote>
<p>Usability issue. Which may be fixable. More on that below.</p>
<p>Security issue? Better than the default we have now. However, I am not sure if that is non-ideal security wise. Running a GUI application as root? Maybe a better default would be if a user <code>admin</code> would be a member of group <code>sudo</code> by default? Then open a terminal as user <code>admin</code> and allow <code>admin</code> to use <code>sudo</code> without a password?</p>
<p>Usability. Somehow add a Qubes start menu entry. Not sure that is yet supported by Qubes to run something as a different user from Qubes start menu.</p>
<p>Example:</p>
<p>dom0</p>
<pre><code>cat .local/share/qubes-appmenus/debian-10/apps.templates/xfce4-terminal.desktop
</code></pre>
<blockquote>
<p>[Desktop Entry]<br>
…<br>
Exec=qvm-run -q -a --service – %VMNAME% qubes.StartApp+xfce4-terminal</p>
</blockquote>
<p>We’d have to use <code>qvm-run -u admin</code>. That may require Qubes dom0 enhancements.</p>
<p>If these aren’t coming / too late, maybe we could work around that limitation somehow. Perhaps an /etc/sudoers.d exception. Maybe a dom0 yes/no prompt using qrexec.</p>
          <p><a href="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561/1</link>
        <pubDate>Wed, 27 Nov 2019 13:43:18 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8561-1</guid>
        <source url="http://forums.whonix.org/t/qubes-sudo-su-root-hardening-development-discussion/8561.rss">Qubes sudo / su / root Hardening - Development Discussion</source>
      </item>
  </channel>
</rss>
