<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</title>
    <link>http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192</link>
    <description>In the wiki it is stated:
[quote]
The XML files are configured to point to the default storage location of: /var/lib/libvirt/images These steps will show how to move the images there in order for the machines to boot.

Note: It is highly recommended you use this default path for storing the images to avoid any conflicts with AppArmor or SELinux, which will prevent the machines from booting. 
[/quote]
Source: https://www.whonix.org/wiki/KVM#Moving_Whonix_Image_Files

Well, i don&#39;t have enough disk space in my /var partition and thus want to store the whonix images on a partition of another hard drive which is not mounted by default.

I see that i have to edit the XML files for the storage location.
But what steps do i have to do, to make AppArmor work with it the way it should work?

For example, at the moment my whonix workstation and gateway images are located in:
/media/truecrypt1/whonix/

The folder whonix does have my user account as owner.
And the truecrypt container file is stored on another drive in 
/media/drivename/tc/data.tc
This another drive is not mounted by default after booting the system.
The same applies to the truecrypt container file. I only want to open it, when i need to use Whonix and Tor.

What steps do i have to do, to make AppArmor working with this kind of configuration?</description>
    <language>en</language>
    <lastBuildDate>Wed, 24 Apr 2019 12:25:38 +0000</lastBuildDate>
    <category>KVM</category>
    <atom:link href="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <p>Thanks a lot for your help.</p>
          <p><a href="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/5</link>
        <pubDate>Wed, 24 Apr 2019 12:25:38 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7192-5</guid>
        <source url="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192.rss">Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</source>
      </item>
      <item>
        <title>Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>You’re all set. I will add your permissions step on there. <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/4</link>
        <pubDate>Wed, 24 Apr 2019 01:06:20 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7192-4</guid>
        <source url="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192.rss">Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</source>
      </item>
      <item>
        <title>Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="2" data-topic="7192">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v3/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>I can see that the documentation is confusing so I need your help verifying if apparmor does work for images in alternative locations and I’ll fix it up.</p>
</blockquote>
</aside>
<p>Okay.</p>
<aside class="quote no-group">
<blockquote>
<p>Run:<br>
<code>sudo aa-status</code></p>
<p>and see if you get something like:</p>
<blockquote>
<p>processes are in enforce mode :<br>
…</p>
<p>libvirt-a22e3930-d87a-584e-22b2-1d8950212bac (6089)</p>
</blockquote>
</blockquote>
</aside>
<p>I am running Kubuntu 16.04 LTS on this machine and i get the following output:</p>
<pre><code class="lang-auto">sudo aa-status
[sudo] Passwort für XXXXXXXX: 
apparmor module is loaded.
28 profiles are loaded.
28 profiles are in enforce mode.
   /sbin/dhclient
   /usr/bin/freshclam
   /usr/lib/NetworkManager/nm-dhcp-client.action
   /usr/lib/NetworkManager/nm-dhcp-helper
   /usr/lib/connman/scripts/dhclient-script
   /usr/lib/cups/backend/cups-pdf
   /usr/lib/libvirt/virt-aa-helper
   /usr/lib/lightdm/lightdm-guest-session
   /usr/lib/lightdm/lightdm-guest-session//chromium
   /usr/lib/snapd/snap-confine
   /usr/lib/snapd/snap-confine//mount-namespace-capture-helper
   /usr/lib/telepathy/mission-control-5
   /usr/lib/telepathy/telepathy-*
   /usr/lib/telepathy/telepathy-*//pxgsettings
   /usr/lib/telepathy/telepathy-*//sanitized_helper
   /usr/lib/telepathy/telepathy-ofono
   /usr/sbin/cups-browsed
   /usr/sbin/cupsd
   /usr/sbin/cupsd//third_party
   /usr/sbin/ippusbxd
   /usr/sbin/libvirtd
   /usr/sbin/mysqld-akonadi
   /usr/sbin/mysqld-akonadi///usr/sbin/mysqld
   /usr/sbin/tcpdump
   libvirt-2f9fc84b-6054-42b0-bdf9-35be96d1ccd6
   libvirt-2f9fc84b-6054-42b0-bdf9-35be96d1ccd6//qemu_bridge_helper
   libvirt-d241b502-f98b-4e74-8740-61b5877fd3c3
   libvirt-d241b502-f98b-4e74-8740-61b5877fd3c3//qemu_bridge_helper
0 profiles are in complain mode.
10 processes have profiles defined.
10 processes are in enforce mode.
   /sbin/dhclient (3073) 
   /usr/bin/freshclam (1265) 
   /usr/lib/telepathy/mission-control-5 (2412) 
   /usr/sbin/cups-browsed (3567) 
   /usr/sbin/cupsd (3565) 
   /usr/sbin/cupsd (3574) 
   /usr/sbin/libvirtd (1486) 
   /usr/sbin/mysqld-akonadi///usr/sbin/mysqld (2625) 
   libvirt-2f9fc84b-6054-42b0-bdf9-35be96d1ccd6 (7667) 
   libvirt-d241b502-f98b-4e74-8740-61b5877fd3c3 (7554) 
0 processes are in complain mode.
0 processes are unconfined but have a profile defined.</code></pre>
<p>So there’s are two processes called:</p>
<aside class="quote no-group">
<blockquote>
<p>libvirt-2f9fc84b-6054-42b0-bdf9-35be96d1ccd6 (7667)<br>
libvirt-d241b502-f98b-4e74-8740-61b5877fd3c3 (7554)</p>
</blockquote>
</aside>
<aside class="quote no-group">
<blockquote>
<p>Make sure Whonix VMs in the alternate location is the only machines up and running to avoid wrong results.</p>
</blockquote>
</aside>
<p>Okay. I will also read the articles you mentioned.</p>
<p>At the moment i have edited the XML files, i also had to adjust the file permission<br>
of my /media/truecrypt/whonix/ folder to</p>
<aside class="quote no-group">
<blockquote>
<p>drwxr-xr-x 2 XXXXXXX XXXXXXX  4096 Apr 23 10:41 whonix</p>
</blockquote>
</aside>
<p>with</p>
<aside class="quote no-group">
<blockquote>
<p>sudo chmod og+xr /media/truecrypt/whonix/</p>
</blockquote>
</aside>
<p>So that the virtual machine manager was able to access the files.</p>
<p>BTW, the virtual machine manager also changed the owner of the whonix image files from my username to root automatically.</p>
          <p><a href="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/3</link>
        <pubDate>Tue, 23 Apr 2019 09:26:57 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7192-3</guid>
        <source url="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192.rss">Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</source>
      </item>
      <item>
        <title>Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="1" data-topic="7192">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v3/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>What steps do i have to do, to make AppArmor working with this kind of configuration?</p>
</blockquote>
</aside>
<p>I can see that the documentation is confusing so I need your help verifying if apparmor does work for images in alternative locations and I’ll fix it up.</p>
<p>Run:<br>
<code>sudo aa-status</code></p>
<p>and see if you get something like:</p>
<blockquote>
<p>processes are in enforce mode :<br>
…</p>
<p>libvirt-a22e3930-d87a-584e-22b2-1d8950212bac (6089)</p>
</blockquote>
<p>Make sure Whonix VMs in the alternate location is the only machines up and running to avoid wrong results.</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://s1.wp.com/i/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://blog.strandboge.com/2009/11/03/apparmor-svirt-security-driver-for-libvirt/" target="_blank" title="07:42PM - 03 November 2009" rel="nofollow noopener">Blog: jdstrand – 3 Nov 09</a>
  </header>
  <article class="onebox-body">
    <img src="https://s0.wp.com/i/blank.jpg" class="thumbnail" width="" height="">

<h3><a href="https://blog.strandboge.com/2009/11/03/apparmor-svirt-security-driver-for-libvirt/" target="_blank" rel="nofollow noopener">AppArmor sVirt security driver for libvirt</a></h3>

<p>Background Ubuntu has been using libvirt as part of its recommended virtualization management toolkit since Ubuntu 8.04 LTS. In short, libvirt provides a set of tools and APIs for managing virtual …</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/2</link>
        <pubDate>Mon, 22 Apr 2019 13:49:03 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7192-2</guid>
        <source url="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192.rss">Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</source>
      </item>
      <item>
        <title>Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <p>In the wiki it is stated:</p>
<aside class="quote no-group">
<blockquote>
<p>The XML files are configured to point to the default storage location of: /var/lib/libvirt/images These steps will show how to move the images there in order for the machines to boot.</p>
<p>Note: It is highly recommended you use this default path for storing the images to avoid any conflicts with AppArmor or SELinux, which will prevent the machines from booting.</p>
</blockquote>
</aside>
<p>Source: <a href="https://www.whonix.org/wiki/KVM#Moving_Whonix_Image_Files" rel="nofollow noopener">https://www.whonix.org/wiki/KVM#Moving_Whonix_Image_Files</a></p>
<p>Well, i don’t have enough disk space in my /var partition and thus want to store the whonix images on a partition of another hard drive which is not mounted by default.</p>
<p>I see that i have to edit the XML files for the storage location.<br>
But what steps do i have to do, to make AppArmor work with it the way it should work?</p>
<p>For example, at the moment my whonix workstation and gateway images are located in:<br>
/media/truecrypt1/whonix/</p>
<p>The folder whonix does have my user account as owner.<br>
And the truecrypt container file is stored on another drive in<br>
/media/drivename/tc/data.tc<br>
This another drive is not mounted by default after booting the system.<br>
The same applies to the truecrypt container file. I only want to open it, when i need to use Whonix and Tor.</p>
<p>What steps do i have to do, to make AppArmor working with this kind of configuration?</p>
          <p><a href="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192/1</link>
        <pubDate>Mon, 22 Apr 2019 05:54:15 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7192-1</guid>
        <source url="http://forums.whonix.org/t/cant-use-var-lib-libvirt-images-for-whonix-images-what-to-do-about-apparmor/7192.rss">Can&#39;t use /var/lib/libvirt/images for whonix images - What to do about apparmor?</source>
      </item>
  </channel>
</rss>
