<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy - #146 by Patrick - AppArmor - Whonix Forum</title>
    <meta name="description" content="Currently, Whonix only has AppArmor profiles for a few high-risk applications. This isn’t the best. It would be much better to have everything confined by default, including init which would greatly increase security. 
T&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../8339fdfa.html?page=8" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../../c/news/21.html">NEWS</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy&#39;" href="../8339.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/apparmor-for-complete-system-including-init-pid1-systemd-everything-full-system-mac-policy/8339/146" />
<meta name="twitter:url" content="https://forums.whonix.org/t/apparmor-for-complete-system-including-init-pid1-systemd-everything-full-system-mac-policy/8339/146" />
<meta property="og:title" content="AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy" />
<meta name="twitter:title" content="AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy" />
<meta property="og:description" content="Yes, we shouldn’t make this a usability mess.  There is even recovery mode (already, standard feature of any/most linux distribution).   That even root cannot escalate to kernel space. Therefore cannot (or harder) to attack the virtualizer or install a rootkit. This might break various malware or exclude classes of exploits.  related: Untrusted Root - improve Security by Restricting Root   Makes sense as per above. apt dist-upgradeing the system while preventing third party repositories.   Yes,..." />
<meta name="twitter:description" content="Yes, we shouldn’t make this a usability mess.  There is even recovery mode (already, standard feature of any/most linux distribution).   That even root cannot escalate to kernel space. Therefore cannot (or harder) to attack the virtualizer or install a rootkit. This might break various malware or exclude classes of exploits.  related: Untrusted Root - improve Security by Restricting Root   Makes sense as per above. apt dist-upgradeing the system while preventing third party repositories.   Yes,..." />
<meta property="article:published_time" content="2019-11-20T17:05:45+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="prev" href="../8339235c.html?page=7">
        <link rel="next" href="../83390b08.html?page=9">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../../index.html">
          <img src="../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="../8339.html">AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../../external.html?link=http://schema.org/ListItem">
            <a href="../../../c/apparmor/14.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #12A89D'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>AppArmor</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T08:50:29Z' class='post-time'>
                November 20, 2019,  8:50am
              </time>
              <meta itemprop='dateModified' content='2019-11-20T08:50:29Z'>
          <span itemprop='position'>#140</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Probably best to develop this on plain Debian? (Non-Whonix) Worry about Whonix integration later. Does this work on Debian yet?</p>
<p>There is a lot of bad things a compromised root can do with <code>mount</code> such as remounting apt / rapt with a script of its choice. Not sure how this could be contained? Can you let the “system” use <code>mount</code> but any “users” (those using serial console, virtual terminal or ) not using <code>mount</code>?</p>
<p>Since initrd is unconfined for now… Are there things in initrd (processes) which are still lingering after boot and unconfined? Writing to the initrd (in memory, not disk image after booting is done shouldn’t have bad effects and is blocked anyhow?</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/HulaHoop'><span itemprop='name'>HulaHoop</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T15:12:28Z' class='post-time'>
                November 20, 2019,  3:12pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T15:12:28Z'>
          <span itemprop='position'>#141</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="139" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>And later if no-root gets implemented…</p>
</blockquote>
</aside>
<p>Thinking about this to prevent choice proliferation:</p>
<p>What would be the use case for a root system <em>with</em> apparmor everything?</p>
<aside class="quote no-group" data-post="139" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Now we have more suggestions which could be different boot modes.</p>
<ul>
<li>“read-only root” (no modifications at all) [0]</li>
<li>No arbitrary apt package installation.</li>
</ul>
</blockquote>
</aside>
<p>You might as well make no-apt synonymous with apparmor-everything because there is no functional advantage to having apt on a system with apparmor-everything (unless you are editing system policy and adding support for more programs).</p>
<p>These are the only boot combinations that make sense to me:</p>
<p>persistent + full-root (DANGER!)<br>
persistent + no-root<br>
persistent + no-root [apparmor-profile-everything]<br>
live + root <strong>(*)</strong><br>
live + no-root<br>
live + no-root [apparmor-profile-everything]</p>
<p><strong>(*)</strong> I am not sure there’s any useful usecase for having full root in live mode since you can install stuff in no-root mode without needing the full root access.</p>
<aside class="quote no-group" data-post="139" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Perhaps this is the same as “noroot boot mode”? Perhaps the “noroot boot mode” should have a more restrictive full system apparmor profile?</p>
</blockquote>
</aside>
<p>On the contrary. This mode would be useful if a user wants to install and use arbitrary packages  from a safe source without risking full system compromise in case the software has a vuln. Apparmor-everything would make this impossible I think.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T16:44:44Z' class='post-time'>
                November 20, 2019,  4:44pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T16:44:44Z'>
          <span itemprop='position'>#142</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="139" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I don’t know what <a class="mention" href="../../../../external.html?link=https://forums.whonix.org/u/madaidan">@madaidan</a> thinks about a “no APT” or “no writing to /etc/ /usr/bin” or “non-admin” boot mode.</p>
</blockquote>
</aside>
<p>I don’t think there should be a “no apt” boot mode. Just unneeded complexity.</p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>What would be the use case for a root system <em>with</em> apparmor everything?</p>
</blockquote>
</aside>
<p>Root is far more privileged than ordinary users even with apparmor everything.</p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>You might as well make no-apt synonymous with apparmor-everything because there is no functional advantage to having apt on a system with apparmor-everything</p>
</blockquote>
</aside>
<p>Yes there is. Apt works fine with apparmor-profile-everything. Even kernel updates do.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T16:53:32Z' class='post-time'>
                November 20, 2019,  4:53pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T16:53:32Z'>
          <span itemprop='position'>#143</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="140" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Probably best to develop this on plain Debian? (Non-Whonix) Worry about Whonix integration later. Does this work on Debian yet?</p>
</blockquote>
</aside>
<p>I haven’t tested it on Debian and I don’t see why we’d want to when getting it working in Whonix is our main goal.</p>
<aside class="quote no-group" data-post="140" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>There is a lot of bad things a compromised root can do with <code>mount</code> such as remounting apt / rapt with a script of its choice.</p>
</blockquote>
</aside>
<p>Is that possible without being able to write to rapt? All binaries/libraries are read-only by default (except in the apt-get profile).</p>
<aside class="quote no-group" data-post="140" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Can you let the “system” use <code>mount</code> but any “users” (those using serial console, virtual terminal or ) not using <code>mount</code> ?</p>
</blockquote>
</aside>
<p>We can probably restrict it to specific users with <a href="../../../../external.html?link=https://gitlab.com/apparmor/apparmor/wikis/AppArmorMLS">MLS</a> but preventing even root from doing it won’t work as root is what mounts/unmounts the filesystems at boot/shutdown.</p>
<p>The best option I can think of is to restrict <code>mount</code> to specific directories and mount options <a href="../../../../external.html?link=https://manpages.debian.org/buster/apparmor/apparmor.d.5.en.html#Mount_Rules">https://manpages.debian.org/buster/apparmor/apparmor.d.5.en.html#Mount_Rules</a></p>
<aside class="quote no-group" data-post="140" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Since initrd is unconfined for now… Are there things in initrd (processes) which are still lingering after boot and unconfined?</p>
</blockquote>
</aside>
<p>Initrd is temporary and only used to prepare the actual root filesystem. I don’t think there’s anything lingering after boot.</p>
<p>Besides, I don’t see how it would even be possible to confine the initrd unless somehow modifying the bootloader to only run the initrd in apparmor.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T16:59:43Z' class='post-time'>
                November 20, 2019,  4:59pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T16:59:43Z'>
          <span itemprop='position'>#145</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="122" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Alternatively (or both for defense in depth), we can make the initramfs hook check if the needed files are there and if not, shuts down.</p>
</blockquote>
</aside>
<p>Would this still make sense with <code>rapt</code>'s package removal blacklist?</p>
<p>I think it would be good for defense in depth. We can also verify hashes to be sure.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T17:05:45Z' class='post-time'>
                November 20, 2019,  5:05pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T17:05:45Z'>
          <span itemprop='position'>#146</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>Thinking about this to prevent choice proliferation:</p>
</blockquote>
</aside>
<p>Yes, we shouldn’t make this a usability mess.<br>
There is even recovery mode (already, standard feature of any/most linux distribution).</p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>What would be the use case for a root system <em>with</em> apparmor everything?</p>
</blockquote>
</aside>
<p>That even root cannot escalate to kernel space. Therefore cannot (or harder) to attack the virtualizer or install a rootkit. This might break various malware or exclude classes of exploits.</p>
<p>related: <a href="../../untrusted-root-improve-security-by-restricting-root/7998.html" class="inline-onebox">Untrusted Root - improve Security by Restricting Root</a></p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>You might as well make no-apt synonymous with apparmor-everything because there is no functional advantage to having apt on a system with apparmor-everything</p>
</blockquote>
</aside>
<p>Makes sense as per above. apt dist-upgradeing the system while preventing third party repositories.</p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>These are the only boot combinations that make sense to me:</p>
<p>persistent + full-root (DANGER!)</p>
</blockquote>
</aside>
<p>Yes, aka “full admin mode”. Just as Whonix works right now.</p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>persistent + no-root<br>
persistent + no-root [apparmor-profile-everything]</p>
</blockquote>
</aside>
<p>I don’t see what the latter would be good for.</p>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>live + root <strong>(*)</strong></p>
</blockquote>
</aside>
<aside class="quote no-group" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p><strong>(*)</strong> I am not sure there’s any useful usecase for having full root in live mode since you can install stuff in no-root mode without needing the full root access.</p>
</blockquote>
</aside>
<p>live+noroot: Install software to home folder and execute it?<br>
live+root: could install software from repository. Test upgrades. (The test’s usefulness is limited but non-zero.)<br>
Tails has an optional root mode for live sessions too.<br>
But indeed, I am not sure a live+root option is important enough to have it easily accessible through grub boot menu as our space there is limited. Could be accessible in custom configurations / grub manual boot kernel parameter.</p>
<aside class="quote no-group quote-modified" data-post="141" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<blockquote>
<p>Perhaps this is the same as “noroot boot mode”? Perhaps the “noroot boot mode” should have a more restrictive full system apparmor profile?</p>
</blockquote>
<p>On the contrary. This mode would be useful if a user wants to install and use arbitrary packages from a safe source</p>
</blockquote>
</aside>
<p>noroot: install to home folder?<br>
noroot meaning: “sudo apt” cannot be used.</p>
<aside class="quote no-group" data-post="142" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>I don’t think there should be a “no apt” boot mode. Just unneeded complexity.</p>
</blockquote>
</aside>
<p>Ok.</p>
<p>Since you’re implementing this, that’s fair. Also indeed too many options may be confusing. We can’t perfect this in every aspect for every use case.</p>
<aside class="quote no-group quote-modified" data-post="143" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<blockquote>
<p>There is a lot of bad things a compromised root can do with <code>mount</code> such as remounting apt / rapt with a script of its choice.</p>
</blockquote>
<p>Is that possible without being able to write to rapt? All binaries/libraries are read-only by default (except in the apt-get profile).</p>
</blockquote>
</aside>
<p>Yes. Any file can be remounted with any other file. Another file can be mounted “on top” of another file. The file “below” will be no longer accessible (as much as I know).</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T17:09:22Z' class='post-time'>
                November 20, 2019,  5:09pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T17:09:22Z'>
          <span itemprop='position'>#147</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="146" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Any file can be remounted with any other file. Another file can be mounted “on top” of another file. The file “below” will be no longer accessible (as much as I know).</p>
</blockquote>
</aside>
<p>Then in that case, until we properly restrict mount rules, wouldn’t <code>deny mount /usr/bin/rapt,</code> be enough?</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-20T17:12:30Z' class='post-time'>
                November 20, 2019,  5:12pm
              </time>
              <meta itemprop='dateModified' content='2019-11-20T17:12:30Z'>
          <span itemprop='position'>#148</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group quote-modified" data-post="145" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<blockquote>
<p>Alternatively (or both for defense in depth), we can make the initramfs hook check if the needed files are there and if not, shuts down.</p>
</blockquote>
<p>Would this still make sense with <code>rapt</code> 's package removal blacklist?</p>
</blockquote>
</aside>
<p>No, I wouldn’t know a good reason for that now. Threat model is here: an attacker specifically targeting apparmor-profile-everything, right? An attacker that manages to remove apparmor even though rapt should prevent that probably has sufficient capability to also modify initrd.</p>
<aside class="quote no-group" data-post="145" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>We can also verify hashes to be sure.</p>
</blockquote>
</aside>
<p>Not easy. Create the hashed. Or get them. From where. Then at initramfs time, make sure they’ve not been tampered with. And update these hashes after upgrades to avoid false positives. Seems really complex. Hopefully not needed.</p>
<aside class="quote no-group quote-modified" data-post="147" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<blockquote>
<p>Any file can be remounted with any other file. Another file can be mounted “on top” of another file. The file “below” will be no longer accessible (as much as I know).</p>
</blockquote>
<p>Then in that case, until we properly restrict mount rules, wouldn’t <code>deny mount /usr/bin/rapt,</code> be enough?</p>
</blockquote>
</aside>
<p>I don’t think so. Because rapt will be using bash and apt. And these need libraries. By re-mourning any library files with malicious versions, anything is possible. The mount command opens the door for a lot creativity.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-22T19:56:02Z' class='post-time'>
                November 22, 2019,  7:56pm
              </time>
              <meta itemprop='dateModified' content='2019-11-22T19:56:02Z'>
          <span itemprop='position'>#149</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Android seems to use an equivalent of apparmor environment scrubbing (AT_SECURE on everything).</p>
<p><a href="../../../../external.html?link=https://android.googlesource.com/platform/system/sepolicy/+/refs/heads/master/public/init.te#597" class="onebox" target="_blank">https://android.googlesource.com/platform/system/sepolicy/+/refs/heads/master/public/init.te#597</a></p>
<pre><code class="lang-auto"># The use of sensitive environment variables, such as LD_PRELOAD, is disallowed
# when init is executing other binaries. The use of LD_PRELOAD for init spawned
# services is generally considered a no-no, as it injects libraries which the
# binary was not expecting. This is especially problematic for APEXes. The use
# of LD_PRELOAD via APEXes is a layering violation, and inappropriately loads
# code into a process which wasn't expecting that code, with potentially
# unexpected side effects.
</code></pre>
<p>I’m thinking of using apparmor’s environment scrubbing on all binaries although that would break using LD_PRELOAD for hardened_malloc.</p>
<p>Also, using a different environment for apt is not enough. Attackers can still write to <code>/etc/ld.so.preload</code> and other <code>/etc/ld.so.*</code> files so everything preloads their malicious library, including apt even with a new environment.</p>
<p>But, using environment scrubbing and disallowing writing to <code>/etc/ld.so.preload</code> will prevent us from using hardened_malloc at all unless we build it into glibc ourselves which doesn’t seem like a good idea unless debian provides a <code>glibc-hardened-malloc</code> package or similar.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick_mobile'><span itemprop='name'>Patrick_mobile</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T03:51:31Z' class='post-time'>
                November 23, 2019,  3:51am
              </time>
              <meta itemprop='dateModified' content='2019-11-23T03:51:31Z'>
          <span itemprop='position'>#150</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I would say go for ld preload scrubbing. Far to dangerous. And I don’t think users use hardened malloc much. (We’d have to preconfigure that and/or simply.)</p>
<p>Could we have a wrapper that adds hardened malloc ld preload?</p>
<p>Also sudo can filter env vars. Maybe some “sudo - u user something” sudoers exception could help?</p>
<p>Maybe a wrapper script (whitelisted in apparmor) that sets hardened malloc ld preload?</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T07:09:52Z' class='post-time'>
                November 23, 2019,  7:09am
              </time>
              <meta itemprop='dateModified' content='2019-11-23T07:09:52Z'>
          <span itemprop='position'>#151</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="131" data-topic="8339" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p><a class="mention" href="../../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a> have you tested this on Qubes yet?</p>
</blockquote>
</aside>
<p>With Qubes dom0 kernel:</p>
<p>Does not work with dom0 kernel. This is expected since by using dom0 kernel it also used dom0 initrd. Therefore apparmor-profile-everything cannot function. The good news about this is, that it does not seem to break anything either.</p>
<p><code>sudo aa-status</code></p>
<blockquote>
<p>apparmor module is loaded.<br>
16 profiles are loaded.<br>
16 profiles are in enforce mode.<br>
/**/*-browser/Browser/firefox<br>
/usr/bin/apt-get<br>
/usr/bin/man<br>
/usr/bin/whonixcheck<br>
/usr/lib/sdwdate/url_to_unixtime<br>
/usr/lib/security-misc/pam_tally2-info<br>
/usr/lib/security-misc/permission-lockdown<br>
/usr/sbin/haveged<br>
bootclockrandomization<br>
firejail-default<br>
init-systemd<br>
man_filter<br>
man_groff<br>
nvidia_modprobe<br>
nvidia_modprobe//kmod<br>
system_tor<br>
0 profiles are in complain mode.<br>
1 processes have profiles defined.<br>
1 processes are in enforce mode.<br>
/usr/sbin/haveged (519)<br>
0 processes are in complain mode.<br>
0 processes are unconfined but have a profile defined.</p>
</blockquote>
<hr>
<p>With <a href="../../../../external.html?link=https://www.qubes-os.org/doc/managing-vm-kernel/">Qubes VM Kernel</a>:</p>
<p>Results coming soon.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T10:51:00Z' class='post-time'>
                November 23, 2019, 10:51am
              </time>
              <meta itemprop='dateModified' content='2019-11-23T10:51:00Z'>
          <span itemprop='position'>#152</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <blockquote>
<p>Nov 23 10:49:09 host audit[961]: AVC apparmor=“DENIED” operation=“exec” profile="/usr/lib/security-misc/pam_tally2-info" name="/usr/sbin/pam_tally2" pid=961 comm=“pam_tally2-info” requested_mask=“x” denied_mask=“x” fsuid=0 ouid=0<br>
Nov 23 10:49:09 host audit[961]: AVC apparmor=“DENIED” operation=“open” profile="/usr/lib/security-misc/pam_tally2-info" name="/usr/sbin/pam_tally2" pid=961 comm=“pam_tally2-info” requested_mask=“r” denied_mask=“r” fsuid=0 ouid=0<br>
Nov 23 10:49:09 host kernel: audit: type=1400 audit(1574506149.778:19): apparmor=“DENIED” operation=“exec” profile="/usr/lib/security-misc/pam_tally2-info" name="/usr/sbin/pam_tally2" pid=961 comm=“pam_tally2-info” requested_mask=“x” denied_mask=“x” fsuid=0 ouid=0<br>
Nov 23 10:49:09 host kernel: audit: type=1400 audit(1574506149.778:20): apparmor=“DENIED” operation=“open” profile="/usr/lib/security-misc/pam_tally2-info" name="/usr/sbin/pam_tally2" pid=961 comm=“pam_tally2-info” requested_mask=“r” denied_mask=“r” fsuid=0 ouid=0</p>
</blockquote>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T10:54:04Z' class='post-time'>
                November 23, 2019, 10:54am
              </time>
              <meta itemprop='dateModified' content='2019-11-23T10:54:04Z'>
          <span itemprop='position'>#153</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="onebox githubcommit">
  <header class="source">
      <a href="../../../../external.html?link=https://github.com/Whonix/security-misc/commit/d32024a3da3cdfbb07f61dd3e9a52535e747de6b" target="_blank">github.com/Whonix/security-misc</a>
  </header>
  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Commit">
    <svg width="60" height="60" class="github-icon" viewbox="0 0 14 16" aria-hidden="true"><path d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="../../../../external.html?link=https://github.com/Whonix/security-misc/commit/d32024a3da3cdfbb07f61dd3e9a52535e747de6b" target="_blank">/usr/sbin/pam_tally2 mrix,</a>
    </h4>

    <div class="github-info">
      <div class="date">
        committed <span class="discourse-local-date" data-format="ll" data-date="2019-11-23" data-time="10:53:19" data-timezone="UTC">10:53AM - 23 Nov 19 UTC</span>
      </div>

      <div class="user">
        <a href="../../../../external.html?link=https://github.com/adrelanos" target="_blank">
          <img alt="adrelanos" src="../../../../external.html?link=https://avatars3.githubusercontent.com/u/1985040?v=4" class="onebox-avatar-inline" width="20" height="20">
          adrelanos
        </a>
        
      </div>

      <div class="lines" title="changed 1 files with 1 additions and 0 deletions">
        <a href="../../../../external.html?link=https://github.com/Whonix/security-misc/commit/d32024a3da3cdfbb07f61dd3e9a52535e747de6b" target="_blank">
          <span class="added">+1</span>
          <span class="removed">-0</span>
        </a>
      </div>
    </div>

  </div>
</div>


  <div class="github-row">
    <pre class="github-content" style="white-space: normal;">https://forums.whonix.org/t/apparmor-for-complete-system-including-init-pid1-systemd-everything-full-system-mac-policy/8339/152</pre>
  </div>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T11:12:16Z' class='post-time'>
                November 23, 2019, 11:12am
              </time>
              <meta itemprop='dateModified' content='2019-11-23T11:12:16Z'>
          <span itemprop='position'>#154</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="131" data-topic="8339" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p><a class="mention" href="../../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a> have you tested this on Qubes yet?</p>
</blockquote>
</aside>
<p>No, doesn’t work yet.</p>
<aside class="quote no-group" data-post="151" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>With <a href="../../../../external.html?link=https://www.qubes-os.org/doc/managing-vm-kernel/">Qubes VM Kernel</a>:</p>
<p>Results coming soon.</p>
</blockquote>
</aside>
<p><code>cat /proc/version</code></p>
<blockquote>
<p>Linux version 4.19.0-6-amd64 (<a href="mailto:debian-kernel@lists.debian.org">debian-kernel@lists.debian.org</a>) (gcc version 8.3.0 (Debian 8.3.0-6)) <span class="hashtag">#1</span> SMP Debian 4.19.67-2+deb10u2 (2019-11-11)</p>
</blockquote>
<p><code>sudo aa-status</code></p>
<blockquote>
<p>apparmor module is loaded.<br>
16 profiles are loaded.<br>
16 profiles are in enforce mode.<br>
/**/*-browser/Browser/firefox<br>
/usr/bin/apt-get<br>
/usr/bin/man<br>
/usr/bin/whonixcheck<br>
/usr/lib/sdwdate/url_to_unixtime<br>
/usr/lib/security-misc/pam_tally2-info<br>
/usr/lib/security-misc/permission-lockdown<br>
/usr/sbin/haveged<br>
bootclockrandomization<br>
firejail-default<br>
init-systemd<br>
man_filter<br>
man_groff<br>
nvidia_modprobe<br>
nvidia_modprobe//kmod<br>
system_tor<br>
0 profiles are in complain mode.<br>
1 processes have profiles defined.<br>
1 processes are in enforce mode.<br>
/usr/sbin/haveged (431)<br>
0 processes are in complain mode.<br>
0 processes are unconfined but have a profile defined.</p>
</blockquote>
<p><code>[user@dom0 ~]$ sudo xl console whonix-ws-15</code></p>
<blockquote>
<p>.[30m.[47mWelcome to GRUB!</p>
<p>.[37m.[40m.[37m.[40m.[37m.[40m.[3;35H      [ grub-xen.cfg  424B  100%  1.53KiB/s ].[3;1Herror: no such device: /boot/xen/pvboot-x86_64.elf.<br>
Reading (xen/xvda,gpt3/boot/grub/grub.cfg<br>
.[H.[J.[1;1H.[1;36H      [ grub.cfg  5.67KiB  100%  8.15KiB/s ].[1;1Herror: file <code>/boot/grub/fonts/unicode.pf2' not found. error: no suitable video mode found. .[H.[J.[1;1H  Booting </code>Whonix GNU/Linux’</p>
<p>Loading Linux 4.19.0-6-amd64 …<br>
.[4;24H      [ vmlinuz-4.19.0-6-amd  5.03MiB  100%  4.95MiB/s ].[4;1HLoading initial ramdisk …<br>
.[5;22H      [ initrd.img-4.19.0-6-  25.46MiB  100%  23.39MiB/s ].[5;1H[    0.000000] Linux version 4.19.0-6-amd64 (<a href="mailto:debian-kernel@lists.debian.org">debian-kernel@lists.debian.org</a>) (gcc version 8.3.0 (Debian 8.3.0-6)) <span class="hashtag">#1</span> SMP Debian 4.19.67-2+deb10u2 (2019-11-11)<br>
[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-4.19.0-6-amd64 root=/dev/xvda3 ro xen_scrub_pages=0 root=/dev/mapper/dmroot console=hvc0 console=tty0 swiotlb=8192 noresume intel_iommu=on amd_iommu=on slab_nomerge slub_debug=FZP mce=0 pti=on mds=full,nosmt</p>
</blockquote>
<p><code>user@host:~$ sudo update-initramfs -u</code></p>
<blockquote>
<p>update-initramfs: Generating /boot/initrd.img-4.19.0-6-amd64<br>
I: The initramfs will attempt to resume from /dev/xvdc1<br>
I: (UUID=aa5657bd-b175-42e0-93df-833b6cd3f8c7)<br>
I: Set the RESUME variable to override this.<br>
<code>user@host:~$ ls /boot/initrd.img-4.19.0-6-amd64</code><br>
/boot/initrd.img-4.19.0-6-amd64<br>
user@host:~$ ls -la /boot/<br>
total 31436<br>
drwxr-xr-x  3 root root     4096 Nov 23 11:09 .<br>
drwxr-xr-x 20 root root     4096 Nov 23 10:40 …<br>
-rw-r–r--  1 root root   206361 Nov 11 00:30 config-4.19.0-6-amd64<br>
drwxrwxr-x  2 root root     4096 Nov 23 10:43 grub<br>
-rw-r–r--  1 root root 26696863 Nov 23 11:09 initrd.img-4.19.0-6-amd64<br>
-rw-r–r--  1 root root  5270768 Nov 11 00:30 vmlinuz-4.19.0-6-amd6</p>
</blockquote>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T11:30:49Z' class='post-time'>
                November 23, 2019, 11:30am
              </time>
              <meta itemprop='dateModified' content='2019-11-23T11:30:49Z'>
          <span itemprop='position'>#155</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>The initrd looks alright in so far that it contains strings of the changes to initrd.</p>
<pre><code class="lang-auto">mkdir /tmp/initrd
cd /tmp/initrd
zcat /boot/initrd.img-4.19.0-6-amd64 | cpio -idmv
grep -r -i apparmor
</code></pre>
<blockquote>
<p>scripts/init-bottom/apparmor-profile-everything:echo “profile init-systemd /lib/systemd/systemd flags=(complain) {}” | /sbin/apparmor_parser -a<br>
scripts/init-bottom/ORDER:/scripts/init-bottom/apparmor-profile-everything “$@”<br>
Binary file usr/sbin/apparmor_parser matches<br>
Binary file usr/bin/udevadm matches<br>
Binary file usr/lib/systemd/systemd-udevd matches</p>
</blockquote>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T13:01:04Z' class='post-time'>
                November 23, 2019,  1:01pm
              </time>
              <meta itemprop='dateModified' content='2019-11-23T13:01:04Z'>
          <span itemprop='position'>#156</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="150" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/p/898d66/40.png" class="avatar"> Patrick_mobile:</div>
<blockquote>
<p>Maybe a wrapper script (whitelisted in apparmor) that sets hardened malloc ld preload?</p>
</blockquote>
</aside>
<p>The binary the wrapper script executes would have to be whitelisted. We can’t just whitelist the wrapper.</p>
<p>We could probably make a list of programs to use hardened_malloc with and whitelist them but then that would also allow any malicious LD_PRELOAD tricks on those programs.</p>
<p>Or, maybe we can make an issue on the apparmor gitlab repo about adding specific variables that can be whitelisted when using environment scrubbing if that’s even possible.</p>
<p>e.g.</p>
<pre><code>/bin/bash Pix allow_var="LD_PRELOAD=/usr/lib/libhardened_malloc.so",
</code></pre>
<p>So this would only allow preloading hardened_malloc and nothing else.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T15:17:02Z' class='post-time'>
                November 23, 2019,  3:17pm
              </time>
              <meta itemprop='dateModified' content='2019-11-23T15:17:02Z'>
          <span itemprop='position'>#157</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group quote-modified" data-post="154" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<blockquote>
<p><a class="mention" href="../../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a> have you tested this on Qubes yet?</p>
</blockquote>
<p>No, doesn’t work yet.</p>
</blockquote>
</aside>
<p>apparmor-profile-everything breaks Qubes upgrading<br>
<a href="../../../../external.html?link=https://phabricator.whonix.org/T936" class="onebox" target="_blank">https://phabricator.whonix.org/T936</a></p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T16:54:11Z' class='post-time'>
                November 23, 2019,  4:54pm
              </time>
              <meta itemprop='dateModified' content='2019-11-23T16:54:11Z'>
          <span itemprop='position'>#158</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="156" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>Or, maybe we can make an issue on the apparmor gitlab repo about adding specific variables that can be whitelisted when using environment scrubbing if that’s even possible.</p>
<p>e.g.</p>
<pre><code class="lang-auto">/bin/bash Pix allow_var="LD_PRELOAD=/usr/lib/libhardened_malloc.so",
</code></pre>
<p>So this would only allow preloading hardened_malloc and nothing else.</p>
</blockquote>
</aside>
<p>Thank you for submitting this feature request!</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../../external.html?link=https://gitlab.com/assets/favicon-7901bd695fb93edb07975966062049829afb56cf11511236e61bcf425070e36e.png" class="site-icon" width="16" height="16">
      <a href="../../../../external.html?link=https://gitlab.com/apparmor/apparmor/issues/66" target="_blank">GitLab</a>
  </header>
  <article class="onebox-body">
    <img src="../../../../external.html?link=https://gitlab.com/uploads/-/system/project/avatar/4484878/apparmor-red-diag_1w2h.png" class="thumbnail" width="" height="">

<h3><a href="../../../../external.html?link=https://gitlab.com/apparmor/apparmor/issues/66" target="_blank">Add a way to whitelist variables from environment scrubbing (#66) · Issues ·...</a></h3>

<p>I want to use [hardened_malloc](https://github.com/GrapheneOS/hardened_malloc) along with a binary that is executed with environment scrubbing. To use hardened_malloc, I need to use LD_PRELOAD which environment scrubbing clears. Because of this,...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/madaidan'><span itemprop='name'>madaidan</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T17:39:54Z' class='post-time'>
                November 23, 2019,  5:39pm
              </time>
              <meta itemprop='dateModified' content='2019-11-23T17:45:20Z'>
          <span itemprop='position'>#159</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Got a response:</p>
<blockquote>
<p>This one will not come quickly: the environment scrubbing isn’t actually performed by AppArmor but by the system c library. AppArmor sets the same flag that’s used when setuid/setgid programs are executed, and when the program starts, libc notes the flag and scrubs environment before going very far.</p>
<p>Providing granularity when scrubbing the environment is something we want to do but I don’t think it’ll happen for a while.</p>
<p>The good news is that you could steal the environment scrubbing routine from glibc, add it as a constructor to your libhardened_malloc.so, and modify AppArmor policy to stop setting the secure exec flag when you want to use this library. That way you could still get a mostly-scrubbed environment and use the different allocator. It might not be as easy as this fine-grained scrubbing feature but you could be using it a lot sooner.</p>
</blockquote>
<p>I think the bottom part is suggesting we modify hardened_malloc to scrub the environment for us instead of using apparmor for it.</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="../8339.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-11-23T17:55:37Z' class='post-time'>
                November 23, 2019,  5:55pm
              </time>
              <meta itemprop='dateModified' content='2019-11-23T17:55:37Z'>
          <span itemprop='position'>#160</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Worth contacting hardened malloc upstream?</p>
<aside class="quote no-group" data-post="159" data-topic="8339">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../letter_avatar_proxy/v4/letter/m/ea5d25/40.png" class="avatar"> madaidan:</div>
<blockquote>
<p>modify AppArmor policy to stop setting the secure exec flag when you want to use this library</p>
</blockquote>
</aside>
<p>Can you make head or tail of this? If not, let’s ask?</p>
        </div>

        <meta itemprop='headline' content='AppArmor for Complete System - Including init, PID1, Systemd, Everything! - Full System MAC policy'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><a rel="prev" itemprop="url" href="../8339235c.html?page=7">← previous page</a></span>
        <span itemprop='name'><b><a rel="next" itemprop="url" href="../83390b08.html?page=9">next page →</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
