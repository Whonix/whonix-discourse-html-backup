<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Improve apt-get Stream Isolation for Qubes Templates</title>
    <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315</link>
    <description>Credit to [s]@tasket[/s] @rustybird for highlighting the issue. [s](can&#39;t find the post)[/s] Just remembered: https://github.com/rustybird/qubes-updates-cache

&gt; 1. For Tor users, the remote network has some insight about what&#39;s installed on the same physical computer, because there is no Tor circuit isolation between update requests from different clients. This can be prevented by waiting at least 10 minutes (or sending NEWNYM) between updating different clients. (The same is true of qubes-updates-proxy.)

Desired behavior: apt-get should use new circuits for each client VM and also use new circuits for each repository. In non-Qubes-Whonix, multiple VMs that perform `apt-get update` use different circuits because of `IsolateClientAddr`. In Qubes-Whonix, all TemplateVMs share the same circuits for apt-get (due to Update Proxy design?).

Current observed behavior: Circuit A is used to route traffic for all apt-get requests from **all TemplateVMs** going to vwakviie2ienjx6t.onion. Circuit B is used for all traffic going to sgvtcaew4bxjd7ln.onion. Circuit C is used for all traffic to clearnet repos, including qubes-os.org, whonix.org, and 3rd party repos. These potentially allows for some linkability between TemplateVMs - both by the Exit Node as well as by the repository server.

I don&#39;t know enough about tinyproxy (or http proxies in general) to propose a solution. Some possibilities:

*1. (For non-Qubes-Whonix) Enable `IsolateDestAddr` for apt-get port. From `/usr/share/tor/tor-service-defaults-torrc`:
```
## Operating system updates: apt-get
## Not using IsolateDestAddr IsolateDestPort, because too much
## performance loss, too much load on Tor network and no gain
## in security.
SocksPort 10.137.1.1:9104
```
This was probably written pre-Qubes. Enabling IsolateDestAddr will cause an extra tor circuit per clearnet repo - not too much load. And no additional load if using .onion repos which are isolated by default. This would fix per-repo isolation but not per-client isolation.

! This doesn&#39;t work for Qubes-Whonix because uwtwrapper is disabled for apt-get. Instead apt-get requests are sent to tinyproxy port 8082 and then sent to Tor via (TransPort???). Can we spin the packet around and have it route through a SocksPort?

*2. (For Qubes-Whonix) Somehow masquerade Source IP so that `IsolateClientAddr` is activated.

*3. (For Qubes-Whonix) Somehow enable `SOCKSAuth` so that some category of apt-get request is assigned a random SOCKS password.</description>
    <language>en</language>
    <lastBuildDate>Mon, 05 Sep 2022 09:25:52 +0000</lastBuildDate>
    <category>Development</category>
    <atom:link href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="onebox githubissue" data-onebox-src="https://github.com/QubesOS/qubes-issues/issues/7737">
  <header class="source">

      <a href="https://github.com/QubesOS/qubes-issues/issues/7737" target="_blank" rel="noopener">github.com/QubesOS/qubes-issues</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Issue">
	  <svg width="60" height="60" class="github-icon" viewBox="0 0 14 16" aria-hidden="true"><path d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/QubesOS/qubes-issues/issues/7737" target="_blank" rel="noopener">remove tinyproxy from Whonix-Gateway (`sys-whonix`) and make Whonix Templates networked by default with Net qube set to `sys-whonix`</a>
    </h4>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2022-09-05" data-time="09:22:50" data-timezone="UTC">09:22AM - 05 Sep 22 UTC</span>
      </div>


      <div class="user">
        <a href="https://github.com/adrelanos" target="_blank" rel="noopener">
          <img alt="adrelanos" src="https://avatars.githubusercontent.com/u/1985040?v=4" class="onebox-avatar-inline" width="20" height="20">
          adrelanos
        </a>
      </div>
    </div>

    <div class="labels">
        <span style="display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;">
          T: bug
        </span>
        <span style="display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;">
          P: default
        </span>
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">I am suggesting to remove tinyproxy from Whonix-Gateway (`sys-whonix`) and make <span class="show-more-container"><a href="http://forums.whonix.org" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden">Whonix Templates networked by default with Net qube set to `sys-whonix`.

motivation for this change suggestion:

* The current implementation is still basically mostly as implemented by nrgaway many years ago. nrgaway is no longer active. No co-maintenance / help / resources / hyper-vigilant auditing eyes available to keep maintaining it.
* I don't like the extra complexity of having Qubes UpdatesProxy specific firewall rules in Whonix-Gateway firewall. ([here](https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-gateway-firewall#L332-L373))
* It makes leak testing more complicated.
* Requires complex torified UpdatesProxy check.
* Primarily goal of Whonix is to route all traffic over Tor, leakproofness. Therefore any complexity / exceptions in its networking configuration is to be avoided.
* Now a more complex solution is suggested on top of the current complexity. (https://github.com/tlaurion/shaker/pull/1)

advantages of this change would be:

* Better leakproofness.
* Simplifies Whonix-Gateway firewall.
* [Improves Qubes-Whonix Templates stream isolation.](https://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315)
* Makes Qubes-Whonix more similar to Non-Qubes-Whonix and hence easier to audit and maintain.

disadvantages if this change is implemented:

* Qubes-Whonix Templates being networked by default.

Why do I as maintainer of Qubes-Whonix make this ticket?

* I am not sure I'd have the authority to decide to make this change. Making a Qubes Template networked by default might be perceived as quite a conceptual level change. And orchestrating this change should be discussed beforehand for sure anyhow.

Other alternatives?

* Getting tinyproxy out of sys-whonix somehow... But how would that be implemented? Maybe a third VM but the effort to maintain that would be too high on my side. Perhaps Qubes would like to maintain a standalone tinyproxy / UpdatesProxy / cacher VM?</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/12">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/12</link>
        <pubDate>Mon, 05 Sep 2022 09:25:52 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-12</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group quote-modified" data-username="Patrick" data-post="10" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/2848_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>A related issue:</p>
<p><a href="https://github.com/unman/shaker/issues/10">https://github.com/unman/shaker/issues/10</a></p>
</blockquote>
</aside>
<aside class="onebox githubpullrequest" data-onebox-src="https://github.com/tlaurion/shaker/pull/1">
  <header class="source">

      <a href="https://github.com/tlaurion/shaker/pull/1" target="_blank" rel="noopener">github.com/tlaurion/shaker</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewBox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/tlaurion/shaker/pull/1" target="_blank" rel="noopener">WiP cacher-whonix</a>
    </h4>

    <div class="branches">
      <code>tlaurion:main</code> ← <code>tlaurion:cacher-whonix</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2022-08-31" data-time="15:30:28" data-timezone="UTC">03:30PM - 31 Aug 22 UTC</span>
      </div>

      <div class="user">
        <a href="https://github.com/tlaurion" target="_blank" rel="noopener">
          <img alt="tlaurion" src="https://avatars.githubusercontent.com/u/827570?v=4" class="onebox-avatar-inline" width="20" height="20">
          tlaurion
        </a>
      </div>

      <div class="lines" title="1 commits changed 19 files with 1444 additions and 0 deletions">
        <a href="https://github.com/tlaurion/shaker/pull/1/files" target="_blank" rel="noopener">
          <span class="added">+1444</span>
          <span class="removed">-0</span>
        </a>
      </div>
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">Done:
- Duplicated and started to specialize cacher into cacher-whonix for both<span class="show-more-container"><a href="https://github.com/tlaurion/shaker/pull/1" target="_blank" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden"> cacher-whonix salt recipes and cacher-whonix.spec rpm build file
- Have userinfo.html put in the right place so that apt-cacher-ng advertise an enforcing tor proxy to whonix templates
- Have references to cacher replaced with cacher-whonix paths and salt proper placeholders
- Remove dependence on clone; we only want to apply changes to sys-whonix
- Removed configure statement dismissing whonix templates (host) so whonix templates have their repos changed to use apt-cacher-ng
- Modify whonix-gw-16 directly, no clone dependency (removed and references deleted)

Missing:
- Actual testing....
- Force restart sys-whonix after deployment, so that network is interrupted but reestablished automatically
- postun of cacher-whonix should disable apt-cacher-ng and reactivate tinyproxy under sys-whonix. Missing unconfigure script?
- Change README to specify this is targeting whonix-gw-16 and sys-whonix directly
@unman: please comment in code in PR to my fork so that this can go forward
@adrelanos: feel free to comment under https://github.com/tlaurion/shaker/pull/1</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/11">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/11</link>
        <pubDate>Mon, 05 Sep 2022 09:25:34 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-11</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>A related issue:</p>
<aside class="onebox githubissue" data-onebox-src="https://github.com/unman/shaker/issues/10">
  <header class="source">

      <a href="https://github.com/unman/shaker/issues/10" target="_blank" rel="noopener">github.com/unman/shaker</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Issue">
	  <svg width="60" height="60" class="github-icon" viewBox="0 0 14 16" aria-hidden="true"><path d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/unman/shaker/issues/10" target="_blank" rel="noopener">Cacher incompatible with sys-whonix (updates fail for whonix-ws and whonix-gw)</a>
    </h4>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2022-08-19" data-time="14:56:54" data-timezone="UTC">02:56PM - 19 Aug 22 UTC</span>
      </div>


      <div class="user">
        <a href="https://github.com/tlaurion" target="_blank" rel="noopener">
          <img alt="tlaurion" src="https://avatars.githubusercontent.com/u/827570?v=4" class="onebox-avatar-inline" width="20" height="20">
          tlaurion
        </a>
      </div>
    </div>

    <div class="labels">
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">EDIT:
- Working, undesired implementation cacher proxy, advertising itself as g<span class="show-more-container"><a href="http://forums.whonix.org" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden">uaranteeing tor proxy even if false, is at: https://github.com/unman/shaker/issues/10#issuecomment-1221116802
- The only way whonix template updates could be cached as all other templates if repo defs modigied to compoy with apt-cacher-ng requirements is if a cacher-whonix version was created, deactivating whonix-gw's tinyproxy and replacing it with apt-cacher-ng so that sys-whonix would be the update+cache proxy.



----

When cacher is activated, whonix-gw and whonix-ws templates cannot be updated anymore, since both whonix-gw and whonix-ws templates implement a check through systemd qubes-whonix-torified-updates-proxy-check at boot.


~Also, cacher overrides whonix recipes applied at salt install from qubes installation, deployed when the user specifies that he wants all updates to be downloaded through sys-whonix.~

~The standard place where qubes defines, and applies policies on what to use as update proxies to be used is under `/etc/qubes-rpc/policy/qubes.UpdatesProxy` which contains on standard install:~
Whonix still has policies deployed at 4.0 standard place:
```
$type:TemplateVM $default allow,target=sys-whonix
$tag:whonix-updatevm $anyvm deny
```

And where cacher write those at standard q4.1 place
https://github.com/unman/shaker/blob/3f59aacbad4e0b10e69bbbcb488c9111e4a784bc/cacher/use.sls#L7-L9

~First thing first, I think both cacher and whonix should agree on where UpdatesProxy settings should be prepended/modified, which I think historically (and per Qubes documentation as well) it should be under `/etc/qubes-rpc/policy/qubes.UpdatesProxy` for clarity and not adding confusion.~
Whonix policies needs to be applied per q4.1 standard under Qubes. Not subject of this issue.

@unman @adrelanos @fepitre

---------

The following applies proper tor+cacher settings:
https://github.com/unman/shaker/blob/3f59aacbad4e0b10e69bbbcb488c9111e4a784bc/cacher/change_templates.sls#L5-L13 

Unfortunately, whonix templates implement a sys-whonix usage check which prevents templates to use cacher.
This is documented over https://www.whonix.org/wiki/Qubes/UpdatesProxy, and is the result of `qubes-whonix-torified-updates-proxy-check` systemd service started at boot.

Source code of the script can be found at https://github.com/Whonix/qubes-whonix/blob/98d80c75b02c877b556a864f253437a5d57c422c/usr/lib/qubes-whonix/init/torified-updates-proxy-check


Hacking around current internals of both project, one can temporarily disable cacher to have  torified-updates-proxy-check check succeed and put its success flag that subsists for the life of that booted Templatevm. We can then reactivate cacher's added UpdatesProxy bypass and restart qubesd, and validate cacher is able to deal with tor+http-&gt;cacher-&gt;tor+https on Whonix TemplatesVMs:

1- deactivate cacher override of qubes.UpdateProxy policy:
```
[user@dom0 ~]$ cat /etc/qubes/policy.d/30-user.policy 
#qubes.UpdatesProxy  *  @type:TemplateVM  @default  allow target=cacher
```
2- restart qubesd
```
[user@dom0 ~]$ sudo systemctl restart qubesd
[user@dom0 ~]$
```
3- Manually restart whonix template's torified-updates-proxy-check (here whonix-gw-16)
`user@host:~$ sudo systemctl restart qubes-whonix-torified-updates-proxy-check`
We see that whonix applied his state at:
https://github.com/Whonix/qubes-whonix/blob/98d80c75b02c877b556a864f253437a5d57c422c/usr/lib/qubes-whonix/init/torified-updates-proxy-check#L46
```
user@host:~$ ls /run/updatesproxycheck/whonix-secure-proxy-check-done 
/run/updatesproxycheck/whonix-secure-proxy-check-done
```
4- Manually change cacher override and restart qubesd
```
[user@dom0 ~]$ cat /etc/qubes/policy.d/30-user.policy 
qubes.UpdatesProxy  *  @type:TemplateVM  @default  allow target=cacher
[user@dom0 ~]$ sudo systemctl restart qubesd
```
5- check functionality of downloading tor+https over cacher from whonix template:
```
user@host:~$ sudo apt update
Hit:1 http://HTTPS///deb.qubes-os.org/r4.1/vm bullseye InRelease
Hit:2 tor+http://HTTPS///deb.debian.org/debian bullseye InRelease
Hit:3 tor+http://HTTPS///deb.debian.org/debian bullseye-updates InRelease
Hit:4 tor+http://HTTPS///deb.debian.org/debian-security bullseye-security InRelease
Hit:5 tor+http://HTTPS///deb.debian.org/debian bullseye-backports InRelease
Get:6 tor+http://HTTPS///fasttrack.debian.net/debian bullseye-fasttrack InRelease [12.9 kB]
Hit:7 tor+http://HTTPS///deb.whonix.org bullseye InRelease                                                                            
Fetched 12.9 kB in 7s (1,938 B/s)                                                                                                     
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
```

Problem with this is that qubes update processes will start templates and try to apply updates unattended, and this obviously won't work unattended. 

The question is then how to have whonix templates do a functional test for it to see that torrified updates **are possible** instead of whonix believing he is the only one providing the service? The code seems to implement curl check, but also doesn't work even if cacher is exposed on as a tinyproxy replacement, listening on 127.0.0.1:8082. Still digging, but at the end, we need to apply mitigation ( disable Whonix check) or proper functional testing from Whonix, which should see that the torrified repositories are actually accessible.

-----

How to fix this?

Some hints:
1- cacher and whonix should modify the policy at the same place to ease troubleshooting and understanding of what is modified on the host system, even more when dom0 is concerned. I think cacher should prepend `/etc/qubes-rpc/policy/qubes.UpdatesProxy`
2- Whonix seems to have thought of a proxy check override:
https://github.com/Whonix/qubes-whonix/blob/685898472356930308268c1be59782fbbb7efbc3/etc/uwt.d/40_qubes.conf#L15-L21

@adrenalos: not sure this is the best option, and I haven't found where to trigger that override so that the check is bypassed?

3- At Qubes OS install, torrified updates and torrifying all network traffic (setting sys-whonix as default gateway) is two different things, the later not being enforced by default. Salt recipes are available to force updates through sys-whonix when selected at install, which dom0 still uses after cacher deployment:
![29-Q41_options_selection_done](https://user-images.githubusercontent.com/827570/156628021-d3ec34af-e620-48b8-aa39-45d84c968769.jpeg)

So my setup picked up sys-whonix as the default gateway for cacher since I configured my setup to use sys-whonix proxy as default, which permits tor+http/HTTPS to go through after applying manual mitigations. But that would not necessarily be the case for default deployments but would need to verify, sys-firewall being the default unless changed.

@unman: on that, I think the configure script should handle that corner case and make sure sys-whonix is the default gateway for cacher if whonix is deployed. Or your solution wants to work independently of Whonix altogether (#6) but there would be discrepancy between Qubes installation options, what most users use and what is available out of the box after installing cacher from rpm:
https://github.com/unman/shaker/blob/3f59aacbad4e0b10e69bbbcb488c9111e4a784bc/cacher.spec#L50-L60

4- That is, cacher cannot be used as of now for dom0 updates either. Assigning dom0 updates to cacher gives the following error from cacher:
`sh: /usr/lib/qubes/qubes-download-dom0-updates.sh: not found`

So when using cacher + sys-whonix, sys-whonix would still be used by dom0 (where caching would not necessarily makes sense since dom0 doesn't share same fedora version then templates, but I understand that this is desired to change in the near future.

Point being here: sys-whonix would still offer its tinyproxy service, sys-whonix would still be needed to torrify whonix templates updates and dom0 would still depend on sys-firewall, not cacher, on a default install (without whonix being installed). Maybe a little bit more thoughts needs to be given to the long term approach of pushing this amazing caching proxy forward to not break things on willing testers :)

@fepitre: adding you to see if you have additional recommendations, feel free to tag Marek if you feel like so later on, but this caching proxy is a really long awaited feature (https://github.com/QubesOS/qubes-issues/issues/1957) which would be a life changer if salt recipes, cloning from debian-11-minimal and sepecializing templates for different use cases, and bringing a salt store being the desired outcome from all of this.

Thank you both. Looking forward for a cacher that can be deployed as "rpm as a service" on default installations.

We are close to that, but as of now, this doesn't work, still, out of the box and seems to need a bit of collaboration from you both.

Thanks guys!</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/10">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/10</link>
        <pubDate>Tue, 30 Aug 2022 08:30:59 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-10</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[nyxnor]]></dc:creator>
        <description><![CDATA[
            <blockquote>
<p>qrexec feature request: tinyproxy would have to receive client addr which would require some qrexec modification.</p>
</blockquote>
<p>I think this is the most realistic option because tinyproxy needs to get different clients first, as of know only getting 127.0.0.1.</p>
<p>My proposal is either use tinyproxy on a virtual network so it can receive the virtual network ip from templates and only that (but this may be insecure, idk)</p>
<p>Or Tinyproxy listening to connection on different ports for different templates, but this is cumbersome to configure on template clones and then having to modify its config port.</p>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/9</link>
        <pubDate>Fri, 08 Jul 2022 12:43:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-9</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>To understand my post, prerequisite knowledge from <a href="https://manpages.debian.org/tor">Tor manual</a>:</p>
<ul>
<li><code>SocksPort</code></li>
<li><code>TransPort</code></li>
<li><code>IsolateClientAddr</code></li>
<li><code>IsolateSOCKSAuth</code></li>
</ul>
<aside class="quote no-group quote-modified" data-username="nyxnor" data-post="5" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/nyxnor/40/2874_2.png" class="avatar"> nyxnor:</div>
<blockquote>
<p>Any update on stream isolation when updating qubes?</p>
<p><a href="https://github.com/tinyproxy/tinyproxy/issues/40#issuecomment-368326575">https://github.com/tinyproxy/tinyproxy/issues/40#issuecomment-368326575</a></p>
</blockquote>
</aside>
<p>Actually, I have to correct my former self. Now, I don’t think tinyproxy now having socks support will help a lot  with improving apt-get stream isolation for Qubes Templates. All Qubes Template APT traffic would then end up in the same Tor <code>SocksPort</code>. A tiny improvement over all of that traffic ending up in Tor’s <code>TransPort</code>.</p>
<p>tinyproxy socks proxy support is useful for other things. Other than stream isolation. Namely, Whonix-Gateway firewall could perhaps be be simplified if tinyproxy was configured by the <code>qubes-whonix</code> package to use a Tor <code>SocksPort</code>.</p>
<aside class="quote no-group" data-username="nyxnor" data-post="6" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/nyxnor/40/2874_2.png" class="avatar"> nyxnor:</div>
<blockquote>
<p>I think it is the way Qubes implemented Tinyproxy, as we are connecting directly to a localhost socket, we are localhost in the traffic, it can’t differ clients (different qubes templates).</p>
</blockquote>
</aside>
<p>Indeed. From the perspective of tinyproxy, traffic is “suddenly coming from nowhere”, in other words, technically from other VM, through qrexec, arriving at tinyproxy localhost.</p>
<p>tinyproxy receives no client addr. Neither tinyproxy has a concept similar to Tor such as <code>IsolateClientAddr</code> and <code>IsolateSOCKSAuth</code>.</p>
<p>Probably required:</p>
<ul>
<li>qrexec feature request: tinyproxy would have to receive client addr which would require some qrexec modification.</li>
<li>tinyproxy feature request: tinyproxy would have to set a different Tor socks user name for each different client addr. This would result in Tor using a different Tor circuit for each Tor socks user name (<code>IsolateSOCKSAuth</code>) set by tinyproxy.</li>
</ul>
<p>Not sure that is realistic?</p>
<ul>
<li>Qubes: An older unrelated qrexec feature request <a href="https://github.com/QubesOS/qubes-issues/issues/5253">https://github.com/QubesOS/qubes-issues/issues/5253</a> didn’t have any activity.</li>
<li>tinyproxy: How interested would tinyproxy contributors be to implement more granular, finer Tor stream isolation support?
<ul>
<li>A feature request similar to the following:
<ul>
<li><a href="https://dev.gajim.org/gajim/gajim/-/issues/9213" class="inline-onebox">Use different socks user name per account (Tor) (#9213) · Issues · gajim / gajim · GitLab</a></li>
<li><a href="https://gitlab.torproject.org/legacy/trac/-/issues/6359" class="inline-onebox">make use of stream isolation (#6359) · Issues · Legacy / Trac · GitLab</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Help welcome with submitting feature request welcome and anything else. Otherwise I don’t think any progress will be made here.</p>
<p>The only other alternative that I can see is making Qubes-Whonix Templates networked by default to patch/fix the direct communication between APT and a Tor <code>SocksPort</code>. Otherwise if a proxy (tinyproxy) is wretched in between, granular stream isolation will be difficult to implement.</p>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/8</link>
        <pubDate>Fri, 08 Jul 2022 12:18:20 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-8</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[nyxnor]]></dc:creator>
        <description><![CDATA[
            <p>Stream isolation is fully function for different WS using the same GW.</p>
<p>Template stream isolation is a QubesOS issue that only pass 127.0.0.1 as the client address to sys-whonix tinyproxy.</p>
<aside class="onebox allowlistedgeneric" data-onebox-src="https://forum.qubes-os.org/t/how-to-identify-which-template-requested-to-use-the-proxy/12432">
  <header class="source">
      <img src="https://forum.qubes-os.org/uploads/db3820/optimized/2X/5/55de5eaf64516902429c411f66491cc9db06c464_2_32x32.png" class="site-icon" width="32" height="32">

      <a href="https://forum.qubes-os.org/t/how-to-identify-which-template-requested-to-use-the-proxy/12432" target="_blank" rel="noopener nofollow ugc" title="10:41AM - 08 July 2022">Qubes OS Forum – 8 Jul 22</a>
  </header>

  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:472/471;"><img src="https://forum.qubes-os.org/uploads/db3820/original/1X/10549f9dff8a289d117f083e9f5155231c452db2.png" class="thumbnail" width="472" height="471"></div>

<h3><a href="https://forum.qubes-os.org/t/how-to-identify-which-template-requested-to-use-the-proxy/12432" target="_blank" rel="noopener nofollow ugc">How to identify which template requested to use the proxy?</a></h3>

  <p>Problem: every client has the same ip, localhost First, templates are network isolated by default and only can use the update proxy 127.0.0.1:8082 done with permanent port binding - QubesOS Firewall Docs  Some important files:  ...</p>


  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<blockquote>
<p>Hello,<br>
Our automated spam filter, <a href="https://akismet.com/" rel="noopener nofollow ugc">Akismet</a>, has temporarily hidden <a href="https://forum.qubes-os.org/t/how-to-identify-which-template-requested-to-use-the-proxy/12432/1" rel="noopener nofollow ugc">your post</a> in <em>How to identify which template requested to use the proxy?</em> for review.<br>
A <a href="https://forum.qubes-os.org/about" rel="noopener nofollow ugc">staff member</a> will review your post soon, and it should appear shortly.<br>
We apologize for the inconvenience.</p>
</blockquote>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/7</link>
        <pubDate>Fri, 08 Jul 2022 10:51:23 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-7</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[nyxnor]]></dc:creator>
        <description><![CDATA[
            <p>I think tinyproxy config needs to change. It needs to bind certain client addresses to certain virtual hosts.</p>
<p>As it is right now, it does not show the client addr,</p>
<pre><code class="lang-auto">CONNECT   Jul [487354]: Connect (file descriptor 10): localhost [127.0.0.1]
CONNECT   Jul [487354]: Request (file descriptor 10): GET http://deb.qubesosfasa4zl44o4tws22di6kepyzfeqv3tg4e3ztknltfxqrymdad.onion/r4.1/vm/dists/bullseye/InRelease HTTP/1.1
INFO      Jul [487354]: No upstream proxy for deb.qubesosfasa4zl44o4tws22di6kepyzfeqv3tg4e3ztknltfxqrymdad.onion
INFO      Jul [487354]: opensock: opening connection to deb.qubesosfasa4zl44o4tws22di6kepyzfeqv3tg4e3ztknltfxqrymdad.onion:80
</code></pre>
<p>I think it is the way Qubes implemented Tinyproxy, as we are connecting directly to a localhost socket, we are localhost in the traffic, it can’t differ clients (different qubes templates).</p>
<aside class="onebox githubblob" data-onebox-src="https://github.com/QubesOS/qubes-core-agent-linux/blob/a90c3568d19026e85959fad1a16fd5cad88845cd/vm-systemd/qubes-updates-proxy-forwarder.socket#L9">
  <header class="source">

      <a href="https://github.com/QubesOS/qubes-core-agent-linux/blob/a90c3568d19026e85959fad1a16fd5cad88845cd/vm-systemd/qubes-updates-proxy-forwarder.socket#L9" target="_blank" rel="noopener nofollow ugc">github.com</a>
  </header>

  <article class="onebox-body">
    <h4><a href="https://github.com/QubesOS/qubes-core-agent-linux/blob/a90c3568d19026e85959fad1a16fd5cad88845cd/vm-systemd/qubes-updates-proxy-forwarder.socket#L9" target="_blank" rel="noopener nofollow ugc">QubesOS/qubes-core-agent-linux/blob/a90c3568d19026e85959fad1a16fd5cad88845cd/vm-systemd/qubes-updates-proxy-forwarder.socket#L9</a></h4>



    <pre class="onebox">      <code class="lang-socket">
        <ol class="start lines" start="1" style="counter-reset: li-counter 0 ;">
            <li>[Unit]</li>
            <li>Description=Forward connection to updates proxy over Qubes RPC</li>
            <li>ConditionPathExists=/var/run/qubes-service/updates-proxy-setup</li>
            <li># don't start the forwarder when updates proxy itself is also enabled here,</li>
            <li># otherwise it would most likely loop back to itself</li>
            <li>ConditionPathExists=!/var/run/qubes-service/qubes-updates-proxy</li>
            <li>
            </li>
<li>[Socket]</li>
            <li class="selected">ListenStream=127.0.0.1:8082</li>
            <li>BindToDevice=lo</li>
            <li>Accept=true</li>
            <li>
            </li>
<li>[Install]</li>
            <li>WantedBy=multi-user.target</li>
        </ol>
      </code>
    </pre>



  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p>Running 2 non-whonix templates and using sys-whonix as update vm:<br>
Circuit reuse because tinyproxy does not pass the client addr.<br>
The DNS request uses localhost ip, while the connection uses the gateway qube local ip.</p>
<pre><code class="lang-auto">$ tor-ctrl-stream -z -m

StreamId StreamPurpose StreamTarget StreamClient CircuitId CircuitPurpose
------------------------------------------------------------------------------------------------------
376 USER 10.228.239.209-(2s4yqjx5ul6okpp3f2gaunr2syex5jgbfpfvhxxbbjwnrsvbk5v3qbid.onion:80) 10.137.0.8:40006 252 HS_CLIENT_REND
386 USER 10.240.194.32-(deb.qubesosfasa4zl44o4tws22di6kepyzfeqv3tg4e3ztknltfxqrymdad.onion:80) 10.137.0.8:47834 285 HS_CLIENT_REND
387 DNS_REQUEST deb.debian.org-(199.232.138.132:0) 127.0.0.1:57744 153 GENERAL
388 DNS_REQUEST deb.debian.org-([2a04:4e42:62::644]:0) 127.0.0.1:57744 153 GENERAL
389 USER deb.debian.org-(199.232.138.132:443) 10.137.0.8:45936 154 GENERAL
392 USER 10.240.194.32-(deb.qubesosfasa4zl44o4tws22di6kepyzfeqv3tg4e3ztknltfxqrymdad.onion:80) 10.137.0.8:47842 285 HS_CLIENT_REND
395 USER 10.240.194.32-(deb.qubesosfasa4zl44o4tws22di6kepyzfeqv3tg4e3ztknltfxqrymdad.onion:80) 10.137.0.8:47846 285 HS_CLIENT_REND
</code></pre>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/6</link>
        <pubDate>Fri, 08 Jul 2022 00:36:01 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-6</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[nyxnor]]></dc:creator>
        <description><![CDATA[
            <p>Any update on stream isolation when updating qubes?</p>
<aside class="onebox githubissue" data-onebox-src="https://github.com/tinyproxy/tinyproxy/issues/40#issuecomment-368326575">
  <header class="source">

      <a href="https://github.com/tinyproxy/tinyproxy/issues/40#issuecomment-368326575" target="_blank" rel="noopener nofollow ugc">github.com/tinyproxy/tinyproxy</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Issue">
	  <svg width="60" height="60" class="github-icon" viewBox="0 0 14 16" aria-hidden="true"><path d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/tinyproxy/tinyproxy/issues/40#issuecomment-368326575" target="_blank" rel="noopener nofollow ugc">Add SOCKS support</a>
    </h4>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2016-10-16" data-time="18:24:40" data-timezone="UTC">06:24PM - 16 Oct 16 UTC</span>
      </div>

        <div class="date">
          closed <span class="discourse-local-date" data-format="ll" data-date="2018-02-25" data-time="17:17:13" data-timezone="UTC">05:17PM - 25 Feb 18 UTC</span>
        </div>

      <div class="user">
        <a href="https://github.com/dave-kennedy" target="_blank" rel="noopener nofollow ugc">
          <img alt="dave-kennedy" src="https://avatars.githubusercontent.com/u/13735532?v=4" class="onebox-avatar-inline" width="20" height="20">
          dave-kennedy
        </a>
      </div>
    </div>

    <div class="labels">
        <span style="display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;">
          enhancement
        </span>
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">It looks like somebody has already done the work: https://github.com/koolshare/t<span class="show-more-container"><a href="http://forums.whonix.org" rel="noopener" class="show-more">…</a></span><span class="excerpt hidden">inyproxy</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/5</link>
        <pubDate>Thu, 07 Jul 2022 22:32:43 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-5</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="2" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Can you please ask on tor-dev if it’s fine for Whonix to use IsolateDestAddr IsolateDestPort for its apt-get Tor SocksPort?</p>
</blockquote>
</aside>
<p>Talked to Roger at 33c3: No, he prefers us not enabling that.</p>
<blockquote>
<blockquote>
<p>/usr/sbin/tinyproxy: Could not create listening socket.<br>
One cannot socksify an application as well as at the same time have it open a listener port using a socksifier.</p>
</blockquote>
</blockquote>
<p>This might be possible in Debian stretch based Whonix 14. torsocks learned <code>AllowOutboundLocalhost 1</code>, <a href="https://github.com/Whonix/uwt/blob/master/etc/tor/torsocks.conf.anondist">which will be enabled by default in Whonix 14</a> in the <a href="https://github.com/Whonix/uwt">uwt</a> package.</p>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/4</link>
        <pubDate>Tue, 31 Jan 2017 13:59:56 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-4</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[marmarek]]></dc:creator>
        <description><![CDATA[
            <blockquote>
<p>Do you think <a href="https://github.com/QubesOS/qubes-issues/issues/1854" rel="nofollow noopener">qrexec based updates proxy</a> will help with this? <a class="mention" href="http://forums.whonix.org/u/marmarek">@marmarek</a></p>
</blockquote>
<p>Maybe. Connection to the “proxy” will arrive as qrexec call, stream<br>
there will be “HTTP proxy” protocol. So, if you pass it to some “HTTP<br>
proxy -&gt; socks” filter (instead of tinyproxy), that would work. I think<br>
socat can not do that, but maybe something else can?</p>
<p>You’ll have there name of source VM, so can use that to direct it to<br>
isolated circuits.</p>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/3</link>
        <pubDate>Thu, 22 Dec 2016 05:16:41 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-3</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="1" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Desired behavior: apt-get should use new circuits for each client VM and also use new circuits for each repository.</p>
</blockquote>
</aside>
<p>Yes.</p>
<aside class="quote" data-post="1" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>In Qubes-Whonix, all TemplateVMs share the same circuits for apt-get (due to Update Proxy design?).</p>
</blockquote>
</aside>
<p>If all TemplateVMs use the same sys-whonix as their NetVM, unfortunately yes.</p>
<aside class="quote" data-post="1" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<pre><code class="lang-auto">## Operating system updates: apt-get
## Not using IsolateDestAddr IsolateDestPort, because too much
## performance loss, too much load on Tor network and no gain
## in security.
SocksPort 10.137.1.1:9104
</code></pre>
<p>This was probably written pre-Qubes.</p>
</blockquote>
</aside>
<p>Was written pre-Qubes indeed.</p>
<aside class="quote" data-post="1" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Enabling IsolateDestAddr will cause an extra tor circuit per clearnet repo - not too much load.</p>
</blockquote>
</aside>
<p>More than that.</p>
<p>When you connect run <code>nslookup ftp.us.debian.org</code> for several times, you get several results. DNS round robin. It’s actually multiple servers. Each apt-get package download is a separate fetch. So it would be one circuit per resolved <a href="http://ftp.us.debian.org">ftp.us.debian.org</a> IP when multiple packages are downloaded.</p>
<p>I agree we should revisit this. Can you please ask on tor-dev if it’s fine for Whonix to use IsolateDestAddr IsolateDestPort for its apt-get Tor SocksPort?</p>
<aside class="quote" data-post="1" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>! This doesn’t work for Qubes-Whonix because uwtwrapper is disabled for apt-get. Instead apt-get requests are sent to tinyproxy port 8082 and then sent to Tor via (TransPort???).</p>
</blockquote>
</aside>
<p>Yes.</p>
<aside class="quote" data-post="1" data-topic="3315">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Can we spin the packet around and have it route through a SocksPort?</p>
</blockquote>
</aside>
<p>I wouldn’t know how. That would be preferred. However, <a href="https://github.com/tinyproxy/tinyproxy/issues/40">tinyproxy does not support socks proxy settings</a>, which would be a lot better. It just uses normal networking ("speaks only <code>trans</code>"). It runs under its own linux user account at least which might make things easier.</p>
<p>The question you are asking is generally a hard one. How can one force an arbitrary application that does not support socks proxy settings through a socks proxy. Well, there there are proxifiers / socksifiers such as <code>torsocks</code> (and <code>uwt</code> scripting it). But that probably won’t work with tinyproxy.</p>
<pre><code>sudo su
torsocks /usr/sbin/tinyproxy -d -c /etc/tinyproxy/tinyproxy-updates.conf
</code></pre>
<blockquote>
<p>/usr/sbin/tinyproxy: Could not create listening socket.</p>
</blockquote>
<p>One cannot socksify an application as well as at the same time have it open a listener port using a socksifier.</p>
<p>redsocks might be worth exploring.</p>
<p>(There is some information on redsocks here - although it’s on a different topic you can see the idea - <a href="https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_proxy#Transparent_Proxying_Method.(">https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_proxy#Transparent_Proxying_Method.(</a></p>
<p>Although all DNS would still go through Tor’s DnsPort. [Might be fingerprintable, because TCP traffic without previous DNS request.]</p>
<hr>
<p>Do you think <a href="https://github.com/QubesOS/qubes-issues/issues/1854">qrexec based updates proxy</a> will help with this? <a class="mention" href="http://forums.whonix.org/u/marmarek">@marmarek</a></p>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/2</link>
        <pubDate>Thu, 22 Dec 2016 03:43:21 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-2</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
      <item>
        <title>Improve apt-get Stream Isolation for Qubes Templates</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p>Credit to <span class="bbcode-s"><a class="mention" href="http://forums.whonix.org/u/tasket">@tasket</a></span> <a class="mention" href="http://forums.whonix.org/u/rustybird">@rustybird</a> for highlighting the issue. <span class="bbcode-s">(can’t find the post)</span> Just remembered: <a href="https://github.com/rustybird/qubes-updates-cache" rel="noopener nofollow ugc">https://github.com/rustybird/qubes-updates-cache</a></p>
<blockquote>
<ol>
<li>For Tor users, the remote network has some insight about what’s installed on the same physical computer, because there is no Tor circuit isolation between update requests from different clients. This can be prevented by waiting at least 10 minutes (or sending NEWNYM) between updating different clients. (The same is true of qubes-updates-proxy.)</li>
</ol>
</blockquote>
<p>Desired behavior: apt-get should use new circuits for each client VM and also use new circuits for each repository. In non-Qubes-Whonix, multiple VMs that perform <code>apt-get update</code> use different circuits because of <code>IsolateClientAddr</code>. In Qubes-Whonix, all TemplateVMs share the same circuits for apt-get (due to Update Proxy design?).</p>
<p>Current observed behavior: Circuit A is used to route traffic for all apt-get requests from <strong>all TemplateVMs</strong> going to <a href="http://vwakviie2ienjx6t.onion" rel="noopener nofollow ugc">vwakviie2ienjx6t.onion</a>. Circuit B is used for all traffic going to <a href="http://sgvtcaew4bxjd7ln.onion" rel="noopener nofollow ugc">sgvtcaew4bxjd7ln.onion</a>. Circuit C is used for all traffic to clearnet repos, including <a href="http://qubes-os.org" rel="noopener nofollow ugc">qubes-os.org</a>, <a href="http://whonix.org" rel="noopener nofollow ugc">whonix.org</a>, and 3rd party repos. These potentially allows for some linkability between TemplateVMs - both by the Exit Node as well as by the repository server.</p>
<p>I don’t know enough about tinyproxy (or http proxies in general) to propose a solution. Some possibilities:</p>
<p>*1. (For non-Qubes-Whonix) Enable <code>IsolateDestAddr</code> for apt-get port. From <code>/usr/share/tor/tor-service-defaults-torrc</code>:</p>
<pre><code class="lang-auto">## Operating system updates: apt-get
## Not using IsolateDestAddr IsolateDestPort, because too much
## performance loss, too much load on Tor network and no gain
## in security.
SocksPort 10.137.1.1:9104
</code></pre>
<p>This was probably written pre-Qubes. Enabling IsolateDestAddr will cause an extra tor circuit per clearnet repo - not too much load. And no additional load if using .onion repos which are isolated by default. This would fix per-repo isolation but not per-client isolation.</p>
<p>! This doesn’t work for Qubes-Whonix because uwtwrapper is disabled for apt-get. Instead apt-get requests are sent to tinyproxy port 8082 and then sent to Tor via (TransPort???). Can we spin the packet around and have it route through a SocksPort?</p>
<p>*2. (For Qubes-Whonix) Somehow masquerade Source IP so that <code>IsolateClientAddr</code> is activated.</p>
<p>*3. (For Qubes-Whonix) Somehow enable <code>SOCKSAuth</code> so that some category of apt-get request is assigned a random SOCKS password.</p>
          <p><a href="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315/1</link>
        <pubDate>Wed, 21 Dec 2016 19:00:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3315-1</guid>
        <source url="http://forums.whonix.org/t/improve-apt-get-stream-isolation-for-qubes-templates/3315.rss">Improve apt-get Stream Isolation for Qubes Templates</source>
      </item>
  </channel>
</rss>
