<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>update-torbrowser tb_onion config setting ignored. </title>
    <link>http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049</link>
    <description>Environment: QubesOS, untested on any other platform but it seems agnostic.

Description:
When setting `tb_onion=true` in any of the config files in `/etc/torbrowser.d/` the `update-torbrowser` script doesn&#39;t download the Tor Browser using the onion services. However the onion services are used when you call `update-torbrowser --onion` or `tb_onion=true update-torbrowser`.

For example using: `echo &quot;tb_onion=true&quot; | sudo tee -a &quot;/etc/torbrowser.d/50_user.conf&quot;`

Looking at the script [1][2] it appears setting the download URL (in function `tb_preparation`) [4][5] happens before the config files are loaded (function `tb_config_folder_parser`) [3], hence as the URL is already set loading the config files from `/etc/torbrowser.d/` with `tb_onion=true` doesn&#39;t make a difference.

The function `tb_config_folder_parser` [6] depends on the variable `$tb_settings_folder` being set to work and this appears to be only set in the function `tb_preparation` [7], hence moving the function `tb_config_folder_parser` before `tb_preparation` doesn&#39;t work [3][4]. I&#39;ve got it to work by moving the function call `tb_config_folder_parser` [3] into the function `tb_preparation` somewhere between setting `$tb_settings_folder` (line 629 [7]) and using `$tb_onion` (line 787 [5]). Another solution would be to refactor function `tb_preparation` into two smaller functions and call `tb_config_folder_parser` in between them.

I&#39;m not as familiar with the scripts internals so I don&#39;t want to make a patch, I thought to just posting my findings on here and you can decide how it should be done. 

This isn&#39;t relevant to the bug, but this my first direct interaction. I&#39;ve used Whonix most days for ~5 years and really appreciate the work that has been put in. :)

Relevant ticket: [8]


[1] https://github.com/Whonix/tb-updater/tree/188cc1e12c01b57cf9e363e87ddd57aed464feba/
[2] https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser
[3] https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L2037
[4] https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L2036
[5] https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L787
[6] https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L434
[7] https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L629
[8] https://phabricator.whonix.org/T678</description>
    <language>en</language>
    <lastBuildDate>Mon, 09 Sep 2019 10:29:52 +0000</lastBuildDate>
    <category>Support</category>
    <atom:link href="http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>update-torbrowser tb_onion config setting ignored. </title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Welcome to the forums! Good to hear! Bug should be fixed. Committed to git just now but untested.</p>
<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/tb-updater/commit/ac21f887493e9f6645af360108c69a62f379e68d" target="_blank" rel="nofollow noopener">github.com/Whonix/tb-updater</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/tb-updater/commit/ac21f887493e9f6645af360108c69a62f379e68d" target="_blank" rel="nofollow noopener">abolish --i2p and move to update-i2pbrowser instead</a>
</h4>


<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/tb-updater/commit/ac21f887493e9f6645af360108c69a62f379e68d" target="_blank" rel="nofollow noopener">10:23AM - 09 Sep 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>2 files</strong>
  with <strong>10 additions</strong>
  and <strong>15 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/tb-updater/commit/e926b87e06fed76a892b30b01fcc378cc1850c84" target="_blank" rel="nofollow noopener">github.com/Whonix/tb-updater</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/tb-updater/commit/e926b87e06fed76a892b30b01fcc378cc1850c84" target="_blank" rel="nofollow noopener">refactoring, set tb_settings_folder in function tb_config_folder_parser</a>
</h4>


<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/tb-updater/commit/e926b87e06fed76a892b30b01fcc378cc1850c84" target="_blank" rel="nofollow noopener">10:24AM - 09 Sep 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>1 files</strong>
  with <strong>1 additions</strong>
  and <strong>1 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/tb-updater/commit/a927394d17bec986a3bfbccd8d4f50a0eee8cf7c" target="_blank" rel="nofollow noopener">github.com/Whonix/tb-updater</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/tb-updater/commit/a927394d17bec986a3bfbccd8d4f50a0eee8cf7c" target="_blank" rel="nofollow noopener">fix "update-torbrowser tb_onion config setting ignored."</a>
</h4>

  <pre class="message" style="white-space: normal;">run tb_config_folder_parser before tb_parse_cmd_options and before tb_preparation
https://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049
Thanks to anon3567998 for the bug report!</pre>

<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/tb-updater/commit/a927394d17bec986a3bfbccd8d4f50a0eee8cf7c" target="_blank" rel="nofollow noopener">10:27AM - 09 Sep 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>1 files</strong>
  with <strong>1 additions</strong>
  and <strong>1 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049/2</link>
        <pubDate>Mon, 09 Sep 2019 10:29:52 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8049-2</guid>
        <source url="http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049.rss">update-torbrowser tb_onion config setting ignored. </source>
      </item>
      <item>
        <title>update-torbrowser tb_onion config setting ignored. </title>
        <dc:creator><![CDATA[anon3567998]]></dc:creator>
        <description><![CDATA[
            <p>Environment: QubesOS, untested on any other platform but it seems agnostic.</p>
<p>Description:<br>
When setting <code>tb_onion=true</code> in any of the config files in <code>/etc/torbrowser.d/</code> the <code>update-torbrowser</code> script doesn’t download the Tor Browser using the onion services. However the onion services are used when you call <code>update-torbrowser --onion</code> or <code>tb_onion=true update-torbrowser</code>.</p>
<p>For example using: <code>echo "tb_onion=true" | sudo tee -a "/etc/torbrowser.d/50_user.conf"</code></p>
<p>Looking at the script [1][2] it appears setting the download URL (in function <code>tb_preparation</code>) [4][5] happens before the config files are loaded (function <code>tb_config_folder_parser</code>) [3], hence as the URL is already set loading the config files from <code>/etc/torbrowser.d/</code> with <code>tb_onion=true</code> doesn’t make a difference.</p>
<p>The function <code>tb_config_folder_parser</code> [6] depends on the variable <code>$tb_settings_folder</code> being set to work and this appears to be only set in the function <code>tb_preparation</code> [7], hence moving the function <code>tb_config_folder_parser</code> before <code>tb_preparation</code> doesn’t work [3][4]. I’ve got it to work by moving the function call <code>tb_config_folder_parser</code> [3] into the function <code>tb_preparation</code> somewhere between setting <code>$tb_settings_folder</code> (line 629 [7]) and using <code>$tb_onion</code> (line 787 [5]). Another solution would be to refactor function <code>tb_preparation</code> into two smaller functions and call <code>tb_config_folder_parser</code> in between them.</p>
<p>I’m not as familiar with the scripts internals so I don’t want to make a patch, I thought to just posting my findings on here and you can decide how it should be done.</p>
<p>This isn’t relevant to the bug, but this my first direct interaction. I’ve used Whonix most days for ~5 years and really appreciate the work that has been put in. <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>Relevant ticket: [8]</p>
<p>[1] <a href="https://github.com/Whonix/tb-updater/tree/188cc1e12c01b57cf9e363e87ddd57aed464feba/" rel="nofollow noopener">https://github.com/Whonix/tb-updater/tree/188cc1e12c01b57cf9e363e87ddd57aed464feba/</a><br>
[2] <a href="https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser" rel="nofollow noopener">https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser</a><br>
[3] <a href="https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L2037" rel="nofollow noopener">https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L2037</a><br>
[4] <a href="https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L2036" rel="nofollow noopener">https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L2036</a><br>
[5] <a href="https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L787" rel="nofollow noopener">https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L787</a><br>
[6] <a href="https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L434" rel="nofollow noopener">https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L434</a><br>
[7] <a href="https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L629" rel="nofollow noopener">https://github.com/Whonix/tb-updater/blob/188cc1e12c01b57cf9e363e87ddd57aed464feba/usr/bin/update-torbrowser#L629</a><br>
[8] <a href="https://phabricator.whonix.org/T678" rel="nofollow noopener">https://phabricator.whonix.org/T678</a></p>
          <p><a href="http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049/1</link>
        <pubDate>Sat, 07 Sep 2019 23:19:36 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8049-1</guid>
        <source url="http://forums.whonix.org/t/update-torbrowser-tb-onion-config-setting-ignored/8049.rss">update-torbrowser tb_onion config setting ignored. </source>
      </item>
  </channel>
</rss>
