<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics - Development - Whonix Forum</title>
    <meta name="description" content="Is there any interest in running whonix in live mode? 
I came across this (Raspbian with Read-only Root - Raspberry Pi Forums) a while ago and tested it on a debian vm. 
It only requires a small patch to the initramfs an&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="3894fdb0.html?page=4" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../c/news/21.html">NEWS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics&#39;" href="3894.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/whonix-live-mode-amnesia-amnesic-non-persistent-anti-forensics/3894?page=4" />
<meta name="twitter:url" content="https://forums.whonix.org/t/whonix-live-mode-amnesia-amnesic-non-persistent-anti-forensics/3894?page=4" />
<meta property="og:title" content="Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics" />
<meta name="twitter:title" content="Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics" />
<meta property="og:description" content="And this is exactly the case! The mount command always succeeds, if it can‚Äôt be mounted rw then it will be automatically mounted ro. One of the earlier versions of the script actually checked the exit code of the mount command but since it always succeeded it did not work. For my tests I just used an invalid disk identifier. In this case it really fails since there is obviously nothing to mount." />
<meta name="twitter:description" content="And this is exactly the case! The mount command always succeeds, if it can‚Äôt be mounted rw then it will be automatically mounted ro. One of the earlier versions of the script actually checked the exit code of the mount command but since it always succeeded it did not work. For my tests I just used an invalid disk identifier. In this case it really fails since there is obviously nothing to mount." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="59 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="141 ‚ù§" />
<meta property="article:published_time" content="2018-06-27T09:04:39+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="prev" href="38949ba9.html?page=3">
        <link rel="next" href="3894af4d.html?page=5">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="3894.html">Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/development/8.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-27T09:04:39Z' class='post-time'>
                June 27, 2018,  9:04am
              </time>
              <meta itemprop='dateModified' content='2018-06-27T09:04:39Z'>
          <span itemprop='position'>#61</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="60" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>This would only make sense if <code>mount -t ext4 -n -o rw $ROOT /livetest</code> falls back to mount read-only if read-write ( <code>rw</code> ) mounting failed?</p>
</blockquote>
</aside>
<p>And this is exactly the case! The mount command always succeeds, if it can‚Äôt be mounted rw then it will be automatically mounted ro. One of the earlier versions of the script actually checked the exit code of the mount command but since it always succeeded it did not work. For my tests I just used an invalid disk identifier. In this case it really fails since there is obviously nothing to mount.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-28T01:18:37Z' class='post-time'>
                June 28, 2018,  1:18am
              </time>
              <meta itemprop='dateModified' content='2018-06-28T01:18:37Z'>
          <span itemprop='position'>#62</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I am very cautious about this since this has potential to break the boot process or kernel package upgrade (initramfs part). Could you please have a look at other initramfs users so we don‚Äôt overlook some common practice here?</p>
<hr>
<p>Does the script need to be idempotent?</p>
<p>If yes: <code>mkdir</code>-&gt; <code>mkdir -p</code></p>
<hr>
<pre><code>if [ -z ‚Äú$(dmesg | grep ‚ÄúBIOS VirtualBox‚Äù)‚Äù ]; then
    echo ‚Äòlive_disk=$(blkid /dev/vda1 -o value -s UUID)‚Äô &gt;&gt; /scripts/local
else
    echo ‚Äòlive_disk=$(blkid /dev/sda1 -o value -s UUID)‚Äô &gt;&gt; /scripts/local
fi
</code></pre>
<p>Could you please add an <code>elif</code> for KVM and then the <code>else</code> if not detection succeeded, the script should continue with some sane default‚Ä¶ Which would be what? Not affecting boot process and continuing normally?</p>
<p>Please echo which virtualizer was being detected to ease future debugging if required.</p>
<hr>
<aside class="quote no-group" data-post="56" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p><code>if [ -z ‚Äú$(dmesg | grep ‚ÄúBIOS VirtualBox‚Äù)‚Äù ]; then</code></p>
</blockquote>
</aside>
<p>dmesg seems the wrong tool for that.</p>
<p><code>systemd-detect-virt</code> is probably unavailable at that point in boot?</p>
<p>In that case let‚Äôs use virt-what / /usr/sbin/virt-what for that? initramfs has some API / config file to have such tools to be copied into initramfs. How to do so can probably be learned at looking at other initramfs users.</p>
<hr>
<blockquote>
<p><code>mount -t ext4 -n -o rw $ROOT /livetest</code></p>
</blockquote>
<p>Is there a better way to test for read/write vs read-only other than using <code>mkdir</code> and <code>mount</code> Couldn‚Äôt we inquiry the kernel about it?</p>
<hr>
<aside class="quote no-group" data-post="56" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p><code>if [ -n ‚Äú$(mount | grep ‚Äú(ro,‚Äù)‚Äù ]; then</code></p>
</blockquote>
</aside>
<p>Is this a common way to check?</p>
<p>Might be better to parse <code>/proc/mounts</code> or something even better?</p>
<p>Anything useful in <a href="../../../external.html?link=https://serverfault.com/questions/193971/determine-if-filesystem-or-partition-is-mounted-ro-or-rw-via-bash-script">https://serverfault.com/questions/193971/determine-if-filesystem-or-partition-is-mounted-ro-or-rw-via-bash-script</a> or related searches?</p>
<hr>
<p>I would like to have this bulletproof even in case the output/format of the <code>mount</code> command or <code>/proc/mounts</code> or <code>virt-what</code> changes in future.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-28T11:17:15Z' class='post-time'>
                June 28, 2018, 11:17am
              </time>
              <meta itemprop='dateModified' content='2018-06-28T11:17:15Z'>
          <span itemprop='position'>#63</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Sure if it somehow breaks then it breaks early in the boot process. But imho this not much different than the current version using grub. The script is based on other initramfs scripts. Since live mode is optional in 14 I‚Äôd keep it as already described on the Whonix live wiki page: make a backup of /boot or even better a VM snapshot. Potential errors can only be found if people actually test it.</p>
<aside class="quote no-group" data-post="62" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Does the script need to be idempotent?</p>
</blockquote>
</aside>
<p>I don‚Äôt see a reason why it should.</p>
<aside class="quote no-group" data-post="62" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Could you please add an <code>elif</code> for KVM and then the <code>else</code> if not detection succeeded, the script should continue with some sane default‚Ä¶ Which would be what? Not affecting boot process and continuing normally?</p>
</blockquote>
</aside>
<p>I can add the elif but there won‚Äôt be an else except maybe dropping to a shell. The part of the script you quoted only takes effect if the disk could not be mounted rw. This either means the user made it ro on the host on purpose or there is something very wrong with his disk. Therefore it also can‚Äôt continue to boot normally since with an ro disk you can‚Äôt boot normally.</p>
<aside class="quote no-group" data-post="62" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Please echo which virtualizer was being detected to ease future debugging if required.</p>
</blockquote>
</aside>
<p>Ok.</p>
<aside class="quote no-group" data-post="62" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p><code>systemd-detect-virt</code> is probably unavailable at that point in boot?</p>
</blockquote>
</aside>
<p>True.</p>
<aside class="quote no-group" data-post="62" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>In that case let‚Äôs use virt-what / /usr/sbin/virt-what for that?</p>
</blockquote>
</aside>
<p>Took a short look at it and it mostly seems to use dmiodecode or stuff in /proc. I can try to put it in the initrd and see how it behaves.</p>
<aside class="quote no-group" data-post="62" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Might be better to parse <code>/proc/mounts</code> or something even better?</p>
</blockquote>
</aside>
<p>I think it doesn‚Äôt get any better than /proc/mounts or just mount. The output of both is more or less the same.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-29T02:54:55Z' class='post-time'>
                June 29, 2018,  2:54am
              </time>
              <meta itemprop='dateModified' content='2018-06-29T02:54:55Z'>
          <span itemprop='position'>#64</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="63" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p><code>systemd-detect-virt</code> is probably unavailable at that point in boot?</p>
</blockquote>
</aside>
<p>Actually, nothing indicates that <code>systemd-detect-virt</code> depends on systemd being running. So it might also run independently.</p>
<aside class="quote no-group" data-post="63" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p>I don‚Äôt see a reason why it should.</p>
</blockquote>
</aside>
<p>Well, there are various initramfs scripts. Those used to create the initramfs and those running during initramfs are separated?</p>
<aside class="quote no-group" data-post="63" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p>I can add the elif but there won‚Äôt be an else except maybe dropping to a shell. The part of the script you quoted only takes effect if the disk could not be mounted rw. This either means the user made it ro on the host on purpose or there is something very wrong with his disk. Therefore it also can‚Äôt continue to boot normally since with an ro disk you can‚Äôt boot normally.</p>
</blockquote>
</aside>
<p>In case of false-positive ro detection boot could continue normally.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-29T02:58:36Z' class='post-time'>
                June 29, 2018,  2:58am
              </time>
              <meta itemprop='dateModified' content='2018-06-29T02:58:36Z'>
          <span itemprop='position'>#65</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="63" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p>But imho this not much different than the current version using grub.</p>
</blockquote>
</aside>
<p>Some differences.</p>
<p>grub-live adds a new boot menu entry. The existing one is preserved. If that one isn‚Äôt used during boot, then the boot is just normal.</p>
<p>initramfs-live code runs every time for everyone. And in case of a bug there is only the debug shell to boot the system?</p>
<p>Documentation on how to boot from debug shell / how to manually boot from grub boot menu using alternative (working initramfs) would be useful.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-29T08:31:00Z' class='post-time'>
                June 29, 2018,  8:31am
              </time>
              <meta itemprop='dateModified' content='2018-06-29T08:31:00Z'>
          <span itemprop='position'>#66</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="64" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Actually, nothing indicates that <code>systemd-detect-virt</code> depends on systemd being running. So it might also run independently.</p>
</blockquote>
</aside>
<p>I can also give it a try in addition to virt-what. Which one would you prefer?</p>
<aside class="quote no-group" data-post="64" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Those used to create the initramfs and those running during initramfs are separated?</p>
</blockquote>
</aside>
<p>I don‚Äôt think I get your point. Scripts for generation as well as those running at boot are scattered accross /etc/initramfs-tools, /usr/share/initramfs-tools, /usr/sbin, /lib/live/boot in case live-tools etc are installed, maybe in other places too.</p>
<aside class="quote no-group" data-post="64" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>In case of false-positive ro detection boot could continue normally.</p>
</blockquote>
</aside>
<p>How do you know if it is a false positive and can you come up with any scenario how a false positive could happen? If you know it is a false positive then you can also prevent the detection of false positives. As described in your link it breaks down to grepping the mount command or /proc/mount which is a fairly simple process. However, as we all know there is no 100% security.</p>
<aside class="quote no-group" data-post="65" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>And in case of a bug there is only the debug shell to boot the system?</p>
</blockquote>
</aside>
<p>Either this or the backup /boot. I can add instructions for that to the wiki. Of course you can also use somthing like chrooting into the system from another system and regenerating the initramfs but this is probably more complicated.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-29T13:04:54Z' class='post-time'>
                June 29, 2018,  1:04pm
              </time>
              <meta itemprop='dateModified' content='2018-06-29T13:04:54Z'>
          <span itemprop='position'>#67</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Algernon:</p>
<blockquote>
<aside class="quote no-group" data-post="64" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Actually, nothing indicates that <code>systemd-detect-virt</code> depends on systemd being running. So it might also run independently.</p>
</blockquote>
</aside>
<p>I can also give it a try in addition to virt-what. Which one would you prefer?</p>
</blockquote>
<p><code>systemd-detect-virt</code> preferred. More updated. Can look at code from<br>
here:<br>
<aside class="onebox githubblob">
  <header class="source">
      <a href="../../../external.html?link=https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_virtualizer.bsh" target="_blank">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="../../../external.html?link=https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_virtualizer.bsh" target="_blank">Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_virtualizer.bsh</a></h4>
<pre><code class="lang-bsh">#!/bin/bash

## Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP &lt;adrelanos@riseup.net&gt;
## See the file COPYING for copying conditions.

check_virtualizer() {
   [ -n "$whonixcheck_virt_detection_tool" ] || whonixcheck_virt_detection_tool="systemd-detect-virt"

   ## Global variable whonixcheck_virtualizer_detected.
   ## (Used by check_pvclock.)

   if command -v "$whonixcheck_virt_detection_tool" &gt;/dev/null 2&gt;&amp;1 ; then
      whonixcheck_virtualizer_detected="$("$whonixcheck_virt_detection_tool" 2&gt;&amp;1)" || true
   else
      local MSG="&lt;p&gt;Check Virtualizer Result: $whonixcheck_virt_detection_tool not available. Skipping test.&lt;/p&gt;"
      $output_x ${output_opts[@]} --messagex --typex "warning" --message "$MSG"
      $output_cli ${output_opts[@]} --messagecli --typecli "warning" --message "$MSG"
      return 0
   fi

</code></pre>

  This file has been truncated. <a href="../../../external.html?link=https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_virtualizer.bsh" target="_blank">show original</a>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
</p>
<blockquote>
<aside class="quote no-group" data-post="64" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Those used to create the initramfs and those running during initramfs are separated?</p>
</blockquote>
</aside>
<p>I don‚Äôt think I get your point. Scripts for generation as well as those running at boot are scattered accross /etc/initramfs-tools, /usr/share/initramfs-tools, /usr/sbin, /lib/live/boot in case live-tools etc are installed, maybe in other places too.</p>
</blockquote>
<p>Ok.</p>
<blockquote>
<aside class="quote no-group" data-post="64" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>In case of false-positive ro detection boot could continue normally.</p>
</blockquote>
</aside>
<p>How do you know if it is a false positive and can you come up with any scenario how a false positive could happen?</p>
</blockquote>
<p>If the format of /proc/mount changes after kernel upgrade.</p>
<blockquote>
<p>If you know it is a false positive then you can also prevent the detection of false positives. As described in your link it breaks down to grepping the mount command or /proc/mount which is a fairly simple process. However, as we all know there is no 100% security.</p>
<aside class="quote no-group" data-post="65" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>And in case of a bug there is only the debug shell to boot the system?</p>
</blockquote>
</aside>
<p>Either this or the backup /boot. I can add instructions for that to the wiki. Of course you can also use somthing like chrooting into the system from another system and regenerating the initramfs but this is probably more complicated.</p>
</blockquote>
<p>Sounds good!</p>
<p>(Sub page /Troubleshooting most likely.)</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-29T20:33:30Z' class='post-time'>
                June 29, 2018,  8:33pm
              </time>
              <meta itemprop='dateModified' content='2018-06-29T20:33:30Z'>
          <span itemprop='position'>#68</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>New version:</p>
<pre><code>#!/bin/sh

set -e

case "${1}" in
        prereqs)
                exit 0
                ;;
esac

echo "Testing for live boot. "
mkdir /livetest
mount -t ext4 -n -o rw $ROOT /livetest
if [ -n "$(mount | grep "(ro,")" ]; then
echo "Mounting root read-write failed. Assuming live-mode. "
umount /livetest
	
	if [ !-x /usr/bin/systemd-detect-virt ]; then
	echo "systemd-detect-virt is missing. Dropping to a shell. " &amp;&amp; /bin/sh
	fi
	
	if [ -n "$( systemd-detect-virt | grep "qemu")" ]; then
	echo 'live_disk=$(blkid /dev/vda1 -o value -s UUID)' &gt;&gt; /scripts/local
	echo "Detected KVM. "
	elif [ -n "$( systemd-detect-virt | grep "oracle")" ]; then
	echo 'live_disk=$(blkid /dev/sda1 -o value -s UUID)' &gt;&gt; /scripts/local
	echo "Detected VirtualBox. "
	else
	echo "Neither VirtualBox nor KVM detected. Live-boot failed. Dropping to a shell. " &amp;&amp; /bin/sh
	fi

echo "BOOT=live" &gt;&gt; /scripts/local
echo 'LIVE_BOOT_CMDLINE="root=/dev/disk/by-uuid/$live_disk boot=live ip=frommedia plainroot union=overlay"' &gt;&gt; /scripts/local
else
echo "Filesystem can be mounted read-write. Proceeding normal boot. "
umount /livetest
fi
if [ -n "$(mount | grep "/livetest")" ]; then
echo "Unmounting the root disk during the live-test failed. Dropping to a shell ... " &amp;&amp; /bin/sh
fi

exit 0
</code></pre>
<p>We also now require:</p>
<p>/etc/initramfs-tools/hooks/systemd-detect-virt with chmod +x</p>
<pre><code>#!/bin/sh

set -e

case "${1}" in
        prereqs)
                exit 0
                ;;
esac

. /usr/share/initramfs-tools/hook-functions
copy_exec /usr/bin/systemd-detect-virt /usr/bin/systemd-detect-virt
</code></pre>
<aside class="quote no-group" data-post="67" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>If the format of /proc/mount changes after kernel upgrade.</p>
</blockquote>
</aside>
<p>The you still don‚Äôt know if the disk is rw or ro. If upstream suddenly changes something there is no way to predict the outcome. The only solution would be to track changes and adapt the script accordingly.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-30T03:19:36Z' class='post-time'>
                June 30, 2018,  3:19am
              </time>
              <meta itemprop='dateModified' content='2018-06-30T03:19:36Z'>
          <span itemprop='position'>#69</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>What happens when the only contents of the script would be this?</p>
<pre><code>#!/bin/sh
set -e
exit 1
</code></pre>
<p>Does normal boot continue or stop boot?</p>
<hr>
<ul>
<li>
<code>mkdir</code> -&gt; <code>mkdir -p</code> - easily made idempotent, why not</li>
<li>missing space: <code>!-x</code> -&gt; <code>! -x</code> (fixed)</li>
<li>leading space: <code>_"</code> - Is this required? (removed for now)</li>
<li>
<code>grep</code> -&gt; <code>grep -i</code> for detect virt - ok?</li>
<li>
<code>if [ ! -x /usr/bin/systemd-detect-virt ]; then</code> - probably not going to work because at that stage the root disk <code>/</code> isn‚Äôt mounted so <code>/usr/bin/systemd-detect-virt</code> can‚Äôt exist. Needs some initramfs hook to copy it into initramfs, I think.</li>
</ul>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-30T03:20:25Z' class='post-time'>
                June 30, 2018,  3:20am
              </time>
              <meta itemprop='dateModified' content='2018-06-30T03:20:25Z'>
          <span itemprop='position'>#70</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <pre><code>#!/bin/sh

set -e

case "${1}" in
        prereqs)
                exit 0
                ;;
esac

output() {
   echo "live boot test: $@"
}

live_boot_test() {
   output "Testing for live boot."

   if [ ! -x /usr/bin/systemd-detect-virt ]; then
      output "systemd-detect-virt is missing."
      read_write=error
      return 0
   fi

   mkdir -p /livetest
   mount -t ext4 -n -o rw $ROOT /livetest

   if [ -n "$(mount | grep "(ro,")" ]; then
      output "Mounting root read-only detected. Assuming live mode."
      read_write=false
   elif [ -n "$(mount | grep "(rw,")" ]; then
      output "Mounting root read-write. Assuming persistent mode."
      read_write=true
   else
      output "Write mode detection failed."
      read_write=error
   fi

   if ! umount /livetest ; then
      output "Unmounting the root disk failed."
      read_write=error
      ## TODO: Should we exit 0 here or is non-zero more appropriate?
      exit 0
   fi

   if [ -n "$(mount | grep "/livetest")" ]; then
      output "Root disk still mounted after umount."
      read_write=error
      ## TODO: Should we exit 0 here or is non-zero more appropriate?
      exit 0
   fi
}

live_boot() {
   if [ -n "$( systemd-detect-virt | grep -i "qemu")" ]; then
      output "Detected KVM."
      echo 'live_disk=$(blkid /dev/vda1 -o value -s UUID)' &gt;&gt; /scripts/local

   elif [ -n "$( systemd-detect-virt | grep -i "oracle")" ]; then
      output "Detected VirtualBox."
      echo 'live_disk=$(blkid /dev/sda1 -o value -s UUID)' &gt;&gt; /scripts/local
   else
      output "Neither VirtualBox nor KVM detected."
      ## Don't live boot.
      return 0
   fi

   echo "BOOT=live" &gt;&gt; /scripts/local
   echo 'LIVE_BOOT_CMDLINE="root=/dev/disk/by-uuid/$live_disk boot=live ip=frommedia plainroot union=overlay"' &gt;&gt; /scripts/local

   exit 0
}

live_boot_test

if [ "$read_write" = "false" ]; then
   live_boot
fi

output "Proceeding persistent boot."

exit 0</code></pre>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-30T03:21:27Z' class='post-time'>
                June 30, 2018,  3:21am
              </time>
              <meta itemprop='dateModified' content='2018-06-30T03:21:27Z'>
          <span itemprop='position'>#71</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Pure theory. What do you think about these changes? If ok, could you please test? If still ok, could you please add license header and add to git?</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-30T06:37:03Z' class='post-time'>
                June 30, 2018,  6:37am
              </time>
              <meta itemprop='dateModified' content='2018-06-30T06:37:03Z'>
          <span itemprop='position'>#72</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Some more theoretic enhancements. The /proc/mounts parser is tested on my running Debian system but not during actual initramfs. Enhanced the /proc/mounts parser to make sure if any other (user or distribution) initramfs script mounts anything, so we don‚Äôt accidentally match <code>ro</code>.</p>
<pre><code>#!/bin/sh

set -e

case "${1}" in
        prereqs)
                exit 0
                ;;
esac

output() {
   echo "live boot test: $@"
}

## based on St√©phane Chazelas answer
## https://unix.stackexchange.com/a/417188
parse_mount_options() {
   set -o noglob # disable glob part
   IFS=","         # split on colon
   set -- $1     # split+glob
   first="$1"
   if [ "$first" = "rw" ]; then
      output "Read-write disk detected. Assuming persistent mode."
      read_write=true
   elif [ "$first" = "ro" ]; then
      output "Read-only disk detected. Assuming live mode."
      read_write=false
   else
      output "Write mode detection failed."
      read_write=error
   fi
}

## Taken from os-prober /usr/share/os-prober/common.sh and modified.
parse_proc_mounts () {
	while read -r line; do
		set -f
		set -- $line
		set +f
		true "line: $line"
		path="$1"
		mount_point="$2"
		file_system="$3"
		mount_options="$4"
		if [ "$path" = "/livetest" ]; then
         parse_mount_options "$mount_options"
         return 0
      fi
	done
}

live_boot_test() {
   output "Testing for live boot."

   if [ ! -x /usr/bin/systemd-detect-virt ]; then
      output "systemd-detect-virt is missing."
      read_write=error
      return 0
   fi

   mkdir -p /livetest
   mount -t ext4 -n -o rw $ROOT /livetest

   cat /proc/mounts | parse_proc_mounts

   if umount /livetest ; then
      rmdir --ignore-fail-on-non-empty /livetest
   else
      output "Unmounting the root disk failed."
      read_write=error
   fi

   if [ -n "$(cat /proc/mounts | grep "/livetest")" ]; then
      output "Root disk still mounted after umount."
      read_write=error
   fi
}

live_boot() {
   if [ -n "$( systemd-detect-virt | grep -i "qemu")" ]; then
      output "Detected KVM."
      echo 'live_disk=$(blkid /dev/vda1 -o value -s UUID)' &gt;&gt; /scripts/local

   elif [ -n "$( systemd-detect-virt | grep -i "oracle")" ]; then
      output "Detected VirtualBox."
      echo 'live_disk=$(blkid /dev/sda1 -o value -s UUID)' &gt;&gt; /scripts/local
   else
      output "Neither VirtualBox nor KVM detected."
      ## Don't live boot.
      return 0
   fi

   echo "BOOT=live" &gt;&gt; /scripts/local
   echo 'LIVE_BOOT_CMDLINE="root=/dev/disk/by-uuid/$live_disk boot=live ip=frommedia plainroot union=overlay"' &gt;&gt; /scripts/local

   exit 0
}

live_boot_test

if [ "$read_write" = "error" ]; then
   output "Contents of /proc/mounts:"
   cat /proc/mounts
   ## TODO: Should we exit 0 here or is non-zero more appropriate?
   exit 0
fi

if [ "$read_write" = "false" ]; then
   live_boot
fi

output "Proceeding persistent boot."

exit 0</code></pre>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-06-30T12:17:40Z' class='post-time'>
                June 30, 2018, 12:17pm
              </time>
              <meta itemprop='dateModified' content='2018-06-30T12:17:40Z'>
          <span itemprop='position'>#73</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="69" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Does normal boot continue or stop boot?</p>
</blockquote>
</aside>
<p>Boots as always.</p>
<aside class="quote no-group" data-post="69" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>eading space: <code>_"</code> - Is this required? (removed for now)</p>
</blockquote>
</aside>
<p>Not really. Looks imho sometimes better when reading stuff from the commandline.</p>
<aside class="quote no-group" data-post="69" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p><code>grep</code> -&gt; <code>grep -i</code> for detect virt - ok?</p>
</blockquote>
</aside>
<p>Yes.</p>
<aside class="quote no-group" data-post="69" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Needs some initramfs hook to copy it into initramfs, I think.</p>
</blockquote>
</aside>
<p>Yes. See previous post.</p>
<p>Your last script does not work for me. It works for normal boot but fails when the disk is set ro. Either ‚Äú/livetest‚Äù needs to be set to ‚Äú/dev/vda1‚Äù or $mount_point needs to be used instead of $path.<br>
When changed accordingly the proc parser generally works  but the read_write variable somehow is not set in the live_boot_test function. Not sure why it gets lost. In this case live boot does not work with a ro disk.<br>
While theoretically failsafe the rmdir is not really required. I‚Äôd just leave the directory there since it is just in the initramfs.<br>
We don‚Äôt drop to a shell in case of errors. I have to think about if is easier for debugging to do that. Alternative would be to set ‚Äúdebug‚Äù and ‚Äúbreak‚Äù on the kernel command line in case something goes wrong.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-01T05:44:25Z' class='post-time'>
                July 1, 2018,  5:44am
              </time>
              <meta itemprop='dateModified' content='2018-07-01T05:44:25Z'>
          <span itemprop='position'>#74</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Algernon:</p>
<blockquote>
<aside class="quote no-group" data-post="69" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>eading space: <code>_"</code> - Is this required? (removed for now)</p>
</blockquote>
</aside>
<p>Not really. Looks imho sometimes better when reading stuff from the commandline.</p>
</blockquote>
<p>Well, if it looks better then it‚Äôs ‚Äúrequired‚Äù.</p>
<blockquote>
<p>Your last script does not work for me. It works for normal boot but fails when the disk is set ro. Either ‚Äú/livetest‚Äù needs to be set to ‚Äú/dev/vda1‚Äù or $mount_point needs to be used instead of $path.</p>
</blockquote>
<p>Fixed, set to mount_point. Please check.</p>
<blockquote>
<p>When changed accordingly the proc parser generally works  but the read_write variable somehow is not set in the live_boot_test function. Not sure why it gets lost. In this case live boot does not work with a ro disk.</p>
</blockquote>
<p>I‚Äôll post a version with debugging enabled. Maybe that helps to idenitfy<br>
the error. Please post the debug output here if not.</p>
<blockquote>
<p>While theoretically failsafe the rmdir is not really required. I‚Äôd just leave the directory there since it is just in the initramfs.</p>
</blockquote>
<p>Ok.</p>
<blockquote>
<p>We don‚Äôt drop to a shell in case of errors. I have to think about if is easier for debugging to do that.</p>
</blockquote>
<blockquote>
<p>Alternative would be to set ‚Äúdebug‚Äù and ‚Äúbreak‚Äù on the kernel command<br>
line in case something goes wrong.</p>
</blockquote>
<p>Yes, perhaps is livedebug=1 (or so) is set as kernel command line, drop<br>
to shell from initramfs-live?</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-01T05:44:49Z' class='post-time'>
                July 1, 2018,  5:44am
              </time>
              <meta itemprop='dateModified' content='2018-07-01T05:44:49Z'>
          <span itemprop='position'>#75</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <pre><code class="lang-auto">#!/bin/sh

set -x

set -e

case "${1}" in
        prereqs)
                exit 0
                ;;
esac

output() {
   echo "live boot test: $@"
}

## based on St√©phane Chazelas answer
## https://unix.stackexchange.com/a/417188
parse_mount_options() {
   set -o noglob # disable glob part
   IFS=","       # split on colon
   set -- $1     # split+glob
   first="$1"
   if [ "$first" = "rw" ]; then
      output "Read-write disk detected. Assuming persistent mode."
      read_write=true
   elif [ "$first" = "ro" ]; then
      output "Read-only disk detected. Assuming live mode."
      read_write=false
   else
      output "Write mode detection failed."
      read_write=error
   fi
}

## Taken from os-prober /usr/share/os-prober/common.sh and modified.
parse_proc_mounts () {
	while read -r line; do
		set -f
		set -- $line
		set +f
		true "line: $line"
		path="$1"
		mount_point="$2"
		file_system="$3"
		mount_options="$4"
		if [ "$mount_point" = "/livetest" ]; then
         parse_mount_options "$mount_options"
         return 0
      fi
	done
}

live_boot_test() {
   output "Testing for live boot."

   if [ ! -x /usr/bin/systemd-detect-virt ]; then
      output "systemd-detect-virt is missing."
      read_write=error
      return 0
   fi

   mkdir -p /livetest
   mount -t ext4 -n -o rw $ROOT /livetest

   cat /proc/mounts | parse_proc_mounts

   if ! umount /livetest ; then
      output "Unmounting the root disk failed."
      read_write=error
   fi

   if [ -n "$(cat /proc/mounts | grep "/livetest")" ]; then
      output "Root disk still mounted after umount."
      read_write=error
   fi
}

live_boot() {
   if [ -n "$(systemd-detect-virt | grep -i "qemu")" ]; then
      output "Detected KVM."
      echo 'live_disk=$(blkid /dev/vda1 -o value -s UUID)' &gt;&gt; /scripts/local
   elif [ -n "$(systemd-detect-virt | grep -i "oracle")" ]; then
      output "Detected VirtualBox."
      echo 'live_disk=$(blkid /dev/sda1 -o value -s UUID)' &gt;&gt; /scripts/local
   else
      output "Neither VirtualBox nor KVM detected."
      ## Don't live boot.
      return 0
   fi

   echo "BOOT=live" &gt;&gt; /scripts/local
   echo 'LIVE_BOOT_CMDLINE="root=/dev/disk/by-uuid/$live_disk boot=live ip=frommedia plainroot union=overlay"' &gt;&gt; /scripts/local

   exit 0
}

true "Setting fallback read_write=error."
read_write=error

live_boot_test

if [ "$read_write" = "error" ]; then
   output "Contents of /proc/mounts:"
   cat /proc/mounts
   ## TODO: Should we exit 0 here or is non-zero more appropriate?
   exit 0
fi

if [ "$read_write" = "false" ]; then
   live_boot
fi

output "Proceeding persistent boot."

exit 0
</code></pre>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-01T20:52:46Z' class='post-time'>
                July 1, 2018,  8:52pm
              </time>
              <meta itemprop='dateModified' content='2018-07-01T20:52:46Z'>
          <span itemprop='position'>#76</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Ok the issue was the pipe see here: <a href="../../../external.html?link=http://www.linuxprogrammingblog.com/pipe-in-bash-can-be-a-trap" rel="nofollow noopener">http://www.linuxprogrammingblog.com/pipe-in-bash-can-be-a-trap</a><br>
Below script now works. If there are no further issues I will try to build the deb package and see how it behaves. If all goes well I‚Äôll update the package on github and the wiki page.</p>
<pre><code>#!/bin/sh

set -e

case "${1}" in
        prereqs)
                exit 0
                ;;
esac

output() {
   echo "live boot test: $@"
}

## based on St√©phane Chazelas answer
## https://unix.stackexchange.com/a/417188
parse_mount_options() {
   set -o noglob # disable glob part
   IFS=","       # split on colon
   set -- $1     # split+glob
   first="$1"
   if [ "$first" = "rw" ]; then
      output "Read-write disk detected. Assuming persistent mode."
      read_write=true
   elif [ "$first" = "ro" ]; then
      output "Read-only disk detected. Assuming live mode."
      read_write=false
   else
      output "Write mode detection failed."
      read_write=error
   fi
}

## Taken from os-prober /usr/share/os-prober/common.sh and modified.
parse_proc_mounts () {
	while read -r line; do
		set -f
		set -- $line
		set +f
		true "line: $line"
		path="$1"
		mount_point="$2"
		file_system="$3"
		mount_options="$4"
		if [ "$mount_point" = "/livetest" ]; then
         parse_mount_options "$mount_options"
         return 0
      fi
	done &lt; /proc/mounts
}

live_boot_test() {
   output "Testing for live boot."

   if [ ! -x /usr/bin/systemd-detect-virt ]; then
      output "systemd-detect-virt is missing."
      read_write=error
      return 0
   fi

   mkdir -p /livetest
   mount -t ext4 -n -o rw $ROOT /livetest

   parse_proc_mounts

   if ! umount /livetest ; then
      output "Unmounting the root disk failed."
      read_write=error
   fi

   if [ -n "$(cat /proc/mounts | grep "/livetest")" ]; then
      output "Root disk still mounted after umount."
      read_write=error
   fi
}

live_boot() {
   if [ -n "$(systemd-detect-virt | grep -i "qemu")" ]; then
      output "Detected KVM."
      echo 'live_disk=$(blkid /dev/vda1 -o value -s UUID)' &gt;&gt; /scripts/local
   elif [ -n "$(systemd-detect-virt | grep -i "oracle")" ]; then
      output "Detected VirtualBox."
      echo 'live_disk=$(blkid /dev/sda1 -o value -s UUID)' &gt;&gt; /scripts/local
   else
      output "Neither VirtualBox nor KVM detected."
      ## Don't live boot.
      return 0
   fi

   echo "BOOT=live" &gt;&gt; /scripts/local
   echo 'LIVE_BOOT_CMDLINE="root=/dev/disk/by-uuid/$live_disk boot=live ip=frommedia plainroot union=overlay"' &gt;&gt; /scripts/local

   exit 0
}

true "Setting fallback read_write=error."
read_write=error

live_boot_test

if [ "$read_write" = "error" ]; then
   output "Contents of /proc/mounts:"
   cat /proc/mounts
   ## TODO: Should we exit 0 here or is non-zero more appropriate?
   exit 0
fi

if [ "$read_write" = "false" ]; then
   live_boot
fi

output "Proceeding persistent boot."

exit 0</code></pre>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-02T03:12:48Z' class='post-time'>
                July 2, 2018,  3:12am
              </time>
              <meta itemprop='dateModified' content='2018-07-02T03:12:48Z'>
          <span itemprop='position'>#77</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Is it possible to use bash inside initramfs? I would very much like to add an error handling <code>trap</code>.</p>
<p>Perhaps leave <a href="../../../external.html?link=https://github.com/Whonix/grub-live">https://github.com/Whonix/grub-live</a> as is? I think it‚Äôs a really cool implementation.</p>
<p>The project name <code>grub-live</code> no longer applies since it‚Äôs now initramfs based. Perhaps a new package? How to call it‚Ä¶? <code>initramfs-live</code>? Or better perhaps we can find a generic name that is independent from the implementation tails grub vs initramfs based? This is only useful inside virtual machines and doesn‚Äôt look like it will be useful on bare metal? That may influence naming. I guess this could be interesting for bare metal for disks which have a physical (or BIOS / firmware) read-only on/off switch.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-02T03:28:00Z' class='post-time'>
                July 2, 2018,  3:28am
              </time>
              <meta itemprop='dateModified' content='2018-07-02T03:28:00Z'>
          <span itemprop='position'>#78</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>A few ideas‚Ä¶</p>
<ul>
<li>read-only-live-boot</li>
<li>live-boot-auto-detection</li>
<li>live-boot-auto-detector</li>
<li>live-boot-detector</li>
</ul>
<p>Could you please discuss this with upstream / try to upstream this?</p>
<p>What would be a good place to upstream this? A few ideas:</p>
<ul>
<li><a href="../../../external.html?link=https://packages.debian.org/stretch/live-tools">https://packages.debian.org/stretch/live-tools</a></li>
<li>
<a href="../../../external.html?link=https://packages.debian.org/stretch/open-infrastructure-system-boot">https://packages.debian.org/stretch/open-infrastructure-system-boot</a> / <a href="../../../external.html?link=https://open-infrastructure.net/software/system-boot/">https://open-infrastructure.net/software/system-boot/</a>
</li>
<li><a href="../../../external.html?link=https://packages.debian.org/stretch/initramfs-tools-core">https://packages.debian.org/stretch/initramfs-tools-core</a></li>
</ul>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/HulaHoop'><span itemprop='name'>HulaHoop</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-02T03:34:10Z' class='post-time'>
                July 2, 2018,  3:34am
              </time>
              <meta itemprop='dateModified' content='2018-07-02T03:39:17Z'>
          <span itemprop='position'>#79</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>ephemeral-mode?</p>
<p>Actually since you want a more descript name, why not ro-mode-init?</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="3894.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-07-02T11:07:09Z' class='post-time'>
                July 2, 2018, 11:07am
              </time>
              <meta itemprop='dateModified' content='2018-07-02T11:07:09Z'>
          <span itemprop='position'>#80</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="77" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Is it possible to use bash inside initramfs? I would very much like to add an error handling <code>trap</code> .</p>
</blockquote>
</aside>
<p>Certainly not impossible, but would at least require an initramfs hook. However, I‚Äôd stick to what it is in there by default. Every other script in there also uses those programs.</p>
<aside class="quote no-group" data-post="77" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Perhaps leave <a href="../../../external.html?link=https://github.com/Whonix/grub-live" rel="nofollow noopener">https://github.com/Whonix/grub-live</a> as is? I think it‚Äôs a really cool implementation.</p>
</blockquote>
</aside>
<p>I can do that. We need another name anyway. ro-mode-init would give a nice abbreviation, romi.</p>
<aside class="quote no-group" data-post="77" data-topic="3894">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>This is only useful inside virtual machines and doesn‚Äôt look like it will be useful on bare metal?</p>
</blockquote>
</aside>
<p>You could maybe use a fallback option for systemd-detect-virt in case it does not detect a hypervisor to automatically assume bare metal. Or you get rid of it at all. You could always parse the underlying stuff directly from /proc or /sys which more or less each virtualization detection tool does and virt-what even suggests in the man page. More recent versions of the kernel can see very early in the boot process if the disk is write protected which could maye also be used instead. It is under  /sys/block/vda/ro or similar path depending on the disk driver.<br>
I can try to contact upstream, though in its current form it is using some rather hacky workarounds to actually not need to change the upstream packages <img src="../../images/emoji/twitter/winkae52.png?v=5" title=":wink:" class="emoji" alt=":wink:"> and is basically an end-user friendly version of adding ‚Äúplainroot ‚Ä¶‚Äù to the boot options. It makes some assumptions which are rather Whonix-specific and always relies on user interaction on the host to work as intended.</p>
        </div>

        <meta itemprop='headline' content='Whonix live mode / amnesia / amnesic / non-persistent / anti-forensics'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><a rel="prev" itemprop="url" href="38949ba9.html?page=3">‚Üê previous page</a></span>
        <span itemprop='name'><b><a rel="next" itemprop="url" href="3894af4d.html?page=5">next page ‚Üí</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
