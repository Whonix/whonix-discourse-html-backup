<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Have firewall accept ICMP Fragmentation Needed</title>
    <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233</link>
    <description>I opened a pull request.

https://github.com/Whonix/whonix-firewall/pull/7

But was told that the requested change needs to be discussed here first. So, here we go.

Let&#39;s just start off with the commit message from my pull requests:

&gt; We want certain related packages to be accepted. In particular,
I&#39;ve run into issues using a VPN in front of a Whonix Gateway. This
because the related Fragmentation Needed packages get dropped:
&gt;
&gt; 1780 280.196298 10.137.0.31 → 10.137.0.19 ICMP 590 Destination unreachable (Fragmentation needed)
&gt;
&gt; With those packages not being delivered, a connection can be
established and works fine until a large package is sent. However,
once that happens no more packages can be delivered and the
connection times out after a while.
&gt;
&gt; There is probably also a bunch of other, related packages that
we want to be delivered. ICMP host unreachable comes to mind, for
instance. Without it being delivered, one has to wait for
the connection attempt to timeout.
&gt;
&gt; Note: Related connections appear to have been disabled in
414c2105149e02dcff82303e4c5b2dcd60ebbd29 but with no clear indication to why.

I do think it&#39;s reasonable to adjust the firewall to ensure ICMP Fragmentation Needed packages are delivered. A hop with a lower MTU somewhere in the network should simply not break the network connection, at least in my opinion. Of course, there are other ways to allow Fragmentation Needed packages than just allowing RELATED packages but I&#39;d like to hear any concerns about using this approach first before looking into how those concerns can be addressed.</description>
    <language>en</language>
    <lastBuildDate>Wed, 13 Oct 2021 14:33:33 +0000</lastBuildDate>
    <category>Development</category>
    <atom:link href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-username="aurin04" data-post="8" data-topic="10233">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/a/34f0e0/40.png" class="avatar"> aurin04:</div>
<blockquote>
<p>I have since fixed the issue on my end by ignoring the ISP’s advertised limits</p>
</blockquote>
</aside>
<p>How?</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/9</link>
        <pubDate>Wed, 13 Oct 2021 14:33:33 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-9</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[aurin04]]></dc:creator>
        <description><![CDATA[
            <p>I have since fixed the issue on my end by ignoring the ISP’s advertised limits, but if this does what I think and simply allows all ICMP messages, then that would have the same effect as my whitelisting of ICMP which I had found during debugging.</p>
<p>I think just whitelisting the specific messages related to link quality would also work with lesser security implications, but as noted that is not currently implemented. In any case, good to have it documented.</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/8</link>
        <pubDate>Sun, 10 Oct 2021 23:39:50 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-8</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Does <a href="https://www.whonix.org/wiki/Troubleshooting#ICMP_Fix">ICMP Fix</a> help? Documented just now.</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/7</link>
        <pubDate>Wed, 06 Oct 2021 10:07:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-7</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[aurin04]]></dc:creator>
        <description><![CDATA[
            <p>To head off claims I didn’t check first, I’m just not sure what the rules for necroing are on this forum. There is a thread titled “Have firewall accept ICMP Fragmentation Needed” about this.</p>
<p>I recently had to deal with the infamous “Tor stuck at 45% forever and not connecting” problem. This turned out to be because of misconfigured hardware ISP-side advertising an MTU lower than Whonix assumes (1500).</p>
<p>If Whonix bothered to actually accept “Destination Unreachable” ICMP messages, it would have quickly noticed the need to fragment the packets so that Tor could even get started working. In fact, specifically adding a rule to accept those “miraculously” fixed the issue, as one would expect. It later turned out that my connection <em>does</em> support higher MTUs despite the ISP’s DHCP options, but that’s just luck.</p>
<p>This also means that Whonix is fundamentally unusable by users stuck on subpar networking links such as dialup when using its default settings (unless they know to manually adjust the MTU of interfaces in the Whonix VM), which is still in use in my country, especially in rural areas.</p>
<aside class="quote no-group" data-username="HulaHoop" data-post="4" data-topic="10233">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p>If we have to make decisions based on security vs performance tradeoff we will choose security almost every time if there isn’t a crippling effect on usability.</p>
</blockquote>
</aside>
<p>I think this qualifies as a crippling effect on usability.</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/6</link>
        <pubDate>Wed, 06 Oct 2021 03:12:41 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-6</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>The ability to customize Whonix firewall is pretty good already, I hope. It supports a configuration drop-in folder.</p>
<p>Related:</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.whonix.org/w/images/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://www.whonix.org/wiki/Configuration_Files" target="_blank" title="11:42PM - 19 June 2020">Whonix – 19 Jun 20</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:110/73;"><img src="https://www.whonix.org/w/images/3/3b/Five-elements-379106640.jpg" class="thumbnail" width="110" height="73"></div>

<h3><a href="https://www.whonix.org/wiki/Configuration_Files" target="_blank">Configuration Files - Whonix</a></h3>

<p>Everything you should know about Configuration Drop-in Folders and Files.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>There is a setting <code>GATEWAY_ALLOW_INCOMING_ICMP=1</code> which would prevent addition of this iptables rule:</p>
<blockquote>
<p><code>$iptables_cmd -A INPUT -p icmp -j DROP</code></p>
</blockquote>
<p>Also could could overwrite whole function <code>ipv4_input_rules</code>  (or any other function) by supplying your own version in config.</p>
<p>As for <code>ESTABLISHED</code> vs <code>ESTABLISHED,RELATED</code> I would accept a patch to make that a variable in the usual script style. Default to <code>ESTABLISHED</code> and possibly overwrite as variable in config.</p>
<p>If you have other suggestions to make Whonix firewall easier customizable please discuss.</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/5</link>
        <pubDate>Thu, 10 Sep 2020 10:22:53 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-5</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>Generally, using any ICMP opens users to the possibility of a sidechannel - CPU has a very visible effect on ICMP packet latency.</p>
<p>Second. If we have to make decisions based on security vs performance tradeoff we will choose security almost every time if there isn’t a crippling effect on usability.</p>
<aside class="quote no-group" data-username="pege" data-post="3" data-topic="10233">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/p/f1d935/40.png" class="avatar"> pege:</div>
<blockquote>
<p>(Of course, if connection tracking was disabled entirely or if additional conntrack helpers were in use, this wouldn’t hold true.)</p>
</blockquote>
</aside>
<p>We disable connection tracking by default so there would be added attack surface.</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/4</link>
        <pubDate>Mon, 07 Sep 2020 18:19:04 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-4</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[pege]]></dc:creator>
        <description><![CDATA[
            <p>Perhaps, we could create a more explicit rule. Something like:</p>
<pre><code class="lang-auto">iptables -I INPUT --proto icmp --icmp-type destination-unreachable -m state --state RELATED -j ACCEPT
</code></pre>
<p>Worst case, we’d let through a <em>destination-unreachable</em> package that’s not actually associated with a connection. In that case, it’d simply be discarded upon reception.</p>
<p>As for the danger of adding additional complexity because of the additional parsing required. As I understand it, this will happen here anyway in order for connection tracking to assign <a href="https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html#STATEMACHINE" rel="nofollow noopener">one of the NEW, ESTABLISHED, RELATED or INVALID states</a>. Whether we use the state information doesn’t matter. (Of course, if connection tracking was disabled entirely or if additional conntrack helpers were in use, this wouldn’t hold true.)</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/3</link>
        <pubDate>Mon, 07 Sep 2020 16:13:11 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-3</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>We drop all ICMP by default anyhow.</p>
<p>Reason for removal of <code>RELATED</code>:</p>
<ul>
<li><a href="https://lists.autistici.org/message/20141203.172230.8dcda825.en.html">https://lists.autistici.org/message/20141203.172230.8dcda825.en.html</a></li>
<li><a href="https://lists.autistici.org/thread/20141203.172230.8dcda825.en.html#i20141203.172230.8dcda825">https://lists.autistici.org/thread/20141203.172230.8dcda825.en.html#i20141203.172230.8dcda825</a></li>
</ul>
<p>Reason to be cautious:</p>
<ul>
<li><a href="https://lists.torproject.org/pipermail/tor-talk/2014-March/032503.html">https://lists.torproject.org/pipermail/tor-talk/2014-March/032503.html</a></li>
</ul>
<p>Reasons for not enabling <code>RELATED</code> by default:</p>
<ul>
<li>works great for years, nobody ever noticed</li>
<li><a href="https://www.whonix.org/wiki/Tunnels/Introduction">https://www.whonix.org/wiki/Tunnels/Introduction</a></li>
</ul>
<p>//cc <a class="mention" href="http://forums.whonix.org/u/hulahoop">@HulaHoop</a></p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/2</link>
        <pubDate>Mon, 07 Sep 2020 14:07:35 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-2</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
      <item>
        <title>Have firewall accept ICMP Fragmentation Needed</title>
        <dc:creator><![CDATA[pege]]></dc:creator>
        <description><![CDATA[
            <p>I opened a pull request.</p>
<aside class="onebox githubpullrequest">
  <header class="source">

      <a href="https://github.com/Whonix/whonix-firewall/pull/7" target="_blank" rel="noopener nofollow ugc">github.com/Whonix/whonix-firewall</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">
  <div class="github-icon-container" title="Pull Request">
    <svg width="60" height="60" class="github-icon" viewBox="0 0 12 16" aria-hidden="true"><path d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
  </div>

  <div class="github-info-container">
    <h4>
      <a href="https://github.com/Whonix/whonix-firewall/pull/7" target="_blank" rel="noopener nofollow ugc">Allow related in addition to established connections</a>
    </h4>

    <div class="branches">
      <code>Whonix:master</code> ← <code>pgerber:related</code>
    </div>

    <div class="github-info">
      <div class="date">
        opened <span class="discourse-local-date" data-format="ll" data-date="2020-09-05" data-time="18:37:54" data-timezone="UTC">06:37PM - 05 Sep 20 UTC</span>
      </div>

      <div class="user">
        <a href="https://github.com/pgerber" target="_blank" rel="noopener nofollow ugc">
          <img alt="pgerber" src="https://avatars.githubusercontent.com/u/11895833?v=4" class="onebox-avatar-inline" width="20" height="20">
          pgerber
        </a>
      </div>

      <div class="lines" title="1 commits changed 3 files with 4 additions and 4 deletions">
        <a href="https://github.com/Whonix/whonix-firewall/pull/7/files" target="_blank" rel="noopener nofollow ugc">
          <span class="added">+4</span>
          <span class="removed">-4</span>
        </a>
      </div>
    </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">We want certain related packages to be accepted. In particular,
I've run into i<span class="show-more-container"><a href="https://github.com/Whonix/whonix-firewall/pull/7" target="_blank" rel="noopener nofollow ugc" class="show-more">…</a></span><span class="excerpt hidden">ssues using a VPN in front of a Whonix Gateway. This
because the related Fragmentation Needed packages get dropped:

 1780 280.196298  10.137.0.31 → 10.137.0.19  ICMP 590 Destination unreachable (Fragmentation needed)

With those packages not being delivered, a connection can be
established and works fine until a large package is sent. However,
once that happens no more packages can be delivered and the
connection times out after a while.

There is probably also a bunch of other, related packages that
we want to be delivered. ICMP host unreachable comes to mind, for
instance. Without it being delivered, one has to wait for
the connection attempt to timeout.

Note: Related connections appear to have been disabled in
414c2105149e02 but with no clear indication to why.</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p>But was told that the requested change needs to be discussed here first. So, here we go.</p>
<p>Let’s just start off with the commit message from my pull requests:</p>
<blockquote>
<p>We want certain related packages to be accepted. In particular,<br>
I’ve run into issues using a VPN in front of a Whonix Gateway. This<br>
because the related Fragmentation Needed packages get dropped:</p>
<p>1780 280.196298 10.137.0.31 → 10.137.0.19 ICMP 590 Destination unreachable (Fragmentation needed)</p>
<p>With those packages not being delivered, a connection can be<br>
established and works fine until a large package is sent. However,<br>
once that happens no more packages can be delivered and the<br>
connection times out after a while.</p>
<p>There is probably also a bunch of other, related packages that<br>
we want to be delivered. ICMP host unreachable comes to mind, for<br>
instance. Without it being delivered, one has to wait for<br>
the connection attempt to timeout.</p>
<p>Note: Related connections appear to have been disabled in<br>
414c2105149e02dcff82303e4c5b2dcd60ebbd29 but with no clear indication to why.</p>
</blockquote>
<p>I do think it’s reasonable to adjust the firewall to ensure ICMP Fragmentation Needed packages are delivered. A hop with a lower MTU somewhere in the network should simply not break the network connection, at least in my opinion. Of course, there are other ways to allow Fragmentation Needed packages than just allowing RELATED packages but I’d like to hear any concerns about using this approach first before looking into how those concerns can be addressed.</p>
          <p><a href="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233/1</link>
        <pubDate>Mon, 07 Sep 2020 12:54:48 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-10233-1</guid>
        <source url="http://forums.whonix.org/t/have-firewall-accept-icmp-fragmentation-needed/10233.rss">Have firewall accept ICMP Fragmentation Needed</source>
      </item>
  </channel>
</rss>
