<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Reducing size of ova images - VirtualBox - Whonix Forum</title>
    <meta name="description" content="It is possible to seriously reduce the size of the vanilla ova images of both Whonix-Gateway and Whonix-Workstation VM. In VirtualBox, the easiest way is to import the ova as usual, fire them up with a live-boot ISO of a&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="50954658.html?page=2" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../c/news/21.html">NEWS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Reducing size of ova images&#39;" href="5095.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/reducing-size-of-ova-images/5095?page=2" />
<meta name="twitter:url" content="https://forums.whonix.org/t/reducing-size-of-ova-images/5095?page=2" />
<meta property="og:title" content="Reducing size of ova images" />
<meta name="twitter:title" content="Reducing size of ova images" />
<meta property="og:description" content="If you want more output and sanity checking:   progress indicator (libvirt_compress uses pv to invent a progress  indicator, I think, might be suitable for adjustment / copy / paste,  otherwise ‚Äúmygrep‚Äù for pv to see other use examples of pv) check size before running (and output) check size after running output human readable summary output size in GB X.XX or so Should be smaller. If not, virt-sparsify failed, obviously. In that  case, make the build script fail. Add an error. (Might happen in  ..." />
<meta name="twitter:description" content="If you want more output and sanity checking:   progress indicator (libvirt_compress uses pv to invent a progress  indicator, I think, might be suitable for adjustment / copy / paste,  otherwise ‚Äúmygrep‚Äù for pv to see other use examples of pv) check size before running (and output) check size after running output human readable summary output size in GB X.XX or so Should be smaller. If not, virt-sparsify failed, obviously. In that  case, make the build script fail. Add an error. (Might happen in  ..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="15 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="23 ‚ù§" />
<meta property="article:published_time" content="2018-04-30T07:33:00+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="prev" href="5095.html">
        <link rel="next" href="50959ba9.html?page=3">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="5095.html">Reducing size of ova images</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/virtualbox/16.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #283890'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>VirtualBox</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T07:33:00Z' class='post-time'>
                April 30, 2018,  7:33am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T07:33:00Z'>
          <span itemprop='position'>#21</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>If you want more output and sanity checking:</p>
<ul>
<li>progress indicator (libvirt_compress uses <code>pv</code> to invent a progress<br>
indicator, I think, might be suitable for adjustment / copy / paste,<br>
otherwise ‚Äúmygrep‚Äù for <code>pv</code> to see other use examples of <code>pv</code>)</li>
<li>check size before running (and output)</li>
<li>check size after running</li>
<li>output human readable summary</li>
<li>output size in GB X.XX or so</li>
<li>Should be smaller. If not, virt-sparsify failed, obviously. In that<br>
case, make the build script fail. Add an <code>error</code>. (Might happen in<br>
future versions of virt-sparsify or its dependencies or due to build<br>
script bugs.)</li>
</ul>
<p>But all of that is very optional. (Meaning: can merge either way even as<br>
is.) Seems pretty good. Perhaps I‚Äôll include even in Whonix 14.</p>
<p>Maybe even decreases build times (libvirt compression)? (Unimportant<br>
question.)</p>
<p>Decreases upload time due to smaller sizes, and download times for<br>
everyone, which is amazing!</p>
<p>onion_knight:</p>
<blockquote>
<aside class="quote" data-post="19" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Looks really good! Without having tested it, I don‚Äôt see anything wrong</p>
<p>with it at first look.</p>
</blockquote>
</aside>
<p>Nice! What is the procedure now? Do I suggest this script on phabricator? Or do we continue the discussion here?</p>
</blockquote>
<p>A phabricator ticket would be good as reminder (used as todo list).<br>
Description can be minimal. With link to this forum discussion.</p>
<p>Script on phabricator: no need.</p>
<p>Script:<br>
Could you post a github pull request (or git push a git branch somewhere<br>
(github if you don‚Äôt mind)) please?</p>
<p>Discussion can continue here.</p>
<blockquote>
<aside class="quote" data-post="19" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>probably adding debugging</p>
<p>I guess no need or not possible.</p>
<p>I would expect the virt-sparsify command to work every time and when it</p>
<p>fails (such as if file not exists‚Ä¶?), it exits non-zero, right? Should</p>
<p>be enough for now. If it makes trouble, which I doubt, we can think</p>
<p>about this more.</p>
</blockquote>
</aside>
<p>It exits non-zero if file doesn‚Äôt exist, yes. The command can be run in verbose mode (-v option) which might be helpful.</p>
</blockquote>
<p>-v sounds good in theory. How does the output look like?</p>
<p>Users love some sort of progress indicator. Otherwise they have a<br>
nervous ctrl+c finger.</p>
<blockquote>
<p>Note that virt-sparsify can be run against any kind of file, it doesn‚Äôt seem to check if the file is a virtual disk image. Not sure of the implications if the file is not a virtual disk, probably none (it runs normally and then quits with ‚Äú<code>Sparsify in-place operation completed with no errors</code>‚Äù, although the shrinking is not performed.</p>
</blockquote>
<p>Ok. Can live with that.</p>
<blockquote>
<aside class="quote" data-post="19" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>error handling capacities?</p>
<p>No need. This is generally sorted out already. (As a fallback:)</p>
<p>set -e</p>
</blockquote>
</aside>
<p>Yes, but I was thinking more of the checks performed in the main() function (<code>if [ "$WHONIX_BUILD_FLAVOR" = "whonix-gateway" ]; then</code> ), do we need to add more checking?</p>
</blockquote>
<p>Ah. I guess no. Should be quite similar to<br>
<code>2300_run-chroot-scripts-post-d</code>. So if it is as good as that one,<br>
should be alright.</p>
<blockquote>
<p>Regarding the unmounting bug, I will try to give a few more tries and open a new thread. But maybe worth taking into account the following:</p>
<ul>
<li>All the build is done in a virtual machine (virtualbox)</li>
<li>The VM vdi is located on an external hdd which is formatted in NTFS (maybe kpartx doesnt like that?)</li>
</ul>
</blockquote>
<p>This might make a difference indeed even if it should not.</p>
<blockquote>
<ul>
<li>the VM already has a user ‚Äúuser‚Äù with password ‚Äúchangeme‚Äù</li>
</ul>
<p>For now, the only solution I found is to reboot the machine‚Ä¶ It only happened with the Workstation, not t he Gateway.<br>
With and without the added 2350 script.</p>
</blockquote>
<p>Yes. I doubt the new script is fault.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">

            <link itemprop="image" href="../../uploads/default/original/2X/2/2ada0765aa321ddeedb30ec0e2fa320dd016f453.png">

          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:25:46Z' class='post-time'>
                April 30, 2018,  9:25am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:25:46Z'>
          <span itemprop='position'>#22</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="21" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>But all of that is very optional. (Meaning: can merge either way even as</p>
<p>is.) Seems pretty good. Perhaps I‚Äôll include even in Whonix 14.</p>
</blockquote>
</aside>
<p>Ok, then I‚Äôll let it as it is.</p>
<aside class="quote no-group" data-post="21" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Maybe even decreases build times (libvirt compression)? (Unimportant</p>
<p>question.)</p>
</blockquote>
</aside>
<p>It seems to decrease the .ova build time, probably also libvirt. But it needs more thorough benchmarking. From the end user side, ova importation is however much faster, as it is twice lighter.</p>
<aside class="quote no-group" data-post="21" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Script:</p>
<p>Could you post a github pull request (or git push a git branch somewhere</p>
<p>(github if you don‚Äôt mind)) please?</p>
</blockquote>
</aside>
<p>I don‚Äôt know how to do that yet. I‚Äôll look into the documentation.</p>
<aside class="quote no-group" data-post="21" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>-v sounds good in theory. How does the output look like?</p>
<p>Users love some sort of progress indicator. Otherwise they have a</p>
<p>nervous ctrl+c finger.</p>
</blockquote>
</aside>
<p>virt-sparsify does have a built-in progress indicator:</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/2/2ada0765aa321ddeedb30ec0e2fa320dd016f453.png" data-download-href="//forums.whonix.org/uploads/default/2ada0765aa321ddeedb30ec0e2fa320dd016f453" title="Screenshot_2018-04-30_11-06-26.png"><img src="../../uploads/default/original/2X/2/2ada0765aa321ddeedb30ec0e2fa320dd016f453.png" alt="Screenshot_2018-04-30_11-06-26" width="690" height="30" data-small-upload="../../uploads/default/optimized/2X/2/2ada0765aa321ddeedb30ec0e2fa320dd016f453_2_10x10.png"><div class="meta">
<svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename">Screenshot_2018-04-30_11-06-26.png</span><span class="informations">796√ó35 3.93 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg>
</div></a></div></p>
<p>Regarding the verbose output. It is indeed very verbose. Please tell me where I can upload the output file, it will be more convenient for you to read than copy-pasting all the lines here. For the peace of mind, I think it ought to be reviewed by you and/or other Whonix devs.</p>
<p>Output log shows that the raw image seems to be booted with qemu-system-x86_64 during the shrinking operation. Is it bad news? Does it leave logs? Is there anything dangerous taking place? Does it change anything inside the virtual disk apart from removing unused space? How can one verify that?</p>
<p>Here is the qemu-system command used by <code>virt-sparsify --in-place</code>:</p>
<pre><code> /usr/bin/qemu-system-x86_64 \
    -global virtio-blk-pci.scsi=off \
    -nodefconfig \
    -enable-fips \
    -nodefaults \
    -display none \
    -machine accel=kvm:tcg \
    -m 500 \
    -no-reboot \
    -rtc driftfix=slew \
    -no-hpet \
    -global kvm-pit.lost_tick_policy=discard \
    -kernel /var/tmp/.guestfs-1000/appliance.d/kernel \
    -initrd /var/tmp/.guestfs-1000/appliance.d/initrd \
    -object rng-random,filename=/dev/urandom,id=rng0 \
    -device virtio-rng-pci,rng=rng0 \
    -device virtio-scsi-pci,id=scsi \
    -drive file=/home/user/whonix_binary/Whonix-Workstation-14.0.0.6.9-13-g58ed9c2b63c8baddc3ebb0b65fbdd9c50d679cf7.raw,cache=writeback,discard=unmap,format=raw,id=hd0,if=none \
    -device scsi-hd,drive=hd0 \
    -drive file=/var/tmp/.guestfs-1000/appliance.d/root,snapshot=on,id=appliance,cache=unsafe,if=none,format=raw \
    -device scsi-hd,drive=appliance \
    -device virtio-serial-pci \
    -serial stdio \
    -device sga \
    -chardev socket,path=/run/user/1000/libguestfsgb8EHA/guestfsd.sock,id=channel0 \
    -device virtserialport,chardev=channel0,name=org.libguestfs.channel.0 \
    -append 'panic=1 console=ttyS0 edd=off udevtimeout=6000 udev.event-timeout=6000 no_timer_check printk.time=1 cgroup_disable=memory usbcore.nousb cryptomgr.notests tsc=reliable 8250.nr_uarts=1 root=/dev/sdb selinux=0 guestfs_verbose=1 TERM=xterm-256color'
</code></pre>
<p>NOTE: I have imported in VirtualBox the Whonix-Workstation ova file produced after virt-sparsify and inspected the content of /var/log. I see no logs other than the ones produced on first boot with VirtualBox. wtmp log only shows the first boot with VirtualBox, nothing seems to have been left by the qemu-system command run by virt-sparsify. Where else should I look?</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:39:47Z' class='post-time'>
                April 30, 2018,  9:39am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:39:47Z'>
          <span itemprop='position'>#23</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Shrinking (without booting during shrinking) could even help with <a href="../../../external.html?link=https://www.whonix.org/wiki/Verifiable_Builds" rel="nofollow noopener">https://www.whonix.org/wiki/Verifiable_Builds</a> (if it is deterministic).</p>
<aside class="quote no-group" data-post="22" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>For the peace of mind, I think it ought to be reviewed by you and/or other Whonix devs.</p>
</blockquote>
</aside>
<p>Will for sure be reviewed / tested by me after git branch or pull request. (Even without can‚Äôt let this drop on the floor but would really help the ‚Äúusual‚Äù way.)</p>
<aside class="quote no-group" data-post="22" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Output log shows that the raw image seems to be booted with qemu-system-x86_64 during the shrinking operation. Is it bad news?</p>
</blockquote>
</aside>
<p>Very bad news. - If it boots the actual Whonix raw image and not a separate helper image or so. Maybe it boots it in a way not modifying anything.</p>
<aside class="quote no-group" data-post="22" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Does it leave logs?</p>
</blockquote>
</aside>
<p>Yes.</p>
<aside class="quote no-group" data-post="22" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Is there anything dangerous taking place?</p>
</blockquote>
</aside>
<p>Quite possibly. Could result in starting services such as the systemd entropy that creates a seed file, which should not be published and/or shared among all Whonix users. In worst case starts Tor service and prepopulates /var/lib/tor. Booting the image and making changes really ought to be avoided - very unprofessional.</p>
<aside class="quote no-group" data-post="22" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Does it change anything inside the virtual disk apart from removing unused space? How can one verify that?</p>
</blockquote>
</aside>
<p>We can look inside"the images. Compare files and contents. Build script with <code>--report true</code> to have it analyzed. Build twice. Compare the reports.</p>
<p>Or manually build twice and then use <code>help-steps/analyze_image</code>.</p>
<p>Context:</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../external.html?link=https://www.whonix.org/favicon.ico" class="site-icon" width="" height="">
      <a href="../../../external.html?link=https://www.whonix.org/wiki/Verifiable_Builds" target="_blank" rel="nofollow noopener">Whonix</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:640/360;"><img src="../../uploads/default/original/2X/a/ae8af01bc0c5ed8283bc1e0e1f57e22c3ca6a05b.jpg" class="thumbnail"></div>

<h3><a href="../../../external.html?link=https://www.whonix.org/wiki/Verifiable_Builds" target="_blank" rel="nofollow noopener">Verifiable Builds</a></h3>

<p>Checking Whonix for backdoors.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:42:25Z' class='post-time'>
                April 30, 2018,  9:42am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:42:25Z'>
          <span itemprop='position'>#24</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="23" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Very bad news. - If it boots the actual Whonix raw image and not a separate helper image or so. Maybe it boots it in a way not modifying anything.</p>
</blockquote>
</aside>
<p>Where could I upload the output log so you can have a look on it?</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:46:48Z' class='post-time'>
                April 30, 2018,  9:46am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:46:48Z'>
          <span itemprop='position'>#25</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>phabricator. But no need. Since the image gets mounted we ought to analyze the image anyhow.</p>
<p>Any tool that doesn‚Äôt boot the image to shrink it?</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:49:32Z' class='post-time'>
                April 30, 2018,  9:49am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:49:32Z'>
          <span itemprop='position'>#26</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Maybe by looking at the output log you would see if something unclean happens?</p>
<p>virt-sparsify can be run without the --in-place option. I will try it now, see if it changes anything/doesnt require booting the image.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:51:38Z' class='post-time'>
                April 30, 2018,  9:51am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:51:38Z'>
          <span itemprop='position'>#27</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I can try to look but booting an image is pretty bad then we ought to check carefully. Better be avoided at all cost.</p>
<aside class="quote" data-post="26" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>virt-sparsify can be run without the --in-place option. I will try it now, see if it changes anything/doesnt require booting the image.</p>
</blockquote>
</aside>
<p>Yes. That might be better.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:54:02Z' class='post-time'>
                April 30, 2018,  9:54am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:54:02Z'>
          <span itemprop='position'>#28</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Brings us back to the <code>dd</code> method suggested by <a class="mention" href="../../../external.html?link=https://forums.whonix.org/u/algernon">@Algernon</a>.</p>
<aside class="quote" data-post="1" data-topic="5095">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="../../letter_avatar_proxy/v2/letter/a/a183cd/40.png" class="avatar">
    <a href="5095/11.html">Reducing size of ova images</a> <a class="badge-wrapper  bullet" href="../../c/virtualbox/16.html"><span class="badge-category-bg" style="background-color: #283890;"></span><span style="" data-drop-close="true" class="badge-category clear-badge" title="Everything specific to Whonix VirtualBox. (devs)">VirtualBox</span></a>
  </div>
  <blockquote>
    Imho the best way to zero the disk space would be before running the scripts to convert raw to qcow2 or vdi. So either in 2300_run-chroot-scripts-post-d or make an extra step like 2310_zero or something like that. 
In the 2300 script one of the last steps is to unmount the image. If you zero the space before unmounting it should result in lower sizes for both the qcow2 and the vdi image. 
For testing you could just use the zerofree command or something like 

dd if=/dev/zero of=/path/to/chroot/z‚Ä¶
  </blockquote>
</aside>

<p>Maybe it can be implemented here‚Ä¶</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="../../../external.html?link=https://github.com/Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup#L421-L432" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="../../../external.html?link=https://github.com/Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup#L421-L432" target="_blank" rel="nofollow noopener">Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup#L421-L432</a></h4>
<pre class="onebox"><code class="lang-d/80_cleanup"><ol class="start lines" start="421" style="counter-reset: li-counter 420 ;">
<li>## This will not work in chroot.</li>
<li>## Take care of development leaks and make resulting ova image smaller.</li>
<li>## Since VBox export works below the FS level it will keep deleted files (and the ova will stay large).</li>
<li>## This also ensure that possible leaks we deleted before are really deleted.</li>
<li>#echo "INFO: Wiping free space. This can take a while."</li>
<li>## TODO CHROOT #dd if=/dev/zero of=/zerofile bs=1024 || true</li>
<li>
</li>
<li>## Flush the zero-file to disk before removing it.</li>
<li>sync</li>
<li>
</li>
<li>## Delete the zero-file.</li>
<li>rm /zerofile || true</li>
</ol></code></pre>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>You see‚Ä¶ We had it before - very first Whonix relases, very long time ago when images were still booted to build them). Broke when changing to <code>chroot</code> image building method. Maybe that could be fixed.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T09:58:00Z' class='post-time'>
                April 30, 2018,  9:58am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T09:58:00Z'>
          <span itemprop='position'>#29</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Yes, dd or zerofree. The dd command during the chroot script requires a lot of available space in the building machine. I will try it again, but slow and heavy.</p>
<p>Zerofree is quicker and lighter but requires mounting, which is prone to errors.</p>
<p>Please have a look at the output log‚Ä¶ Maybe I missed or misinterpreted something and it is not that bad?</p>
<p><a href="../../../external.html?link=https://phabricator.whonix.org/T790" class="onebox" target="_blank" rel="nofollow noopener">https://phabricator.whonix.org/T790</a></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T10:13:35Z' class='post-time'>
                April 30, 2018, 10:13am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T10:13:35Z'>
          <span itemprop='position'>#30</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="29" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>lease have a look at the output log</p>
</blockquote>
</aside>
<p>Creates a machine_id.</p>
<aside class="quote" data-post="29" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>The dd command during the chroot script requires a lot of available space in the building machine.</p>
</blockquote>
</aside>
<p>100 GB? Pretty bad! Best avoided.</p>
<aside class="quote" data-post="29" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Zerofree is quicker and lighter but requires mounting, which is prone to errors.</p>
</blockquote>
</aside>
<p>Hm‚Ä¶ Still preferred.</p>
<p>Or we need to consolidate the amount of times the image gets mounted / unmounted. But not great. Breaks the logical flow of the separate steps.</p>
<p>Or better‚Ä¶ Fix the root cause‚Ä¶ Why unmounting fails. Rehashing the old bug report. Fixing the root cause is long term always best.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T11:52:10Z' class='post-time'>
                April 30, 2018, 11:52am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T11:52:10Z'>
          <span itemprop='position'>#31</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>The ouput log without the --in-place option shows that the image is nevertheless booted with qemu-system.</p>
<p>So we agree to drop the virt-sparsify solution? It‚Äôs a pity, but agreed booting images is not tolerable.</p>
<p>I‚Äôll do a few more tests with zerofree‚Ä¶ Simple dd‚Äôing takes too much place and time.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T13:13:49Z' class='post-time'>
                April 30, 2018,  1:13pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T13:22:41Z'>
          <span itemprop='position'>#32</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>This a new attempt of a 2350 script, this time with zerofree (2350_zerofree-raw). So far I had success with whonix-gateway, manually launching scripts 2350 to 2700. Zerofree takes about 5 minutes. ova image is still 934 MB <img src="../../images/emoji/twitter/%2b1ae52.png?v=5" title=":+1:" class="emoji" alt=":+1:"></p>
<p>Now I will try the script for full builds for both images.</p>
<pre><code>#!/bin/bash

## Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP &lt;adrelanos@riseup.net&gt;
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &amp;&amp; pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source pre
source colors
source variables

error_handler_mount-raw() {
   : echo "
${red}${bold}BASH_COMMAND${reset}: $BASH_COMMAND
${red}${bold}ERROR $BASH_SOURCE: | caller: $(caller)${reset}
"
   exit 1
}

errorhandlerunmount-raw() {
   true "${red}${bold}BASH_COMMAND${reset}: $BASH_COMMAND
${red}${bold}ERROR $BASH_SOURCE: | caller: $(caller)${reset}"
   exit 1
}

mount_raw_read_only() {
   trap "error_handler_mount-raw" ERR INT TERM

   if [ "$mount_folder" = "" ]; then
      true
   else
      ## hack for help-steps/analyze-image
      CHROOT_FOLDER="$mount_folder"
   fi

   sync

   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
      local img="$binary_image_raw"
   else
      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
   fi

   ## Debugging.
   losetup --all
   sync

   sleep 2 &amp;
   wait "$!"

   ## Better not use this, because this can lead to a kpartx bug:
   ## "ioctl: LOOP_CLR_FD: Device or resource busy"
   ## Difficult to reproduce.
   ## Debugging.
   #kpartx -l -s -v "$img"
   #sync

   local kpartx_output a b device
   kpartx_output="$(kpartx -a -s -v "$img" 2&gt;&amp;1)"
   sync

   if [ "$kpartx_output" = "" ]; then
      local msg="kpartx did not output anything."
      error "$msg"
   fi

   ## Debugging.
   losetup --all
   sync

   read a b device _ &lt;&lt;&lt; "$kpartx_output"
   dev_mapper_device="/dev/mapper/$device"

}


zerofree_raw() {

    zerofree "$dev_mapper_device"
}

unmount_raw_read_only() {
   trap "errorhandlerunmount-raw" ERR INT TERM

   sync

   ## Sleep to work around some obscure bug.
   ## http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=734794
   sleep 2 &amp;
   wait "$!"
   sync

   ## Debugging.
   losetup --all
   sync

   kpartx -d -s -v "$img"
   sync

   ## Debugging.
   losetup --all
   sync

}


main() {
   root_check
   mount_raw_read_only
   zerofree_raw
   unmount_raw_read_only
}

main "$@"
</code></pre>
<p>NOTE: I think this part is useless in the script</p>
<pre><code>   if [ "$mount_folder" = "" ]; then
      true
   else
      ## hack for help-steps/analyze-image
      CHROOT_FOLDER="$mount_folder"
   fi

   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
      local img="$binary_image_raw"
   else
      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
   fi</code></pre>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T14:40:38Z' class='post-time'>
                April 30, 2018,  2:40pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T14:40:38Z'>
          <span itemprop='position'>#33</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p><strong>mygrep</strong></p>
<pre><code>cat ~/bin/mygrep 
</code></pre>
<pre><code class="lang-auto">#!/bin/bash
set -x
exec \
grep \
--exclude=README.md \
--exclude=GPLv2 \
--exclude=GPLv3 \
--exclude=COPYING \
--exclude=changelog.upstream-old1 \
--exclude-dir=mnt \
--exclude-dir=qubes-src/linux-template-builder/mnt \
--exclude=changelog.upstream \
--exclude-dir=".git" \
--exclude-dir=chroot-debian \
--exclude-dir=chroot-jessie "$@"
</code></pre>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T14:42:34Z' class='post-time'>
                April 30, 2018,  2:42pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T14:42:34Z'>
          <span itemprop='position'>#34</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>WHONIX_BUILD_MOUNT_RAW_FILE is not useless.</p>
<p>But I agree, the implementation is not pretty and should be improved.</p>
<pre><code class="lang-auto">mygrep -r WHONIX_BUILD_MOUNT_RAW_FILE
+ exec grep --exclude=README.md --exclude=GPLv2 --exclude=GPLv3 --exclude=COPYING --exclude=changelog.upstream-old1 --exclude-dir=mnt --exclude-dir=qubes-src/linux-template-builder/mnt --exclude=changelog.upstream --exclude-dir=.git --exclude-dir=chroot-debian --exclude-dir=chroot-jessie -r WHONIX_BUILD_MOUNT_RAW_FILE
help-steps/mount-raw:   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
help-steps/mount-raw:      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
help-steps/unmount-raw:   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
help-steps/unmount-raw:      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
help-steps/analyze_image:   ## WHONIX_BUILD_MOUNT_RAW_FILE us read by help-steps/mount-raw
help-steps/analyze_image:   export WHONIX_BUILD_MOUNT_RAW_FILE="$raw_file_short_link"
help-steps/analyze_image:   ## WHONIX_BUILD_MOUNT_RAW_FILE us read by help-steps/mount-raw
help-steps/analyze_image:   export WHONIX_BUILD_MOUNT_RAW_FILE="$raw_file_short_link
</code></pre>
<hr>
<pre><code>mygrep -r mount_folder=</code></pre>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T14:45:15Z' class='post-time'>
                April 30, 2018,  2:45pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T14:45:15Z'>
          <span itemprop='position'>#35</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Could you remove the code duplication please?</p>
<p>Perhaps move shared code into a new file into functions (in help-steps folder (ok for now) or perhaps a new folder for things to be sourced not actually executed (should do long term)).</p>
<p>And then call the out sourced code from the two scripts using that code?</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T14:50:15Z' class='post-time'>
                April 30, 2018,  2:50pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T14:50:15Z'>
          <span itemprop='position'>#36</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Yes I agree</p>
<pre><code>   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
      local img="$binary_image_raw"
   else
      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
   fi
</code></pre>
<p>is NOT useless. Actually mounting/unmounting fails without this part (it defines $img variable). I thought I had edited my comment, sorry. I left this part in the script. Please see github, I did a pull request. Or is it too early?</p>
<p>I confirm it works with whonix-workstation too (1.1GB ova file, as expected).</p>
<aside class="quote" data-post="35" data-topic="5095" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Could you remove the code duplication please?</p>
<p>Perhaps move shared code into a new file into functions (in help-steps folder (ok for now) or perhaps a new folder for things to be sourced not actually executed (should do long term)).</p>
<p>And then call the out sourced code from the two scripts using that code?</p>
</blockquote>
</aside>
<p>You mean removing the mount/unmount functions from the script and putting them in separate files in the help-steps folder? Yes.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T15:01:38Z' class='post-time'>
                April 30, 2018,  3:01pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T15:01:38Z'>
          <span itemprop='position'>#37</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Yes.</p>
<aside class="quote" data-post="36" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Or is it too early?</p>
</blockquote>
</aside>
<p>As you feel comfortable. No too fixed progress. Too much rules deter contributors. So I try keep things easy. For me github pull requests are comfortable. Easy to review. However, if they create a burden on your side, also other things can work.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T15:09:28Z' class='post-time'>
                April 30, 2018,  3:09pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T15:09:28Z'>
          <span itemprop='position'>#38</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>OK. Pull requests are OK for me. But maybe a problem for you if I pull too early and must add a number of commits later? Like it will happen now <img src="../../images/emoji/twitter/grinningae52.png?v=5" title=":grinning:" class="emoji" alt=":grinning:"></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T15:54:00Z' class='post-time'>
                April 30, 2018,  3:54pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T15:54:00Z'>
          <span itemprop='position'>#39</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>onion_knight:</p>
<blockquote>
<p>But maybe a problem for you if I pull too early</p>
</blockquote>
<p>No problem here. Well, if you pull to early, I just wait with the merge.<br>
Then either improve the current pull (by modifying that git branch) or<br>
close the pull request and send a new one.</p>
<blockquote>
<p>and must add a number of commits later? Like it will happen now <img src="../../images/emoji/twitter/grinningae52.png?v=5" title=":grinning:" class="emoji" alt=":grinning:"></p>
</blockquote>
<p>I don‚Äôt mind to add changes on top at all. That‚Äôs what collaborative<br>
development is for.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T18:16:07Z' class='post-time'>
                April 30, 2018,  6:16pm
              </time>
              <meta itemprop='dateModified' content='2018-04-30T19:08:33Z'>
          <span itemprop='position'>#40</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>OK, I need some help here.</p>
<p>So I removed the mount/unmount functions from the 2350 script and put them in new separate scripts in help-steps directory. So far so good.The function looks like this now:</p>
<pre><code>zerofree_raw() {

   "$WHONIX_SOURCE_HELP_STEPS_FOLDER"/mount-raw-nochroot

    zerofree -v "$dev_mapper_device"

   "$WHONIX_SOURCE_HELP_STEPS_FOLDER"/unmount-raw-nochroot
}
</code></pre>
<p>But of course it fails because the variable <code>"$dev_mapper_device"</code> is not defined here.  I need to import its  value defined in the <code>"$WHONIX_SOURCE_HELP_STEPS_FOLDER"/mount-raw-nochroot</code> script, in the following function:</p>
<pre><code>mount_raw_nochroot() {
   trap "error_handler_mount-raw" ERR INT TERM

   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
      local img="$binary_image_raw"
   else
      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
   fi

   ## Debugging.
   losetup --all
   sync

   sleep 2 &amp;
   wait "$!"

   ## Better not use this, because this can lead to a kpartx bug:
   ## "ioctl: LOOP_CLR_FD: Device or resource busy"
   ## Difficult to reproduce.
   ## Debugging.
   #kpartx -l -s -v "$img"
   #sync

   local kpartx_output a b device
   kpartx_output="$(kpartx -a -s -v "$img" 2&gt;&amp;1)"
   sync

   if [ "$kpartx_output" = "" ]; then
      local msg="kpartx did not output anything."
      error "$msg"
   fi

   ## Debugging.
   losetup --all
   sync

   read a b device _ &lt;&lt;&lt; "$kpartx_output"
   dev_mapper_device="/dev/mapper/$device"
</code></pre>
<p>}</p>
<p>How do I ‚Äúexport‚Äù this <code>dev_mapper_device</code> variable in my 2350 script? I have no idea, I‚Äôve been trying for a few hours now with export commands without success.</p>
<p><strong>EDIT</strong>: I found a workaround:<br>
added <code>export dev_mapper_device</code> in <code>mount-raw-nochroot</code> script<br>
added <code>source "$WHONIX_SOURCE_HELP_STEPS_FOLDER"/mount-raw-nochroot</code> in <code>2350_zerofree-raw script</code></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><a rel="prev" itemprop="url" href="5095.html">‚Üê previous page</a></span>
        <span itemprop='name'><b><a rel="next" itemprop="url" href="50959ba9.html?page=3">next page ‚Üí</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
