<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Reducing size of ova images - VirtualBox - Whonix Forum</title>
    <meta name="description" content="It is possible to seriously reduce the size of the vanilla ova images of both Whonix-Gateway and Whonix-Workstation VM. In VirtualBox, the easiest way is to import the ova as usual, fire them up with a live-boot ISO of a&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="5095.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../c/news/21.html">NEWS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Reducing size of ova images&#39;" href="5095.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/reducing-size-of-ova-images/5095" />
<meta name="twitter:url" content="https://forums.whonix.org/t/reducing-size-of-ova-images/5095" />
<meta property="og:title" content="Reducing size of ova images" />
<meta name="twitter:title" content="Reducing size of ova images" />
<meta property="og:description" content="It is possible to seriously reduce the size of the vanilla ova images of both Whonix-Gateway and Whonix-Workstation VM. In VirtualBox, the easiest way is to import the ova as usual, fire them up with a live-boot ISO of any Linux distributions (without networking for the paranoids), and then to run  zerofree /dev/sda1  as root in the console (/dev/sda1 being the Whonix partition).  Back in the host, convert the vmdk file to a vdi file and compact the disk:  vboxmanage clonehd &lt;whonix*.vmdk&gt; &lt;whon..." />
<meta name="twitter:description" content="It is possible to seriously reduce the size of the vanilla ova images of both Whonix-Gateway and Whonix-Workstation VM. In VirtualBox, the easiest way is to import the ova as usual, fire them up with a live-boot ISO of any Linux distributions (without networking for the paranoids), and then to run  zerofree /dev/sda1  as root in the console (/dev/sda1 being the Whonix partition).  Back in the host, convert the vmdk file to a vdi file and compact the disk:  vboxmanage clonehd &lt;whonix*.vmdk&gt; &lt;whon..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="15 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="23 ❤" />
<meta property="article:published_time" content="2018-04-20T22:52:38+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="next" href="50954658.html?page=2">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="5095.html">Reducing size of ova images</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/virtualbox/16.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #283890'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>VirtualBox</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-20T22:52:38Z' class='post-time'>
                April 20, 2018, 10:52pm
              </time>
              <meta itemprop='dateModified' content='2018-04-21T00:28:56Z'>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>It is possible to seriously reduce the size of the vanilla ova images of both Whonix-Gateway and Whonix-Workstation VM. In VirtualBox, the easiest way is to import the ova as usual, fire them up with a live-boot ISO of any Linux distributions (without networking for the paranoids), and then to run</p>
<p><code>zerofree /dev/sda1</code></p>
<p>as root in the console (/dev/sda1 being the Whonix partition).</p>
<p>Back in the host, convert the vmdk file to a vdi file and compact the disk:</p>
<pre><code>vboxmanage clonehd &lt;whonix*.vmdk&gt; &lt;whonix*.vdi&gt; --format VDI
vboxmanage modifyhd &lt;whonix*.vdi&gt; --compact
</code></pre>
<p>And then in VirtualBox, replace the vmdk disks by the new vdi disks and reexport the image appliances.</p>
<p>Current sizes after this (and with both images up-to-date!*):<br>
<strong>Whonix-Gateway &gt; 1.1 GB instead of 1.7 GB</strong><br>
<strong>Whonix-Workstation &gt; 1.3 GB instead of 2.0 GB</strong></p>
<p>Is there any security issue that I am not aware of? Otherwise I think it might be a good idea to reduce the size of the ova files that are available for download. Especially considering that many are probably downloading them over Tor.</p>
<p>*After running apt-get clean in both VM</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

            <div class='crawler-linkback-list' itemscope itemtype='../../../external.html?link=http://schema.org/ItemList'>
                  <div itemprop='itemListElement' itemscope itemtype='../../../external.html?link=http://schema.org/ListItem'>
                    <a href="../whonix-15-has-been-released/7616.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='../whonix-15-has-been-released/7616.html'>
                      <span itemprop='name'>Whonix 15 has been Released</span>
                    </a>
                    <meta itemprop='position' content='1'>
                  </div>
            </div>
      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-23T11:47:00Z' class='post-time'>
                April 23, 2018, 11:47am
              </time>
              <meta itemprop='dateModified' content='2018-04-23T11:47:00Z'>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Please create a ticket against Whonix_15 on <a href="../../../external.html?link=http://phabricator.whonix.org/">phabricator.whonix.org</a>.</p>
<p>Can you patch Whonix build process to add that step?</p>
<p>We however must not boot the image and then redistribute. (Very unclean.<br>
Creates logs, entropy seeds and non-determinism [related to reproducible<br>
builds].)</p>
<p>Instead I guess it should be possible to run zerofree has to be run<br>
against the image directly (against the block device). Not sure against<br>
the raw image is enough or if against the vdi image would be required.<br>
(In the latter case I don’t know there is a tool available to get a<br>
blockdevice.)</p>
<ul>
<li><a href="../../../external.html?link=https://github.com/Whonix/Whonix/blob/master/help-steps/mount-raw">https://github.com/Whonix/Whonix/blob/master/help-steps/mount-raw</a></li>
</ul>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-25T15:16:44Z' class='post-time'>
                April 25, 2018,  3:16pm
              </time>
              <meta itemprop='dateModified' content='2018-04-25T15:16:44Z'>
          <span itemprop='position'>#3</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Hi Patrick,<br>
I’ve just created an account on phabricator (Onion_Knight). Waiting for your approval.<br>
Not sure what you mean by “patching Whonix build process”, but I am currently building Whonix with a few more insructions to zerofree the raw images as block devices. I’ll write the results here.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/0brand'><span itemprop='name'>0brand</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-25T20:51:23Z' class='post-time'>
                April 25, 2018,  8:51pm
              </time>
              <meta itemprop='dateModified' content='2018-04-25T20:51:23Z'>
          <span itemprop='position'>#4</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="3" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>I’ve just created an account on phabricator (Onion_Knight). Waiting for your approval.</p>
</blockquote>
</aside>
<p>Your account has been approved! If you have any problems logging in you can ask for help in this thread.</p>
<p><a href="../phabricator-account-sign-ups-now-needs-manual-confirmation/index.html">https://forums.whonix.org/t/phabricator-account-sign-ups-now-needs-manual-confirmation/</a></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-25T22:03:56Z' class='post-time'>
                April 25, 2018, 10:03pm
              </time>
              <meta itemprop='dateModified' content='2018-04-25T22:40:11Z'>
          <span itemprop='position'>#5</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>So I did a fresh build with the <code>--target raw</code> option  in a virtual debian 8 i386 machine.</p>
<p>Once the raw files were ready, I <em>manually</em> ran the following commands (against both .raw images):</p>
<pre><code>sudo losetup -f -P &lt;whonix-*.raw&gt;
sudo zerofree $(sudo losetup -j &lt;whonix-*.raw&gt; | awk '{print $1}' | cut -d: -f 1)p1
sudo losetup -D
</code></pre>
<p>After that, I manually launched the <code>2500_convert-raw-to-vdi, 2600_create-vbox-vm</code> and <code>2700_export-vm</code> scripts against the previously zeroed raw images.</p>
<p>Note that I had to comment the line<br>
<code>sudo -u "$user_name" VBoxManage modifyvm "$VMNAME" --synthcpu on</code><br>
in the 2600 script, as I ran into a weird fatal error:<br>
<code>VBoxManage: error: Unknown option: --synthcpu</code><br>
But I assume it is unrelated to this topic (maybe related to the 32 bits VM?).<br>
<em>EDIT: OK, this is normal as the feature is not supported anymore in VBox 5 . <a href="../../../external.html?link=https://phabricator.whonix.org/T408#11595" rel="nofollow noopener">https://phabricator.whonix.org/T408#11595</a></em></p>
<p>The end result is quite impressive:<br>
<strong>Whonix-Gateway-13.0.0.1.4.ova: now 862.8MB instead of 1.8GB!</strong><br>
<strong>Whonix-Workstation-13.0.0.1.4.ova: now 990MB instead of 2.1GB!</strong></p>
<p>Moreover, <strong>the KVM files seem to also benefit from the zeroing of the raw images</strong>. The Whonix-Gateway qcow2 file is reduced to a 826MB tar.gz file (instead of the 1.3GB distributed .xz) . But I don’t know how actual distributed Whonix KVM images are being produced (they are .xz files, I don’t know how to make that?).</p>
<p>For the peace of mind I imported these .ova files into VirtualBox and tested them. Everything worked as usual, only VBoxGuest Additions didn’t seem to work. Again, probably unrelated bug to this topic, but did I miss something during the build process? It’s my first time building Whonix.</p>
<p>I was less successful when trying to add these manual instructions into the <code>2500_convert-raw-to-vdi script</code>:</p>
<pre><code>   sudo -u "$user_name" \
 losetup -f -P "$binary_image_raw" 
   sudo -u "$user_name" \
       zerofree $(losetup -j "$binary_image_raw"  | awk '{print $1}' | cut -d: -f 1)p1 
   sudo -u "$user_name" \
       losetup -D 
   sudo -u "$user_name" \
      VBoxManage convertfromraw "$binary_image_raw" "$HOMEVAR/VirtualBox VMs/$VMNAME/$VMNAME.vdi"
</code></pre>
<p>It always resulted in a failure (permission denied). I don’t know why I ran into a permission denied error as the script is run with sudo rights. I tried using kpartx as in the <code>mount-raw</code> script but without success.</p>
<p>Unfortunately, I am afraid my limited bash script skills do not allow me to further patch the build process by myself without great pain. But I am sure someone more advanced will figure it out quickly, and I’ll be happy to learn how!</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-25T22:06:11Z' class='post-time'>
                April 25, 2018, 10:06pm
              </time>
              <meta itemprop='dateModified' content='2018-04-25T22:06:11Z'>
          <span itemprop='position'>#6</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Thanks, added a ticket:</p>
<p><a href="../../../external.html?link=https://phabricator.whonix.org/T790" class="onebox" target="_blank" rel="nofollow noopener">https://phabricator.whonix.org/T790</a></p>
<p>It’s my first ticket, hope it’s OK.</p>
<p>I posted it against Whonix_15, but couldn’t it be also applied to Whonix 13 and 14? I think the solution is quite straightforward, and the benefits very tangible.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-26T07:28:00Z' class='post-time'>
                April 26, 2018,  7:28am
              </time>
              <meta itemprop='dateModified' content='2018-04-26T07:28:00Z'>
          <span itemprop='position'>#7</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>onion_knight:</p>
<blockquote>
<p>Thanks, added a ticket:</p>
<p><a href="../../../external.html?link=https://phabricator.whonix.org/T790">https://phabricator.whonix.org/T790</a></p>
<p>It’s my first ticket, hope it’s OK.</p>
</blockquote>
<p>Thanks!</p>
<blockquote>
<p>I posted it against Whonix_15, but couldn’t it be also applied to Whonix 13 and 14?</p>
</blockquote>
<p>Whonix 13 is already released. No grave changes after release.</p>
<p>Whonix 14 is overdue. Whonix development is understaffed. I want to<br>
avoid introducing new possibly breaking bugs (even if just build<br>
process) and building new downloadable Whonix images just for this.</p>
<p>The right time for this is during Whonix 15 development.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-26T07:30:00Z' class='post-time'>
                April 26, 2018,  7:30am
              </time>
              <meta itemprop='dateModified' content='2018-04-26T07:30:00Z'>
          <span itemprop='position'>#8</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>onion_knight:</p>
<blockquote>
<p>Not sure what you mean by “patching Whonix build process”</p>
</blockquote>
<p>Contributing to Whonix development and changing the source files as<br>
required to add this feature.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-26T07:39:00Z' class='post-time'>
                April 26, 2018,  7:39am
              </time>
              <meta itemprop='dateModified' content='2018-04-26T07:39:00Z'>
          <span itemprop='position'>#9</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>onion_knight:</p>
<blockquote>
<p>So I did a fresh build with the <code>--target raw</code> option  in a virtual debian 8 i386 machine.</p>
<p>Once the raw files were ready, I <em>manually</em> ran the following commands (against both .raw images):</p>
<pre><code>sudo losetup -f -P &lt;whonix-*.raw&gt;
sudo zerofree $(sudo losetup -j &lt;whonix-*.raw&gt; | awk '{print $1}' | cut -d: -f 1)p1
sudo losetup -D
</code></pre>
<p>After that, I manually launched the <code>2500_convert-raw-to-vdi, 2600_create-vbox-vm</code> and <code>2700_export-vm</code> scripts against the previously zeroed raw images. Note that I had to comment the line<br>
<code>sudo -u "$user_name" VBoxManage modifyvm "$VMNAME" --synthcpu on</code><br>
in the 2600 script, as I ran into a weird fatal error:<br>
<code>VBoxManage: error: Unknown option: --synthcpu</code><br>
But I assume it is unrelated to this topic (maybe related to the 32 bits VM?).</p>
</blockquote>
<p>Your Whonix build script sources are probably outdated. Not using that<br>
option anymore.</p>
<pre><code class="lang-auto">   ## Hide hosts CPU info. This does not have a GUI option.
   ## Was removed from VirtualBox.
   ## https://phabricator.whonix.org/T408
   #sudo $SUDO_OPTS VBoxManage modifyvm "$VMNAME" --synthcpu on
</code></pre>
<blockquote>
<p>The end result is quite impressive:<br>
<strong>Whonix-Gateway-13.0.0.1.4.ova: now 862.8MB instead of 1.8GB!</strong><br>
<strong>Whonix-Workstation-13.0.0.1.4.ova: now 990MB instead of 2.1GB!</strong></p>
</blockquote>
<p>Wow, excellent!</p>
<blockquote>
<p>Moreover, <strong>the KVM files seem to also benefit from the zeroing of the raw images</strong>. The Whonix-Gateway qcow2 file is reduced to a 826MB tar.gz file (instead of the 1.3GB distributed .xz) . But I don’t know how actual distributed Whonix KVM images are being produced</p>
</blockquote>
<blockquote>
<p>(they are .xz files, I don’t know how to make that?).</p>
</blockquote>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../external.html?link=https://www.whonix.org/favicon.ico" class="site-icon" width="" height="">
      <a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Redistribution" target="_blank" rel="nofollow noopener">Whonix</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="../../uploads/default/original/2X/9/997bef28d9dd0e3a84553afa8e33f383970adcab.png" class="thumbnail"></div>

<h3><a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Redistribution" target="_blank" rel="nofollow noopener">Dev/Redistribution</a></h3>

<p>Design Documentation about Redistribution of Whonix</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>prepare_release</p>
<p><a href="../../../external.html?link=https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release" rel="nofollow noopener">https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release</a> in function <code>libvirt_compress</code>.</p>
<pre><code>./packages/whonix-developer-meta-files/release/prepare_release
</code></pre>
<p>–flavor whonix-gateway --target qcow2 --build</p>
<blockquote>
<p>For the peace of mind I imported these .ova files into VirtualBox and tested them. Everything worked as usual, only VBoxGuest Additions didn’t seem to work. Again, probably unrelated bug to this topic, but did I miss something during the build process? It’s my first time building Whonix.</p>
</blockquote>
<p>Yes, probably unrelated. Probably fixed in current source code version.</p>
<blockquote>
<p>I was less successful when trying to add these manual instructions into the <code>2500_convert-raw-to-vdi script</code>:</p>
</blockquote>
<p>Better a separate build step.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-26T09:04:56Z' class='post-time'>
                April 26, 2018,  9:04am
              </time>
              <meta itemprop='dateModified' content='2018-04-26T09:04:56Z'>
          <span itemprop='position'>#10</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="7" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Whonix 13 is already released. No grave changes after release.</p>
<p>Whonix 14 is overdue. Whonix development is understaffed. I want to</p>
<p>avoid introducing new possibly breaking bugs (even if just build</p>
<p>process) and building new downloadable Whonix images just for this.</p>
<p>The right time for this is during Whonix 15 development.</p>
</blockquote>
</aside>
<p>OK</p>
<aside class="quote no-group" data-post="9" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Your Whonix build script sources are probably outdated. Not using that</p>
<p>option anymore.</p>
</blockquote>
</aside>
<p>Don’t know, I used the following link (current version):</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../external.html?link=https://www.whonix.org/favicon.ico" class="site-icon" width="" height="">
      <a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Build_Documentation/13_full" target="_blank" rel="nofollow noopener">Whonix</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="../../uploads/default/original/2X/9/997bef28d9dd0e3a84553afa8e33f383970adcab.png" class="thumbnail"></div>

<h3><a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Build_Documentation/13_full" target="_blank" rel="nofollow noopener">Dev/Build Documentation/13 full</a></h3>

<p>Complete and Comprehensive Instructions to build Whonix Virtual Machine Images from Source Code. Including build configurations, such as 64 bit builds...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="quote no-group" data-post="9" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>prepare_release</p>
<p><a href="../../../external.html?link=https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release" rel="nofollow noopener">https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release</a> in function libvirt_compress.</p>
<p>./packages/whonix-developer-meta-files/release/prepare_release</p>
</blockquote>
</aside>
<p>OK, I’ll try this way.</p>
<aside class="quote no-group" data-post="9" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Better a separate build step.</p>
</blockquote>
</aside>
<p>Agreed.</p>
<p>Also, could you confirm the build process runs an <code>apt-get clean</code> in both images before ending the chroot? I think I have seen it somewhere but can’t remember where exactly. This of course also significantly reduces the images size.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Algernon'><span itemprop='name'>Algernon</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-26T11:31:16Z' class='post-time'>
                April 26, 2018, 11:31am
              </time>
              <meta itemprop='dateModified' content='2018-04-26T11:31:16Z'>
          <span itemprop='position'>#11</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Imho the best way to zero the disk space would be before running the scripts to convert raw to qcow2 or vdi. So either in 2300_run-chroot-scripts-post-d or make an extra step like 2310_zero or something like that.<br>
In the 2300 script one of the last steps is to unmount the image. If you zero the space before unmounting it should result in lower sizes for both the qcow2 and the vdi image.<br>
For testing you could just use the zerofree command or something like</p>
<blockquote>
<p>dd if=/dev/zero of=/path/to/chroot/zero.img<br>
rm of=/path/to/chroot/zero.img</p>
</blockquote>
<p>The virt-sparsify command should also do the same directly on the raw image after unmounting or as part of the 2400 or 2500 script.<br>
In the 1700 script is an apt-clean step.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-26T16:55:00Z' class='post-time'>
                April 26, 2018,  4:55pm
              </time>
              <meta itemprop='dateModified' content='2018-04-28T08:10:59Z'>
          <span itemprop='position'>#12</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>For development (for next version, not released version), one should use<br>
the master branch, not Whonix 13 branch.</p>
<p>onion_knight:</p>
<blockquote>
<p>Also, could you confirm the build process runs an <code>apt-get clean</code> in both images before ending the chroot? I think I have seen it somewhere but can’t remember where exactly. This of course also significantly reduces the images size.</p>
</blockquote>
<p>here (and a lot more cleanup):</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="../../../external.html?link=https://github.com/Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup#L328" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="../../../external.html?link=https://github.com/Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup#L328" target="_blank" rel="nofollow noopener">Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup#L328</a></h4>
<pre class="onebox"><code class="lang-d/80_cleanup"><ol class="start lines" start="318" style="counter-reset: li-counter 317 ;">
<li>rm /var/lib/dhcp/*.lease || true</li>
<li>## We are best of deleting the whole folder.</li>
<li>rm -r /var/lib/dhcp/* || true</li>
<li>
</li>
<li>## Cleanup.</li>
<li>## || true to support re-running the script.</li>
<li>apt-get --yes autoremove --purge || true</li>
<li>
</li>
<li>## Get rid of /var/cache/apt/pkgcache.bin. (non-deterministic)</li>
<li>## || true to support re-running the script.</li>
<li class="selected">apt-get --yes clean || true</li>
<li>
</li>
<li>## No longer deleting /var/lib/tor. We install but forbid to run software such as Tor we install.</li>
<li>## Therefore /var/lib/tor should be empty.</li>
<li>## Ensure to delete /var/lib/tor. It contains sensitive stuff like the Tor consensus and the Tor entry guards.</li>
<li>## rm -r /var/lib/tor/* || true</li>
<li>
</li>
<li>## Delete logs and other stuff.</li>
<li>rm -r /tmp/* || true</li>
<li>rm /var/log/installer/* || true</li>
<li>rm -r /var/cache/apt/* || true</li>
</ol></code></pre>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p><aside class="onebox githubblob">
  <header class="source">
      <a href="../../../external.html?link=https://github.com/Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="../../../external.html?link=https://github.com/Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d" target="_blank" rel="nofollow noopener">Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d</a></h4>
<pre><code class="lang-d/2300_run-chroot-scripts-post-d">#!/bin/bash

## Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP &lt;adrelanos@riseup.net&gt;
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &amp;&amp; pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source pre
source colors
source variables

</code></pre>

  This file has been truncated. <a href="../../../external.html?link=https://github.com/Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d" target="_blank" rel="nofollow noopener">show original</a>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
runs these.</p>
<p>A good new build step name would be:</p>
<pre><code>2350_shrink-raw
</code></pre>
<p>Then it would run at the perfect time - so far the theory!</p>
<ul>
<li>2300_run-chroot-scripts-post-d</li>
<li>2350_shrink-raw</li>
<li>2400_convert-raw-to-qcow2</li>
<li>2500_convert-raw-to-vdi</li>
</ul>
<p>zerofree alternatives that don’t require mounting beforehand - if these<br>
are (almost) equally efficient - are strongly preferred. Much simpler.<br>
Less risk of too many mount/umount and running in some upstream bug<br>
because of this.</p>
<p>If virt-sparsify works, that would be great. It’s part of libguestfs-tools.</p>
<p>There is an outdated comment in Whonix source code on libguestfs-tools<br>
which I will remove now. (Whonix build script is no longer used to build<br>
Qubes-Whonix.)</p>
<pre><code>  ## XXX: No longer installing libguestfs-tools.
  ##      Breaks Non-Qubes-Whonix builds within Qubes-Whonix.
  ##      https://github.com/QubesOS/qubes-issues/issues/1974
</code></pre>
<p>So if there is a tool providing same shrinking functionality in another<br>
package fewer dependencies that would be even better. But<br>
libguestfs-tools would be acceptable too.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-27T07:23:06Z' class='post-time'>
                April 27, 2018,  7:23am
              </time>
              <meta itemprop='dateModified' content='2018-04-27T07:50:43Z'>
          <span itemprop='position'>#13</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="12" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>For development (for next version, not released version), one should use</p>
<p>the master branch, not Whonix 13 branch.</p>
</blockquote>
</aside>
<p>Master branch = Whonix 14 as in here?<br>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../external.html?link=https://www.whonix.org/favicon.ico" class="site-icon" width="" height="">
      <a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Build_Documentation/14_full" target="_blank" rel="nofollow noopener">Whonix</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="../../uploads/default/original/2X/9/997bef28d9dd0e3a84553afa8e33f383970adcab.png" class="thumbnail"></div>

<h3><a href="../../../external.html?link=https://www.whonix.org/wiki/Dev/Build_Documentation/14_full" target="_blank" rel="nofollow noopener">Dev/Build Documentation/14 full</a></h3>

<p>Instructions to build Whonix Virtual Machine Images from Source Code.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
</p>
<p>Regarding zeroing, this is my understanding so far:</p>
<ul>
<li>
<p>dd command needs a lot of time and space. It will claim all the available space until the image reaches its limits (i.e. 100 GB here). The underlying host needs to be able to allocate this space.</p>
</li>
<li>
<p>zerofree is faster and doesn’t involve image growing but needs mounting the image (as block device or read only)</p>
</li>
<li>
<p><strong>virt-sparsify seems by far the best method. I</strong>t does not need mounting as it can be run directly against the image (<code>virt-sparsify --in-place &lt;file.raw&gt;</code>) and is very fast (like less than a minute).</p>
</li>
</ul>
<p>I did a try with virt-sparsify, manually, on a raw Whonix-Gateway 13 image:</p>
<p><code>virt-sparsify --in-place Whonix-Gateway-13.0.0.1.4.raw</code></p>
<p>I then run manually the 2500, 2600 and 2700 scripts against the zeroed raw image.<br>
Result: <strong>862.8 MB</strong>  for Whonix-Gateway-13.0.0.1.4.ova, which is exactly the same result as with the zerofree method! So I would say we should go for it!</p>
<p>Of course, needs more testing, integration in scripts, and running against the master branch images (both for virtualbox and kvm).</p>
<p><a class="mention" href="../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a><br>
libguestfs-tools does not need to be installed in Whonix. Only in the building machine.</p>
<p>EDIT:<br>
Result for Whonix-Workstation 13 (ova):<br>
<strong>990MB</strong> (again same result as with zerofree!)</p>
<p>virt-sparsify execution time for Whonix-Gateway:</p>
<div class="md-table">
<table>
<thead>
<tr>
<th>real</th>
<th>0m20.425s</th>
</tr>
</thead>
<tbody>
<tr>
<td>user</td>
<td>0m10.052s</td>
</tr>
<tr>
<td>sys</td>
<td>0m1.332s</td>
</tr>
</tbody>
</table>
</div><p>virt-sparsify execution time for Whonix-Workstation (don’t know why it went faster although the image is bigger):</p>
<div class="md-table">
<table>
<thead>
<tr>
<th>real</th>
<th>0m11.290s</th>
</tr>
</thead>
<tbody>
<tr>
<td>user</td>
<td>0m8.244s</td>
</tr>
<tr>
<td>sys</td>
<td>0m1.180s</td>
</tr>
</tbody>
</table>
</div><p><em>on a debian8 i386 VirtualBox VM, 4096 RAM, 1 CPU</em></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-27T10:43:00Z' class='post-time'>
                April 27, 2018, 10:43am
              </time>
              <meta itemprop='dateModified' content='2018-04-27T10:43:00Z'>
          <span itemprop='position'>#14</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>virt-sparsify then. <img src="../../images/emoji/twitter/slight_smileae52.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>onion_knight:</p>
<blockquote>
<p><a class="mention" href="../../../external.html?link=https://forums.whonix.org/u/patrick">@Patrick</a><br>
libguestfs-tools does not need to be installed in Whonix. Only in the building machine.</p>
</blockquote>
<p>Yes, for sure.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-28T08:05:07Z' class='post-time'>
                April 28, 2018,  8:05am
              </time>
              <meta itemprop='dateModified' content='2018-04-28T08:05:07Z'>
          <span itemprop='position'>#15</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="13" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Master branch = Whonix 14 as in here?</p>
</blockquote>
</aside>
<p>Always the tip of the development. So at the moment yes.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-29T13:01:15Z' class='post-time'>
                April 29, 2018,  1:01pm
              </time>
              <meta itemprop='dateModified' content='2018-04-29T13:01:15Z'>
          <span itemprop='position'>#16</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I did a test with Whonix 14 and virt-sparsify:</p>
<ul>
<li>Whonix-Gateway.ova: 934MB instead of 1.8GB</li>
<li>Whonix-Workstation.ova: 1.1GB instead of 2.2GB</li>
</ul>
<p>Question: the build scripts produce .ova and .raw files with long seemingly random names, like Whonix-Gateway-14.0.0.6.9-13-g58ed9c2b63c8baddc3ebb0b65fbdd9c50d679cf7.ova. Is it normal?</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-29T21:54:14Z' class='post-time'>
                April 29, 2018,  9:54pm
              </time>
              <meta itemprop='dateModified' content='2018-04-29T22:55:52Z'>
          <span itemprop='position'>#17</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>This is a first proposal for <code>2350_shrink-raw</code>. Needs reviewing, editing, probably adding debugging/error handling capacities? So far it’s working:</p>
<pre><code>#!/bin/bash

## Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP &lt;adrelanos@riseup.net&gt;
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &amp;&amp; pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source pre
source colors
source variables

shrink_raw() {

    virt-sparsify --in-place "$binary_image_raw"
}

main() {

    if [ "$WHONIX_BUILD_FLAVOR" = "whonix-gateway" ]; then
      shrink_raw
    elif [ "$WHONIX_BUILD_FLAVOR" = "whonix-workstation" ]; then
      shrink_raw
    elif [ "$WHONIX_BUILD_FLAVOR" = "whonix-custom-workstation" ]; then
      shrink_raw
    else
       error "ERROR: Invalid WHONIX_BUILD_FLAVOR $WHONIX_BUILD_FLAVOR. Please report this bug!"
    fi
}   

main "$@"
</code></pre>
<p>Note: the whonix-build script often fails during the umount-raw part of 1700_install-packages (<code>umount: /home/user/whonix_binary/Whonix-Workstation_image: target is busy</code>). For the Whonix-Workstation I had to do all the other steps manually…</p>
<p>EDIT:<br>
<strong>libvirt.xz</strong> (KVM) image for Workstation is now <strong>746.3 MB</strong>, Gateway is <strong>605.2 MB</strong></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T05:21:00Z' class='post-time'>
                April 30, 2018,  5:21am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T05:21:00Z'>
          <span itemprop='position'>#18</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>onion_knight:</p>
<blockquote>
<p>I did a test with Whonix 14 and virt-sparsify:</p>
<ul>
<li>Whonix-Gateway.ova: 934MB instead of 1.8GB</li>
<li>Whonix-Workstation.ova: 1.1GB instead of 2.2GB</li>
</ul>
</blockquote>
<p>Terrific!</p>
<blockquote>
<p>Question: the build scripts produce .ova and .raw files with long seemingly random names, like Whonix-Gateway-14.0.0.6.9-13-g58ed9c2b63c8baddc3ebb0b65fbdd9c50d679cf7.ova. Is it normal?</p>
</blockquote>
<p>Yes.</p>
<p>The trailing <code>13</code> in Whonix-Gateway-14.0.0.6.9-13 means “13 commits<br>
after git tag 14.0.0.6.9” with git head at git commit has<br>
<code>g58ed9c2b63c8baddc3ebb0b65fbdd9c50d679cf7</code>.</p>
<p>It’s to make sure no one builds a tag and claims it’s version so and so<br>
while it’s not a tagged version.</p>
<p>The issue goes away once a newer git tag gets created. Really unrelated.<br>
No worries. Really normal. (The code for setting version and file names<br>
is in help-steps/variables.)</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T05:33:00Z' class='post-time'>
                April 30, 2018,  5:33am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T05:33:00Z'>
          <span itemprop='position'>#19</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>onion_knight:</p>
<blockquote>
<p>This is a first proposal for <code>2350_shrink-raw</code>. Needs reviewing,</p>
</blockquote>
<p>Looks really good! Without having tested it, I don’t see anything wrong<br>
with it at first look.</p>
<blockquote>
<p>probably adding debugging</p>
</blockquote>
<p>I guess no need or not possible.</p>
<p>I would expect the virt-sparsify command to work every time and when it<br>
fails (such as if file not exists…?), it exits non-zero, right? Should<br>
be enough for now. If it makes trouble, which I doubt, we can think<br>
about this more.</p>
<blockquote>
<p>error handling capacities?</p>
</blockquote>
<p>No need. This is generally sorted out already. (As a fallback:)</p>
<blockquote>
<pre><code>set -e
</code></pre>
</blockquote>
<p>Primarily:</p>
<blockquote>
<pre><code>source pre
</code></pre>
</blockquote>
<blockquote>
<p>Note: the whonix-build script often fails during the umount-raw part of 1700_install-packages (<code>umount: /home/user/whonix_binary/Whonix-Workstation_image: target is busy</code>). For the Whonix-Workstation I had to do all the other steps manually…</p>
</blockquote>
<p>Probably unrelated? Please create a new thread for this.</p>
<p>Store the output of <code>ps aux</code> (or similar) before running Whonix build<br>
script. Run Whonix build script. When this happens, run <code>ps aux</code> again.<br>
Compare. See if there is some process still running inside the chroot?</p>
<p>If fear not… I fear Whonix build script does nothing wrong.</p>
<p>Try rebooting after building a VM. Sometimes it happens when mounting /<br>
unmounting “too often”.</p>
<p>There is some obscure bug in <code>kpartx</code> and I doubt it was ever really fixed:</p>
<p><a href="../../../external.html?link=http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=734794" class="onebox" target="_blank">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=734794</a></p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/onion_knight'><span itemprop='name'>onion_knight</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="5095.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2018-04-30T06:32:54Z' class='post-time'>
                April 30, 2018,  6:32am
              </time>
              <meta itemprop='dateModified' content='2018-04-30T06:32:54Z'>
          <span itemprop='position'>#20</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote" data-post="19" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Looks really good! Without having tested it, I don’t see anything wrong</p>
<p>with it at first look.</p>
</blockquote>
</aside>
<p>Nice! What is the procedure now? Do I suggest this script on phabricator? Or do we continue the discussion here?</p>
<aside class="quote" data-post="19" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>probably adding debugging</p>
<p>I guess no need or not possible.</p>
<p>I would expect the virt-sparsify command to work every time and when it</p>
<p>fails (such as if file not exists…?), it exits non-zero, right? Should</p>
<p>be enough for now. If it makes trouble, which I doubt, we can think</p>
<p>about this more.</p>
</blockquote>
</aside>
<p>It exits non-zero if file doesn’t exist, yes. The command can be run in verbose mode (-v option) which might be helpful. Note that virt-sparsify can be run against any kind of file, it doesn’t seem to check if the file is a virtual disk image. Not sure of the implications if the file is not a virtual disk, probably none (it runs normally and then quits with “<code>Sparsify in-place operation completed with no errors</code>”, although the shrinking is not performed.</p>
<aside class="quote" data-post="19" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>error handling capacities?</p>
<p>No need. This is generally sorted out already. (As a fallback:)</p>
<p>set -e</p>
</blockquote>
</aside>
<p>Yes, but I was thinking more of the checks performed in the main() function (<code>if [ "$WHONIX_BUILD_FLAVOR" = "whonix-gateway" ]; then</code> ), do we need to add more checking?</p>
<p>Regarding the unmounting bug, I will try to give a few more tries and open a new thread. But maybe worth taking into account the following:</p>
<ul>
<li>All the build is done in a virtual machine (virtualbox)</li>
<li>The VM vdi is located on an external hdd which is formatted in NTFS (maybe kpartx doesnt like that?)</li>
<li>the VM already has a user “user” with password “changeme”</li>
</ul>
<p>For now, the only solution I found is to reboot the machine… It only happened with the Workstation, not t he Gateway. With and without the added 2350 script.</p>
        </div>

        <meta itemprop='headline' content='Reducing size of ova images'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><b><a rel="next" itemprop="url" href="50954658.html?page=2">next page →</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
