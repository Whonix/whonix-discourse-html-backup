<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Reducing size of ova images</title>
    <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095</link>
    <description>It is possible to seriously reduce the size of the vanilla ova images of both Whonix-Gateway and Whonix-Workstation VM. In VirtualBox, the easiest way is to import the ova as usual, fire them up with a live-boot ISO of any Linux distributions (without networking for the paranoids), and then to run 

`zerofree /dev/sda1`

as root in the console (/dev/sda1 being the Whonix partition).

Back in the host, convert the vmdk file to a vdi file and compact the disk:

    vboxmanage clonehd &lt;whonix*.vmdk&gt; &lt;whonix*.vdi&gt; --format VDI
    vboxmanage modifyhd &lt;whonix*.vdi&gt; --compact

And then in VirtualBox, replace the vmdk disks by the new vdi disks and reexport the image appliances.

Current sizes after this (and with both images up-to-date!*):
**Whonix-Gateway &gt; 1.1 GB instead of 1.7 GB**
**Whonix-Workstation &gt; 1.3 GB instead of 2.0 GB**

Is there any security issue that I am not aware of? Otherwise I think it might be a good idea to reduce the size of the ova files that are available for download. Especially considering that many are probably downloading them over Tor.

*After running apt-get clean in both VM</description>
    <language>en</language>
    <lastBuildDate>Tue, 28 Aug 2018 22:27:05 +0000</lastBuildDate>
    <category>VirtualBox</category>
    <atom:link href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>Hello</p>
<p>Back to the forum after a long summer pause…</p>
<p>I did a try with a Whonix-Gateway (current, 14) build and did not notice any difference.</p>
<p>I proceeded as follows:</p>
<ul>
<li>I ran manually steps 1100 to 2300</li>
<li>After rebooting the machine I mounted the .raw image using /<code>home/user/Whonix/help-steps/mount-raw</code>
</li>
<li>Then I ran <code>sudo /sbin/fstrim -v /home/user/Whonix-Gateway_image</code>
</li>
<li>After that I proceeded with the last build-steps as usual</li>
</ul>
<p>The final .ova size is 937 MB, exactly the same size as without the fstrim command.</p>
<p>By the way, I notice that using the current github version results in a 14.0.0.8.1-19 version, whereas the official download version is currently 14.0.0.7.4, and only weighs 850 MB. Is there any substantial difference between the two versions, and why this size increase?</p>
<p>One more little thing: the values for .ova files must be updated here according to their new value: <a href="https://www.whonix.org/wiki/Template:DownloadTable#" rel="nofollow noopener">https://www.whonix.org/wiki/Template:DownloadTable#</a></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/64">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/64</link>
        <pubDate>Tue, 28 Aug 2018 22:27:05 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-64</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>Hi Patrick. I didn’t know this method. I can give it a try.<br>
Cheers</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/63">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/63</link>
        <pubDate>Tue, 17 Jul 2018 23:09:50 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-63</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Qubes uses <code>fstrim</code>.</p>
<p><a href="https://github.com/QubesOS/qubes-linux-template-builder/blob/master/cleanup_image#L24">https://github.com/QubesOS/qubes-linux-template-builder/blob/master/cleanup_image#L24</a></p>
<p>If we run that before and/or after <code>zerofree</code> (or vice versa) could we further reduce Whonix image sizes?</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/62">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/62</link>
        <pubDate>Fri, 13 Jul 2018 13:56:18 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-62</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Please have a look.</p>
<aside class="onebox githubissue">
  <header class="source">
      <a href="https://github.com/QubesOS/qubes-issues/issues/4076" target="_blank" rel="nofollow noopener">github.com/QubesOS/qubes-issues</a>
  </header>
  <article class="onebox-body">
    <a href="https://github.com/adrelanos" rel="nofollow noopener">
<img src="//forums.whonix.org/uploads/default/original/2X/7/770a15f475a1de4a6ba4d68ffb96bd85c7274aa0.jpg" class="thumbnail onebox-avatar" width="96" height="96">
</a>

<h4><a href="https://github.com/QubesOS/qubes-issues/issues/4076" target="_blank" rel="nofollow noopener">Issue: Reduce Qubes TemplateVM packages by using zerofree?</a></h4>

<div class="date" style="margin-top:10px;">
	<div class="user" style="margin-top:10px;">
	opened by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
	on <a href="https://github.com/QubesOS/qubes-issues/issues/4076" target="_blank" rel="nofollow noopener">2018-07-13</a>
	</div>
	<div class="user">
	closed by <a href="https://github.com/marmarek" target="_blank" rel="nofollow noopener">marmarek</a>
	on <a href="https://github.com/QubesOS/qubes-issues/issues/4076" target="_blank" rel="nofollow noopener">2018-07-15</a>
	</div>
</div>

<pre class="content" style="white-space: pre-wrap;">Thanks to a contribution by @onion_night the size of Non-Qubes-Whonix (all raw images, VirtualBox ova and libvirt qcow2) downloadable images could...</pre>

<div class="labels">
 	<span style="display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;">C: templates</span>
 	<span style="display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;">not an issue</span>
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/61">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/61</link>
        <pubDate>Fri, 13 Jul 2018 09:55:39 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-61</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[tempest]]></dc:creator>
        <description><![CDATA[
            <p>this is an excellent development. thank you <a class="mention" href="http://forums.whonix.org/u/onion_knight">@onion_knight</a> and the whonix team.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/60">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/60</link>
        <pubDate>Thu, 17 May 2018 01:21:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-60</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>Fantastic! <a class="mention" href="http://forums.whonix.org/u/patrick">@Patrick</a> thanks a lot for making this real! Sorry that I could not take it through the end. I’ll make sure to have a look on the code and see how it looks now, hopefully with time my technical skills will progress and I’ll be able to contribute more thoroughly <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/59">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/59</link>
        <pubDate>Wed, 16 May 2018 14:52:22 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-59</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Has been deployed.</p>
<aside class="quote" data-post="1" data-topic="5189">
  <div class="title">
    <div class="quote-controls"></div>
    <img alt="" width="20" height="20" src="/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar">
    <a href="https://forums.whonix.org/t/whonix-virtualbox-kvm-14-0-0-7-3-testers-wanted/5189">Whonix VirtualBox / KVM 14.0.0.7.3 - Testers Wanted!</a> <a class="badge-wrapper  bullet" href="http://forums.whonix.org/c/development"><span class="badge-category-bg" style="background-color: #25AAE2;"></span><span style="" data-drop-close="true" class="badge-category clear-badge" title="Hacking on the Whonix software and code. (devs) (list of unmaintained components)">Development</span></a>
  </div>
  <blockquote>
    Untested. 
Testers Wanted! 
Download: 
<a href="https://download.whonix.org/linux/14.0.0.7.3/" class="onebox" target="_blank">https://download.whonix.org/linux/14.0.0.7.3/</a> 
Release Notes: 
<a href="https://www.whonix.org/wiki/Whonix_Release_Notes#Whonix_14">https://www.whonix.org/wiki/Whonix_Release_Notes#Whonix_14</a> 
Changes since last update of release notes: 

<a href="https://github.com/Whonix/Whonix/compare/14.0.0.6.9-developers-only...whonix:14.0.0.7.3-developers-only">https://github.com/Whonix/Whonix/compare/14.0.0.6.9-developers-only...whonix:14.0.0.7.3-developers-only</a>
most notably: shrunk download file sizes “by half or so” using zerofree (<a href="//forums.whonix.org/t/reducing-size-of-ova-images">http://forums.whonix.org/t/reducing-size-of-ova-images</a>)
  </blockquote>
</aside>

          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/58">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/58</link>
        <pubDate>Fri, 11 May 2018 12:00:30 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-58</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Unrelated but fixed in git.</p>
<aside class="onebox githubissue">
  <header class="source">
      <a href="https://github.com/Whonix/power-savings-disable-in-vms/issues/1" target="_blank" rel="nofollow noopener">github.com/Whonix/power-savings-disable-in-vms</a>
  </header>
  <article class="onebox-body">
    <a href="https://github.com/marmarek" rel="nofollow noopener">
<img src="//forums.whonix.org/uploads/default/original/2X/5/5fc870fcf8f58e3caef9ed70fd65d6426aea328d.jpg" class="thumbnail onebox-avatar" width="96" height="96">
</a>

<h4><a href="https://github.com/Whonix/power-savings-disable-in-vms/issues/1" target="_blank" rel="nofollow noopener">Issue: Scripts in /etc/profile.d shouldn't be bash specific</a></h4>

<div class="date" style="margin-top:10px;">
	<div class="user" style="margin-top:10px;">
	opened by <a href="https://github.com/marmarek" target="_blank" rel="nofollow noopener">marmarek</a>
	on <a href="https://github.com/Whonix/power-savings-disable-in-vms/issues/1" target="_blank" rel="nofollow noopener">2018-04-04</a>
	</div>
	<div class="user">
	closed by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
	on <a href="https://github.com/Whonix/power-savings-disable-in-vms/issues/1" target="_blank" rel="nofollow noopener">2018-04-06</a>
	</div>
</div>

<pre class="content" style="white-space: pre-wrap;">/etc/profile.d/*.sh are sourced not executed, so #!/bin/bash doesn't matter. And when non-bash shell (/bin/sh for example) is used, shopt fails.
 
...</pre>

<div class="labels">
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/57">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/57</link>
        <pubDate>Fri, 11 May 2018 08:36:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-57</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[torjunkie]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="53" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>/bin/bash /etc/X11/Xsession.d/20power_savings_disable_in_vms</p>
</blockquote>
</aside>
<p>Maybe this bug below is related?</p>
<p>In Qubes R4, with sys-whonix set as updateVM, when you run sudo qubes-dom-update in dom0, you see:</p>
<blockquote>
<p>/usr/lib/qubes/qubes-rpc-multiplexer: 14: /etc/profile.d/20_power_savings_disable_in_vms.sh: shopt: not found</p>
</blockquote>
<p>(repeats twice)</p>
<p>dom0 update procedure still works though.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/56">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/56</link>
        <pubDate>Fri, 11 May 2018 08:07:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-56</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p><a href="https://github.com/Whonix/Whonix/compare/14.0.0.7.0-developers-only...whonix:14.0.0.7.3-developers-only">https://github.com/Whonix/Whonix/compare/14.0.0.7.0-developers-only...whonix:14.0.0.7.3-developers-only</a></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/55">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/55</link>
        <pubDate>Thu, 10 May 2018 14:58:38 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-55</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p><code>zerofree</code> is now implemented.</p>
<p>Please test building:<br>
<code>14.0.0.7.3-developers-only</code></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/54">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/54</link>
        <pubDate>Thu, 10 May 2018 14:53:34 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-54</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Above works.</p>
<p>It works around an interesting maybe heisenbug.</p>
<pre><code class="lang-auto">+ /home/user/Whonix/help-steps/umount_kill.sh /home/user/whonix_binary/Whonix-Gateway_image/
-&gt; Attempting to kill any processes still running in '/home/user/whonix_binary/Whonix-Gateway_image/' before un-mounting
Okay, the following pids are still running inside '/home/user/whonix_binary/Whonix-Gateway_image/', which will now be killed.
  PID TTY      STAT   TIME COMMAND
 8486 ?        S      0:00 /bin/bash /etc/X11/Xsession.d/20power_savings_disable_in_vms
 8488 ?        S      0:00 sleep 60
un-mounting /home/user/whonix_binary/Whonix-Gateway_image/dev
</code></pre>
<p>And also attempted to really fix the bug.</p>
<p><a href="https://github.com/Whonix/power-savings-disable-in-vms/compare/093ae0438c295d678e567da31b9cbe79bf1a09f5...a8454e788cbe414c290f8edc62e9989abd1d1967#diff-52b97294a5ecaed249ad90c4623aba65">https://github.com/Whonix/power-savings-disable-in-vms/compare/093ae0438c295d678e567da31b9cbe79bf1a09f5...a8454e788cbe414c290f8edc62e9989abd1d1967#diff-52b97294a5ecaed249ad90c4623aba65</a></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/53">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/53</link>
        <pubDate>Thu, 10 May 2018 11:03:21 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-53</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>onion_knight:</p>
<blockquote>
<p>As usual, the 1700 script fails during unmounting (device busy)… Since it happens before the new 2350 script, and nothing else was changed, I am assuming it is not related to the zeroing function. Last time it happened I did a check with <code>lsof</code> and it showed that a single process, <code>gpg-agent</code> had actually some files still open in the Workstation image (see screenshot below). Has anyone already seen that?</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208.png" data-download-href="//forums.whonix.org/uploads/default/ca0e17bb5346080db1989ed33cb97bc76cda3208" title="image.png"><img src="//forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_690x185.png" alt="image" width="690" height="185" srcset="//forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_690x185.png, //forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_1035x277.png 1.5x, //forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_1380x370.png 2x" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_10x10.png"></a></div><p></p>
</blockquote>
<p>Attempting to fix this.</p>
<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/Whonix/commit/51acda6fcd40ff06cc9a0c66231c2cb2c62c198e" target="_blank" rel="nofollow noopener">github.com/Whonix/Whonix</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="//forums.whonix.org/uploads/default/original/2X/5/567709cd4b873e59936246faf52ef8293c7793cd.jpg" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/Whonix/commit/51acda6fcd40ff06cc9a0c66231c2cb2c62c198e" target="_blank" rel="nofollow noopener">use umount_kill.sh also from unmount-raw</a>
</h4>

  <pre class="message" style="white-space: normal;">to kill gpg-agent
Thanks to @onions-knight for the bug report!
http://forums.whonix.org/t/reducing-size-of-ova-images/5095/47</pre>

<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/Whonix/commit/51acda6fcd40ff06cc9a0c66231c2cb2c62c198e" target="_blank" rel="nofollow noopener">08:21AM - 10 May 18 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>1 files</strong>
  with <strong>6 additions</strong>
  and <strong>0 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Included in <code>14.0.0.7.0-developers-only</code> but haven’t finished a build<br>
myself yet.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/52">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/52</link>
        <pubDate>Thu, 10 May 2018 09:27:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-52</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>Thanks for your feedback. Unfortunately I have trouble understanding what you mean here. I am afraid this is beyond my technical skills yet. I don’t know how I can help here.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/51">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/51</link>
        <pubDate>Sun, 06 May 2018 17:01:38 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-51</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>mount-raw-no-chroot shouldn’t have</p>
<pre><code class="lang-auto">+main (){
+   root_check
+   if [ "$ANON_BUILD_INSTALL_TO_ROOT" = "1" ]; then
+      true "${green}INFO: Skipping script, because
ANON_BUILD_INSTALL_TO_ROOT=1: $BASH_SOURCE${reset}"
+      exit 0
+   else
+      mount_raw_nochroot
+   fi
+}
+
+main "$@"
</code></pre>
<p>The main point of <code>source</code>ing a file in most cases is to import a bash<br>
function which is then used from multiple bash scripts.</p>
<p>(Except when using a logic "if sourced, don’t execute (up to script that<br>
sources it. if executed (not sourced), execute it. (We have examples of<br>
this in Whonix source code.))</p>
<p>So just <code>source</code> <code>mount_raw_nochroot</code> and then use it from<br>
<code>2350_zerofree-raw</code>.</p>
<p>The duplicate source code issue is not solved yet. <code>mount-raw</code> /<br>
<code>unmount-raw</code> still have the full copy of the source code.</p>
<p>Maybe the easiest would be if the <code>mount-raw</code> / <code>unmount-raw</code> would also<br>
source mount-raw-no-chroot / unmount-raw-no-chroot and then run their<br>
functions.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/50">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/50</link>
        <pubDate>Sun, 06 May 2018 13:48:50 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-50</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>I put everything on GitHub. Please check and review the code.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/48">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/48</link>
        <pubDate>Sat, 05 May 2018 18:11:15 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-48</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>I did a few more tries, both on NTFS and ext4 partitions.</p>
<p>I confirm zeroing works now! .ova files are shrunk as expected. I will update the code on git later today. Please test and review!</p>
<p>As usual, the 1700 script fails during unmounting (device busy)… Since it happens before the new 2350 script, and nothing else was changed, I am assuming it is not related to the zeroing function. Last time it happened I did a check with <code>lsof</code> and it showed that a single process, <code>gpg-agent</code> had actually some files still open in the Workstation image (see screenshot below). Has anyone already seen that?</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208.png" data-download-href="//forums.whonix.org/uploads/default/ca0e17bb5346080db1989ed33cb97bc76cda3208" title="image.png"><img src="//forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_690x185.png" alt="image" width="690" height="185" srcset="//forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_690x185.png, //forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_1035x277.png 1.5x, //forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_1380x370.png 2x" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/c/ca0e17bb5346080db1989ed33cb97bc76cda3208_2_10x10.png"></a></div><p></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/47">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/47</link>
        <pubDate>Sat, 05 May 2018 16:36:48 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-47</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>OK, seems to work now, except that my build attempts ALWAYS fail during the unmount-raw function of script 1700 (I have to reboot the machine and launch the remaining scripts manually)… But this is most probably unrelated to this topic.</p>
<p>Should I do a few more tries (maybe on a ext4 partition, not NTFS), or I can already commit the new scripts?</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/46">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/46</link>
        <pubDate>Wed, 02 May 2018 09:18:50 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-46</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>Just a little update: the new functions/scripts worked fine with the Whonix-Gateway, I am trying with the Workstation (building from scratch). It takes time. I’ll keep you updated.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/45">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/45</link>
        <pubDate>Wed, 02 May 2018 07:12:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-45</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Let’s stay still away from virt-sparsify. At the moment it may be ok, but we don’t know how the implementation of virt-sparsify changes over the years.</p>
<p>This is because we don’t have safeguards in place for sanity testing. That is automated checking if modifications to the image are made, <a href="https://www.whonix.org/wiki/Verifiable_Builds">https://www.whonix.org/wiki/Verifiable_Builds</a>, deterministic builds.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/44">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/44</link>
        <pubDate>Wed, 02 May 2018 06:52:31 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-44</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Algernon]]></dc:creator>
        <description><![CDATA[
            <p>I took a closer look at the build log. virt-sparsify actually seems to use direct kernel boot with the kernel from the currently running machine + some custom initrd where the magic happens. The generated machine id is initramfs internal, at least I could not find any different or new files between the raw image before and after running virt-sparsify.<br>
The real root is mounted but not booted. The relevant stuff for shrinking occurs during the end of the script i.e. mounting with -o discard and using fstrim. The latter one is quite similar to zerofree. See here <a href="https://ext4.wiki.kernel.org/index.php/Ext4_VM_Images" rel="nofollow noopener">https://ext4.wiki.kernel.org/index.php/Ext4_VM_Images</a>.<br>
Since in practice there is no difference in the final size between those commands it probably does not matter which one to use.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/43">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/43</link>
        <pubDate>Tue, 01 May 2018 22:23:50 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-43</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="41" data-topic="5095">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Can you put the functions please into a file which is not supposed to be</p>
<p>executed on its own? Then it can be sourceed from multiple places.</p>
</blockquote>
</aside>
<p>Yes this is what I am testing now.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/42">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/42</link>
        <pubDate>Tue, 01 May 2018 11:40:02 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-42</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Can you put the functions please into a file which is not supposed to be<br>
executed on its own? Then it can be <code>source</code>ed from multiple places.</p>
<p>No export commands needed - only for parent / child scripts - which are<br>
unrelated here.</p>
<p>file a_test:</p>
<pre><code class="lang-auto">some_function() {
   echo "do things"
}
</code></pre>
<p>file b_test:</p>
<pre><code class="lang-auto">source a_test

some_function
</code></pre>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/41">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/41</link>
        <pubDate>Tue, 01 May 2018 10:25:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-41</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>OK, I need some help here.</p>
<p>So I removed the mount/unmount functions from the 2350 script and put them in new separate scripts in help-steps directory. So far so good.The function looks like this now:</p>
<pre><code>zerofree_raw() {

   "$WHONIX_SOURCE_HELP_STEPS_FOLDER"/mount-raw-nochroot

    zerofree -v "$dev_mapper_device"

   "$WHONIX_SOURCE_HELP_STEPS_FOLDER"/unmount-raw-nochroot
}
</code></pre>
<p>But of course it fails because the variable <code>"$dev_mapper_device"</code> is not defined here.  I need to import its  value defined in the <code>"$WHONIX_SOURCE_HELP_STEPS_FOLDER"/mount-raw-nochroot</code> script, in the following function:</p>
<pre><code>mount_raw_nochroot() {
   trap "error_handler_mount-raw" ERR INT TERM

   if [ "$WHONIX_BUILD_MOUNT_RAW_FILE" = "" ]; then
      local img="$binary_image_raw"
   else
      local img="$WHONIX_BUILD_MOUNT_RAW_FILE"
   fi

   ## Debugging.
   losetup --all
   sync

   sleep 2 &amp;
   wait "$!"

   ## Better not use this, because this can lead to a kpartx bug:
   ## "ioctl: LOOP_CLR_FD: Device or resource busy"
   ## Difficult to reproduce.
   ## Debugging.
   #kpartx -l -s -v "$img"
   #sync

   local kpartx_output a b device
   kpartx_output="$(kpartx -a -s -v "$img" 2&gt;&amp;1)"
   sync

   if [ "$kpartx_output" = "" ]; then
      local msg="kpartx did not output anything."
      error "$msg"
   fi

   ## Debugging.
   losetup --all
   sync

   read a b device _ &lt;&lt;&lt; "$kpartx_output"
   dev_mapper_device="/dev/mapper/$device"
</code></pre>
<p>}</p>
<p>How do I “export” this <code>dev_mapper_device</code> variable in my 2350 script? I have no idea, I’ve been trying for a few hours now with export commands without success.</p>
<p><strong>EDIT</strong>: I found a workaround:<br>
added <code>export dev_mapper_device</code> in <code>mount-raw-nochroot</code> script<br>
added <code>source "$WHONIX_SOURCE_HELP_STEPS_FOLDER"/mount-raw-nochroot</code> in <code>2350_zerofree-raw script</code></p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/40">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/40</link>
        <pubDate>Mon, 30 Apr 2018 18:16:07 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-40</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
      <item>
        <title>Reducing size of ova images</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>onion_knight:</p>
<blockquote>
<p>But maybe a problem for you if I pull too early</p>
</blockquote>
<p>No problem here. Well, if you pull to early, I just wait with the merge.<br>
Then either improve the current pull (by modifying that git branch) or<br>
close the pull request and send a new one.</p>
<blockquote>
<p>and must add a number of commits later? Like it will happen now <img src="//forums.whonix.org/images/emoji/twitter/grinning.png?v=5" title=":grinning:" class="emoji" alt=":grinning:"></p>
</blockquote>
<p>I don’t mind to add changes on top at all. That’s what collaborative<br>
development is for.</p>
          <p><a href="http://forums.whonix.org/t/reducing-size-of-ova-images/5095/39">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/reducing-size-of-ova-images/5095/39</link>
        <pubDate>Mon, 30 Apr 2018 15:54:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-5095-39</guid>
        <source url="http://forums.whonix.org/t/reducing-size-of-ova-images/5095.rss">Reducing size of ova images</source>
      </item>
  </channel>
</rss>
