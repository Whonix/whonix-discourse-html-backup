<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Live mode breaks apparmor</title>
    <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559</link>
    <description>On live mode apparmor breaks completely 0 profile loaded:

apparmor module is loaded.
0 profiles are loaded.
0 profiles are in enforce mode.
0 profiles are in complain mode.
0 processes have profiles defined.
0 processes are in enforce mode.
0 processes are in complain mode.
0 processes are unconfined but have a profile defined.

On persistent mode doesn&#39;t load all profiles, only 3 if I recall correctly.
Tested on KVM.
Any advice is welcomed if a solution is not ready.</description>
    <language>en</language>
    <lastBuildDate>Thu, 20 Jun 2019 13:26:58 +0000</lastBuildDate>
    <category>Support</category>
    <atom:link href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/apparmor-profile-anondist/commit/b949b0dbb5b21f3ab5566eb8acbc15d427d37357" target="_blank" rel="nofollow noopener">github.com/Whonix/apparmor-profile-anondist</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/apparmor-profile-anondist/commit/b949b0dbb5b21f3ab5566eb8acbc15d427d37357" target="_blank" rel="nofollow noopener">make apparmor work also in live mode</a>
</h4>

  <pre class="message" style="white-space: normal;">https://forums.whonix.org/t/live-mode-breaks-apparmor/7559</pre>

<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/apparmor-profile-anondist/commit/b949b0dbb5b21f3ab5566eb8acbc15d427d37357" target="_blank" rel="nofollow noopener">01:25PM - 20 Jun 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>1 files</strong>
  with <strong>6 additions</strong>
  and <strong>0 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/14">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/14</link>
        <pubDate>Thu, 20 Jun 2019 13:26:58 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-14</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[zilika]]></dc:creator>
        <description><![CDATA[
            <pre><code class="lang-auto">user@host:~$ sudo systemctl status apparmor
● apparmor.service - Load AppArmor profiles
   Loaded: loaded (/lib/systemd/system/apparmor.service; enabled; vendor preset:
  Drop-In: /lib/systemd/system/apparmor.service.d
           └─30_live_mode.conf
   Active: active (exited) since Thu 2019-06-20 12:45:41 UTC; 23s ago
     Docs: man:apparmor(7)
           https://gitlab.com/apparmor/apparmor/wikis/home/
  Process: 387 ExecStart=/lib/apparmor/apparmor.systemd reload (code=exited, sta
 Main PID: 387 (code=exited, status=0/SUCCESS)

Jun 20 12:45:41 host systemd[1]: Starting Load AppArmor profiles...
Jun 20 12:45:41 host apparmor.systemd[387]: Restarting AppArmor
Jun 20 12:45:41 host apparmor.systemd[387]: Reloading AppArmor profiles
Jun 20 12:45:41 host apparmor.systemd[387]: Skipping profile in /etc/apparmor.d/
Jun 20 12:45:41 host systemd[1]: Started Load AppArmor profiles.
</code></pre>
<p>It works, profiles are loaded. Thank you Patrick!</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/13">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/13</link>
        <pubDate>Thu, 20 Jun 2019 12:49:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-13</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Corrected by above post just now.</p>
<p><a href="https://forums.whonix.org/t/live-mode-breaks-apparmor/7559/8" class="inline-onebox">Live mode breaks apparmor</a></p>
<p>Relevant fixed part:</p>
<p>Paste the following content.</p>
<pre><code class="lang-auto">[Unit]
ConditionPathExists=
</code></pre>
<p>Please try.</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/12">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/12</link>
        <pubDate>Thu, 20 Jun 2019 12:43:44 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-12</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[zilika]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="10" data-topic="7559">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>sudo systemctl status apparmor</p>
</blockquote>
</aside>
<pre><code class="lang-auto">user@host:~$ sudo systemctl status apparmor
Warning: The unit file, source configuration file or drop-ins of apparmor.servic
● apparmor.service - Load AppArmor profiles
   Loaded: loaded (/lib/systemd/system/apparmor.service; enabled; vendor preset:
  Drop-In: /lib/systemd/system/apparmor.service.d
           └─30_live_mode.conf
   Active: inactive (dead)
Condition: start condition failed at Thu 2019-06-20 12:31:10 UTC; 6min ago
           └─ ConditionPathExists=!/run/live/overlay/work was not met
     Docs: man:apparmor(7)
           https://gitlab.com/apparmor/apparmor/wikis/home/

Jun 20 12:31:10 host systemd[1]: Condition check resulted in Load AppArmor profi
</code></pre>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/11">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/11</link>
        <pubDate>Thu, 20 Jun 2019 12:38:53 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-11</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Would help if you could provide</p>
<pre><code>sudo systemctl status apparmor
</code></pre>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d.png" data-download-href="//forums.whonix.org/uploads/default/567b677d4e4be95421573aa9beecae76e2179b0d" title="apparmorlive.png"><img src="//forums.whonix.org/uploads/default/optimized/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d_2_690x222.png" alt="apparmorlive" width="690" height="222" srcset="//forums.whonix.org/uploads/default/optimized/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d_2_690x222.png, //forums.whonix.org/uploads/default/original/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d.png 1.5x, //forums.whonix.org/uploads/default/original/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d.png 2x" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d_2_10x10.png"></a></div><p></p>
<p>too</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/10">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/10</link>
        <pubDate>Thu, 20 Jun 2019 12:36:55 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-10</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[zilika]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="7" data-topic="7559">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>post I will suggest a potential workaroun</p>
</blockquote>
</aside>
<p>Pasted ConditionPathExists= in <code>/lib/systemd/system/apparmor.service.d/30_live_mode.conf</code><br>
Same as before in Live mode. Not working.</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/9</link>
        <pubDate>Thu, 20 Jun 2019 12:35:15 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-9</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Potential workaround:</p>
<p>Boot in persistent mode.</p>
<p>Create folder <code>/lib/systemd/system/apparmor.service.d</code>.</p>
<pre><code>sudo mkdir -p /lib/systemd/system/apparmor.service.d
</code></pre>
<p>Open file <code>/lib/systemd/system/apparmor.service.d/30_live_mode.conf</code> with root rights.</p>
<pre><code>lxsu mousepad /lib/systemd/system/apparmor.service.d/30_live_mode.conf
</code></pre>
<p>Paste the following content.</p>
<pre><code class="lang-auto">[Unit]
ConditionPathExists=
</code></pre>
<p>Save. Reboot.</p>
<p>Could you try please?</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/8</link>
        <pubDate>Thu, 20 Jun 2019 04:11:31 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-8</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Thanks, that gives a very good lead.</p>
<p><code>cat /lib/systemd/system/apparmor.service</code></p>
<pre><code>[Unit]
Description=Load AppArmor profiles
DefaultDependencies=no
Before=sysinit.target
After=local-fs.target
After=systemd-journald-audit.socket
RequiresMountsFor=/var/cache/apparmor
AssertPathIsReadWrite=/sys/kernel/security/apparmor/.load
ConditionSecurity=apparmor
Documentation=man:apparmor(7)
Documentation=https://gitlab.com/apparmor/apparmor/wikis/home/

# Don't start this unit on the Ubuntu Live CD
ConditionPathExists=!/rofs/etc/apparmor.d

# Don't start this unit on the Debian Live CD when using overlayfs
ConditionPathExists=!/run/live/overlay/work

[Service]
Type=oneshot
ExecStart=/lib/apparmor/apparmor.systemd reload
ExecReload=/lib/apparmor/apparmor.systemd reload

# systemd maps 'restart' to 'stop; start' which means removing AppArmor confinement
# from running processes (and not being able to re-apply it later).
# Upstream systemd developers refused to implement an option that allows overriding
# this behaviour, therefore we have to make ExecStop a no-op to error out on the
# safe side.
#
# If you really want to unload all AppArmor profiles, run   aa-teardown
ExecStop=/bin/true
RemainAfterExit=yes

[Install]
WantedBy=sysinit.target
</code></pre>
<p>Culprit being:</p>
<pre><code class="lang-auto"># Don't start this unit on the Debian Live CD when using overlayfs
ConditionPathExists=!/run/live/overlay/work
</code></pre>
<p>Next step, find out which component creates <code>/run/live/overlay/work</code>?</p>
<p>//cc <a class="mention" href="http://forums.whonix.org/u/onion_knight">@onion_knight</a> <a class="mention" href="http://forums.whonix.org/u/troubadour">@troubadour</a></p>
<p>In my next post I will suggest a potential workaround, which if working, can be applied to next package upgrade of Whonix.</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/7</link>
        <pubDate>Thu, 20 Jun 2019 04:08:49 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-7</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>Confirmed! Thanks for your report <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d.png" data-download-href="//forums.whonix.org/uploads/default/567b677d4e4be95421573aa9beecae76e2179b0d" title="apparmorlive.png"><img src="//forums.whonix.org/uploads/default/optimized/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d_2_690x222.png" alt="apparmorlive" width="690" height="222" srcset="//forums.whonix.org/uploads/default/optimized/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d_2_690x222.png, //forums.whonix.org/uploads/default/original/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d.png 1.5x, //forums.whonix.org/uploads/default/original/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d.png 2x" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/5/567b677d4e4be95421573aa9beecae76e2179b0d_2_10x10.png"></a></div><p></p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/6</link>
        <pubDate>Wed, 19 Jun 2019 17:56:54 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-6</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[zilika]]></dc:creator>
        <description><![CDATA[
            <p>After todays Whonix package update in persistent mode Apparmor works corectly, but on live mode still doesn’t work, 0 profiles loaded.</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/5</link>
        <pubDate>Wed, 19 Jun 2019 09:45:23 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-5</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>wait for this issue to get fixed then check back again:</p>
<p><a href="http://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/whonix-virtualbox-15-0-0-0-7-debian-buster-based-testers-wanted/7131/27" class="onebox" target="_blank" rel="nofollow noopener">http://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/whonix-virtualbox-15-0-0-0-7-debian-buster-based-testers-wanted/7131/27</a></p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/4</link>
        <pubDate>Mon, 17 Jun 2019 14:49:02 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-4</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[zilika]]></dc:creator>
        <description><![CDATA[
            <p>Whonix 15</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/3</link>
        <pubDate>Mon, 17 Jun 2019 14:32:16 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-3</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[TNT_BOM_BOM]]></dc:creator>
        <description><![CDATA[
            <p>whonix 14 or 15?</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/2</link>
        <pubDate>Mon, 17 Jun 2019 10:07:18 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-2</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
      <item>
        <title>Live mode breaks apparmor</title>
        <dc:creator><![CDATA[zilika]]></dc:creator>
        <description><![CDATA[
            <p>On live mode apparmor breaks completely 0 profile loaded:</p>
<p>apparmor module is loaded.<br>
0 profiles are loaded.<br>
0 profiles are in enforce mode.<br>
0 profiles are in complain mode.<br>
0 processes have profiles defined.<br>
0 processes are in enforce mode.<br>
0 processes are in complain mode.<br>
0 processes are unconfined but have a profile defined.</p>
<p>On persistent mode doesn’t load all profiles, only 3 if I recall correctly.<br>
Tested on KVM.<br>
Any advice is welcomed if a solution is not ready.</p>
          <p><a href="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/live-mode-breaks-apparmor/7559/1</link>
        <pubDate>Mon, 17 Jun 2019 09:52:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7559-1</guid>
        <source url="http://forums.whonix.org/t/live-mode-breaks-apparmor/7559.rss">Live mode breaks apparmor</source>
      </item>
  </channel>
</rss>
