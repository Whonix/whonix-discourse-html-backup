<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
    <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917</link>
    <description>@onion_knight in https://forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/109

[quote=&quot;onion_knight, post:109, topic:7350&quot;]
* By default, the VMs do no start until the CPU configuration is set to “Copy host CPU configuration”, which is expected in KVM, but also happened when testing on real hardware (both using the ISO and the installed version). Might be related to my specific hardware though.
[/quote]</description>
    <language>en</language>
    <lastBuildDate>Wed, 21 Aug 2019 12:02:21 +0000</lastBuildDate>
    <category>KVM</category>
    <atom:link href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="11" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>What (simply) <code>virsh define</code></p>
<pre><code class="lang-auto">virsh -c qemu:///system define /usr/share/whonix-libvirt/xml/Whonix-Gateway.xml
</code></pre>
<p>is does is simply copy <code>/usr/share/whonix-libvirt/xml/Whonix-Gateway.xml</code> to <code>/etc/libvirt/qemu/Whonix-Gateway.xml</code> ?</p>
</blockquote>
</aside>
<p>As far as I remember (but would need testing anew to confirm), <code>virsh define</code> command was necessary as “simply copying” the file would not would not persist after reboot or something like that… Or maybe the following <code>virsh</code> commands would not work otherwise…</p>
<aside class="quote no-group" data-post="13" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Are both QEMU and KVM xml files inside the same folder <code>/etc/libvirt/qemu</code> ?</p>
<p>Do you have folder <code>/etc/libvirt/kvm</code> anywhere on any “<a href="https://www.whonix.org/wiki/KVM" rel="nofollow noopener">usual</a>” (KVM VM version as of now) on any of your hosts?</p>
</blockquote>
</aside>
<p>On my debian buster host: yes, everything is inside this directory, and I have no <code>/etc/libvirt/kvm</code> directory.</p>
<aside class="quote no-group" data-post="16" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Did you need to enable <code>Nested KVM Virtualization</code> inside the Whonix-Host build which was running inside a VM?</p>
</blockquote>
</aside>
<p>No, only on the physical host (as the virtualized host probably “doesn’t know” it is virtualized?).</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/17">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/17</link>
        <pubDate>Wed, 21 Aug 2019 12:02:21 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-17</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Did you need to enable <code>Nested KVM Virtualization</code> inside the Whonix-Host build which was running inside a VM?</p>
<aside class="quote no-group" data-post="4" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>See my <a href="https://github.com/Whonix/whonix-libvirt/pull/92" rel="nofollow noopener">pull request</a> <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> (I hope I changed the right file! but you get the idea…)</p>
</blockquote>
</aside>
<p>Merged. And modified/fixed.</p>
<aside class="quote no-group" data-post="4" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>The problem is that this temporary change must be reverted back once the VMs have been configured, which was initially taken care of, but these lines were (probably mistakenly) removed from the same file:</p>
</blockquote>
</aside>
<p>In conclusion, this should be fixed in <code>whonix-libvirt</code> git master.</p>
<aside class="quote no-group" data-post="7" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Actually, I am currently writing this post from a Whonix-Host install running in KVM in live-mode, with both Whonix-VM in live-mode too! Isn’t that amazing? <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> It’s not even that slow! Perfectly fine for testing!</p>
</blockquote>
</aside>
<p>Yay!</p>
<aside class="quote no-group" data-post="8" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>Host running Whonix-Host install (booted in live mode) on KVM with virt-manager -&gt; Whonix-Host running Whonix-Gateway and Whonix-Workstation VMs in live-mode (nested KVM virtualization)</p>
</blockquote>
</aside>
<p>Terrific! <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> <img src="//forums.whonix.org/images/emoji/twitter/partying_face.png?v=9" title=":partying_face:" class="emoji" alt=":partying_face:"></p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/16">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/16</link>
        <pubDate>Wed, 21 Aug 2019 07:19:04 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-16</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="11" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Does (simply) <code>virsh define</code> do something else too on top of that?</p>
</blockquote>
</aside>
<p>It does or maybe “it might”. Unrelated command (<a href="https://phabricator.whonix.org/T914" rel="nofollow noopener">https://phabricator.whonix.org/T914</a>)</p>
<p><code>sudo virt-xml Whonix-Workstation --edit --disk readonly=on</code></p>
<p>changes on top of what is expected additionally domain type from <code>kvm</code> to <code>qubes</code> on my Qubes test machine.</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/15">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/15</link>
        <pubDate>Wed, 21 Aug 2019 06:39:30 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-15</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/whonix-libvirt/commit/62a212bbfd52d0f5f82a55aa57d886ebfc76b166" target="_blank" rel="nofollow noopener">github.com/Whonix/whonix-libvirt</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/whonix-libvirt/commit/62a212bbfd52d0f5f82a55aa57d886ebfc76b166" target="_blank" rel="nofollow noopener">fix string replacement</a>
</h4>


<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/whonix-libvirt/commit/62a212bbfd52d0f5f82a55aa57d886ebfc76b166" target="_blank" rel="nofollow noopener">06:30AM - 21 Aug 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>2 files</strong>
  with <strong>9 additions</strong>
  and <strong>5 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/14">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/14</link>
        <pubDate>Wed, 21 Aug 2019 06:35:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-14</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Are both QEMU and KVM xml files inside the same folder <code>/etc/libvirt/qemu</code>?</p>
<p>Do you have folder <code>/etc/libvirt/kvm</code> anywhere on any “<a href="https://www.whonix.org/wiki/KVM" rel="nofollow noopener">usual</a>” (KVM VM version as of now) on any of your hosts?</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/13">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/13</link>
        <pubDate>Wed, 21 Aug 2019 06:18:52 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-13</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>I am asking because rather than (simply) <code>virsh define</code> we could avoid using (simply) <code>virsh define</code> and copy over the file manually instead. That would spare us all the creation of a temporary file and all the sed calls.</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/12">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/12</link>
        <pubDate>Wed, 21 Aug 2019 06:15:16 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-12</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>What (simply) <code>virsh define</code></p>
<pre><code>virsh -c qemu:///system define /usr/share/whonix-libvirt/xml/Whonix-Gateway.xml
</code></pre>
<p>is does is simply copy <code>/usr/share/whonix-libvirt/xml/Whonix-Gateway.xml</code> to <code>/etc/libvirt/qemu/Whonix-Gateway.xml</code>?</p>
<p>(The file name in name <code>Whonix-Gateway.xml</code> folder <code>/etc/libvirt/qemu/</code> is not extracted from the path <code>/usr/share/whonix-libvirt/xml/Whonix-Gateway.xml</code> but from <code>&lt;name&gt;Whonix-Gateway&lt;/name&gt;</code>.</p>
<p>I.e. if you replace <code>&lt;name&gt;Whonix-Gateway&lt;/name&gt;</code> with <code>&lt;name&gt;Whonix-Gateway&lt;/name&gt;</code> then <code>/etc/libvirt/qemu/Whonix-Gateway-test.xml</code> is created.</p>
<p>Does (simply) <code>virsh define</code> do something else too on top of that?</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/11">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/11</link>
        <pubDate>Wed, 21 Aug 2019 06:13:53 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-11</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="http://forums.whonix.org/u/hulahoop">@HulaHoop</a> not that I know of.</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/10">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/10</link>
        <pubDate>Tue, 20 Aug 2019 14:29:55 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-10</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="5" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>It it sane to enable <code>Nested KVM Virtualization</code> on Whonix Host by default?</p>
<p>Otherwise we get minimal QEMU support for developer testing purposes? <a class="mention" href="http://forums.whonix.org/u/hulahoop">@HulaHoop</a></p>
</blockquote>
</aside>
<p>Emulation should always be a last resort because performance.</p>
<p><a class="mention" href="http://forums.whonix.org/u/onion_knight">@onion_knight</a> Are there changes I need to do to the libvirt files to make things easier?</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/9</link>
        <pubDate>Tue, 20 Aug 2019 14:26:57 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-9</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>See screenshot below:</p>
<p>Host running Whonix-Host install (booted in live mode) on KVM with virt-manager -&gt; Whonix-Host running Whonix-Gateway and Whonix-Workstation VMs in live-mode (nested KVM virtualization)</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/4/474cb6602431bdce233388b7a9781a7ca22d46a9.png" data-download-href="//forums.whonix.org/uploads/default/474cb6602431bdce233388b7a9781a7ca22d46a9" title="Screenshot_2019-08-20_11-44-41.png"><img src="//forums.whonix.org/uploads/default/optimized/2X/4/474cb6602431bdce233388b7a9781a7ca22d46a9_2_690x379.png" alt="Screenshot_2019-08-20_11-44-41" data-base62-sha1="aaKfRWWvrWfuQGLXieN0PCLXH7P" width="690" height="379" srcset="//forums.whonix.org/uploads/default/optimized/2X/4/474cb6602431bdce233388b7a9781a7ca22d46a9_2_690x379.png, //forums.whonix.org/uploads/default/optimized/2X/4/474cb6602431bdce233388b7a9781a7ca22d46a9_2_1035x568.png 1.5x, //forums.whonix.org/uploads/default/optimized/2X/4/474cb6602431bdce233388b7a9781a7ca22d46a9_2_1380x758.png 2x" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/4/474cb6602431bdce233388b7a9781a7ca22d46a9_2_10x10.png"></a></div><p></p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/8</link>
        <pubDate>Tue, 20 Aug 2019 09:47:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-8</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <ol>
<li>I confirm that running (manually in my case)</li>
</ol>
<pre><code class="lang-auto">sed -i "8 s/^.*$/&lt;domain type='kvm'&gt;/" $CHROOT_DIRECTORY/etc/libvirt/qemu/Whonix-Gateway.xml
sed -i "8 s/^.*$/&lt;domain type='kvm'&gt;/" $CHROOT_DIRECTORY/etc/libvirt/qemu/Whonix-Workstation.xml
</code></pre>
<p><strong>solves the initial problem, as expected.</strong></p>
<ol start="2">
<li>I confirm that once enabled on host, <strong>nested KVM virtualization works, both with ISO and on install target!</strong>
</li>
</ol>
<p>Actually, I am currently writing this post from a Whonix-Host install running in KVM in live-mode, with both Whonix-VM in live-mode too! Isn’t that amazing? <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> It’s not even that slow! Perfectly fine for testing!</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/7</link>
        <pubDate>Tue, 20 Aug 2019 09:44:45 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-7</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>EDIT: forget what I just wrote and erased, I missed the part where you said you were talking about “When Whonix Host starts in a VM”.<br>
Will try nested KVM virtualization and report back.</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/6</link>
        <pubDate>Tue, 20 Aug 2019 08:03:12 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-6</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>When Whonix Host starts in a VM… To make developer builds more easy…<br>
I could write a systemd unit file that does “something” only when detecting virtualization. Even only if some forms of virtualization are detected. Perhaps (not) do something when detected running inside VirtualBox / Xen (Qubes) but (not) do something when running inside KVM.<br>
“something” could be such as switching from KVM to QEMU.<br>
At that stage the VMs are already imported so probably another command is needed to change from KVM to QEMU?<br>
I just need to know the conditions (which virtualization or any virtualization) and which command to run.</p>
<p>Or better… Does <code>Nested KVM Virtualization</code> work for you? I see it documented here:<br>
<a href="https://www.whonix.org/wiki/KVM#Nested_KVM_Virtualization" rel="nofollow noopener">https://www.whonix.org/wiki/KVM#Nested_KVM_Virtualization</a></p>
<p>Can you enable <code>Nested KVM Virtualization</code> on the physical host as well as inside Whonix Host (running in VM)?</p>
<p>It it sane to enable <code>Nested KVM Virtualization</code> on Whonix Host by default?</p>
<p>Otherwise we get minimal QEMU support for developer testing purposes? <a class="mention" href="http://forums.whonix.org/u/hulahoop">@HulaHoop</a></p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.whonix.org/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://www.whonix.org/wiki/QEMU" target="_blank" rel="nofollow noopener">Whonix</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:111/35;"><img src="https://www.whonix.org/w/images/e/ee/Qemulogo.svg.png" class="thumbnail"></div>

<h3><a href="https://www.whonix.org/wiki/QEMU" target="_blank" rel="nofollow noopener">QEMU</a></h3>

<p>Using Whonix ™ with QEMU instead of VirtualBox</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>That is only if we cannot get <code>Nested KVM Virtualization</code> functional?</p>
<aside class="quote no-group" data-post="4" data-topic="7917">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/o/f6c823/40.png" class="avatar"> onion_knight:</div>
<blockquote>
<p>First, at least one of the kernel hardening boot parameters somehow messes with the CPU detection on the host (in my case, a quadcore showing only two physical cores, the virtual cores being ignored), which heavily decreases performances. I need to further investigate this issue to find out which specific boot parameter(s) causes that.</p>
</blockquote>
</aside>
<p>Copied here: <a href="https://forums.whonix.org/t/kernel-hardening/7296/15" class="inline-onebox">Kernel Hardening</a></p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/5</link>
        <pubDate>Tue, 20 Aug 2019 07:47:57 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-5</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>OK, I think I found what is the problem <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>First, at least one of the kernel hardening boot parameters somehow messes  with the CPU detection on the host (in my case, a quadcore showing only two physical cores, the virtual cores being ignored), which heavily decreases performances. I need to further investigate this issue to find out which specific boot parameter(s) causes that.</p>
<p>But the main problem is that currently the VMs domain types in the host are set as qemu and not kvm. Indeed, this is done on purpose during building as a workaround to configure the VMs:</p>
<pre><code>## workaround to replace the 'kvm' domain type with 'qemu' otherwise libvirtd service will fail to start in chroot
sed -i "1 s/^.*$/&lt;domain type='qemu'&gt;/" "$temp_dir/xml/Whonix-Gateway.xml"
sed -i "1 s/^.*$/&lt;domain type='qemu'&gt;/" "$temp_dir/xml/Whonix-Workstation.xml"
</code></pre>
<aside class="onebox githubblob">
  <header class="source">
      <a href="https://github.com/Whonix/whonix-libvirt/blob/2d6ed37237af6ae3553eeee307872d0c24615b9f/usr/lib/whonix-libvirt/install" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="https://github.com/Whonix/whonix-libvirt/blob/2d6ed37237af6ae3553eeee307872d0c24615b9f/usr/lib/whonix-libvirt/install" target="_blank" rel="nofollow noopener">Whonix/whonix-libvirt/blob/2d6ed37237af6ae3553eeee307872d0c24615b9f/usr/lib/whonix-libvirt/install</a></h4>
<pre><code class="lang-">#!/bin/bash

## Copyright (C) 2019 - 2019 ENCRYPTED SUPPORT LP &lt;adrelanos@riseup.net&gt;
## See the file COPYING for copying conditions.

set -x
set -e

## {{ Taken from qemu-system-common.postinst.
# Add the kvm group unless it's already there
if ! getent group kvm &gt;/dev/null; then
   addgroup --quiet --system kvm || true
fi
## }} Taken from qemu-system-common.postinst.

## {{ Taken from libvirt-bin.postinst.
if ! getent group libvirt &gt;/dev/null; then
   addgroup --system libvirt
fi
## }} Taken from libvirt-bin.postinst.
</code></pre>

  This file has been truncated. <a href="https://github.com/Whonix/whonix-libvirt/blob/2d6ed37237af6ae3553eeee307872d0c24615b9f/usr/lib/whonix-libvirt/install" target="_blank" rel="nofollow noopener">show original</a>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>The problem is that this temporary change must be reverted back once the VMs have been configured, which was initially taken care of, but these lines were (probably mistakenly) removed from the same file:</p>
<pre><code>## now we can replace back 'qemu' with 'kvm' domain type
sed -i "8 s/^.*$/&lt;domain type='kvm'&gt;/" $CHROOT_DIRECTORY/etc/libvirt/qemu/Whonix-Gateway.xml
sed -i "8 s/^.*$/&lt;domain type='kvm'&gt;/" $CHROOT_DIRECTORY/etc/libvirt/qemu/Whonix-Workstation.xml
</code></pre>
<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/whonix-libvirt/commit/3c15dda26942f72c4173706fe019064fff729147#diff-743295d57fb671f4ac59a2e65834769a" target="_blank" rel="nofollow noopener">github.com/Whonix/whonix-libvirt</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/whonix-libvirt/commit/3c15dda26942f72c4173706fe019064fff729147" target="_blank" rel="nofollow noopener">undo no longer required since done in temp dir</a>
</h4>


<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/whonix-libvirt/commit/3c15dda26942f72c4173706fe019064fff729147" target="_blank" rel="nofollow noopener">08:52AM - 12 May 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>1 files</strong>
  with <strong>0 additions</strong>
  and <strong>4 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>See my <a href="https://github.com/Whonix/whonix-libvirt/pull/92" rel="nofollow noopener">pull request</a> <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> (I hope I changed the right file! but you get the idea…)</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/4</link>
        <pubDate>Mon, 19 Aug 2019 22:58:51 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-4</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>No, this only happens using the Whonix-Host system.</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/3</link>
        <pubDate>Mon, 19 Aug 2019 18:35:26 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-3</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Did this also happen for you if you used KVM “normally” “as a normal user” as per the usual instructions on <a href="https://www.whonix.org/wiki/KVM" rel="nofollow noopener">https://www.whonix.org/wiki/KVM</a> on Debian buster hosts?</p>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/2</link>
        <pubDate>Mon, 19 Aug 2019 13:50:55 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-2</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
      <item>
        <title>VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="http://forums.whonix.org/u/onion_knight">@onion_knight</a> in <a href="https://forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/109" class="inline-onebox">Whonix Desktop Installer with Calamares - field report</a></p>
<aside class="quote no-group" data-post="109" data-topic="7350">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/o/f6c823/40.png" class="avatar"><a href="//forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/109">Whonix Desktop Installer with Calamares - field report</a>
</div>
<blockquote>
<ul>
<li>By default, the VMs do no start until the CPU configuration is set to “Copy host CPU configuration”, which is expected in KVM, but also happened when testing on real hardware (both using the ISO and the installed version). Might be related to my specific hardware though.</li>
</ul>
</blockquote>
</aside>
          <p><a href="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917/1</link>
        <pubDate>Mon, 19 Aug 2019 13:50:17 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7917-1</guid>
        <source url="http://forums.whonix.org/t/vms-do-no-start-until-the-cpu-configuration-is-set-to-copy-host-cpu-configuration/7917.rss">VMs do no start until the CPU configuration is set to “Copy host CPU configuration”</source>
      </item>
  </channel>
</rss>
