<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>whonix, torrents, and being a good tor citizen - Development - Whonix Forum</title>
    <meta name="description" content="- my memory of torrent ips, protocols, and ports is rusty. - torrenting within whonix seems a useful idea, taking advantage of all the goodness that whonix brings. - tor would rather people not torrent through it, for th&amp;hellip;">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="17669ba9.html?page=3" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../c/news/21.html">NEWS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;whonix, torrents, and being a good tor citizen&#39;" href="1766.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/whonix-torrents-and-being-a-good-tor-citizen/1766?page=3" />
<meta name="twitter:url" content="https://forums.whonix.org/t/whonix-torrents-and-being-a-good-tor-citizen/1766?page=3" />
<meta property="og:title" content="whonix, torrents, and being a good tor citizen" />
<meta name="twitter:title" content="whonix, torrents, and being a good tor citizen" />
<meta property="og:description" content="Working notes … continuing …  [quote]whonix, torrents, and being a good tor citizen  There are 2 issues:   Identifying / corralling net traffic. Proxying (udp / socks5) / anonymizing such traffic.  [/quote]  For 2: Internally. whonix already has several proxies in play, be it browser, e-mail, or generally. By definition, and desire, all go through tor. It is the point of using whonix. Yet not all programs have settings to set proxies, http, socks4|5, or otherwise, so there is no easy or universa..." />
<meta name="twitter:description" content="Working notes … continuing …  [quote]whonix, torrents, and being a good tor citizen  There are 2 issues:   Identifying / corralling net traffic. Proxying (udp / socks5) / anonymizing such traffic.  [/quote]  For 2: Internally. whonix already has several proxies in play, be it browser, e-mail, or generally. By definition, and desire, all go through tor. It is the point of using whonix. Yet not all programs have settings to set proxies, http, socks4|5, or otherwise, so there is no easy or universa..." />
<meta property="article:published_time" content="2016-03-02T11:35:47+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="prev" href="17664658.html?page=2">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="1766.html">whonix, torrents, and being a good tor citizen</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/development/8.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/rAntOCauDgb'><span itemprop='name'>rAntOCauDgb</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1766.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-03-02T11:35:47Z' class='post-time'>
                March 2, 2016, 11:35am
              </time>
              <meta itemprop='dateModified' content='2016-03-02T11:43:34Z'>
          <span itemprop='position'>#41</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Working notes … continuing …</p>
<p>[quote]<strong>whonix, torrents, and being a good tor citizen</strong></p>
<p>There are 2 issues:</p>
<ol>
<li>Identifying / corralling net traffic.</li>
<li>Proxying (udp / socks5) / anonymizing such traffic.<br>
[/quote]</li>
</ol>
<p><strong>For 2</strong>: Internally. whonix already has several proxies in play, be it browser, e-mail, or generally. By definition, and desire, all go through tor. It is the point of using whonix. Yet not all programs have settings to set proxies, http, socks4|5, or otherwise, so there is no easy or universal way by which to except particular traffic beside tor rather than through it.</p>
<p>Except, that is, for using a vpn, which is by definition a proxy, and routing all traffic through it. Yes, this is trusting that the vpn provider (truly) is anonymous, or sufficiently so. However, anonymity is -the- selling feature of many VPNs. OTOH … no way to prove a negative. It’s anonymous, until it isn’t, and by then it’s too late. Hopefully word will get out on providers that aren’t, and hopefully all concerned are paying attention when it does.</p>
<p>But then, I suppose the possibility is no worse than the possibility of a compromised tor node or honey trap.<br>
<br><br>
So, <strong>for 2 - VPN</strong>. From a trusted provider.</p>
<p>Aside from using a VPN, the particulars of effecting non-tor traffic on whonix will be discussed another time. It will likely involve iptables rules, routing, and perhaps even policy based routing.<br>
<br></p>
<p><strong>For 1</strong>, the challenge of identifying particular traffic so it may be constrained as desired, outside of tor, yet within the vpn (else one wouldn’t be using whonix at all) …</p>
<p><strong>Solution, part a</strong>: Create and use an additional interface, and associated IP address, and thus provide breadcrumbs by which the whonix gateway can identify, permit, and route, particular traffic, and only that particular traffic, directly to the VPN.</p>
<p>One way to do this would be to create an additional virtualbox, internal network only, interface on both the whonix workstation, and gateway.</p>
<p>However, I instead <em>propose</em> creating a virtual interface on workstation only. Thus only users interested in this particular facility, and having manually installed it, are affected, and only when so running such designated programs. Impact is specific, leaving all other whonix safeguards in place, and in play.</p>
<p>On workstation:</p>
<p>First - # apt-get install bridge-utils</p>
<p>Manually -<br>
<code><br>
brctl addbr br0<br>
brctl addif br0 eth0<br>
ip tuntap add dev tap0 mode tap<br>
ifconfig tap0 192.168.2.1 up<br>
brctl addif br0 tap0<br>
</code></p>
<p>Automatically:</p>
<ul>
<li>mv /etc/network/interfaces.d/30_non-qubes-whonix /etc/network</li>
<li>this mv probably shouldn’t be needed / isn’t appropriate, but I haven’t gotten it to work by merely adding the tap0 and br0 bits to a separate file such as /etc/network/interfaces.d/50_user_add_whonix.</li>
<li>append to /etc/network/interfaces:<br>
<code><br>
auto lo<br>
iface lo inet loopback</code>
</li>
</ul>
<p>iface eth0 inet manual</p>
<p>auto tap0<br>
iface tap0 inet manual<br>
pre-up ip tuntap add dev tap0 mode tap<br>
pre-up ip addr add 192.168.2.1/24 dev tap0<br>
up ip link set dev tap0 up</p>
<p>auto br0<br>
iface br0 inet static<br>
bridge_ports eth0 tap0<br>
address 10.152.152.11<br>
netmask 255.255.192.0<br>
gateway 10.152.152.10</p>
<p><span class="hashtag">#ip</span> tuntap add dev tap0 mode tap<br>
<span class="hashtag">#ifconfig</span> tap0 192.168.1.1 up<br>
<span class="hashtag">#brctl</span> addif br0 tap0<br>
</p>
<ul>
<li>alternately, put the above in something like /etc/network/interfaces.d/50_user_add_whonix, but I haven’t tested that.</li>
</ul>
<p>Leaving a distinct ip address (192.168.2.1) / interface (tap0) upon which to set a designated program to use, and by which the whonix gateway can discern such traffic.</p>
<p>e.g. Some torrent clients have a setting to designate the interface, or ip address, to use.</p>
<p>On gateway:</p>
<p><em>Pre-test</em>:<br>
<code><br>
ping 192.168.2.1 # - no response, expected.<br>
</code></p>
<p>Modify or create a file in /etc/whonix_firewall.d, such as 50_user_conf, creating or modifying a section to look like:<br>
<code><br>
## Destinations you don not want routed through the VPN.<br>
## 10.0.2.2/24: VirtualBox DHCP<br>
#LOCAL_NET=“127.0.0.0/8 10.152.152.0/24 10.0.2.2/24”<br>
#LOCAL_NET="<br>
#       127.0.0.0-127.0.0.24 <br>
#       192.168.0.0-192.168.0.24 <br>
#       192.168.1.0-192.168.1.24 <br>
#       10.152.152.0-10.152.152.24 <br>
#       10.0.2.2-10.0.2.24 <br>
#"<br>
LOCAL_NET="<br>
127.0.0.0-127.0.0.24 <br>
192.168.2.0-192.168.2.24 <br>
10.152.152.0-10.152.152.24 <br>
10.0.2.2-10.0.2.24 <br>
"<br>
</code></p>
<p><em>Manually</em> -<br>
<code><br>
route add -net 192.168.2.0/24 dev eth1<br>
</code></p>
<p><em>Automatically</em> - edit /etc/network/interfaces.d/30_non-qubes-whonix:</p>
<ul>
<li>append a line to the ‘<em>iface eth inet static</em>’ section:<br>
<code><br>
&lt;tab&gt; up route add -net 192.168.2.0/24 gw 10.152.152.11<br>
</code>
</li>
</ul>
<p><em>Alternately</em>: Add ‘route add -net 192.168.2.0/24 gw 10.152.152.11’ to 50_user_conf above, rather than messing with files under /etc/network.</p>
<p>Run “whonix_firewall” to manually effect the change, without rebooting.</p>
<p><em>Test</em>:<br>
ping 10.152.152.11 # - should work, as expected.<br>
ping 192.168.2.1 # - should work, now.</p>
<br>
<p>Next up, <em>Solution, part b</em> combining the individually incompletely effective <a href="../../../external.html?link=http://0pointer.de/lennart/projects/fixsrcip/" rel="nofollow noopener">fixsrcip</a> and <a href="../../../external.html?link=http://freecode.com/projects/force_bind" rel="nofollow noopener">force_bind</a> together, to be more completely effective.<br>
<br><br>
And beyond that, <em>Solution, part c</em> will be necessary gateway iptables changes to make the whole work.<br>
<br></p>
<p>Suggestions/enhancements most certainly welcome. Especially for anything suggested that’s actually inadvertently rather ‘dumb’ -particularly, from a whonix community / purpose perspective. Especially anything that pertains to where best to place / plug in this stuff for other whonix users so interested, to find.</p>
        </div>

        <meta itemprop='headline' content='whonix, torrents, and being a good tor citizen'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/rAntOCauDgb'><span itemprop='name'>rAntOCauDgb</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1766.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-03-14T20:06:47Z' class='post-time'>
                March 14, 2016,  8:06pm
              </time>
              <meta itemprop='dateModified' content='2016-03-14T20:06:47Z'>
          <span itemprop='position'>#42</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Working notes … continuing …</p>
<p>[quote]<strong>whonix, torrents, and being a good tor citizen</strong></p>
<p>There are 2 issues:</p>
<ol>
<li>Identifying / corralling net traffic.</li>
<li>Proxying (udp / socks5) / anonymizing such traffic.<br>
.<br>
.<br>
.<br>
So, <strong>for 2 - VPN</strong>. From a trusted provider.</li>
</ol>
<p>Aside from using a VPN, the particulars of effecting non-tor traffic on whonix will be discussed another time. It will likely involve iptables rules, routing, and perhaps even policy based routing.<br>
<br></p>
<p><strong>For 1</strong>, the challenge of identifying particular traffic so it may be constrained as desired, outside of tor, yet within the vpn (else one wouldn’t be using whonix at all) …</p>
<p><strong>Solution, part a</strong>: Create and use an additional interface, and associated IP address, and thus provide breadcrumbs by which the whonix gateway can identify, permit, and route, particular traffic, and only that particular traffic, directly to the VPN.</p>
<p>One way to do this would be to create an additional virtualbox, internal network only, interface on both the whonix workstation, and gateway.</p>
<p>However, I instead <em>propose</em> creating a virtual interface on workstation only. …</p>
<p>{Creation of br0 …}[/quote]</p>
<p>Continuing here with <strong>Solution, part b</strong>: Constraining a program / application’s IP traffic to a designated address …</p>
<p>I have combined / expanded / ‘enhanced’ the individually incompletely effective <a href="../../../external.html?link=http://0pointer.de/lennart/projects/fixsrcip/" rel="nofollow noopener">fixsrcip</a> and <a href="../../../external.html?link=http://freecode.com/projects/force_bind" rel="nofollow noopener">force_bind</a> together, creating <a href="../../../external.html?link=https://github.com/rAntOCauDgb/runfromiptcpudp" rel="nofollow noopener">runfromiptcpudp</a></p>
<p>Usage: runfromiptcpudp {ip address} {program}<br>
e.g., per prior post: runfromiptcpudp 192.168.2.1 qbittorrent</p>
<p>Having pinned the program to an ip, traffic is corralled, and <em>part c, what to do with the now identified traffic</em>, can proceed.</p>
<p>Enhancements include:<br>
- exiting if the specified IP doesn’t exist on an interface (rather than proceeding anyways!).<br>
- more verbosity / better syslog’ging whereby a user can figure out what all a program is doing / IPs being used.</p>
<p>Degradation includes:<br>
- fixsrcip is not IPv6 aware, while force_bind is. However, although the runfromiptcpudp combination doesn’t remove that awareness, it has not yet been extended to the fixsrcip base. Thus, until such experts apply their expertise to the code, IPv6 traffic is denied. (Which some may agree is no bad thing.)</p>
<p>Consequences include:<br>
- traffic that escapes a program is either denied, or gets handled and appropriately scrubbed by the current whonix facility. e.g. Despite being so pinned, ktorrent leaks traffic (being a KDE program) - which still gets tor’ified.<br>
- local network broadcasts get muted. (Since they become bound to an IP, not 0.0.0.0).<br>
- A program is independently network encapsulated, without the overhead of LXC, and traffic sysloggable. Providing, consequently, an independent trapping / logging mechanism for 3rd party programs.</p>
<p>To make use of / install:<br>
<code><br>
$ mkdir ~/local/src; cd ~/local/src<br>
$ git clone <a href="../../../external.html?link=https://github.com/rAntOCauDgb/runfromiptcpudp.git" rel="nofollow noopener">https://github.com/rAntOCauDgb/runfromiptcpudp.git</a><br>
$ ./INSTALL #(which merely calls make; make install.)<br>
</code></p>
<p>Having set up br0 as per prior message in this thread:</p>
<p>runfromiptcpudp 192.168.2.1 {program}</p>
<p>And traffic is corralled, as desired.<br>
<br><br>
Next up, <em>Solution, part c</em> will be necessary gateway iptables changes to make the whole work.</p>
        </div>

        <meta itemprop='headline' content='whonix, torrents, and being a good tor citizen'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.html'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/rAntOCauDgb'><span itemprop='name'>rAntOCauDgb</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="1766.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2016-03-24T01:07:28Z' class='post-time'>
                March 24, 2016,  1:07am
              </time>
              <meta itemprop='dateModified' content='2016-03-24T01:20:00Z'>
          <span itemprop='position'>#43</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Working notes … final.</p>
<p>[quote]<strong>whonix, torrents, and being a good tor citizen</strong></p>
<p>There are 2 issues:</p>
<ol>
<li>Identifying / corralling net traffic.</li>
<li>Proxying (udp / socks5) / anonymizing such traffic.<br>
…<br>
So, <strong>for 2 - VPN</strong>. From a trusted provider.</li>
</ol>
<p><strong>For 1, part a</strong>, identifying particular traffic and constraining as desired, <a href="../../../external.html?link=https://github.com/rAntOCauDgb/runfromiptcpudp" rel="nofollow noopener">runfromiptcpudp</a> as discussed.<br>
[/quote]</p>
<p>Concluding here with <strong>1, Solution part b</strong>: Permitting and appropriately routing the designated traffic.</p>
<p><i>Note: Presented is <b>a</b> way of <a href="1766/42.html">whonix, torrents, and being a good tor citizen</a>. Proof of concept. Only. Although the steps and details are correct, the specifics of implementing them are suitable only for individual experimentation and use. For general use or implementation, a more robust installation would be required. See <a href="../bolt-on-for-whonix-firewall-best-place-to-put-files/2222/18.html">Bolt on for whonix_firewall - best place to put files?</a> for such beginnings, and particularly <a href="../../../external.html?link=https://www.whonix.org/w/index.php?title=Dev/Firewall_Refactoring" rel="nofollow noopener">Dev/Firewall Refactoring</a>.</i></p>
<p>Environment: For the purposes of development / proof of concept, whonix_firewall was ‘cloned’ (and gutted) to whonix_firewall-post, and associated /etc/whonix_firewall-post.d directory clone of /etc/whonix_firewall.d created.<em>(Thank you Patrick!)</em> Specifics can be seen at <a href="../../../external.html?link=https://github.com/rAntOCauDgb/whonix-torexceptedtraffic_proofofconcept" rel="nofollow noopener">whonix-torexceptedtraffic_proofofconcept</a> Only the summary / details are shown below.</p>
<p>Assumption: Appropriate settings placed in a file in /etc/whonix_firewall.d, as per /etc/whonix_firewall/30_default, settings such as ‘50_user.conf’:<br>
<code>VPN_FIREWALL=1<br>
VPN_SERVERS="10.0.1.2"<br>
VPN_INTERFACE=tun0<br>
LOCAL_NET="<br>
127.0.0.0-127.0.0.24 <br>
192.168.2.1-192.168.2.1 <br>
10.152.152.0-10.152.152.24 <br>
10.0.2.2-10.0.2.24 <br>
"</code></p>
<p>On Whonix Gateway:</p>
<p>Preparation:<br>
(1) /usr/local/bin/whonix_firewall-post - essentially just the top part of whonix_firewall, the sourcing and executing of files within a designated .d directory.<br>
(2) /etc/whonix_firewall-post.d/30_lastrules_to_envvars - essentially just the environment variables of whonix_firewall, <i>-and-</i> the storing of the last / dropping rules of each chain, so that iptables changes can be modularly implemented.</p>
<ul>
<li>Each .d file utilizes a lock file so it can’t run twice / double iptables rules.</li>
</ul>
<p>e.g.:<br>
<code> # Delete old iptables INPUT last rule.<br>
$iptables_cmd -D $IPT_FILTER_INPUT_LASTRULE</code></p>
<p>&lt; insert appropriate iptables script lines for this module &gt;</p>
<h1>Reapply old iptables INPUT last rule.</h1>
<p>$iptables_cmd -A $IPT_FILTER_INPUT_LASTRULE<br>
</p>
<p>Note: This is NOT how whonix would implement this facility. This mechanism is only useful during the process of development / debugging / discerning correct steps. See <a href="../bolt-on-for-whonix-firewall-best-place-to-put-files/2222/18.html">Bolt on for whonix_firewall - best place to put files?</a> and/or <a href="../../../external.html?link=https://www.whonix.org/w/index.php?title=Dev/Firewall_Refactoring" rel="nofollow noopener">Dev/Firewall Refactoring</a> for a better implementation mechanism.</p>
<p>/etc/whonix_firewall-post.d/70_torexcept:<br>
<code>iam=$(basename $BASH_SOURCE)<br>
mylockfile=/run/lock/WFP_${iam}_run</code></p>
<p>if [ -e “$mylockfile” ]; then<br>
echo ; echo $iam already run, lockfile $mylockfile present. Returning without running.<br>
return 0<br>
fi</p>
<p>echo ; echo Running $iam, setting lockfile ${mylockfile}.<br>
touch $mylockfile</p>
<h1>whonix_firewall permits multiple VPN servers to be specified, space separated.</h1>
<h1>iptables, OTOH, requires the servers to be comma separated.</h1>
<p>VPNIPS="${VPN_SERVERS// /,}"<br>
echo -e “\nExtrapolating VPN IPs of ‘$VPNIPS’ from ‘$VPN_SERVERS’.\n”</p>
<h1>For the moment, put in log entries … skipped for the purposes of this forum thread.</h1>
<h1>Note that iptables -t nat INPUT, OUTPUT, and POSTROUTING, default to accept.</h1>
<h1>- note that -t nat OUTPUT RETURNS if uid cleanet.</h1>
<h1>Note: whonix_firewall INPUT rules:</h1>
<h1>- drop all weird/erroneous things</h1>
<h1>- accept all in from lo</h1>
<h1>- accept all established</h1>
<h1>- deny all icmp</h1>
<h1>- allow all in from tun0</h1>
<h1>- drop all (last rule)</h1>
<p>set -v -x</p>
<h1>----------------------------------------</h1>
<h1>Delete current iptables INPUT last rule.</h1>
<p>$iptables_cmd -D $IPT_FILTER_INPUT_LASTRULE</p>
<h1>{Placeholder Line: Turns out no rules needed. Logging rules in ‘source’ file handy.}</h1>
<h1>Reapply old iptables INPUT last rule.</h1>
<p>$iptables_cmd -A $IPT_FILTER_INPUT_LASTRULE</p>
<h1>---------------------------------------</h1>
<h1>Note: whonix_firewall FORWARD REJECT all (last rule)</h1>
<h1>---------------------------------------</h1>
<h1>Delete current iptables FORWARD last rule.</h1>
<p>$iptables_cmd -D $IPT_FILTER_FORWARD_LASTRULE</p>
<p>$iptables_cmd -A FORWARD -i $INT_IF -o $VPN_INTERFACE -s $XCEPTIP -j ACCEPT<br>
$iptables_cmd -A FORWARD -i $VPN_INTERFACE -o $INT_IF -d $XCEPTIP -j ACCEPT</p>
<h1>Torrents want to talk to VPN server (presumably) to open ports for</h1>
<h1>forwarding. (*1)</h1>
<p>$iptables_cmd -A FORWARD -i $INT_IF -s $XCEPTIP -d $VPNIPS -j ACCEPT</p>
<h1>Reapply old iptables FORWARD last rule.</h1>
<p>$iptables_cmd -A $IPT_FILTER_FORWARD_LASTRULE</p>
<h1>---------------------------------------</h1>
<h1>Note: whonix_firewall OUTPUT rules:</h1>
<h1>- reject all weird/erroneous things</h1>
<h1>- accept all to tun0</h1>
<h1>- accept all established</h1>
<h1>- accept all LOCAL_NETS</h1>
<h1>- accept all to vpn server ip</h1>
<h1>- accept all from clearnet userid</h1>
<h1>- reject all (last rule)</h1>
<h1>---------------------------------------</h1>
<h1>Delete current iptables OUTPUT last rule.</h1>
<p>iptables -D $IPT_FILTER_OUTPUT_LASTRULE</p>
<h1>{Placeholder Line: Turns out no rules needed. Logging rules in ‘source’ file handy.}</h1>
<h1>Reapply old iptables FORWARD last rule.</h1>
<p>$iptables_cmd -A $IPT_FILTER_OUTPUT_LASTRULE</p>
<h1>---------------------------------------</h1>
<h1>Note: whonix_firewall -t nat PREROUTING rules:</h1>
<h1>- redir (incoming) eth1 tor/9xxx ports to self (tor) equivalents.</h1>
<h1>- redir eth1 udp/dns to self (tor) :5300</h1>
<h1>- redir eth1 tcp to self: 9040 (tor) (last rule)</h1>
<h1>---------------------------------------</h1>
<h1>Delete old iptables -t nat PREROUTING last rule.</h1>
<p>$iptables_cmd -t nat -D $IPT_NAT_PREROUTING_LASTRULE</p>
<p>$iptables_cmd -t nat -I PREROUTING -i $INT_IF -s $XCEPTIP -j ACCEPT</p>
<h1>Reapply old iptables -t nat PREROUTING last rule.</h1>
<p>$iptables_cmd -t nat -A $IPT_NAT_PREROUTING_LASTRULE</p>
<h1>---------------------------------------</h1>
<h1>Note: whonix_firewall -t nat INPUT rules: none.</h1>
<h1>- Default ACCEPT, so won’t be in any way.</h1>
<h1>Note: whonix_firewall -t nat OUTPUT rules: none.</h1>
<h1>- Default ACCEPT, so won’t be in any way.</h1>
<h1>Note: whonix_firewall -t nat POSTROUTING rules: none.</h1>
<h1>- Default ACCEPT, so won’t be in any way.</h1>
<h1>---------------------------------------</h1>
<h1>Delete old iptables -t nat POSTOUTING last rule.</h1>
<h1>- except … it doesn’t currently have any rules.</h1>
<h1>$iptables_cmd -t nat -D $IPT_NAT_POSTROUTING_LASTRULE</h1>
<p>iptables -t nat -A POSTROUTING -o $VPN_INTERFACE -s $XCEPTIP -j MASQUERADE</p>
<h1>See (*1).</h1>
<p>$iptables_cmd -t nat -A POSTROUTING -s $XCEPTIP -d $VPNIPS -j MASQUERADE</p>
<h1>Reapply old iptables -t nat POSTROUTING last rule.</h1>
<h1>$iptables_cmd -t nat -A $IPT_NAT_POSTROUTING_LASTRULE</h1>
<h1>---------------------------------------</h1>
<p>set +v +x<br>
echo</p>
<h1>Enable forwarding.</h1>
<p>echo -n "/proc/sys/net/ipv4/ip_forward \(forwarding\) was: "<br>
cat /proc/sys/net/ipv4/ip_forward<br>
echo 1 &gt; /proc/sys/net/ipv4/ip_forward<br>
echo -n "/proc/sys/net/ipv4/ip_forward \(forwarding\) now: "<br>
cat /proc/sys/net/ipv4/ip_forward</p>
<p>return 0<br>
</p>
<p>To effect: $ sudo whonix_firewall-post<br>
<br><br>
Complete and more extensive details can be seen at <a href="../../../external.html?link=https://github.com/rAntOCauDgb/whonix-torexceptedtraffic_proofofconcept" rel="nofollow noopener">whonix-torexceptedtraffic_proofofconcept</a></p>
<p><i>fini</i><br>
<br><br>
<i>Comments, suggestions, welcome.</i></p>
        </div>

        <meta itemprop='headline' content='whonix, torrents, and being a good tor citizen'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><a rel="prev" itemprop="url" href="17664658.html?page=2">← previous page</a></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
