<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>improving compression of Whonix image downloads</title>
    <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086</link>
    <description>You should use another  data compression archive file format which supports deduplication.

 whonix-gateway and whonix-workstation share a big amount of the same binary files.
Especially the ones in /usr
The differences are only small and in /etc

Last weekend i did the following test.
I unpacked your big Whonix-XFCE-14.0.1.4.4.libvirt.xz archive file.
This file has a compressed size of 1099884060  Bytes, around 1100 MB.

Then i packed the two files 
Whonix-Gateway-XFCE-14.0.1.4.4.qcow2
and
Whonix-Workstation-XFCE-14.0.1.4.4.qcow2
individually.
I ignored the xml files, they have such a small size that they are not important for this comparison.

I used the following commands:
[code]
tar -cvf workstation.tar Whonix-Workstation-XFCE-14.0.1.4.4.qcow2 
xz -z workstation.tar 
tar -cvf gateway.tar Whonix-Gateway-XFCE-14.0.1.4.4.qcow2
xz -z gateway.tar 
[/code]
This resulted in the following two files:
[code]
-rw-rw-r-- 1 XXXXXXXX XXXXXXXXX 498373356 Mar 30 02:37 gateway.tar.xz
-rw-rw-r-- 1 XXXXXXXX XXXXXXXXX 638927196 Mar 30 01:43 workstation.tar.xz
[/code]

If you do the calculation you get the following:
498373356+638927196 = 1137300552 Bytes
compared to the 1099884060  Bytes before with all the additional *.xml stuff.

This shows, that the compression isn&#39;t good.
As i said before, the two *.qcow2 files have a lot in common.
If you mount them, you can see that their directories are nearly identical.
Both use Debian, so both use the same program and library files.
Only the configuration might differ plus a small amount of additional software only available on gateway or workstation. 

This means, if you use a compression format, that can find these file duplications you can save around 500 MB.

You could try to use a raw image file instead of qcow2, this might allow the compression software to find the duplicates easier on a byte level.

Or you could build up the two images with a script on the users side with just one big file. There are plenty of possibilities.</description>
    <language>en</language>
    <lastBuildDate>Mon, 16 Sep 2019 09:24:42 +0000</lastBuildDate>
    <category>Development</category>
    <atom:link href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Algernon]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="34" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I didn’t try that as this would complicate VM import instructions.</p>
</blockquote>
</aside>
<p>Sure, but you would know if it is (maybe) related to the compression algorithm.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/35">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/35</link>
        <pubDate>Mon, 16 Sep 2019 09:24:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-35</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="33" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p>What happens when you xz compress the ova?</p>
</blockquote>
</aside>
<p>I didn’t try that as this would complicate VM import instructions.</p>
<aside class="quote no-group" data-post="33" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/a/a183cd/40.png" class="avatar"> Algernon:</div>
<blockquote>
<p>If it doesn’t go down to approximately the same size as the libvirt file there must be more data in there.</p>
</blockquote>
</aside>
<p>Not necessarily. Compressing already compressed data might not be as compressible as plain data. Or let’s say, a compressor works best with what a compressor is designed to handle.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/34">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/34</link>
        <pubDate>Sun, 15 Sep 2019 09:02:21 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-34</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Algernon]]></dc:creator>
        <description><![CDATA[
            <p>What happens when you xz compress the ova? If it doesn’t go down to approximately the same size as the libvirt file there must be more data in there.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/33">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/33</link>
        <pubDate>Sun, 15 Sep 2019 08:33:24 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-33</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <pre><code>VBoxManage convertfromraw whonix_binary/Kicksecure-XFCE-15.0.0.5.4.raw whonix_binary/Kicksecure-XFCE-15.0.0.5.4-convertfromraw-variant-stream.vmkd --format vmdk --variant Stream
</code></pre>
<p>That did not go a long way.</p>
<blockquote>
<p>813M    Kicksecure-XFCE-15.0.0.5.4-convertfromraw-variant-stream.vmkd</p>
</blockquote>
<p>That is what is already happening.</p>
<blockquote>
<p>813M    Kicksecure-XFCE-15.0.0.5.4.ova</p>
</blockquote>
<p>I figured out we might speed up the build process. Even though vmdk is not VirtualBox’s own / best supported file format, it’s defined in the OVA standard.</p>
<p>Current Whonix VirtualBox build process: raw image creation -&gt; create vdi from raw -&gt; create VirtualBox VM -&gt; stop here for most users -&gt; prepare_release script can create ova (which makes VirtualBox convert the vdi to vmdk)</p>
<p>(And when user imports the ova, VirtualBox will convert back to vdi by default nowadays. A waste of time. But unfixable until/if OVA supports vdi. Maybe the ova could be manually created without use of vboxmange but that could be more prone to bugs during VM import.)</p>
<p>Whonix VirtualBox build process could be speed up by skipping the convert to vdi step but that would require different build <code>--target</code>s being implemented. Perhaps <code>--target virtualbox-vdi</code> (handy for use after build) and <code>--virtualbox-vmdk</code> (handy for ova creation). But convert form raw to vdi is taking only two minutes so maybe not worth the hassle.</p>
<p>When using installers (<a href="https://www.whonix.org/wiki/Dev/Whonix-Windows-Installer" rel="nofollow noopener">https://www.whonix.org/wiki/Dev/Whonix-Windows-Installer</a>) these might improve compression on top of it.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/32">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/32</link>
        <pubDate>Sat, 14 Sep 2019 07:18:18 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-32</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Could <code>fstrim</code> be of any use?</p>
<p><a href="https://manpages.debian.org/buster/util-linux/fstrim.8.en.html" class="onebox" target="_blank" rel="nofollow noopener">https://manpages.debian.org/buster/util-linux/fstrim.8.en.html</a></p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/31">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/31</link>
        <pubDate>Sat, 14 Sep 2019 06:40:32 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-31</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>This might not have any effect since we are already <a href="https://github.com/Whonix/Whonix/blob/master/build-steps.d/2350_zerofree-raw" rel="nofollow noopener">using zerofree</a>.</p>
<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Whonix/Whonix/commit/e4a86cd9315ded19164fbac339411bba53c31f07" target="_blank" rel="nofollow noopener">github.com/Whonix/Whonix</a>
  </header>
  <article class="onebox-body">
      <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">
    <img alt="adrelanos" src="https://avatars3.githubusercontent.com/u/1985040?v=4" class="thumbnail onebox-avatar" width="90" height="90">
  </a>

<h4>
  <a href="https://github.com/Whonix/Whonix/commit/e4a86cd9315ded19164fbac339411bba53c31f07" target="_blank" rel="nofollow noopener">VBoxManage modifymedium --compact</a>
</h4>

  <pre class="message" style="white-space: normal;">https://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/29</pre>

<div class="date">
  by <a href="https://github.com/adrelanos" target="_blank" rel="nofollow noopener">adrelanos</a>
  on <a href="https://github.com/Whonix/Whonix/commit/e4a86cd9315ded19164fbac339411bba53c31f07" target="_blank" rel="nofollow noopener">06:23AM - 14 Sep 19 UTC</a>
</div>

<div class="github-commit-stats">
  changed <strong>1 files</strong>
  with <strong>9 additions</strong>
  and <strong>0 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/30">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/30</link>
        <pubDate>Sat, 14 Sep 2019 06:25:15 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-30</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <pre><code>du -h whonix_binary/*
</code></pre>
<p>(Dropping unimportant files such as signatures.)</p>
<blockquote>
<p>522M    whonix_binary/Kicksecure-XFCE-15.0.0.5.4.libvirt.xz<br>
813M    whonix_binary/Kicksecure-XFCE-15.0.0.5.4.ova<br>
2.6G    whonix_binary/Kicksecure-XFCE-15.0.0.5.4.qcow2<br>
3.9G    whonix_binary/Kicksecure-XFCE-15.0.0.5.4.raw</p>
</blockquote>
<pre><code>du -h /home/user/VirtualBox\ VMs/Kicksecure-XFCE/Kicksecure-XFCE.vdi 
</code></pre>
<blockquote>
<p>2.9G    /home/user/VirtualBox VMs/Kicksecure-XFCE/Kicksecure-XFCE.vdi</p>
</blockquote>
<p>The <code>libvirt.xz</code> is a lot smaller than the <code>ova</code>.</p>
<p>How can we improve compression of the <code>ova</code>?</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/29">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/29</link>
        <pubDate>Sat, 14 Sep 2019 06:13:45 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-29</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="26" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>What about the Debian installer?</p>
</blockquote>
</aside>
<p>Progress on that was made. Calamares based. Search the forums for <code>Whonix Host</code> or <code>Calamares</code>.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/28">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/28</link>
        <pubDate>Sat, 14 Sep 2019 05:56:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-28</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="26" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>What about the Debian installer?<br>
Have you ever thought about adapting it for Whonix?</p>
</blockquote>
</aside>
<p>Yes. Complex thing. A ton of work.</p>
<p>Whonix 0.2 or so build process was based on automating (preseeding) Ubuntu installer. Fragile, messy.</p>
<aside class="quote no-group" data-post="26" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>That’s more packages than i have expected.</p>
</blockquote>
</aside>
<p>Yeah. Some stuff should be merged. anon-mixmaster fits into anon-apps-config and more. Long time ago, I acted on bad advice and overdid the split.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/27">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/27</link>
        <pubDate>Fri, 05 Apr 2019 11:22:56 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-27</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <p>Okay, i understand.</p>
<p>What about the Debian installer?<br>
Have you ever thought about adapting it for Whonix?</p>
<aside class="quote no-group">
<blockquote>
<p><a href="https://github.com/Whonix" rel="nofollow noopener">https://github.com/Whonix</a></p>
</blockquote>
</aside>
<p>That’s more packages than i have expected.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/26">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/26</link>
        <pubDate>Fri, 05 Apr 2019 09:57:47 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-26</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[onion_knight]]></dc:creator>
        <description><![CDATA[
            <p>Very interesting read, thank you <a class="mention" href="http://forums.whonix.org/u/firefox">@Firefox</a> for the amazing efforts you put into this well-thought reflection.</p>
<p>But while it’s always nice to have smaller images to download, I agree that the amount of work needed for what would eventually a rather small gain is probably not worth it. If you look at the standard Linux distributions, Whonix is actually on the lighter side regarding the size of the downloadable image files. Ubuntu is 1.8 GB, Tails 1.2 GB, any other distro probably somewhere in-between, if not more. As a matter of fact, Whonix images size has already been greatly reduced since 2018 (going from 2 files of 1.7 and 2 GB to one single file of 1.6 GB for the ova file, 1.1 GB for the libvirt file).</p>
<p>IMHO anything that adds complexity for the end-users must be avoided at all costs if possible, especially for a vanilla install and first use. It may be seem absurdly easy to you, but many people already struggle with the basic task of downloading and setting up VirtualBox and importing two simple .ova files (I am not mentioning KVM on purpose as its users are probably more tech savvy). I couldn’t imagine how it would be if they had to run some kind of script on top of that. Not even mentioning all the extra work for the already understaffed Whonix team and the many many inevitable bugs to solve.</p>
<p>Speaking of which, judging by your level of knowledge and commitment, I think the Whonix project would greatly benefit from your help and contributions! <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/25">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/25</link>
        <pubDate>Thu, 04 Apr 2019 22:41:05 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-25</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="22" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>it’s really no big work</p>
</blockquote>
</aside>
<aside class="quote no-group" data-post="22" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>isn’t much work.</p>
</blockquote>
</aside>
<p>For you it may be simple but for me it’s a high mountain to climb. That’s why I call it unrealistic. If I saw an implementation of this, I might change my mind. But unless you intent to fork Whonix, this isn’t a great exercise (unless it costs you very, very little time). I estimate this this will introduce way too much extra complexity for relatively small gains. There are few people who told me that they looked into the build script, understood it or let alone contributed major things to it. So I wouldn’t want to make it even more difficult than it already is.</p>
<aside class="quote no-group" data-post="22" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>But that’s why symlinks are there for.</p>
</blockquote>
</aside>
<p>More and more complexity which then leads to follow up issues such as symlinks vs apparmor.</p>
<aside class="quote no-group" data-post="22" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>Thus you can in most times just overwrite the dependency checking for this step, because it is solved anyway as soon as the missing packages are installed after the first boot.</p>
</blockquote>
</aside>
<aside class="quote no-group" data-post="22" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>That’s sad to hear.</p>
</blockquote>
</aside>
<p>May be possible but extra source code, extra complexity.</p>
<p>Perhaps you’re more clever than me. However, the volunteer workforce contributing to Whonix is rather small. So while me being scared by he extra complexity I am still useful. (Unless, you fork Whonix and do everything better. I wouldn’t mind about that either. I could be a contributor and also I am sure I’d find other fun things in life too.)</p>
<p>I concentrate on something easy and yet impact such as <a href="https://forums.whonix.org/t/kloak-keystroke-anonymization-tool-testers-wanted/7089/6">kloak</a>. I would encourage you to contribute. Perhaps you could implement something that fixes <a href="https://www.whonix.org/wiki/Advanced_Deanonymization_Attacks" rel="nofollow noopener">https://www.whonix.org/wiki/Advanced_Deanonymization_Attacks</a> or some of the open tickets <a href="https://phabricator.whonix.org/maniphest/query/open/" rel="nofollow noopener">https://phabricator.whonix.org/maniphest/query/open/</a>?</p>
<aside class="quote no-group" data-post="22" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>Just a question, how many Tor or Whonix specific packages that are not Debian packages are in Whonix gateway and workstation at the moment?</p>
</blockquote>
</aside>
<p><a href="https://github.com/Whonix" rel="nofollow noopener">https://github.com/Whonix</a></p>
<aside class="quote no-group" data-post="23" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>I am also wondering why Whonix isn’t using an installer in the first place like other distributions do?</p>
</blockquote>
</aside>
<ul>
<li>Historic growth. Limited time. Flood of issues.</li>
<li>Lack of source code contributors.</li>
<li>Requires development work.</li>
<li>Whonix is the only distribution that specialized on deploying VMs for end-users that I am aware of. Build script, deployment methods (platform independent ova’s), it’s maintainable. During Whonix’s total lifetime 2012 to time of writing in 2019, I managed to keep up with all underlying changes (Debian, Tor, virtzalizers).</li>
</ul>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/24">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/24</link>
        <pubDate>Thu, 04 Apr 2019 14:00:25 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-24</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <h1>Suggestion 5</h1>
<p>Thinking about my suggestion 4, which  i personally like the best at the moment, i am wondering if a installer image wouldn’t be the best solution of all.<br>
With a installer image the user would download just one image and when the installer image boots up it allows to select between installing a Whonix Gateway or a Whonix Workstation system.<br>
With the installer, all problems with duplicates are gone and a installer is also much more versatile than VM images. You could for example use an installer image to install Whonix Workstation or Gateway on real hardware.<br>
With other architecture specific deb files, the installer image could also be used to provide a solution for non x86 hardware, like for example an arm based Raspberry Pi.<br>
I am also wondering why Whonix isn’t using an installer in the first place like other distributions do?</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/23">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/23</link>
        <pubDate>Thu, 04 Apr 2019 11:51:31 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-23</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="20" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Rather than “just import the<br>
ova using virtualbox” it’s “extract, make the script executable, run the<br>
script” (or in case of Windows perhaps an installer). Possible but no<br>
development resources for that.</p>
</blockquote>
</aside>
<p>Yes, that’s the drawback and probably the price to pay for having much smaller download sizes.</p>
<aside class="quote no-group">
<blockquote>
<p>Whonix packages using genmkfile also support setting DESTDIR. However,<br>
<code>make install</code> is only used during the package creation process.<br>
Software by Whonix is installed through packages. These are using the<br>
default paths as per FHS. Packages install to / as per usual.</p>
</blockquote>
</aside>
<p>I know, but it’s really no big work changing the default path from /usr to /opt for a deb package.<br>
Creating deb packages is rather simple and straightforward.<br>
The installation path change for the makefile is required for the binary, because the binary executable is searching for its libs and files in paths compiled into the binary. If that is done, the rest, packing them in a deb archive isn’t much work.<br>
Especially if these are only a small amount of Tor or Whonix specific packages.</p>
<p>Just a question, how many Tor or Whonix specific packages that are not Debian packages are in Whonix gateway and workstation at the moment?</p>
<aside class="quote no-group">
<blockquote>
<p>These are using the<br>
default paths as per FHS. Packages install to / as per usual.  No package<br>
/ just using <code>make install</code> -&gt; no good upgrade path. Packages provide a<br>
very good upgrade path.</p>
</blockquote>
</aside>
<p>I know that. I did use that as an example because the rest, creating the deb isn’t a real problem.<br>
deb packages work just fine with having files in another path like /opt as long as the executable was created for the new path. In other words, the work is in the Makefiles and compiling, the rest is only packaging the files to a deb package.</p>
<aside class="quote no-group">
<blockquote>
<p>Also package installation<br>
requires their dependencies being installed already.</p>
</blockquote>
</aside>
<p>Dependencies are not an issue, because a program that is installed to /opt by its deb package can easily search for its required libs in /usr. This is all done in the Makefile process.<br>
And thus this can also be worked out for dependencies. There is really no big change in that.</p>
<p>The only exception is, when you have to <strong>replace</strong> a Debian package with a Whonix specific package and having other still Debian deb packages be dependent on this replaced Debian package.<br>
Only then you have a small problem. Because the programs of these other Debian deb packages will search in /usr, not in /opt.<br>
But that’s why symlinks are there for.<br>
So it’s still solvable. the Whonix package,which replaces the Debian package has just to also provide and create the symbolic links in /usr for the files in /opt.</p>
<aside class="quote no-group">
<blockquote>
<p>(To resolve<br>
dependencies, to install in right order, a local apt repository would be<br>
required.)</p>
</blockquote>
</aside>
<p>Well most Debian packages that depend on another Debian package just do this, because they need some specific files in the path which is provided by the other Debian package. Only very view Debian packages are shipped with some sort of script, that change some configuration information in a file, that was provided by the other package it depends on.<br>
Thus you can in most times just overwrite the dependency checking for this step, because it is solved anyway as soon as the missing packages are installed after the first boot.<br>
Only if you have some script, that change a config, you need to reinstall it after installing the Whonix package.<br>
But this can be solved too, by just providing the Debian package in the /var/apt/cache/apt/archives/  directory and installing it, after the other Whonix specific packages are installed.<br>
The only drawback of this approach is, that you will have some deb packages as duplicates in gateway and workstation.</p>
<aside class="quote no-group">
<blockquote>
<p>In theory it’s all doable but super complex and error prone. I would<br>
veto such changes and suggest to fork Whonix instead if this is desired.</p>
</blockquote>
</aside>
<p>That’s sad to hear.</p>
<aside class="quote no-group">
<blockquote>
<p>So<br>
someone must have sorted out deduplication and compression of VM images<br>
in a generic way already.</p>
</blockquote>
</aside>
<p>I agree on that a generic way by using a compression tool is an easier approach with less work, but i highly doubt that this can fight all duplicates.<br>
I also agree on that it is a good idea to do more tests with different compression tools and other compression settings to find a better solution.</p>
<p>But on the other side i also doubt that a generic compression tool can solve the principle problem.<br>
The actual problem is, that the compression tool must or should be clever enough and be able to understand file-systems and vm images, only when this is the case, the duplicates can really be sorted out. But generic compression tools can’t do that.<br>
Maybe we should also take a look into backup tools. They understand that on a filesystem level or use at least the filesystem support of the system for that.</p>
<p>With a generic approach, you will always have duplicates in two vm images, but the byte sequence differs because block arrangement or meta information is different. Especially when the vm image does use compression too.</p>
<h1>New suggestion 4:</h1>
<p>I have a new idea for a new approach that will simplify a lot and be able to fight all duplicate problems.<br>
You could provide two vm starter images for Whonix workstation and Whonix gatewith with the absolute minimum just to boot a kernel and be able to install deb packages.</p>
<p>And additional to this, we provide a big data vm image which contains ALL deb packages that are required for whonix workstation or whonix gateway.</p>
<p>The user loads a VM configuration file that knows about mounting the initial starter vm image and the data image. Also to mention, the data image is only mounted read only.<br>
Then he boots both Whonix systems, workstation and gateway.</p>
<p>And on workstation and gateway a script runs at first boot time and installes all deb packages that are required for workstation or gateway from the data partition provided with the data vm img.<br>
If that is done, the user does have his Whonix workstation and gateway system.<br>
The data img can be removed from the VM after that and deleted from the disk.</p>
<p>By doing it this way, you don’t have to hassle about /opt or /usr, or a /usr partition, you can use any compression tool and you can still fight most duplication files, because all the deb files that are duplicates at the moment are uniq on the data partition, with a small amount of exceptions in the small bare starter images. They will still have the same kernel and thus some duplicates, but the amount is very small.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/22">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/22</link>
        <pubDate>Thu, 04 Apr 2019 10:42:18 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-22</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <pre><code>7z a -t7z -m0=lzma2 -mx=3 -mfb=32 -md=1m -ms=on archive.7z Whonix-Gateway-XFCE-14.0.1.4.4.raw Whonix-Workstation-XFCE-14.0.1.4.4.raw
</code></pre>
<blockquote>
<p><code>du -sh archive.7z</code><br>
<code>1.3G archive.7z</code></p>
</blockquote>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/21">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/21</link>
        <pubDate>Thu, 04 Apr 2019 09:22:25 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-21</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Firefox via Whonix Forum:</p>
<blockquote>
<aside class="quote no-group" data-post="17" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Changing the code for image compression is realistic. But changing the build process for something that benefits KVM only, I am certainly not going to write that code.</p>
</blockquote>
</aside>
<p>Well the principles are the same for both, KVM and Virtualbox. KVM and Virtualbox are only Virtual machines with their specific VM image format and both understand the raw image format or can convert from raw to their VM specific image format.</p>
<p>Thus building 3 raw images and converting them to qcow2 and vdi should be all that is needed to make them VM specific.</p>
</blockquote>
<p>VirtualBox: This would have to be done on the user’s machine. Something<br>
simple (ova image to import) would be converted into something more<br>
complex and platform specific. A script, one for linux, another one for<br>
Windows, and perhaps another one for mac. Rather than “just import the<br>
ova using virtualbox” it’s “extract, make the script executable, run the<br>
script” (or in case of Windows perhaps an installer). Possible but no<br>
development resources for that.</p>
<blockquote>
<pre><code class="lang-auto">Common vm image also seems risky form a security point of view. Which VM would be authorized to make changes to it (update it)?</code></pre>
<p>No, the common vm image format is only shared for step 1 which is the step of downloading the files. The common vm image file makes the download size smaller by removing the extra size for duplicates, that’s the whole point of this thread.</p>
</blockquote>
<p>I see.</p>
<blockquote>
<p>In step 2 the user clones the common image for whonix workspace and renames the other for whonix gateway, or vice versa. Like described above.<br>
Thus in step 3, when the user boots whonix workspace and whonix gateway both have their own image file for /usr.<br>
So to sum it up, at runtime and later usage these are individual independent images.</p>
<p>That is also needed because in step 4, when the workspace or gateway images are booted for the first time, a script automatically installs the none duplicate deb packages as described above from  /var/apt/cache/apt/archives/ making image file gateway_usr.qcow2 and whonix_usr.qcow2 completely independent and different from each other.</p>
</blockquote>
<p>I see.</p>
<blockquote>
<p>The only things that are to keep in mind are:<br>
A. by cloning the common.qcow2 file the UUID of the disk image changes<br>
B. The virtual machine config file may require a change to the new UUID if it is UUID and not filename based.<br>
C. inside of workspace or gateway the /etc/fstab file must be changed according to the UUID. But this should be doable by the script that also installs the deb files when booting the first time.</p>
<p>Steps A and B should be doable by a script the user has to run after download.<br>
Step C can run automatically when the images are booted the first time.</p>
</blockquote>
<p>A lot code to be written.</p>
<blockquote>
<aside class="quote no-group">
<blockquote>
<blockquote>
<p>And only a very small amount of Tor or Whonix specific software must go to opt.</p>
</blockquote>
<p>Development work, and new bugs.</p>
</blockquote>
</aside>
<p>Most open source software offer a way to provide a destination for the installation during the create makefile process.</p>
</blockquote>
<p>Whonix packages using genmkfile also support setting DESTDIR. However,<br>
<code>make install</code> is only used during the package creation process.<br>
Software by Whonix is installed through packages. These are using the<br>
default paths as per FHS. Packages install to / as per usual. No package<br>
/ just using <code>make install</code> -&gt; no good upgrade path. Packages provide a<br>
very good upgrade path. Having the packages install to /opt would be a<br>
lot work updating any paths, new bugs. Also package installation<br>
requires their dependencies being installed already. So Whonix packages<br>
could go to the same directory for initial installation. (To resolve<br>
dependencies, to install in right order, a local apt repository would be<br>
required.)</p>
<p>In theory it’s all doable but super complex and error prone. I would<br>
veto such changes and suggest to fork Whonix instead if this is desired.</p>
<p>I also don’t think Whonix needs to invent something new as complex as<br>
this here. Whonix isn’t an outsider by using VM images. These are very<br>
popular in data centers. These need to backups and transfer files. So<br>
someone must have sorted out deduplication and compression of VM images<br>
in a generic way already.</p>
<p>These two blog posts indicate that just switching to another compression<br>
algorithm could do the trick.</p>
<p><a href="http://www.doublecloud.org/2012/06/best-tool-to-compress-virtual-machines/" class="onebox" target="_blank" rel="nofollow noopener">http://www.doublecloud.org/2012/06/best-tool-to-compress-virtual-machines/</a></p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://wiitez.blogspot.com/favicon.ico" class="site-icon" width="32" height="32">
      <a href="https://wiitez.blogspot.com/2016/12/vm-image-compression-and-optimization.html" target="_blank" rel="nofollow noopener">wiitez.blogspot.com</a>
  </header>
  <article class="onebox-body">
    

<h3><a href="https://wiitez.blogspot.com/2016/12/vm-image-compression-and-optimization.html" target="_blank" rel="nofollow noopener">VM image compression and optimization for transfer, distribution or deep-freeze</a></h3>

<p>We often need to send and receive VM images, mostly over intercontinental and/or slow and/or high latency and/or unreliable connections. We...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>If that does not suffice, for duplication we could also research huge<br>
compression algorithm dictionary sizes and/or preprocessors to remove<br>
duplication.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/20">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/20</link>
        <pubDate>Thu, 04 Apr 2019 09:19:00 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-20</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="16" data-topic="7086" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p><a class="mention" href="http://forums.whonix.org/u/firefox">@Firefox</a> dang you really thought about this. It’s good to see a thought out proposal instead of the usual drive by user requests.</p>
</blockquote>
</aside>
<p>Thanks.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/19">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/19</link>
        <pubDate>Wed, 03 Apr 2019 22:30:51 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-19</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="17" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Changing the code for image compression is realistic. But changing the build process for something that benefits KVM only, I am certainly not going to write that code.</p>
</blockquote>
</aside>
<p>Well the principles are the same for both, KVM and Virtualbox. As far as i know KVM and Virtualbox are only different kinds of Virtual machines software with their specific VM image format and both understand the raw image format or can convert from raw to their VM specific image format.</p>
<p>Thus building 3 raw images and converting them to qcow2 and vdi should be all that is needed to make them VM specific.</p>
<pre><code class="lang-auto">Common vm image also seems risky form a security point of view. Which VM would be authorized to make changes to it (update it)?</code></pre>
<p>No, the common vm image format is only shared for step 1 which is the step of downloading the files. The common vm image file makes the download size smaller by removing the extra size for duplicates, that’s the whole point of this thread.</p>
<p>In step 2 the user clones the common image for whonix workspace and renames the other for whonix gateway, or vice versa. Like described above.<br>
Thus in step 3, when the user boots whonix workspace and whonix gateway both have their own image file for /usr.<br>
So to sum it up, at runtime and later usage these are individual independent images.</p>
<p>That is also needed because in step 4, when the workspace or gateway images are booted for the first time, a script automatically installs the none duplicate deb packages as described above from  /var/apt/cache/apt/archives/ making image file gateway_usr.qcow2 and whonix_usr.qcow2 completely independent and different from each other.</p>
<p>The only things that are to keep in mind are:<br>
A. by cloning the common.qcow2 file the UUID of the disk image changes<br>
B. The virtual machine config file may require a change to the new UUID if it is UUID and not filename based.<br>
C. inside of workspace or gateway the /etc/fstab file must be changed according to the UUID. But this should be doable by the script that also installs the deb files when booting the first time.</p>
<p>Steps A and B should be doable by a script the user has to run after download.<br>
Step C can run automatically when the images are booted the first time.</p>
<aside class="quote no-group">
<blockquote>
<blockquote>
<p>And only a very small amount of Tor or Whonix specific software must go to opt.</p>
</blockquote>
<p>Development work, and new bugs.</p>
</blockquote>
</aside>
<p>Most open source software offer a way to provide a destination for the installation during the create makefile process.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/18">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/18</link>
        <pubDate>Wed, 03 Apr 2019 22:26:32 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-18</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Might be doable in theory, but…<br>
KVM only changes not compatible with VirtualBox changes are very, very unlikely to be contributed.<br>
A third shared image is very, very unlikely to materialize.<br>
A third shared image adds a lot complexity, increase the size of the code base, speak even fewer people would read and understood the source code.<br>
The available labor is very low.</p>
<p>Changing the code for image compression is realistic. But changing the build process for something that benefits KVM only, I am certainly not going to write that code.</p>
<aside class="quote no-group" data-post="15" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>A common vm image file just for /usr and the duplicates is definitely the best way to keep the download size low.</p>
</blockquote>
</aside>
<p>Common vm image also seems risky form a security point of view. Which VM would be authorized to make changes to it (update it)?</p>
<p>A shared image can make a lot of sense. Qubes OS TemplateVMs share their root image. Simplified:</p>
<ul>
<li>TemplateBasedVMs can write to root image (which is /usr and others) but these changes will not be shared with any other VMs and be lost after shutdown</li>
<li>TemplateVMs can write to the root image persistently</li>
<li>after TemplateVM shutdown and TemplateBasedVMs reboot the updated root file system is available to the TemplateBasedVMs</li>
<li>this allows huge savings in disk space and centralized updates, i.e. only the TemplateVM has to be updated and shut down then after reboot of the TemplateBasedVMs everything will be up to date.</li>
<li><a href="https://www.qubes-os.org/doc/template-implementation/" rel="nofollow noopener">https://www.qubes-os.org/doc/template-implementation/</a></li>
</ul>
<p>But I don’t see anyone reinventing that for Whonix KVM only.</p>
<aside class="quote no-group" data-post="15" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>And only a very small amount of Tor or Whonix specific software must go to opt.</p>
</blockquote>
</aside>
<p>Development work, and new bugs.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/17">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/17</link>
        <pubDate>Wed, 03 Apr 2019 20:55:05 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-17</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="http://forums.whonix.org/u/firefox">@Firefox</a> dang you really thought about this. It’s good to see a thought out proposal instead of the usual drive by user requests.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/16">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/16</link>
        <pubDate>Wed, 03 Apr 2019 19:51:54 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-16</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <p>I have an idea.<br>
Most of these none duplicate files in /usr are very likely just additional software from Debian packages which are required for the workstation but not for the gateway.<br>
And if they are simple Debian packages, then they are not Tor or Whonix specific.</p>
<p>And apt does download and store deb packages in /var/apt/cache/apt/archives/ before installing them.<br>
You could make the Workstation specific image in a way, that it already contains these deb files in /var/apt/cache/apt/archives/ but doesn’t have them installed on the system into /usr.<br>
By having them already in the workstation specific image, they don’t have to be downloaded via the slow Tor network.</p>
<p>And when the user boots up the workstation for the first time, a script could install these deb packages from this directory on the system automatically.</p>
<p>By doing so, you could have a common /usr vm image file as mentioned before in suggestion 1 without the need to have a lot of work.<br>
Because all the Debian packages will stay the same and unaltered.<br>
And only a very small amount of Tor or Whonix specific software must go to opt.<br>
Software like the Tor Browser or the Tor software itself.<br>
But usually you build the Whonix or Tor specific software anyway, so it’s only a change of the installation destination.</p>
<p>A common vm image file just for /usr and the duplicates is definitely the best way to keep the download size low.<br>
And the none duplicates as deb packages in /var… which can get installed by a script during first boot up.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/15">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/15</link>
        <pubDate>Wed, 03 Apr 2019 18:55:08 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-15</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="13" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>Strange is the number of duplicate files which is 75987.<br>
It seems to be higher than the number of files in each directory.<br>
I don’t know why?</p>
</blockquote>
</aside>
<p>Maybe these are symlinks which are ignored in the find command with the -type f option.<br>
In this the number 54722 should be the real number of files.</p>
<p>If we assume that it is that way then<br>
workstation/usr does have 73340-54722 = 18618 none duplicate files<br>
and<br>
gateway/user does have 67674-54722 =12952 none duplicate files.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/14">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/14</link>
        <pubDate>Wed, 03 Apr 2019 17:56:57 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-14</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <p>I did a little further testing.<br>
I created 3 directories</p>
<pre><code class="lang-auto">mkdir dupes
mkdir dupes/workstation
mkdir dupes/gateway</code></pre>
<p>and mounted the two qcow2 files read only with guestmount.</p>
<pre><code class="lang-auto">sudo guestmount -a Whonix-Workstation-XFCE-14.0.1.4.4.qcow2 -m /dev/sda1 --ro dupes/workstation/
sudo guestmount -a Whonix-Gateway-XFCE-14.0.1.4.4.qcow2 -m /dev/sda1 --ro dupes/gateway/                         </code></pre>
<p>After that i started as root fdupes to calculate how many files are duplicates and what are their uncompressed summarized size:</p>
<pre><code class="lang-auto">fdupes -r -m dupes/
86503 duplicate files (in 63077 sets), occupying 1890.7 megabytes</code></pre>
<p>The summarized size means, that this is the extra size the duplicates occupy and the size that can be avoided.</p>
<p>Or in other words as an example a test folder with two identical files with a size of around 7 MB each gives:</p>
<pre><code class="lang-auto"># ls -l test/
total 14072
-rw------- 1 root root 7188984 Apr  3 18:49 a.img
-rw------- 1 root root 7188984 Apr  3 18:49 b.img</code></pre>
<pre><code class="lang-auto">fdupes -r -m test/
1 duplicate files (in 1 sets), occupying 7.2 megabytes</code></pre>
<p>So we should keep this in mind, that fdupes shows the extra space that is occupied.<br>
The space that could be avoided.</p>
<p>The two whonix folders have a combined size of</p>
<pre><code class="lang-auto">du * -sm dupes
4327    dupes</code></pre>
<p>This means, from these 4327 MB 43.69 % is wasted space because of duplicates.<br>
And it could be 1890 MB smaller with a combined size of only 2438 MB.</p>
<p>The two cow2 files have btw. a size of:</p>
<pre><code class="lang-auto">2085    Whonix-Gateway-XFCE-14.0.1.4.4.qcow2
2536    Whonix-Workstation-XFCE-14.0.1.4.4.qcow2</code></pre>
<p>4621 MB</p>
<p>I also checked how much space could be saved if the directory /usr would be in its own partition in a common virtual machine image.<br>
And here the result was:</p>
<pre><code class="lang-auto">fdupes -r -m  gateway/usr workstation/usr
75987 duplicate files (in 54722 sets), occupying 1604.6 megabytes</code></pre>
<p>Total file size in gateway/usr and workstation/usr is:</p>
<pre><code class="lang-auto">du -sm  gateway/usr workstation/usr
1599    gateway/usr
1852    workstation/usr</code></pre>
<p>= 3451 MB<br>
Total file count in gateway/usr and workstation/usr is:</p>
<pre><code class="lang-auto">find gateway/usr/ -type  f | wc -l
67674</code></pre>
<p>and</p>
<pre><code class="lang-auto">find workstation/usr/ -type  f | wc -l
73340</code></pre>
<p>= 141014 files</p>
<p>Strange is the number of duplicate files which is 75987.<br>
It seems to be higher than the number of files in each directory.<br>
I don’t know why?<br>
141014 is also what is shown in the beginning when i started fdupes.<br>
Maybe the sets of 54722 are the real numbers?<br>
This would at least make more sense.</p>
<p>This also means, if you put the non duplicates to /opt this wouldn’t be a lot of files but you would save 1604 MB.<br>
The other 286 MB of 1890 MB of duplicates are probably in /lib, /bin and /boot<br>
/lib does have a size of 228 MB in the workstation image.<br>
/bin 11 MB<br>
/boot 30 MB<br>
But files that are in /lib are needed during boot time, the same applies to /bin and /boot so putting them somewhere else is not an option.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/13">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/13</link>
        <pubDate>Wed, 03 Apr 2019 17:41:38 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-13</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Firefox]]></dc:creator>
        <description><![CDATA[
            <p>Okay, it seems to be, that the compression can’t find the duplicates even when raw image files are used.</p>
<p>I also did some tests, converted the two cow2 files to raw, put them in an archive with tar and compressed them again with xz.<br>
My result was the following:</p>
<pre><code class="lang-auto">1099884060 Whonix-XFCE-14.0.1.4.4.libvirt.xz
1137252192 whonix_raw.tar.xz</code></pre>
<p>So it’s even bigger and without the xml files.<br>
I wonder if other compression preset levels or different chunk sizes might help, according to the xz manpage default compression preset level is 6.</p>
<p>I also did a little research about virtual images and deduplication.<br>
You might take a look into these papers:</p>
<p></p><aside class="onebox pdf">
  <header class="source">
      <a href="https://www.ssrc.ucsc.edu/papers/jin-systor09.pdf" target="_blank" rel="nofollow noopener">ssrc.ucsc.edu</a>
  </header>
  <article class="onebox-body">
    <a href="https://www.ssrc.ucsc.edu/papers/jin-systor09.pdf" target="_blank" rel="nofollow noopener"><span class="pdf-onebox-logo"></span></a>
<h3><a href="https://www.ssrc.ucsc.edu/papers/jin-systor09.pdf" target="_blank" rel="nofollow noopener">jin-systor09.pdf</a></h3>

<p class="filesize">343.59 KB</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox pdf">
  <header class="source">
      <a href="https://www.systor.org/2009/papers/2_1_2.pdf" target="_blank" rel="nofollow noopener">systor.org</a>
  </header>
  <article class="onebox-body">
    <a href="https://www.systor.org/2009/papers/2_1_2.pdf" target="_blank" rel="nofollow noopener"><span class="pdf-onebox-logo"></span></a>
<h3><a href="https://www.systor.org/2009/papers/2_1_2.pdf" target="_blank" rel="nofollow noopener">2_1_2.pdf</a></h3>

<p class="filesize">1405.23 KB</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox pdf">
  <header class="source">
      <a href="https://www.usenix.org/system/files/conference/hotstorage13/hotstorage13-smaldone.pdf" target="_blank" rel="nofollow noopener">usenix.org</a>
  </header>
  <article class="onebox-body">
    <a href="https://www.usenix.org/system/files/conference/hotstorage13/hotstorage13-smaldone.pdf" target="_blank" rel="nofollow noopener"><span class="pdf-onebox-logo"></span></a>
<h3><a href="https://www.usenix.org/system/files/conference/hotstorage13/hotstorage13-smaldone.pdf" target="_blank" rel="nofollow noopener">hotstorage13-smaldone.pdf</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<p></p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/12">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/12</link>
        <pubDate>Wed, 03 Apr 2019 16:02:55 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-12</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
      <item>
        <title>improving compression of Whonix image downloads</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>I am very sure. I did not have a workstation qcow2 image before that. (HulaHoop builds and uploads them.) To double check just now scrolled up.</p>
<pre><code>sudo --non-interactive -u user tar --create --verbose --owner=0 --group=0 --numeric-owner --mode=go=rX,u+rw,a-s --sort=name --sparse '--mtime=2015-10-21 00:00Z' --xz --directory=/home/user/whonix_binary --file Whonix-XFCE-14.0.1.4.4.libvirt.xz WHONIX_BINARY_LICENSE_AGREEMENT Whonix-Gateway-XFCE-14.0.1.4.4.raw Whonix-Workstation-XFCE-14.0.1.4.4.raw Whonix-Gateway-XFCE-14.0.1.4.4.xml Whonix-Workstation-XFCE-14.0.1.4.4.xml Whonix_external_network-14.0.1.4.4.xml Whonix_internal_network-14.0.1.4.4.xml
tar: Option --mtime: Treating date '2015-10-21 00:00Z' as 2015-10-21 00:00:00
WHONIX_BINARY_LICENSE_AGREEMENT
Whonix-Gateway-XFCE-14.0.1.4.4.raw
Whonix-Workstation-XFCE-14.0.1.4.4.raw
Whonix-Gateway-XFCE-14.0.1.4.4.xml
Whonix-Workstation-XFCE-14.0.1.4.4.xml
Whonix_external_network-14.0.1.4.4.xml
Whonix_internal_network-14.0.1.4.4.xml
</code></pre>
<aside class="quote no-group" data-post="10" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>If it can find the duplicates the compression should be much better than these 1.1 GB.</p>
</blockquote>
</aside>
<p>Perhaps it is because the raw images are itself sparse files?</p>
<pre><code>du -sh Whonix-Gateway-XFCE-14.0.1.4.4.raw
3.5G    Whonix-Gateway-XFCE-14.0.1.4.4.raw
user@host:~/whonix_binary$ du -sh --apparent-size Whonix-Gateway-XFCE-14.0.1.4.4.raw
100G    Whonix-Gateway-XFCE-14.0.1.4.4.raw
</code></pre>
<p>And they were also treated with <code>zerofree</code> beforehand.</p>
          <p><a href="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/11">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086/11</link>
        <pubDate>Wed, 03 Apr 2019 12:40:14 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-7086-11</guid>
        <source url="http://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086.rss">improving compression of Whonix image downloads</source>
      </item>
  </channel>
</rss>
