<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>improving compression of Whonix image downloads - Development - Whonix Forum</title>
    <meta name="description" content="You should use another  data compression archive file format which supports deduplication.  whonix-gateway and whonix-workstation share a big amount of the same binary files.  Especially the ones in /usr  The differences are only small and in /etc  Last weekend i did the following test.  I unpacked your big Whonix-XFCE-14.0.1.4.4.libvirt.xz archive file.  This file has a compressed size of 1099884060  Bytes, around 1100 MB.  Then i packed the two files  Whonix-Gateway-XFCE-14.0.1.4.4.qcow2  and  ...">
    <meta name="generator" content="Discourse 2.8.9 - https://github.com/discourse/discourse version 1503ec07c57898a507395552b765b6808b4e1db9">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/37fe81e592143b0c01c9656c44069b4bfdd3990e_2_32x32.ico">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/2/222b7257d0600f2bc69cf77e6bc273aa0074ed4e_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="7086.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forums.whonix.org","potentialAction":{"@type":"SearchAction","target":"https://forums.whonix.org/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="Whonix Forum Search">

      <link href="../../stylesheets/desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5.css_%3b%20filename_%3dUTF-8%27%27desktop_eaead85939ea2f99650f56b40c8681f4e1cb68d5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop"  />
      <link href="../../stylesheets/desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6c.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_3_f7af26cfd21c1d79bdb82342526b638dccef9d6cd2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="3" data-theme-name="header"/>
<link href="../../stylesheets/desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_4_56ca71d15f2048e2e474553f0c3928756f57aec5d2c8.css?__ws=forums.whonix.org" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="4" data-theme-name="default"/>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/">HOME</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Download">DOWNLOAD</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Documentation">DOCS</a>]
[<a href="../../c/news/21.html">NEWS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Support">SUPPORT</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Forum_Best_Practices">TIPS</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker">ISSUES</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contribute">CONTRIBUTE</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Donate">DONATE</a>]
</center>
    
        <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;improving compression of Whonix image downloads&#39;" href="7086.rss" />
    <meta property="og:site_name" content="Whonix Forum" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://forums.whonix.org/uploads/default/original/2X/a/ac61071d4245560068a380cd1c08c97d1da2201d.jpeg" />
<meta property="og:image" content="https://forums.whonix.org/uploads/default/original/2X/5/5ac973ff4302e69269667e09e67d850c0b628c7a.jpeg" />
<meta property="og:url" content="https://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086" />
<meta name="twitter:url" content="https://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086" />
<meta property="og:title" content="improving compression of Whonix image downloads" />
<meta name="twitter:title" content="improving compression of Whonix image downloads" />
<meta property="og:description" content="You should use another  data compression archive file format which supports deduplication.  whonix-gateway and whonix-workstation share a big amount of the same binary files.  Especially the ones in /usr  The differences are only small and in /etc  Last weekend i did the following test.  I unpacked your big Whonix-XFCE-14.0.1.4.4.libvirt.xz archive file.  This file has a compressed size of 1099884060  Bytes, around 1100 MB.  Then i packed the two files  Whonix-Gateway-XFCE-14.0.1.4.4.qcow2  and  ..." />
<meta name="twitter:description" content="You should use another  data compression archive file format which supports deduplication.  whonix-gateway and whonix-workstation share a big amount of the same binary files.  Especially the ones in /usr  The differences are only small and in /etc  Last weekend i did the following test.  I unpacked your big Whonix-XFCE-14.0.1.4.4.libvirt.xz archive file.  This file has a compressed size of 1099884060  Bytes, around 1100 MB.  Then i packed the two files  Whonix-Gateway-XFCE-14.0.1.4.4.qcow2  and  ..." />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="16 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="32 ❤" />
<meta property="article:published_time" content="2019-04-01T18:37:24+00:00" />
<meta property="og:ignore_canonical" content="true" />

        <link rel="next" href="70864658.html?page=2">

    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png" alt="Whonix Forum" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
        <div id="topic-title">
    <h1>
      <a href="7086.html">improving compression of Whonix image downloads</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/development/8.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  


      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-01T18:37:24Z' class='post-time'>
                April 1, 2019,  6:37pm
              </time>
              <meta itemprop='dateModified' content='2019-04-01T18:37:24Z'>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>You should use another  data compression archive file format which supports deduplication.</p>
<p>whonix-gateway and whonix-workstation share a big amount of the same binary files.<br>
Especially the ones in /usr<br>
The differences are only small and in /etc</p>
<p>Last weekend i did the following test.<br>
I unpacked your big Whonix-XFCE-14.0.1.4.4.libvirt.xz archive file.<br>
This file has a compressed size of 1099884060  Bytes, around 1100 MB.</p>
<p>Then i packed the two files<br>
Whonix-Gateway-XFCE-14.0.1.4.4.qcow2<br>
and<br>
Whonix-Workstation-XFCE-14.0.1.4.4.qcow2<br>
individually.<br>
I ignored the xml files, they have such a small size that they are not important for this comparison.</p>
<p>I used the following commands:</p>
<pre><code class="lang-auto">tar -cvf workstation.tar Whonix-Workstation-XFCE-14.0.1.4.4.qcow2 
xz -z workstation.tar 
tar -cvf gateway.tar Whonix-Gateway-XFCE-14.0.1.4.4.qcow2
xz -z gateway.tar </code></pre>
<p>This resulted in the following two files:</p>
<pre><code class="lang-auto">-rw-rw-r-- 1 XXXXXXXX XXXXXXXXX 498373356 Mar 30 02:37 gateway.tar.xz
-rw-rw-r-- 1 XXXXXXXX XXXXXXXXX 638927196 Mar 30 01:43 workstation.tar.xz</code></pre>
<p>If you do the calculation you get the following:<br>
498373356+638927196 = 1137300552 Bytes<br>
compared to the 1099884060  Bytes before with all the additional *.xml stuff.</p>
<p>This shows, that the compression isn’t good.<br>
As i said before, the two *.qcow2 files have a lot in common.<br>
If you mount them, you can see that their directories are nearly identical.<br>
Both use Debian, so both use the same program and library files.<br>
Only the configuration might differ plus a small amount of additional software only available on gateway or workstation.</p>
<p>This means, if you use a compression format, that can find these file duplications you can save around 500 MB.</p>
<p>You could try to use a raw image file instead of qcow2, this might allow the compression software to find the duplicates easier on a byte level.</p>
<p>Or you could build up the two images with a script on the users side with just one big file. There are plenty of possibilities.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>
          <meta itemprop='keywords' content=''>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

            <div class='crawler-linkback-list' itemscope itemtype='../../../external.html?link=http://schema.org/ItemList'>
                  <div itemprop='itemListElement' itemscope itemtype='../../../external.html?link=http://schema.org/ListItem'>
                    <a href="../whonix-kvm-14-0-1-4-4-unified-tar-gz-download-point-release/7061/4.html" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
                      <meta itemprop='url' content='../whonix-kvm-14-0-1-4-4-unified-tar-gz-download-point-release/7061/4.html'>
                      <span itemprop='name'>Whonix KVM 14.0.1.4.4 - Unified tar.gz Download - Point Release</span>
                    </a>
                    <meta itemprop='position' content='1'>
                  </div>
            </div>
      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-02T06:50:59Z' class='post-time'>
                April 2, 2019,  6:50am
              </time>
              <meta itemprop='dateModified' content='2019-04-02T06:50:59Z'>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Deduplication would be very much welcome to save upload time (over Tor) and download traffic and user download time.</p>
<ul>
<li>The input files (qcow2 images) are not yet deterministic/reproducible. Hopefully at some point in future as Debian reproducible builds project progresses.</li>
<li>Nevertheless the output (the compressed archive) should be deterministic/reproducible. (I.e. same images with same compression command should end up with a byte for byte identical archive.)</li>
<li>qcow2 images are <a href="../../../external.html?link=https://www.whonix.org/wiki/Sparse_files" rel="nofollow noopener">sparse files</a>.</li>
<li><a href="../../../external.html?link=https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=535987" rel="nofollow noopener">Not using <code>gzip</code>, because it cannot handle sparse files.</a></li>
<li>Previous related discussion <a href="../../../external.html?link=https://phabricator.whonix.org/T605" rel="nofollow noopener">speed up libvirt tarball creation time</a> which might contain suggestions.
<ul>
<li>Compression time may not be priority anymore since KVM builds are nowadays done by KVM maintainer <a class="mention" href="../../../external.html?link=https://forums.whonix.org/u/hulahoop">@HulaHoop</a>.</li>
</ul>
</li>
<li>The related source code is <a href="../../../external.html?link=https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release#L26-L90" rel="nofollow noopener">here</a>.</li>
<li><code>help-steps/variables</code></li>
</ul>
<p>contains:</p>
<pre><code>[ -n "$XZ_OPT" ] || XZ_OPT="--threads=8"
export XZ_OPT
</code></pre>
<p><a href="../../../external.html?link=https://www.whonix.org/wiki/FAQ#Patches_are_Welcome" rel="nofollow noopener">Patches are welcome.</a></p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T09:45:30Z' class='post-time'>
                April 3, 2019,  9:45am
              </time>
              <meta itemprop='dateModified' content='2019-04-03T10:11:52Z'>
          <span itemprop='position'>#3</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I have some suggestions.</p>
<h1>Suggestion 1:</h1>
<p>Make it so that /usr is in its own partition and qcow2 file and put all the Gateway or Workstation specific things, that are not common to /opt in their own qcow2 images.</p>
<p>This will lead to 3 qcow2 files.<br>
gateway.qcow2<br>
workstation.qcow2<br>
and<br>
base_or_common.qcow2</p>
<p>It is not perfect, because /lib and the kernel in /boot are still in gateway.qcow2 or workstation.qcow2 but the big junk of data of around 400-500 MB resides in a common qcow2 file which can be cloned after downloading with</p>
<pre><code class="lang-auto">virt-clone  base_or_common.qcow2 gateway_base.qcow2
mv base_or_common.qcow2 workstation_base.qcow2</code></pre>
<p>This way, you will make the download 400-500 MB smaller.</p>
<p>When starting the virtual machine the user only needs to add two qcow2 images to the VM.</p>
<p>For gateway VM:<br>
gateway.qcow2 and  gateway_base.qcow2</p>
<p>and for workstation VM:<br>
workstation.qcow2 and workstation_base.qcow2</p>
<p>On the positive side this solution will work and is still easy enough for the typical user.<br>
If you make it a little more easier just provide a script that does the cloning and renaming thing.</p>
<p>For compiling workstation or gateway specific stuff most open source software that use autoconfigure ./configure scripts the option “–prefix=/opt” can be applied.<br>
This will make sure, that the software will be installed to /opt and not to /usr.<br>
For example you might compile tor browser and install it to /opt then, if firefox does use autoconfigure, then you can compile it with the following command</p>
<pre><code class="lang-auto">./configure --prefix=/opt
make
make install # this can be replaced by the thing you do when creating a deb package</code></pre>
<h1>Suggestion 2:</h1>
<p>Another alternative to the above suggestion is to make it so, that the system files<br>
are stored in a raw image file with a max size of around 10 GB instead of the 100 GB it is now.<br>
And only the partition for the /home directory in qcow2 sparse files.<br>
Usually you don’t need 100 GB big partitions just for system files.<br>
On Linux the big partitions are usually only needed for /home.</p>
<p>By using smaller raw image files instead of qcow2 image files the compression software might achieve a better compression with duplicates.</p>
<p>In this case you will have to pack 4 virtual machine image files.<br>
gateway_home.qcow2<br>
workstation_home.qcow2<br>
gateway_system.raw<br>
workstation_system.raw</p>
<p>into one whonix.tar.xz archive.</p>
<p>Because gateway_system.raw and workstation_system.raw are in a raw image format, the compression software might be able to compress the duplicates much better.<br>
At least that’s what i assume, but this have to be tested.<br>
And this also will keep the image files on the computer of the user small, because system image partitions do not grow as big as /home image partitions.<br>
For the latter you have qcow2 which can grow as needed.</p>
<p>The first suggestion will definitely work, the second might work too but need some tests to run.</p>
<h1>EDIT:<br>
Suggestion 3:</h1>
<p>Maybe it’s also possible to work with some sort of sophisticated diff and merge utility.<br>
That will diff out the common data of the two qcow2 files and later merge them back to the qcow2 files.<br>
But i don’t know if such sophisticated diff and merge utilities do exist.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T10:18:24Z' class='post-time'>
                April 3, 2019, 10:18am
              </time>
              <meta itemprop='dateModified' content='2019-04-03T10:18:24Z'>
          <span itemprop='position'>#4</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="3" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<h1>Suggestion 1:</h1>
<p>Make it so that /usr is in its own partition and qcow2 file and put all the Gateway or Workstation specific things, that are not common to /opt in their own qcow2 images.</p>
</blockquote>
</aside>
<p>A ton of development work. Incompatible with current way the images are build (base image + installation of Whonix packages). Would require to totally re-organize all packages. A lot software (like Tor Browser) supposed to be installed on the workstation would be installed on the gateway then too. Or somehow move it at first boot in the right place. Most unrealistic.</p>
<aside class="quote no-group" data-post="3" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>are stored in a raw image file with a max size of around 10 GB instead of the 100 GB it is now.</p>
</blockquote>
</aside>
<p>I don’t think 10 GB vs 100 GB makes any difference. Sparse files aren’t an issue during compression. Could even be 1000 GB without making any difference.</p>
<aside class="quote no-group" data-post="3" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>By using smaller raw image files instead of qcow2 image files the compression software might achieve a better compression with duplicates.</p>
</blockquote>
</aside>
<p>I would really wonder if that is the case. Unused space is just a description, not actually initialized data.</p>
<aside class="quote no-group" data-post="3" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>Suggestion 3:</p>
</blockquote>
</aside>
<p>Ideally the complexity of an installer script just for that very purpose can be avoided.</p>
<p>Ideally, we’d just find the proper compression tool and command line.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T11:01:39Z' class='post-time'>
                April 3, 2019, 11:01am
              </time>
              <meta itemprop='dateModified' content='2019-04-03T11:12:27Z'>
          <span itemprop='position'>#5</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="4" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>A ton of development work. Incompatible with current way the images are build (base image + installation of Whonix packages). Would require to totally re-organize all packages. A lot software (like Tor Browser) supposed to be installed on the workstation would be installed on the gateway then too. Or somehow move it at first boot in the right place. Most unrealistic.</p>
</blockquote>
</aside>
<p>Okay, i didn’t take a look at how much work it really is.<br>
I just assumed that whonix is basically debian + edited config files which are usually in /etc not in /usr and some additional tor related software.</p>
<p>The Tor browser won’t be installed on the gateway, because Tor browser is installed to /opt, not to /usr<br>
And /opt is in the specific workstation image, the same applies for the config files in /etc and /var.</p>
<p>Workstation or Gateway specific image contains:<br>
/home<br>
/etc<br>
/boot<br>
/var<br>
/opt  # Tor software<br>
/lib<br>
/lib64<br>
/dev<br>
…</p>
<p>Specific means that /etc gateway and /etc workstation is not the same. That also applies to /opt and the rest.</p>
<p>common image contains:<br>
/usr # command line tools, c++ libs, maybe Xorg and XFCE if you also want have that in gateway</p>
<p>The good thing about the File Hierarchy Standard of Unix or Linux is, that config files are usually not in /usr<br>
This makes it possible to even mount /usr only readable or put it somewhere as a network share.<br>
<a href="../../../external.html?link=http://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.html" class="onebox" target="_blank" rel="nofollow noopener">http://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.html</a></p>
<p>Thus the amount of work really depends basically on how many different binaries of the same software do you have in /usr.<br>
And i doubt that this is a lot, if most of the debian files in /usr stay untouched.</p>
<aside class="quote no-group">
<blockquote>
<p>I don’t think 10 GB vs 100 GB makes any difference. Sparse files aren’t an issue during compression. Could even be 1000 GB without making any difference.<br>
…<br>
I would really wonder if that is the case. Unused space is just a description, not actually initialized data.</p>
</blockquote>
</aside>
<p>Well, the problem are the duplicate files.<br>
And if you pack meta data of the file system with a binary file and compress it by using qcow2 spares files, which does compression by itself, then you will always have a lot differences in your two qcow2 files which makes it very difficult to find duplicates for the compression software.</p>
<p>If you do not compress the image file by using raw images the meta data of the file system and the binaries laying inside of it are still independent.<br>
This should allow a better compression in the end.</p>
<p>Let’s say you have a file in /usr called foolib.so in gateway and workstation.<br>
if you put it in a raw image file, the byte sequence will be the same in gateway and workstation.<br>
If you put it in a sparse file, the way how sparse file work will compress it with the metadata.<br>
foolib.so + filesystem metadata like date 12/01/2019 = compressed byte sequence A<br>
foolib.so + filesystem metadata like date 13/01/2019 = compressed byte sequence B</p>
<p>If you would hash A and B it will result into hash A’ and B’ and they will differ a lot.<br>
How should xv or gzip compress A and B in a good way, if they differ so much?</p>
<p>Thus the solution is to not compress the image files for the Virtual image and only compress the archive for download.</p>
<p>The reason to put the system data into their own image file is, because the user doesn’t want to store a 100 GB bug raw image file if he doesn’t use all of that space inside whonix.<br>
Thus you need a growable image file just for /home.<br>
But the system files can be put inside a raw image file for better compression because of the duplicates.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T11:19:29Z' class='post-time'>
                April 3, 2019, 11:19am
              </time>
              <meta itemprop='dateModified' content='2019-04-03T11:19:29Z'>
          <span itemprop='position'>#6</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I understand if the files are compressed individually, then a lot less duplication can be found and compressed during archive creation. However, I hope it’s not what’s happening here.</p>
<aside class="quote no-group" data-post="5" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>And if you pack meta data of the file system with a binary file and compress it by using qcow2 spares files, which does compression by itself, then you will always have a lot differences in your two qcow2 files which makes it very difficult to find duplicates for the compression software.</p>
</blockquote>
</aside>
<p>That’s interesting.</p>
<p><a href="../../../external.html?link=https://github.com/Whonix/Whonix/blob/master/build-steps.d/2400_convert-raw-to-qcow2#L38" rel="nofollow noopener">We use the following to convert from raw to qcow2 during the build process.</a></p>
<blockquote>
<pre><code>  qemu-img \
     convert \
        -p \
        -O qcow2 \
        -S "$VMSIZE" \
        -o cluster_size=2M \
        -o preallocation=metadata \
        "$binary_image_raw" \
</code></pre>
<p>“$binary_image_qcow2”</p>
</blockquote>
<p>We are not using <code>qemu-img</code> with <code>-c</code> option for compression. Quote <a href="../../../external.html?link=https://manpages.debian.org/stretch/qemu-utils/qemu-img.1.en.html" rel="nofollow noopener">qemu-img man page</a>.</p>
<blockquote>
<p>It can be optionally compressed ("-c" option)</p>
</blockquote>
<p>I guess we douldn’t want to use compression at image level anyhow since that would be lower performance. On the contrary, long time ago <code>-o preallocation=metadata</code> was introduced for better performance.</p>
<p>Do you mean that our use of <code>-o preallocation=metadata</code> adds compressino even though we are not using <code>-c</code>?</p>
<aside class="quote no-group" data-post="5" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>If you put it in a sparse file, the way how sparse file work will compress it with the metadata.</p>
</blockquote>
</aside>
<p>Quote <a href="../../../external.html?link=https://manpages.debian.org/stretch/qemu-utils/qemu-img.1.en.html" rel="nofollow noopener">qemu-img man page</a>.</p>
<blockquote>
<p><em>sparse_size</em> indicates the consecutive number of bytes (defaults to 4k) that must contain only zeros for qemu-img to create a sparse image during conversion. If <em>sparse_size</em> is 0, the source will not be scanned for unallocated or zero sectors, and the destination image will always be fully allocated.</p>
</blockquote>
<p>And also <a href="../../../external.html?link=https://en.wikipedia.org/wiki/Sparse_file" rel="nofollow noopener">wikipedia</a> does not indicate that sparse files are related to compression.</p>
<p>Things to be tested:</p>
<ul>
<li>compress the raw images to an archive instead and see if that results in a smaller image size</li>
<li>drop sparse files <code>-S</code>, see if that helps</li>
<li>drop also <code>-o cluster_size=2M</code> and <code>-o preallocation=metadata</code>, see if that helps</li>
</ul>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T11:28:12Z' class='post-time'>
                April 3, 2019, 11:28am
              </time>
              <meta itemprop='dateModified' content='2019-04-03T11:28:12Z'>
          <span itemprop='position'>#7</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <blockquote>
<p>sudo --non-interactive -u user qemu-img convert -p -O qcow2 -S 100G -o cluster_size=2M -o preallocation=metadata /home/user/whonix_binary/Whonix-Gateway-XFCE-14.0.1.4.4.raw /home/user/whonix_binary/Whonix-Gateway-XFCE-14.0.1.4.4.qcow2</p>
</blockquote>
<p>That command finished quite fast. 2:20 minutes. Doesn’t indicate compression.</p>
<p>Let’s look at the file sizes.</p>
<pre><code>du -hs /home/user/whonix_binary/Whonix-Gateway-XFCE-14.0.1.4.4.raw
</code></pre>
<blockquote>
<p><code>3.5G /home/user/whonix_binary/Whonix-Gateway-XFCE-14.0.1.4.4.raw</code></p>
</blockquote>
<pre><code>du -hs /home/user/whonix_binary/Whonix-Gateway-XFCE-14.0.1.4.4.qcow2 
</code></pre>
<blockquote>
<p><code>2.4G /home/user/whonix_binary/Whonix-Gateway-XFCE-14.0.1.4.4.qcow2</code></p>
</blockquote>
<p>Alright, 1.1G less might be due to compression.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T12:08:08Z' class='post-time'>
                April 3, 2019, 12:08pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T12:08:08Z'>
          <span itemprop='position'>#8</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="6" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>drop sparse files <code>-S</code> , see if that helps</p>
</blockquote>
</aside>
<p>Doesn’t help.</p>
<aside class="quote no-group" data-post="6" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>drop also <code>-o cluster_size=2M</code> and <code>-o preallocation=metadata</code> , see if that helps</p>
</blockquote>
</aside>
<p>Also doesn’t help.</p>
<hr>
<aside class="quote no-group" data-post="6" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>compress the raw images to an archive instead and see if that results in a smaller image size</p>
</blockquote>
</aside>
<p>That indeed minimized image sizes. Took 30 minutes. Compressed <strong>raw</strong> rather than qcow2 images:</p>
<pre><code>du -sh Whonix-XFCE-14.0.1.4.4.libvirt.xz
</code></pre>
<blockquote>
<p><code>1.1G Whonix-XFCE-14.0.1.4.4.libvirt.xz</code></p>
</blockquote>
<p>Even smaller than Whonix ova (VirtualBox) (which contains compressed (by VirtualBox default) vmdk images).</p>
<pre><code>du -sh Whonix-XFCE-14.0.1.4.4.ova
</code></pre>
<blockquote>
<p><code>1.6G Whonix-XFCE-14.0.1.4.4.ova</code></p>
</blockquote>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T12:22:50Z' class='post-time'>
                April 3, 2019, 12:22pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T12:22:50Z'>
          <span itemprop='position'>#9</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="6" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Do you mean that our use of <code>-o preallocation=metadata</code> adds compressino even though we are not using <code>-c</code> ?</p>
</blockquote>
</aside>
<p>I think the -c option is only related to the qcow version 1 format, not qcow2.<br>
The man page states:</p>
<aside class="quote no-group">
<blockquote>
<p>-c<br>
indicates that target image must be compressed (qcow format only)</p>
</blockquote>
</aside>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T12:25:40Z' class='post-time'>
                April 3, 2019, 12:25pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T12:25:40Z'>
          <span itemprop='position'>#10</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group quote-modified" data-post="8" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>That indeed minimized image sizes. Took 30 minutes. Compressed <strong>raw</strong> rather than qcow2 images:</p>
<pre><code class="lang-auto">du -sh Whonix-XFCE-14.0.1.4.4.libvirt.xz
</code></pre>
<blockquote>
<p><code>1.1G Whonix-XFCE-14.0.1.4.4.libvirt.xz</code></p>
</blockquote>
</blockquote>
</aside>
<p>Is this really based on the two raw image files?<br>
1.1 G look a little big to me and not smaller than the initial archive with the two qcow2 images.<br>
If it can find the duplicates the compression should be much better than these 1.1 GB.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T12:40:14Z' class='post-time'>
                April 3, 2019, 12:40pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T12:40:14Z'>
          <span itemprop='position'>#11</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I am very sure. I did not have a workstation qcow2 image before that. (HulaHoop builds and uploads them.) To double check just now scrolled up.</p>
<pre><code>sudo --non-interactive -u user tar --create --verbose --owner=0 --group=0 --numeric-owner --mode=go=rX,u+rw,a-s --sort=name --sparse '--mtime=2015-10-21 00:00Z' --xz --directory=/home/user/whonix_binary --file Whonix-XFCE-14.0.1.4.4.libvirt.xz WHONIX_BINARY_LICENSE_AGREEMENT Whonix-Gateway-XFCE-14.0.1.4.4.raw Whonix-Workstation-XFCE-14.0.1.4.4.raw Whonix-Gateway-XFCE-14.0.1.4.4.xml Whonix-Workstation-XFCE-14.0.1.4.4.xml Whonix_external_network-14.0.1.4.4.xml Whonix_internal_network-14.0.1.4.4.xml
tar: Option --mtime: Treating date '2015-10-21 00:00Z' as 2015-10-21 00:00:00
WHONIX_BINARY_LICENSE_AGREEMENT
Whonix-Gateway-XFCE-14.0.1.4.4.raw
Whonix-Workstation-XFCE-14.0.1.4.4.raw
Whonix-Gateway-XFCE-14.0.1.4.4.xml
Whonix-Workstation-XFCE-14.0.1.4.4.xml
Whonix_external_network-14.0.1.4.4.xml
Whonix_internal_network-14.0.1.4.4.xml
</code></pre>
<aside class="quote no-group" data-post="10" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>If it can find the duplicates the compression should be much better than these 1.1 GB.</p>
</blockquote>
</aside>
<p>Perhaps it is because the raw images are itself sparse files?</p>
<pre><code>du -sh Whonix-Gateway-XFCE-14.0.1.4.4.raw
3.5G    Whonix-Gateway-XFCE-14.0.1.4.4.raw
user@host:~/whonix_binary$ du -sh --apparent-size Whonix-Gateway-XFCE-14.0.1.4.4.raw
100G    Whonix-Gateway-XFCE-14.0.1.4.4.raw
</code></pre>
<p>And they were also treated with <code>zerofree</code> beforehand.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T16:02:55Z' class='post-time'>
                April 3, 2019,  4:02pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T16:02:55Z'>
          <span itemprop='position'>#12</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Okay, it seems to be, that the compression can’t find the duplicates even when raw image files are used.</p>
<p>I also did some tests, converted the two cow2 files to raw, put them in an archive with tar and compressed them again with xz.<br>
My result was the following:</p>
<pre><code class="lang-auto">1099884060 Whonix-XFCE-14.0.1.4.4.libvirt.xz
1137252192 whonix_raw.tar.xz</code></pre>
<p>So it’s even bigger and without the xml files.<br>
I wonder if other compression preset levels or different chunk sizes might help, according to the xz manpage default compression preset level is 6.</p>
<p>I also did a little research about virtual images and deduplication.<br>
You might take a look into these papers:</p>
<p><aside class="onebox pdf">
  <header class="source">
      <a href="../../../external.html?link=https://www.ssrc.ucsc.edu/papers/jin-systor09.pdf" target="_blank" rel="nofollow noopener">ssrc.ucsc.edu</a>
  </header>
  <article class="onebox-body">
    <a href="../../../external.html?link=https://www.ssrc.ucsc.edu/papers/jin-systor09.pdf" target="_blank" rel="nofollow noopener"><span class="pdf-onebox-logo"></span></a>
<h3><a href="../../../external.html?link=https://www.ssrc.ucsc.edu/papers/jin-systor09.pdf" target="_blank" rel="nofollow noopener">jin-systor09.pdf</a></h3>

<p class="filesize">343.59 KB</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox pdf">
  <header class="source">
      <a href="../../../external.html?link=https://www.systor.org/2009/papers/2_1_2.pdf" target="_blank" rel="nofollow noopener">systor.org</a>
  </header>
  <article class="onebox-body">
    <a href="../../../external.html?link=https://www.systor.org/2009/papers/2_1_2.pdf" target="_blank" rel="nofollow noopener"><span class="pdf-onebox-logo"></span></a>
<h3><a href="../../../external.html?link=https://www.systor.org/2009/papers/2_1_2.pdf" target="_blank" rel="nofollow noopener">2_1_2.pdf</a></h3>

<p class="filesize">1405.23 KB</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox pdf">
  <header class="source">
      <a href="../../../external.html?link=https://www.usenix.org/system/files/conference/hotstorage13/hotstorage13-smaldone.pdf" target="_blank" rel="nofollow noopener">usenix.org</a>
  </header>
  <article class="onebox-body">
    <a href="../../../external.html?link=https://www.usenix.org/system/files/conference/hotstorage13/hotstorage13-smaldone.pdf" target="_blank" rel="nofollow noopener"><span class="pdf-onebox-logo"></span></a>
<h3><a href="../../../external.html?link=https://www.usenix.org/system/files/conference/hotstorage13/hotstorage13-smaldone.pdf" target="_blank" rel="nofollow noopener">hotstorage13-smaldone.pdf</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="3" />
           <span class='post-likes'>3 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T17:41:38Z' class='post-time'>
                April 3, 2019,  5:41pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T17:41:38Z'>
          <span itemprop='position'>#13</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I did a little further testing.<br>
I created 3 directories</p>
<pre><code class="lang-auto">mkdir dupes
mkdir dupes/workstation
mkdir dupes/gateway</code></pre>
<p>and mounted the two qcow2 files read only with guestmount.</p>
<pre><code class="lang-auto">sudo guestmount -a Whonix-Workstation-XFCE-14.0.1.4.4.qcow2 -m /dev/sda1 --ro dupes/workstation/
sudo guestmount -a Whonix-Gateway-XFCE-14.0.1.4.4.qcow2 -m /dev/sda1 --ro dupes/gateway/                         </code></pre>
<p>After that i started as root fdupes to calculate how many files are duplicates and what are their uncompressed summarized size:</p>
<pre><code class="lang-auto">fdupes -r -m dupes/
86503 duplicate files (in 63077 sets), occupying 1890.7 megabytes</code></pre>
<p>The summarized size means, that this is the extra size the duplicates occupy and the size that can be avoided.</p>
<p>Or in other words as an example a test folder with two identical files with a size of around 7 MB each gives:</p>
<pre><code class="lang-auto"># ls -l test/
total 14072
-rw------- 1 root root 7188984 Apr  3 18:49 a.img
-rw------- 1 root root 7188984 Apr  3 18:49 b.img</code></pre>
<pre><code class="lang-auto">fdupes -r -m test/
1 duplicate files (in 1 sets), occupying 7.2 megabytes</code></pre>
<p>So we should keep this in mind, that fdupes shows the extra space that is occupied.<br>
The space that could be avoided.</p>
<p>The two whonix folders have a combined size of</p>
<pre><code class="lang-auto">du * -sm dupes
4327    dupes</code></pre>
<p>This means, from these 4327 MB 43.69 % is wasted space because of duplicates.<br>
And it could be 1890 MB smaller with a combined size of only 2438 MB.</p>
<p>The two cow2 files have btw. a size of:</p>
<pre><code class="lang-auto">2085    Whonix-Gateway-XFCE-14.0.1.4.4.qcow2
2536    Whonix-Workstation-XFCE-14.0.1.4.4.qcow2</code></pre>
<p>4621 MB</p>
<p>I also checked how much space could be saved if the directory /usr would be in its own partition in a common virtual machine image.<br>
And here the result was:</p>
<pre><code class="lang-auto">fdupes -r -m  gateway/usr workstation/usr
75987 duplicate files (in 54722 sets), occupying 1604.6 megabytes</code></pre>
<p>Total file size in gateway/usr and workstation/usr is:</p>
<pre><code class="lang-auto">du -sm  gateway/usr workstation/usr
1599    gateway/usr
1852    workstation/usr</code></pre>
<p>= 3451 MB<br>
Total file count in gateway/usr and workstation/usr is:</p>
<pre><code class="lang-auto">find gateway/usr/ -type  f | wc -l
67674</code></pre>
<p>and</p>
<pre><code class="lang-auto">find workstation/usr/ -type  f | wc -l
73340</code></pre>
<p>= 141014 files</p>
<p>Strange is the number of duplicate files which is 75987.<br>
It seems to be higher than the number of files in each directory.<br>
I don’t know why?<br>
141014 is also what is shown in the beginning when i started fdupes.<br>
Maybe the sets of 54722 are the real numbers?<br>
This would at least make more sense.</p>
<p>This also means, if you put the non duplicates to /opt this wouldn’t be a lot of files but you would save 1604 MB.<br>
The other 286 MB of 1890 MB of duplicates are probably in /lib, /bin and /boot<br>
/lib does have a size of 228 MB in the workstation image.<br>
/bin 11 MB<br>
/boot 30 MB<br>
But files that are in /lib are needed during boot time, the same applies to /bin and /boot so putting them somewhere else is not an option.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="3" />
           <span class='post-likes'>3 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T17:56:57Z' class='post-time'>
                April 3, 2019,  5:56pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T17:56:57Z'>
          <span itemprop='position'>#14</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="13" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>Strange is the number of duplicate files which is 75987.<br>
It seems to be higher than the number of files in each directory.<br>
I don’t know why?</p>
</blockquote>
</aside>
<p>Maybe these are symlinks which are ignored in the find command with the -type f option.<br>
In this the number 54722 should be the real number of files.</p>
<p>If we assume that it is that way then<br>
workstation/usr does have 73340-54722 = 18618 none duplicate files<br>
and<br>
gateway/user does have 67674-54722 =12952 none duplicate files.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="3" />
           <span class='post-likes'>3 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T18:55:08Z' class='post-time'>
                April 3, 2019,  6:55pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T18:55:08Z'>
          <span itemprop='position'>#15</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>I have an idea.<br>
Most of these none duplicate files in /usr are very likely just additional software from Debian packages which are required for the workstation but not for the gateway.<br>
And if they are simple Debian packages, then they are not Tor or Whonix specific.</p>
<p>And apt does download and store deb packages in /var/apt/cache/apt/archives/ before installing them.<br>
You could make the Workstation specific image in a way, that it already contains these deb files in /var/apt/cache/apt/archives/ but doesn’t have them installed on the system into /usr.<br>
By having them already in the workstation specific image, they don’t have to be downloaded via the slow Tor network.</p>
<p>And when the user boots up the workstation for the first time, a script could install these deb packages from this directory on the system automatically.</p>
<p>By doing so, you could have a common /usr vm image file as mentioned before in suggestion 1 without the need to have a lot of work.<br>
Because all the Debian packages will stay the same and unaltered.<br>
And only a very small amount of Tor or Whonix specific software must go to opt.<br>
Software like the Tor Browser or the Tor software itself.<br>
But usually you build the Whonix or Tor specific software anyway, so it’s only a change of the installation destination.</p>
<p>A common vm image file just for /usr and the duplicates is definitely the best way to keep the download size low.<br>
And the none duplicates as deb packages in /var… which can get installed by a script during first boot up.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/HulaHoop'><span itemprop='name'>HulaHoop</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T19:51:54Z' class='post-time'>
                April 3, 2019,  7:51pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T19:51:54Z'>
          <span itemprop='position'>#16</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p><a class="mention" href="../../../external.html?link=https://forums.whonix.org/u/firefox">@Firefox</a> dang you really thought about this. It’s good to see a thought out proposal instead of the usual drive by user requests.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="2" />
           <span class='post-likes'>2 Likes</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T20:55:05Z' class='post-time'>
                April 3, 2019,  8:55pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T20:55:05Z'>
          <span itemprop='position'>#17</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Might be doable in theory, but…<br>
KVM only changes not compatible with VirtualBox changes are very, very unlikely to be contributed.<br>
A third shared image is very, very unlikely to materialize.<br>
A third shared image adds a lot complexity, increase the size of the code base, speak even fewer people would read and understood the source code.<br>
The available labor is very low.</p>
<p>Changing the code for image compression is realistic. But changing the build process for something that benefits KVM only, I am certainly not going to write that code.</p>
<aside class="quote no-group" data-post="15" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>A common vm image file just for /usr and the duplicates is definitely the best way to keep the download size low.</p>
</blockquote>
</aside>
<p>Common vm image also seems risky form a security point of view. Which VM would be authorized to make changes to it (update it)?</p>
<p>A shared image can make a lot of sense. Qubes OS TemplateVMs share their root image. Simplified:</p>
<ul>
<li>TemplateBasedVMs can write to root image (which is /usr and others) but these changes will not be shared with any other VMs and be lost after shutdown</li>
<li>TemplateVMs can write to the root image persistently</li>
<li>after TemplateVM shutdown and TemplateBasedVMs reboot the updated root file system is available to the TemplateBasedVMs</li>
<li>this allows huge savings in disk space and centralized updates, i.e. only the TemplateVM has to be updated and shut down then after reboot of the TemplateBasedVMs everything will be up to date.</li>
<li><a href="../../../external.html?link=https://www.qubes-os.org/doc/template-implementation/" rel="nofollow noopener">https://www.qubes-os.org/doc/template-implementation/</a></li>
</ul>
<p>But I don’t see anyone reinventing that for Whonix KVM only.</p>
<aside class="quote no-group" data-post="15" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/f/9de053/40.png" class="avatar"> Firefox:</div>
<blockquote>
<p>And only a very small amount of Tor or Whonix specific software must go to opt.</p>
</blockquote>
</aside>
<p>Development work, and new bugs.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="2" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T22:26:32Z' class='post-time'>
                April 3, 2019, 10:26pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T22:31:43Z'>
          <span itemprop='position'>#18</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="17" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Changing the code for image compression is realistic. But changing the build process for something that benefits KVM only, I am certainly not going to write that code.</p>
</blockquote>
</aside>
<p>Well the principles are the same for both, KVM and Virtualbox. As far as i know KVM and Virtualbox are only different kinds of Virtual machines software with their specific VM image format and both understand the raw image format or can convert from raw to their VM specific image format.</p>
<p>Thus building 3 raw images and converting them to qcow2 and vdi should be all that is needed to make them VM specific.</p>
<pre><code class="lang-auto">Common vm image also seems risky form a security point of view. Which VM would be authorized to make changes to it (update it)?</code></pre>
<p>No, the common vm image format is only shared for step 1 which is the step of downloading the files. The common vm image file makes the download size smaller by removing the extra size for duplicates, that’s the whole point of this thread.</p>
<p>In step 2 the user clones the common image for whonix workspace and renames the other for whonix gateway, or vice versa. Like described above.<br>
Thus in step 3, when the user boots whonix workspace and whonix gateway both have their own image file for /usr.<br>
So to sum it up, at runtime and later usage these are individual independent images.</p>
<p>That is also needed because in step 4, when the workspace or gateway images are booted for the first time, a script automatically installs the none duplicate deb packages as described above from  /var/apt/cache/apt/archives/ making image file gateway_usr.qcow2 and whonix_usr.qcow2 completely independent and different from each other.</p>
<p>The only things that are to keep in mind are:<br>
A. by cloning the common.qcow2 file the UUID of the disk image changes<br>
B. The virtual machine config file may require a change to the new UUID if it is UUID and not filename based.<br>
C. inside of workspace or gateway the /etc/fstab file must be changed according to the UUID. But this should be doable by the script that also installs the deb files when booting the first time.</p>
<p>Steps A and B should be doable by a script the user has to run after download.<br>
Step C can run automatically when the images are booted the first time.</p>
<aside class="quote no-group">
<blockquote>
<blockquote>
<p>And only a very small amount of Tor or Whonix specific software must go to opt.</p>
</blockquote>
<p>Development work, and new bugs.</p>
</blockquote>
</aside>
<p>Most open source software offer a way to provide a destination for the installation during the create makefile process.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Firefox'><span itemprop='name'>Firefox</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-03T22:30:51Z' class='post-time'>
                April 3, 2019, 10:30pm
              </time>
              <meta itemprop='dateModified' content='2019-04-03T22:30:51Z'>
          <span itemprop='position'>#19</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <aside class="quote no-group" data-post="16" data-topic="7086" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v2/letter/h/edb3f5/40.png" class="avatar"> HulaHoop:</div>
<blockquote>
<p><a class="mention" href="../../../external.html?link=https://forums.whonix.org/u/firefox">@Firefox</a> dang you really thought about this. It’s good to see a thought out proposal instead of the usual drive by user requests.</p>
</blockquote>
</aside>
<p>Thanks.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="0" />
           <span class='post-likes'></span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0" />
          </div>

      </div>
      <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
          <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
            <meta itemprop='name' content='Whonix - Anonymous Operating System'>
              <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
                <meta itemprop='url' content='../../uploads/default/original/2X/d/d66e6a1341d872ca984eb1f23d30009afef57a4c.png'>
              </div>
          </div>
          <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
            <a itemprop="url" href='../../../external.html?link=https://forums.whonix.org/u/Patrick'><span itemprop='name'>Patrick</span></a>
            
          </span>

          <link itemprop="mainEntityOfPage" href="7086.html">


          <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2019-04-04T09:19:00Z' class='post-time'>
                April 4, 2019,  9:19am
              </time>
              <meta itemprop='dateModified' content='2019-04-04T09:19:00Z'>
          <span itemprop='position'>#20</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
          <p>Firefox via Whonix Forum:</p>
<blockquote>
<aside class="quote no-group" data-post="17" data-topic="7086">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forums.whonix.org/patrick/40/17_2.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Changing the code for image compression is realistic. But changing the build process for something that benefits KVM only, I am certainly not going to write that code.</p>
</blockquote>
</aside>
<p>Well the principles are the same for both, KVM and Virtualbox. KVM and Virtualbox are only Virtual machines with their specific VM image format and both understand the raw image format or can convert from raw to their VM specific image format.</p>
<p>Thus building 3 raw images and converting them to qcow2 and vdi should be all that is needed to make them VM specific.</p>
</blockquote>
<p>VirtualBox: This would have to be done on the user’s machine. Something<br>
simple (ova image to import) would be converted into something more<br>
complex and platform specific. A script, one for linux, another one for<br>
Windows, and perhaps another one for mac. Rather than “just import the<br>
ova using virtualbox” it’s “extract, make the script executable, run the<br>
script” (or in case of Windows perhaps an installer). Possible but no<br>
development resources for that.</p>
<blockquote>
<pre><code class="lang-auto">Common vm image also seems risky form a security point of view. Which VM would be authorized to make changes to it (update it)?</code></pre>
<p>No, the common vm image format is only shared for step 1 which is the step of downloading the files. The common vm image file makes the download size smaller by removing the extra size for duplicates, that’s the whole point of this thread.</p>
</blockquote>
<p>I see.</p>
<blockquote>
<p>In step 2 the user clones the common image for whonix workspace and renames the other for whonix gateway, or vice versa. Like described above.<br>
Thus in step 3, when the user boots whonix workspace and whonix gateway both have their own image file for /usr.<br>
So to sum it up, at runtime and later usage these are individual independent images.</p>
<p>That is also needed because in step 4, when the workspace or gateway images are booted for the first time, a script automatically installs the none duplicate deb packages as described above from  /var/apt/cache/apt/archives/ making image file gateway_usr.qcow2 and whonix_usr.qcow2 completely independent and different from each other.</p>
</blockquote>
<p>I see.</p>
<blockquote>
<p>The only things that are to keep in mind are:<br>
A. by cloning the common.qcow2 file the UUID of the disk image changes<br>
B. The virtual machine config file may require a change to the new UUID if it is UUID and not filename based.<br>
C. inside of workspace or gateway the /etc/fstab file must be changed according to the UUID. But this should be doable by the script that also installs the deb files when booting the first time.</p>
<p>Steps A and B should be doable by a script the user has to run after download.<br>
Step C can run automatically when the images are booted the first time.</p>
</blockquote>
<p>A lot code to be written.</p>
<blockquote>
<aside class="quote no-group">
<blockquote>
<blockquote>
<p>And only a very small amount of Tor or Whonix specific software must go to opt.</p>
</blockquote>
<p>Development work, and new bugs.</p>
</blockquote>
</aside>
<p>Most open source software offer a way to provide a destination for the installation during the create makefile process.</p>
</blockquote>
<p>Whonix packages using genmkfile also support setting DESTDIR. However,<br>
<code>make install</code> is only used during the package creation process.<br>
Software by Whonix is installed through packages. These are using the<br>
default paths as per FHS. Packages install to / as per usual. No package<br>
/ just using <code>make install</code> -&gt; no good upgrade path. Packages provide a<br>
very good upgrade path. Having the packages install to /opt would be a<br>
lot work updating any paths, new bugs. Also package installation<br>
requires their dependencies being installed already. So Whonix packages<br>
could go to the same directory for initial installation. (To resolve<br>
dependencies, to install in right order, a local apt repository would be<br>
required.)</p>
<p>In theory it’s all doable but super complex and error prone. I would<br>
veto such changes and suggest to fork Whonix instead if this is desired.</p>
<p>I also don’t think Whonix needs to invent something new as complex as<br>
this here. Whonix isn’t an outsider by using VM images. These are very<br>
popular in data centers. These need to backups and transfer files. So<br>
someone must have sorted out deduplication and compression of VM images<br>
in a generic way already.</p>
<p>These two blog posts indicate that just switching to another compression<br>
algorithm could do the trick.</p>
<p><a href="../../../external.html?link=http://www.doublecloud.org/2012/06/best-tool-to-compress-virtual-machines/" class="onebox" target="_blank" rel="nofollow noopener">http://www.doublecloud.org/2012/06/best-tool-to-compress-virtual-machines/</a></p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="../../../external.html?link=https://wiitez.blogspot.com/favicon.ico" class="site-icon" width="32" height="32">
      <a href="../../../external.html?link=https://wiitez.blogspot.com/2016/12/vm-image-compression-and-optimization.html" target="_blank" rel="nofollow noopener">wiitez.blogspot.com</a>
  </header>
  <article class="onebox-body">
    

<h3><a href="../../../external.html?link=https://wiitez.blogspot.com/2016/12/vm-image-compression-and-optimization.html" target="_blank" rel="nofollow noopener">VM image compression and optimization for transfer, distribution or deep-freeze</a></h3>

<p>We often need to send and receive VM images, mostly over intercontinental and/or slow and/or high latency and/or unreliable connections. We...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>If that does not suffice, for duplication we could also research huge<br>
compression algorithm dictionary sizes and/or preprocessors to remove<br>
duplication.</p>
        </div>

        <meta itemprop='headline' content='improving compression of Whonix image downloads'>

        <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
           <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
           <meta itemprop="userInteractionCount" content="1" />
           <span class='post-likes'>1 Like</span>
         </div>

         <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1" />
          </div>

      </div>

    <div role='navigation' itemscope itemtype='http://schema.org/SiteNavigationElement' class="topic-body crawler-post">
        <span itemprop='name'><b><a rel="next" itemprop="url" href="70864658.html?page=2">next page →</a></b></span>
    </div>





    </div>
    <footer class="container wrap">
      <nav class='crawler-nav'>
        <ul>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../index.html' itemprop="url">Home </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../categories.html' itemprop="url">Categories </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/tos' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../../external.html?link=https://forums.whonix.org/privacy' itemprop="url">Privacy Policy </a>
          </span>
        </li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    <center>
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Imprint">Imprint</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Privacy_Policy">Privacy Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Cookie_Policy">Cookie Policy</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Terms_of_Use">Terms of Use</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/E-Sign_Consent">E-Sign Consent</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/DMCA">DMCA</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Contributors">Contributors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Investors">Investors</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Priority_Support">Priority Support</a>]
[<a href="../../../external.html?link=https://www.whonix.org/wiki/Professional_Support">Professional Support</a>]
</center>
    
  </body>
  
</html>
