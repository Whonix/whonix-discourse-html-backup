<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
    <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137</link>
    <description>Experienced this issue while troubleshooting the domain isolation features of TBB. I don&#39;t usually use the New Identity feature.

TBB 6.0.5 in Qubes 3.1
Appears to be related to Whonix. Unsure if it is Qubes-specific.

To reproduce:
1: launch Whonix-WS dispVM.
2: launch torbrowser
3: click `New Identity`
4: results in error 

&lt;img src=&quot;/uploads/default/original/1X/9f2fc32b61667913610699d5d6816befdb657565.jpeg&quot; width=&quot;643&quot; height=&quot;142&quot;&gt;

whonixcheck in dispVM reports:

    [ERROR] [whonixcheck] Tor Bootstrap Result:
    Tor&#39;s Control Port could not be reached!

whonixcheck in all other appVMs also report same error.

5: close torbrowser
6: whonixcheck connects to control port successfully in all VMs again.
7: **interesting part:** launch torbrowser again in same dispVM
8: whonixcheck can not connect to control port in any VM again

Seems like a trivial issue but I&#39;d rather err on the side of caution with anything related to the Control Port. :)</description>
    <language>en</language>
    <lastBuildDate>Mon, 21 Nov 2016 18:07:42 +0000</lastBuildDate>
    <category>Support</category>
    <atom:link href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="9" data-topic="3137" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/bladetongue/40/747_1.png" class="avatar"> Bladetongue:</div>
<blockquote>
<p>For the layman, is this problem a risk to my system? Is there a fix needed?</p>
</blockquote>
</aside>
<p>The control port has very limited functionality in Whonix - by design to protect you. Should it become non-functional, you’ll mostly lose some usability tools provided by Whonix. You’ll see various error messages as well (sdwdate, whonixcheck, torbrowser). None of these will weaken your anonymity.</p>
<p>However, it is important to note that if you see the error message in the first post, then <code>New Identity</code> is not triggering the circuit reset in the Gateway like it’s supposed to so proceed accordingly.</p>
<p>The workaround / fix is to close Workstations that aren’t needed or to edit <code>/etc/cpfpy.d/30_default.conf</code> to increase the maximum number of concurrent connections.</p>
<p>Further reading:<br>
<a href="https://www.whonix.org/wiki/Advanced_Security_Guide#Disable_Control_Port_Filter_Proxy">https://www.whonix.org/wiki/Advanced_Security_Guide#Disable_Control_Port_Filter_Proxy</a><br>
<a href="https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy">https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy</a></p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/10">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/10</link>
        <pubDate>Mon, 21 Nov 2016 18:07:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-10</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[Bladetongue]]></dc:creator>
        <description><![CDATA[
            <p>For the layman, is this problem a risk to my system? Is there a fix needed?</p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/9">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/9</link>
        <pubDate>Mon, 21 Nov 2016 15:39:13 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-9</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <aside class="quote" data-post="7" data-topic="3137">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>Have we found the culprit? <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</blockquote>
</aside>
<p>I believe so! (As much as my RAM will let me test anyway.) I’m surprised I haven’t run into the issue earlier. It must be because I just never used the control port for anything. I guess if I had run Whonixcheck in all open VMs, I would’ve noticed sooner. It’s nice to know that I can survive without control port - I should disable it altogether now. <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<aside class="quote" data-post="7" data-topic="3137">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>I wonder why we have set it so low.</p>
</blockquote>
</aside>
<p>I guess it will depend also on outcome of Multi GW recommendation: <a href="https://phabricator.whonix.org/T567">https://phabricator.whonix.org/T567</a>.</p>
<aside class="quote" data-post="7" data-topic="3137">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/user_avatar/forums.whonix.org/patrick/40/17_1.png" class="avatar"> Patrick:</div>
<blockquote>
<p>how to create a deterministic dump of iptables rules. Then you could change something or do something. After that you can create a second deterministic dump and then compare both with a diff viewer.</p>
</blockquote>
</aside>
<p>Sounds useful. Gonna have to re-read that a few times on a rainy day.</p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/8">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/8</link>
        <pubDate>Sun, 20 Nov 2016 23:04:48 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-8</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Whonix firewall and cpfpy should not interact. But btw this is a great opportunity to hint at the following chapter. It explains how to create a deterministic dump of iptables rules. Then you could change something or do something. After that you can create a second deterministic dump and then compare both with a diff viewer.</p>
<p><a href="https://www.whonix.org/wiki/Dev/Firewall_Refactoring#How_to_refactor_the_firewall_script_while_being_sure_there_are_no_iptables_changes">https://www.whonix.org/wiki/Dev/Firewall_Refactoring#How_to_refactor_the_firewall_script_while_being_sure_there_are_no_iptables_changes</a></p>
<aside class="quote" data-post="6" data-topic="3137">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v2/letter/e/8dc957/40.png" class="avatar"> entr0py:</div>
<blockquote>
<p>Is there a maximum number of control port connections?</p>
</blockquote>
</aside>
<p>Yes, as of Whonix 13, it’s <code>5</code>. Config:</p>
<aside class="onebox githubblob">
  <header class="source">
      <a href="https://github.com/Whonix/control-port-filter-python/blob/88aafe059bb05dd1175148d00f635db6ff020cbd/etc/cpfpy.d/30_default.conf#L109-L113" target="_blank" rel="nofollow noopener">github.com</a>
  </header>
  <article class="onebox-body">
    <h4><a href="https://github.com/Whonix/control-port-filter-python/blob/88aafe059bb05dd1175148d00f635db6ff020cbd/etc/cpfpy.d/30_default.conf#L109-L113" target="_blank" rel="nofollow noopener">Whonix/control-port-filter-python/blob/88aafe059bb05dd1175148d00f635db6ff020cbd/etc/cpfpy.d/30_default.conf#L109-L113</a></h4>
<pre class="onebox"><code class="lang-conf"><ol class="start lines" start="109" style="counter-reset: li-counter 108 ;">
<li>##############################</li>
<li># CONTROL_PORT_FILTER_CONCURRENT_CONNECTIONS_LIMIT #</li>
<li>##############################</li>
<li>Limit the number of parallel connections accepted by the server</li>
<li>CONTROL_PORT_FILTER_CONCURRENT_CONNECTIONS_LIMIT=5</li>
</ol></code></pre>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Please try to increase that number. I wonder why we have set it so low. Probably that default was set long before there was Qubes-Whonix a thing. Feel free to set it to <code>50</code> or so. Then</p>
<pre><code> sudo service control-port-filter-python restart
</code></pre>
<p>Have we found the culprit? <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/7</link>
        <pubDate>Sun, 20 Nov 2016 22:42:34 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-7</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p>Was difficult to reproduce this time. Took 15-20 tries. Once it happens, (almost?) every dispVM that is subsequently created experiences the issue.</p>
<p><code>tail -f /var/log/control-port-filter-python.log</code></p>
<p>On a working TBB, <code>New Identity</code> results in:</p>
<pre><code>CPFP log - DEBUG - Request: signal newnym
CPFP log - DEBUG - Answer: 250 OK
</code></pre>
<p>On a broken TBB, there is nothing logged after sending <code>New Identity</code><br>
While broken TBB is running, other TBB that send <code>New Identity</code> also do not generate any output.<br>
After closing offending TBB, <code>New Identity</code> results in normal output for all TBB.</p>
<hr>
<p><code>sudo service control-port-filter-python status</code></p>
<p>Status never changes.</p>
<hr>
<p>I took one additional step. I monitored iptables for incoming packets and indeed, <code>New Identity</code> on all TBB (working or broken) results in incrementing both:</p>
<pre><code>nat: PREROUTING
REDIRECT   tcp  --  vif+   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:9052 redir ports 9052

filter: INPUT
ACCEPT     tcp  --  vif+   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:9052
</code></pre>
<p>So something is happening between iptables and cpfp in Gateway.<br>
Is there a maximum number of control port connections?</p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/6</link>
        <pubDate>Sun, 20 Nov 2016 22:23:50 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-6</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Please provide the following debug output. Please shutdown all Whonix VMs. Then start just sys-whonix. Start watching the cpfpy log.</p>
<pre><code>tail -f /var/log/control-port-filter-python.log
</code></pre>
<p>The reproduce this issue. Once it happened, please provide that log. Please also check if it is still running after this issue happened.</p>
<pre><code>sudo service control-port-filter-python status</code></pre>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/5</link>
        <pubDate>Sat, 19 Nov 2016 18:43:28 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-5</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[Bladetongue]]></dc:creator>
        <description><![CDATA[
            <p>I’m having this error too, seems pretty persistent for me.</p>
<p>I’m going to reinstall and create multiples</p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/4</link>
        <pubDate>Sat, 19 Nov 2016 12:40:31 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-4</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p>NetVM is correctly set to Whonix-GW. dispVM connectivity is unaffected. In fact, the error-triggering Tor Browser continues to function normally.</p>
<p>Even more strange. This is not reproducible 100% of the time. After I wrote the bug report, a newly launched dispVM did not experience this issue. I tested a further dispVM to confirm the issue and indeed, it caused control port failure.</p>
<p>Just now (after system reboot)<br>
disp2: no issue<br>
disp3: no issue<br>
disp4: control port failure</p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/3</link>
        <pubDate>Thu, 10 Nov 2016 17:26:06 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-3</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>I am on Qubes R3.2. (And on Qubes testing repository - so things break for me before for everyone else.) Tried to reproduce with stable Whonix 13.</p>
<p>It’s a very well written bug report. I could not reproduce this issue.</p>
<p>Can you check in QVMM please the NetVM setting of <code>Disp1</code>, <code>Disp2</code>, etc. please? It should be set to <code>sys-whonix</code>.</p>
<p>Is all DispVM connectivity broken? Or does curl, wget etc. still work after this is happening?</p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/2</link>
        <pubDate>Thu, 10 Nov 2016 17:03:55 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-2</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
      <item>
        <title>TBB New Identity Breaks Tor Control Port / Maximum Connections</title>
        <dc:creator><![CDATA[entr0py]]></dc:creator>
        <description><![CDATA[
            <p>Experienced this issue while troubleshooting the domain isolation features of TBB. I don’t usually use the New Identity feature.</p>
<p>TBB 6.0.5 in Qubes 3.1<br>
Appears to be related to Whonix. Unsure if it is Qubes-specific.</p>
<p>To reproduce:<br>
1: launch Whonix-WS dispVM.<br>
2: launch torbrowser<br>
3: click <code>New Identity</code><br>
4: results in error</p>
<p><img src="//forums.whonix.org/uploads/default/original/1X/9f2fc32b61667913610699d5d6816befdb657565.jpeg" width="643" height="142"></p>
<p>whonixcheck in dispVM reports:</p>
<pre><code>[ERROR] [whonixcheck] Tor Bootstrap Result:
Tor's Control Port could not be reached!
</code></pre>
<p>whonixcheck in all other appVMs also report same error.</p>
<p>5: close torbrowser<br>
6: whonixcheck connects to control port successfully in all VMs again.<br>
7: <strong>interesting part:</strong> launch torbrowser again in same dispVM<br>
8: whonixcheck can not connect to control port in any VM again</p>
<p>Seems like a trivial issue but I’d rather err on the side of caution with anything related to the Control Port. <img src="//forums.whonix.org/images/emoji/twitter/slight_smile.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137/1</link>
        <pubDate>Thu, 10 Nov 2016 03:59:39 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-3137-1</guid>
        <source url="http://forums.whonix.org/t/tbb-new-identity-breaks-tor-control-port-maximum-connections/3137.rss">TBB New Identity Breaks Tor Control Port / Maximum Connections</source>
      </item>
  </channel>
</rss>
