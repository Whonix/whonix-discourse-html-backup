<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Using apparmor-profile-everything on Debian Buster</title>
    <link>http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650</link>
    <description>I have been keeping up with @madaidan&#39;s and @Patrick&#39;s ongoing development of [`apparmor-profile-everything`](https://github.com/Whonix/apparmor-profile-everything). So far, their efforts have led to a system of total confinement aptly named `apparmor-profile-everything`.

This is not simply a single profile but a series of profiles, system files, and related scripting. Together these elements work as one to confine the user&#39;s system starting from `init` onward. The confinements include: the systemd init process and any children it spawns, the `apt-get` processes through a wrapper named `rapt`, and a lockdown of files and directories that could pose significant security risks if they were to be exploited.

The `initramfs` is made aware through a hook so that the `init-systemd` AppArmor profile is executed right before systemd starts parsing. This is proven through simple examination of the boot log information (`journalctl`).

This was tested on a Debian Buster host with kernel `4.19.0-6-amd64` fully updated. Since Debian ships AppArmor as default, and it is already active, no kernel boot parameter is necessary. There is a very convenient way to add this profile to your system by simply obtaining it from the official Whonix repository.

    sudo apt-get install apparmor-profile-everything

That will install the package onto your machine.

The `rapt` application was very interesting because it completely confined `apt-get` while at the same time allowing for normal use. It acts as a wrapper for `apt`, similar in function to how [`uwt`](https://github.com/Whonix/uwt) acts as a wrapper for `torsocks` in Whonix. `rapt` protects your system and a review of the code shows that it specifically works with and for `apparmor-profile-everything` to make sure an attacker or malicious script cannot simply remove packages to bypass protections.

The `initramfs-tools` hook is simple enough to understand. Its purpose is to make sure that the `initramfs` knows to initiate the `init-systemd` AppArmor profile before systemd. The log confirms this:

&gt; Dec 19 00:16:08 host kernel: audit: type=1400 audit(1576714567.608:2): apparmor=&quot;STATUS&quot; operation=&quot;profile_load&quot; profile=&quot;unconfined&quot; name=&quot;init-systemd&quot; pid=211 comm=&quot;apparmor_parser&quot;

then immediately after:

&gt; Dec 19 00:16:08 host systemd[1]: systemd 241 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP 

the `/usr/bin/rapt` profile parses as well:

&gt; Dec 19 00:16:08 host kernel: audit: type=1400 audit(1576714568.800:4): apparmor=&quot;STATUS&quot; operation=&quot;profile_load&quot; profile=&quot;unconfined&quot; name=&quot;/usr/bin/rapt&quot; pid=308 comm=&quot;apparmor_parser&quot;

Now, it is important to note that this particular system is a torified and hardened workstation. No clearnet allowed. My permissions are not identical to those of Whonix, but they are similar. I can only report on my own system, so your mileage may vary. That would not be a problem though, because (if you know what you are doing) AppArmor is very flexible and still very secure. If my testing continues as smoothly as it has so far, my plan is to implement `apparmor-profile-everything` on all my systems.

There are no errors with System Tor (`4.1.6`) or the Tor Browser (`9.02`). 
I have not tested UDP, but TCP is fine OpenVPN works. Both as `openvpn@server` and as a client connecting to that server. No interruptions or permissions issues found. Performance is as expected. OpenVPN works both with TCP and UDP, and ports are flexible. Used in TCP mode, no errors are experienced.
Monero cli wallet works. Electrum works.
Normal day to day tasks also work with no issue. Specifically: browsing, coding and compiling (with minor tweaks),
There was an error regarding GPG that wanted access to `/proc/sys/crypto/fips_enabled`. It was not an impediment however. I did not adjust any permissions, and the error proved harmless. (This error was generated by the `/usr/bin/rapt` profile and recorded by audit in `dmesg`)
Other than that, there have been no issues!

Apparmor is a versatile and powerful system that can provide formidable protections and be a substantial if not insurmountable obstacle to any misbehaving program or malware. Profiles are straightforward and rely on absolute paths. Some commands to get you started in AppArmor:
with `sudo` privileges:

    sudo aa-status

shows you the list of profiles on the system. Shows you how many are loaded, being enforced, are complaining, active processes and associated profiles, and unconfined but with a profile.

    sudo aa-enforce

make a new profile go into &quot;enforce&quot; mode right away
This command needs the `apparmor-utils` package.

    sudo systemctl status apparmor

shows if AppArmor is active, when it was started and its process ID number

    sudo systemctl restart apparmor

restarts AppArmor and its profiles.

----

Edit by Patrick:
Formatting changes.

https://www.whonix.org/w/images/c/cf/Shield.png</description>
    <language>en</language>
    <lastBuildDate>Thu, 19 Dec 2019 16:41:42 +0000</lastBuildDate>
    <category>News</category>
    <atom:link href="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Using apparmor-profile-everything on Debian Buster</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>A great advertisement for a cool feature.</p>
          <p><a href="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650/3</link>
        <pubDate>Thu, 19 Dec 2019 16:41:42 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8650-3</guid>
        <source url="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650.rss">Using apparmor-profile-everything on Debian Buster</source>
      </item>
      <item>
        <title>Using apparmor-profile-everything on Debian Buster</title>
        <dc:creator><![CDATA[Patrick]]></dc:creator>
        <description><![CDATA[
            <p>Made some formatting edits. And moved to news section.</p>
<p>Note: apparmor-profile-everything is still under development. While it might already break some malware, we don’t have it block dangerous file edits by default yet. Stay tuned. We’ll post an update when ready.</p>
          <p><a href="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650/2</link>
        <pubDate>Thu, 19 Dec 2019 07:44:21 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8650-2</guid>
        <source url="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650.rss">Using apparmor-profile-everything on Debian Buster</source>
      </item>
      <item>
        <title>Using apparmor-profile-everything on Debian Buster</title>
        <dc:creator><![CDATA[anontor]]></dc:creator>
        <description><![CDATA[
            <p>I have been keeping up with <a class="mention" href="http://forums.whonix.org/u/madaidan">@madaidan</a>’s and <a class="mention" href="http://forums.whonix.org/u/patrick">@Patrick</a>’s ongoing development of <a href="https://github.com/Whonix/apparmor-profile-everything" rel="nofollow noopener"><code>apparmor-profile-everything</code></a>. So far, their efforts have led to a system of total confinement aptly named <code>apparmor-profile-everything</code>.</p>
<p>This is not simply a single profile but a series of profiles, system files, and related scripting. Together these elements work as one to confine the user’s system starting from <code>init</code> onward. The confinements include: the systemd init process and any children it spawns, the <code>apt-get</code> processes through a wrapper named <code>rapt</code>, and a lockdown of files and directories that could pose significant security risks if they were to be exploited.</p>
<p>The <code>initramfs</code> is made aware through a hook so that the <code>init-systemd</code> AppArmor profile is executed right before systemd starts parsing. This is proven through simple examination of the boot log information (<code>journalctl</code>).</p>
<p>This was tested on a Debian Buster host with kernel <code>4.19.0-6-amd64</code> fully updated. Since Debian ships AppArmor as default, and it is already active, no kernel boot parameter is necessary. There is a very convenient way to add this profile to your system by simply obtaining it from the official Whonix repository.</p>
<pre><code>sudo apt-get install apparmor-profile-everything
</code></pre>
<p>That will install the package onto your machine.</p>
<p>The <code>rapt</code> application was very interesting because it completely confined <code>apt-get</code> while at the same time allowing for normal use. It acts as a wrapper for <code>apt</code>, similar in function to how <a href="https://github.com/Whonix/uwt" rel="nofollow noopener"><code>uwt</code></a> acts as a wrapper for <code>torsocks</code> in Whonix. <code>rapt</code> protects your system and a review of the code shows that it specifically works with and for <code>apparmor-profile-everything</code> to make sure an attacker or malicious script cannot simply remove packages to bypass protections.</p>
<p>The <code>initramfs-tools</code> hook is simple enough to understand. Its purpose is to make sure that the <code>initramfs</code> knows to initiate the <code>init-systemd</code> AppArmor profile before systemd. The log confirms this:</p>
<blockquote>
<p>Dec 19 00:16:08 host kernel: audit: type=1400 audit(1576714567.608:2): apparmor=“STATUS” operation=“profile_load” profile=“unconfined” name=“init-systemd” pid=211 comm=“apparmor_parser”</p>
</blockquote>
<p>then immediately after:</p>
<blockquote>
<p>Dec 19 00:16:08 host systemd[1]: systemd 241 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP</p>
</blockquote>
<p>the <code>/usr/bin/rapt</code> profile parses as well:</p>
<blockquote>
<p>Dec 19 00:16:08 host kernel: audit: type=1400 audit(1576714568.800:4): apparmor=“STATUS” operation=“profile_load” profile=“unconfined” name="/usr/bin/rapt" pid=308 comm=“apparmor_parser”</p>
</blockquote>
<p>Now, it is important to note that this particular system is a torified and hardened workstation. No clearnet allowed. My permissions are not identical to those of Whonix, but they are similar. I can only report on my own system, so your mileage may vary. That would not be a problem though, because (if you know what you are doing) AppArmor is very flexible and still very secure. If my testing continues as smoothly as it has so far, my plan is to implement <code>apparmor-profile-everything</code> on all my systems.</p>
<p>There are no errors with System Tor (<code>4.1.6</code>) or the Tor Browser (<code>9.02</code>).<br>
I have not tested UDP, but TCP is fine OpenVPN works. Both as <code>openvpn@server</code> and as a client connecting to that server. No interruptions or permissions issues found. Performance is as expected. OpenVPN works both with TCP and UDP, and ports are flexible. Used in TCP mode, no errors are experienced.<br>
Monero cli wallet works. Electrum works.<br>
Normal day to day tasks also work with no issue. Specifically: browsing, coding and compiling (with minor tweaks),<br>
There was an error regarding GPG that wanted access to <code>/proc/sys/crypto/fips_enabled</code>. It was not an impediment however. I did not adjust any permissions, and the error proved harmless. (This error was generated by the <code>/usr/bin/rapt</code> profile and recorded by audit in <code>dmesg</code>)<br>
Other than that, there have been no issues!</p>
<p>Apparmor is a versatile and powerful system that can provide formidable protections and be a substantial if not insurmountable obstacle to any misbehaving program or malware. Profiles are straightforward and rely on absolute paths. Some commands to get you started in AppArmor:<br>
with <code>sudo</code> privileges:</p>
<pre><code>sudo aa-status
</code></pre>
<p>shows you the list of profiles on the system. Shows you how many are loaded, being enforced, are complaining, active processes and associated profiles, and unconfined but with a profile.</p>
<pre><code>sudo aa-enforce
</code></pre>
<p>make a new profile go into “enforce” mode right away<br>
This command needs the <code>apparmor-utils</code> package.</p>
<pre><code>sudo systemctl status apparmor
</code></pre>
<p>shows if AppArmor is active, when it was started and its process ID number</p>
<pre><code>sudo systemctl restart apparmor
</code></pre>
<p>restarts AppArmor and its profiles.</p>
<hr>
<p>Edit by Patrick:<br>
Formatting changes.</p>
<p>                    <a href="https://www.whonix.org/w/images/c/cf/Shield.png" target="_blank" class="onebox" rel="nofollow noopener">
            <img src="https://www.whonix.org/w/images/c/cf/Shield.png" width="128" height="128">
          </a>

</p>
          <p><a href="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650/1</link>
        <pubDate>Thu, 19 Dec 2019 01:46:27 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8650-1</guid>
        <source url="http://forums.whonix.org/t/using-apparmor-profile-everything-on-debian-buster/8650.rss">Using apparmor-profile-everything on Debian Buster</source>
      </item>
  </channel>
</rss>
