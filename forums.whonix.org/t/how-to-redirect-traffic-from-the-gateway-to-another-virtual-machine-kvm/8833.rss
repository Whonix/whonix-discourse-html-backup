<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
    <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833</link>
    <description>How to redirect traffic from the whonix (virbr1) gateway to another KVM virtual machine (virbr3)? That the external network was not from the host. I want to separate openvpn + stunnel from host and gateway. By running them in another virtual machine.

Default:
workstation &gt; gateway &gt; host system &gt; internet

I need so:
workstation &gt; gateway &gt; virtual machine(OpenVpn+stunnel) &gt; host system &gt; internet</description>
    <language>en</language>
    <lastBuildDate>Sat, 25 Jan 2020 19:17:19 +0000</lastBuildDate>
    <category>KVM</category>
    <atom:link href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[Patrick_mobile]]></dc:creator>
        <description><![CDATA[
            <aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://www.whonix.org/w/images/favicon.ico" class="site-icon" width="16" height="16">
      <a href="https://www.whonix.org/wiki/Tunnels/Introduction" target="_blank" title="05:33PM - 03 November 2019" rel="nofollow noopener">whonix.org – 3 Nov 19</a>
  </header>
  <article class="onebox-body">
    <img src="https://www.whonix.org/w/images/8/86/Beyond-1087922640.jpg" class="thumbnail" width="" height="">

<h3><a href="https://www.whonix.org/wiki/Tunnels/Introduction" target="_blank" rel="nofollow noopener">Combining Tunnels with Tor - Whonix</a></h3>

<p>Instructions on how to combine tunnels (VPN, SSH, proxy) with Tor. (User → Tor → proxy/VPN/SSH → Internet) (User → proxy/VPN/SSH → Tor → Internet)</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>Follow carefully</p>
<p>see also there</p>
<p>Troubleshooting</p>
<p>and</p>
<p>How to Submit a Support Request</p>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/7">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/7</link>
        <pubDate>Sat, 25 Jan 2020 19:17:19 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-7</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[Patrick_mobile]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="3" data-topic="8833">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/m/ecccb3/40.png" class="avatar"> Masaika:</div>
<blockquote>
<p>Loaded: loaded (/lib/systemd/system/openvpn-client@.service; disabled - off?</p>
</blockquote>
</aside>
<p>No. This is a template. To be copied. Not to be enabled.</p>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/6">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/6</link>
        <pubDate>Sat, 25 Jan 2020 19:12:44 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-6</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-post="3" data-topic="8833">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/m/ecccb3/40.png" class="avatar"> Masaika:</div>
<blockquote>
<p>Should TUN0 interface go up?</p>
</blockquote>
</aside>
<p>Of course. How else  can apps use the vpn interface?</p>
<aside class="quote no-group" data-post="3" data-topic="8833">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="//forums.whonix.org/letter_avatar_proxy/v4/letter/m/ecccb3/40.png" class="avatar"> Masaika:</div>
<blockquote>
<p>Loaded: loaded (/lib/systemd/system/openvpn-client@.service; disabled - off?</p>
</blockquote>
</aside>
<p>Should be enabled I think.</p>
<p>My advice is to test if normal programs on the system use the VPN before attempting to tunnel Tor thru it. Makes it easier to figure out what’s wrong.</p>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/5">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/5</link>
        <pubDate>Sat, 25 Jan 2020 14:42:07 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-5</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[Masaika]]></dc:creator>
        <description><![CDATA[
            <p>On a host used such a config - OPENVPN<br>
Works great.</p>
<pre><code>client
dev tun
proto tcp
remote 127.0.0.1 1194
resolv-retry infinite
nobind
user nobody
group nobody
persist-key
persist-tun

ca ca.crt
cert openvpn-client.crt
key openvpn-client.key
tls-auth ta.key 1

remote-cert-tls server
cipher AES-256-GCM
verb 3</code></pre>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/4">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/4</link>
        <pubDate>Fri, 24 Jan 2020 21:57:38 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-4</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[Masaika]]></dc:creator>
        <description><![CDATA[
            <p>The problem is that on the host, I quietly start my openvpn + stunnel configuration, but it doesn’t work out inside the whonix gateway, for various reasons. To begin with, WIKI with the RISEVPN example is only confusing.</p>
<p>Where am I mistaken?<br>
Following the instructions - my actions are as follows:</p>
<ol>
<li>
<p>sudoedit /etc/whonix_firewall.d/50_user.conf<br>
<code>add - VPN_FIREWALL = 1</code></p>
</li>
<li>
<p>reload firewall</p>
</li>
<li>
<p>sudoedit /etc/sudoers.d/tunnel_unpriv<br>
tunnel ALL = (ALL) NOPASSWD: /bin/ip<br>
tunnel ALL = (ALL) NOPASSWD: /usr/sbin/openvpn *<br>
Defaults: tunnel! Requiretty</p>
</li>
<li>
<p>Next, I copy my certificates using scp<br>
scp -P 12222 user@server: “/tmp/ {openvpn-client *, ca.crt, ta.key}” /etc/openvpn/client/</p>
<p>scp -P 12222 user@server: “/tmp/ {eakj - *, stunnel-server.crt}” /etc/stunnel/<br>
(had to install openssh-client)</p>
</li>
</ol>
<p>I register the stunnel and openvpn configs<br>
They look like this:</p>
<ol>
<li>/etc/stunnel/stunnel.conf<br>
[openvpn]<br>
client = yes<br>
accept = 127.0.0.1:1194<br>
connect = ipserver: 443<br>
verifyPeer = yes<br>
CAfile = /etc/stunnel/stunnel-server.crt<br>
cert = /etc/stunnel/eakj-desktop.crt<br>
key = /etc/stunnel/eakj-desktop.key</li>
</ol>
<hr>
<pre><code>systemctl start stunnel4
systemctl status stunnel4 - very good
systemctl enable stunnel4
</code></pre>
<ol start="2">
<li>
<p>/etc/openvpn/client/openvpn-client.conf<br>
client<br>
dev tun0<br>
proto tcp<br>
remote 127.0.0.1 1194<br>
resolv-retry infinite<br>
nobind<br>
user tunnel<br>
iproute /usr/bin/ip_unpriv<br>
persist-key<br>
persist-tun</p>
<p>ca ca.crt<br>
cert openvpn-client.crt<br>
key openvpn-client.key<br>
tls-auth ta.key 1</p>
<p>remote-cert-tls server<br>
cipher AES-256-GCM<br>
verb 3</p>
</li>
</ol>
<hr>
<pre><code>    sudo chown -R tunnel: tunnel /etc/openvpn
    sudo chown -R tunnel: tunnel /var/run/openvpn
    sudo cp /lib/systemd/system/openvpn-client@.service /lib/systemd/system/openvpn-client@openvpn.service

systemctl start openvpn-client@openvpn-client
systemctl status openvpn-client@openvpn-client 
</code></pre>
<p>Everything starts, but there is no connection via VPN - Tor off. Should TUN0 interface go up? IFCONFIG is silent about this.<br>
Perhaps this is the problem?<br>
Loaded: loaded (/lib/systemd/system/openvpn-client@.service; disabled - off?</p>
<p>Thanks in advance.</p><div class="lightbox-wrapper"><a class="lightbox" href="//forums.whonix.org/uploads/default/original/2X/4/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9.png" data-download-href="//forums.whonix.org/uploads/default/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9" title="Screenshot_Whonix-Gateway_2020-01-25_00:27:31.png"><img src="//forums.whonix.org/uploads/default/optimized/2X/4/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9_2_666x500.png" alt="Screenshot_Whonix-Gateway_2020-01-25_00%3A27%3A31" data-base62-sha1="bkF3cAkR5XOZh5K81WKvlIvqN7z" width="666" height="500" srcset="//forums.whonix.org/uploads/default/optimized/2X/4/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9_2_666x500.png, //forums.whonix.org/uploads/default/optimized/2X/4/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9_2_999x750.png 1.5x, //forums.whonix.org/uploads/default/original/2X/4/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9.png 2x" data-small-upload="//forums.whonix.org/uploads/default/optimized/2X/4/4f6dd715e6437fd33f83fc444e9104bdde1ff6f9_2_10x10.png"></a></div><p></p>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/3">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/3</link>
        <pubDate>Fri, 24 Jan 2020 21:43:11 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-3</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[HulaHoop]]></dc:creator>
        <description><![CDATA[
            <p>Not really supported. You can try creating a second “internal” nework and connect GW egress to it and hope your stunnel/openvpn VM is configured to correctly redirect the traffic, but it seems pointless to me when GW supports running  OpenVPN at the moment. This may change when we move to nftables.</p>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/2">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/2</link>
        <pubDate>Fri, 24 Jan 2020 17:30:05 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-2</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
      <item>
        <title>How to redirect traffic from the gateway to another virtual machine KVM.</title>
        <dc:creator><![CDATA[Masaika]]></dc:creator>
        <description><![CDATA[
            <p>How to redirect traffic from the whonix (virbr1) gateway to another KVM virtual machine (virbr3)? That the external network was not from the host. I want to separate openvpn + stunnel from host and gateway. By running them in another virtual machine.</p>
<p>Default:<br>
workstation &gt; gateway &gt; host system &gt; internet</p>
<p>I need so:<br>
workstation &gt; gateway &gt; virtual machine(OpenVpn+stunnel) &gt; host system &gt; internet</p>
          <p><a href="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/1">Read full topic</a></p>
        ]]></description>
        <link>http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833/1</link>
        <pubDate>Thu, 23 Jan 2020 23:24:18 +0000</pubDate>
        <guid isPermaLink="false">forums.whonix.org-post-8833-1</guid>
        <source url="http://forums.whonix.org/t/how-to-redirect-traffic-from-the-gateway-to-another-virtual-machine-kvm/8833.rss">How to redirect traffic from the gateway to another virtual machine KVM.</source>
      </item>
  </channel>
</rss>
